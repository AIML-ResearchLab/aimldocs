<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Ganesh kinkar Giri" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>ADK - AIML documents</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "ADK";
        var mkdocs_page_input_path = "AgenticAI/GCP/adk.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../index.html" class="icon icon-home"> AIML documents
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">AIML</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >Programing</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Programing/python.html">PYTHON</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Statistic</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Descriptive Statistics</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Measures of Central Tendency</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Central-Tendency/Mean.html">Mean</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Central-Tendency/Median.html">Median</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Central-Tendency/Mode.html">Mode</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Measures of Position (Relative Standing)</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Position-Relative-Standing/Percentiles.html">Percentiles</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Position-Relative-Standing/Quartiles.html">Quartiles</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Position-Relative-Standing/Deciles.html">Deciles</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Position-Relative-Standing/Z-Score.html">Z-Score</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Shape of the Distribution</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Shape-of-the-Distribution/Skewness.html">Skewness</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Shape-of-the-Distribution/Kurtosis.html">Kurtosis</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Visualization Tools</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/Histogram.html">Histogram</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/BarChart.html">Bar Chart</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/PieChart.html">Pie Chart</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/BoxPlot.html">Box Plot</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/LinePlot.html">Line Plot</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/DotPlot.html">Dot Plot</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Measures of Dispersion (Variability)</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Dispersion/Range.html">Range</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Dispersion/Variance.html">Variance</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Dispersion/StandardDeviation.html">Standard Deviation</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Dispersion/InterquartileRange.html">Interquartile Range(IQR)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Dispersion/CofficientVariation.html">Cofficient of Variation</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Inferential Statistics</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Population and Sample</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Population-and-Sample/Population.html">Population</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Population-and-Sample/Sample.html">Sample</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Population-and-Sample/SamplingMethods.html">Sampling Methods</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Estimation</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Estimation/PointEstimation.html">Point Estimation</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Estimation/IntervalEstimation.html">Interval Estimation</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Estimation/MarginError.html">Margin of Error</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Regression and Correlation Analysis</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Regression-and-Correlation-Analysis/LinearRegression.html">Linear Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Regression-and-Correlation-Analysis/LogisticRegression.html">Logistic Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Regression-and-Correlation-Analysis/MultipleRegression.html">Multiple Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Regression-and-Correlation-Analysis/CorrelationCoefficients.html">Correlation Coefficients</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Hypothesis Testing</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/NullHypothesis.html">Null Hypothesis (H₀)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/AlternativeHypothesis.html">Alternative Hypothesis (H₁)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/TestStatistic.html">Test Statistic</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/pvalue.html">p-value</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/SignificanceLevel.html">Significance Level (α)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/TypeIError.html">Type I Error (α)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/TypeIIError.html">Type II Error (β)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/PoweroftheTest.html">Power of the Test</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Parametric Tests</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Parametric-Tests/t-test.html">t-test</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Parametric-Tests/z-test.html">z-test</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Parametric-Tests/ANOVA.html">ANOVA</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Parametric-Tests/F-test.html">F-test</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Non-Parametric Tests</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Non-Parametric-Tests/Mann-WhitneyU.html">Mann-Whitney U</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Non-Parametric-Tests/Kruskal-Wallis.html">Kruskal-Wallis</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Non-Parametric-Tests/Wilcoxon.html">Wilcoxon</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Non-Parametric-Tests/Chi-square.html">Chi-square</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Resampling Methods</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Resampling-Methods/Bootstrapping.html">Bootstrapping</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Resampling-Methods/Jackknife.html">Jackknife</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Analysis of Variance (ANOVA)</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/ANOVA/One-way-ANOVA.html">One-way ANOVA</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/ANOVA/Two-way-ANOVA.html">Two-way ANOVA</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/ANOVA/Post-hoc-Tests.html">Post-hoc Tests</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Probability Theory</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Probability-Theory/ProbabilityDistributions.html">Probability Distributions</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Probability-Theory/CentralLimitTheorem.html">Central Limit Theorem</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Probability-Theory/BayesianInference.html">Bayesian Inference</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Time Series</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Trend.html">Trend</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Seasonality.html">Seasonality</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Cyclic.html">Cyclic</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Noise.html">Irregular/Noise</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Stationarity.html">Stationarity</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Non-stationary.html">Non-stationary</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Autocorrelation.html">Autocorrelation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Lag.html">Lag</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/MovingAverages.html">Moving Averages</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Holt-Winters.html">Holt-Winters Method</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Additive.html">Additive</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Multiplicative.html">Multiplicative</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/AR.html">AR (Auto Regression)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/ARIMA.html">ARIMA</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Arimax.html">Arimax</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Sarimax.html">Sarimax</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Smoothing.html">Smoothing</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/AutomatedForecasting.html">Automated Forecasting</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/AutomatedTimeSeries.html">Automated Time Series</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Multivariate.html">Uni, Bi and Multivariate</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Statistic/metrics.html">Metrics Evaluation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Statistic/timeseries.html">Time Series Old</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Statistic/statistic-details.html">Statistic Details</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Data manipulation and analysis</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Data-manipulation-and-analysis/data-manipulation-analysis.html">PANDAS</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Data Processing</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Data-processing/sql.html">Basic SQL</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Data-processing/sql-datascience.html">Using SQL for Data Science</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Data-processing/unstructured-data.html">Unstructured Data</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Data-processing/exploratory-data-analysis.html">Exploratory Data Analysis(EDA)</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../Data-processing/building-ml-models-on-text-data.md">Building ML Models on Text Data</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Databases</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Databases/PostgreSQL.html">PostgreSQL</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Databases/MySQL.html">MySQL</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Databases/MongoDB.html">MongoDB</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Machine Learning</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../MachineLearning/Overview.html">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Supervised Learning</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/Overview.html">Overview</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/Regression.html">Regression</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/Classification.html">Classification</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/CrossValidation.html">Cross Validation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/HyperparameterTuning.html">Hyperparameter Tuning</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/TuningDecisionThreshold.html">Tuning decision threshold</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Regression Models</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/SimpleLinearRegression.html">Simple Linear Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/MultipleLinearRegression.html">Multiple Linear Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/PolynomialRegression.html">Polynomial Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/RidgeLassoRegression.html">Ridge & Lasso Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/SupportVectorRegression.html">Support Vector Regression (SVR)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/DecisionTreeRegression.html">Decision Tree Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/RandomForestRegression.html">Random Forest Regression</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Linear Classification Models</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/LinearClassificationModels/LogisticRegression.html">Logistic Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/LinearClassificationModels/SupportVectorMachines.html">Support Vector Machines</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/LinearClassificationModels/SinglelayerPerceptron.html">Single-layer Perceptron</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/LinearClassificationModels/StochasticGradientDescent.html">Stochastic Gradient Descent (SGD)</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Non-linear Classification Models</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/DecisionTreeClassification.html">Decision Tree Classification</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/KNearestNeighbours.html">K-Nearest Neighbours</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/NaiveBayes.html">Naive Bayes</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/RandomForests.html">Random Forests</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/AdaBoost.html">AdaBoost</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/BaggingClassifier.html">Bagging Classifier</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/Ensemblelearningclassifiers.html">Ensemble learning classifiers</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/KernelSVM.html">Kernel SVM</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Unsupervised Learning</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/UnsupervisedLearning/overview.html">Overview</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/UnsupervisedLearning/Clustering.html">Clustering</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/UnsupervisedLearning/Pca.html">Principal Component Analysis(PCA)</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Reinforcement Learning</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/ReinforcementLearning/ReinforcementLearning.html">Overview</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Linear Algebra</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../LinearAlgebra/Overview.html">Overview</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Deep Learning</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../DeepLearning/Overview.html">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../DeepLearning/Vanishing.html">Vanishing and Exploding Gradients Problems</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Components of Neural Networks</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/LayersNeuralNetworks.html">Layers in Neural Networks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/WeightsBiases.html">Weights and Biases</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/ForwardPropagation.html">Forward Propagation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/ActivationFunctions.html">Activation Functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/LossFunctions.html">Loss Functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/Backpropagation.html">Backpropagation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/LearningRate.html">Learning Rate</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Optimization Algorithm</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/GradientDescent.html">Gradient Descent</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/SGD.html">Stochastic Gradient Descent (SGD)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/Adam.html">Adam (Adaptive Moment Estimation)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/BatchNormalization.html">Batch Normalization</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/Mini-batch-GD.html">Mini-batch Gradient Descent</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/Momentum-based-GO.html">Momentum-based Gradient Optimizer</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/AdagradOptimizer.html">Adagrad Optimizer</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/RMSPropOptimizer.html">RMSProp Optimizer</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Models</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/FNN.html">Feedforward Neural Network (FNN)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Recurrent Neural Network (RNN)</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../DeepLearning/Models/RNN.html">Recurrent Neural Network (RNN)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../DeepLearning/Models/LSTM.html">LSTM (Long Short-Term Memory)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../DeepLearning/Models/GRU.html">GRU (Gated Recurrent Unit)</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/CNN.html">Convolutional Neural Network (CNN)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/RBFN.html">Radial Basis Function Network (RBFN)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/ComputerVision.html">Computer Vision</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/GANs.html">Generative Adversarial Networks (GANs)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/Transformer.html">Transformer Networks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/Autoencoders.html">Autoencoders</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/SOM.html">Self-Organizing Maps (SOM)</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Natural Language Processing(NLP)</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../NLP/overview.html">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../NLP/nlpdetails.html">NLP Details</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Retrieval-Augmented Generation(RAG)</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../RAG/rag.html">RAG</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >AI agents</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../AIagents/aiagents.html">AI agents</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Agentic AI</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../general.html">general</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../overview.html">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../crewai.html">crewai</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../LangGraph.html">LangGraph</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../AutoGen.html">AutoGen</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../aws.html">AWS</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../azure.html">AZURE</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" >Agent Development Kit</a>
    <ul class="current">
                <li class="toctree-l3 current"><a class="reference internal current" href="#">ADK</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="Agents.html">Agents</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="Tools.html">Tools</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="a2a.html">Tools</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >MCPModel Context Protocol (MCP)</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../MCP/mcp.html">MCP</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Models Details information</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Models/Ollama.html">Ollama</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Note Book</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Notebook/allnotebook.html">All Notebook</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AIML documents</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html" class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">AIML</li>
          <li class="breadcrumb-item">Agentic AI</li>
          <li class="breadcrumb-item">Agent Development Kit</li>
      <li class="breadcrumb-item active">ADK</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h3 style="color:red;">✅ Google Agent Development Kit</h3>

<h3 style="color:blue;">📌 What Agent Development Kit (ADK)?</h3>

<p>ADK is a Python framework designed to streamline the development of applications powered by Large Language Models (LLMs).
It offers robust building blocks for creating agents that can reason, plan, utilize tools, interact dynamically with users, and collaborate effectively within a team.</p>
<h3 style="color:red;">✅ Tool Definition & Usage:</h3>
<p>Crafting Python functions (tools) that grant agents specific abilities (like fetching data) and instructing agents on how to use them effectively.</p>
<h3 style="color:red;">✅ Multi-LLM Flexibility:</h3>
<p>Configuring agents to utilize various leading LLMs (Gemini, GPT-4o, Claude Sonnet) via LiteLLM integration, allowing you to choose the best model for each task.</p>
<h3 style="color:red;">✅ Agent Delegation & Collaboration:</h3>
<p>Designing specialized sub-agents and enabling automatic routing (auto flow) of user requests to the most appropriate agent within a team.</p>
<h3 style="color:red;">✅ Session State for Memory:</h3>
<p>Utilizing Session State and ToolContext to enable agents to remember information across conversational turns, leading to more contextual interactions.</p>
<h3 style="color:red;">✅ Safety Guardrails with Callbacks:</h3>
<p>Implementing before_model_callback and before_tool_callback to inspect, modify, or block requests/tool usage based on predefined rules, enhancing application safety and control.</p>
<h3 style="color:blue;">📌 Prerequisites</h3>

<h3 style="color:red;">✅ Solid understanding of Python programming.</h3>
<h3 style="color:red;">✅ Familiarity with Large Language Models (LLMs), APIs, and the concept of agents.</h3>
<h3 style="color:red;">✅ API Keys for the LLMs you intend to use (e.g., Google AI Studio for Gemini, OpenAI Platform, Anthropic Console).</h3>

<h3 style="color:blue;">📌 Note on Execution Environment:</h3>

<h3 style="color:red;">✅ Running Async Code:</h3>
<p>Notebook environments handle asynchronous code differently.using <code>await</code> (suitable when an event loop is already running, common in notebooks) or <code>asyncio.run()</code> (often needed when running as a standalone <code>.py</code> script or in specific notebook setups).</p>
<h3 style="color:red;">✅ Manual Runner/Session Setup:</h3>
<p>The steps involve explicitly creating <code>Runner</code> and <code>SessionService</code> instances. This approach is shown because it gives you fine-grained control over the agent's execution lifecycle, session management, and state persistence.</p>
<h3 style="color:blue;">📌 Using ADK's Built-in Tools (Web UI / CLI / API Server):</h3>
<p>If you prefer a setup that handles the runner and session management automatically using ADK's standard tools,
That version is designed to be run directly with commands like <code>adk web</code> (for a web UI), <code>adk run</code> (for CLI interaction), or <code>adk api_server</code> (to expose an API).</p>
<h3 style="color:blue;">📌 Ready to build your agent team? Let's dive in!</h3>

<h3 style="color:red;">✅ Setup and Installation:</h3>

<div class="codehilite"><pre><span></span><code>#<span class="w"> </span><span class="p">@</span><span class="nb">title</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">Setup</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">Installation</span>
#<span class="w"> </span><span class="n">Install</span><span class="w"> </span><span class="n">ADK</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">LiteLLM</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">model</span><span class="w"> </span><span class="n">support</span>

<span class="sx">!pip install google-adk -q</span>
<span class="sx">!pip install litellm -q</span>
</code></pre></div>

<h3 style="color:red;">✅ Import necessary libraries:</h3>

<div class="codehilite"><pre><span></span><code><span class="c1"># @title Import necessary libraries</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.lite_llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLlm</span> <span class="c1"># For multi-model support</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.sessions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.runners</span><span class="w"> </span><span class="kn">import</span> <span class="n">Runner</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span> <span class="c1"># For creating message Content/Parts</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="c1"># Ignore all warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:red;">✅ Configure API Keys:</h3>

<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nv">@title</span><span class="w"> </span><span class="n">Configure</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">Keys</span><span class="w"> </span><span class="p">(</span><span class="nf">Replace</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">actual</span><span class="w"> </span><span class="n">keys</span><span class="err">!</span><span class="p">)</span>

<span class="err">#</span><span class="w"> </span><span class="c1">--- IMPORTANT: Replace placeholders with your real API keys ---</span>

<span class="err">#</span><span class="w"> </span><span class="n">Gemini</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="k">Key</span><span class="w"> </span><span class="p">(</span><span class="k">Get</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Google</span><span class="w"> </span><span class="n">AI</span><span class="w"> </span><span class="nl">Studio</span><span class="p">:</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">aistudio</span><span class="p">.</span><span class="n">google</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">apikey</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="o">[</span><span class="n">&quot;GOOGLE_API_KEY&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;YOUR_GOOGLE_API_KEY&quot;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="c1">--- REPLACE</span>

<span class="err">#</span><span class="w"> </span><span class="o">[</span><span class="n">Optional</span><span class="o">]</span>
<span class="err">#</span><span class="w"> </span><span class="n">OpenAI</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="k">Key</span><span class="w"> </span><span class="p">(</span><span class="k">Get</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">OpenAI</span><span class="w"> </span><span class="nl">Platform</span><span class="p">:</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">platform</span><span class="p">.</span><span class="n">openai</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">-</span><span class="n">keys</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="o">[</span><span class="n">&#39;OPENAI_API_KEY&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;YOUR_OPENAI_API_KEY&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="c1">--- REPLACE</span>

<span class="err">#</span><span class="w"> </span><span class="o">[</span><span class="n">Optional</span><span class="o">]</span>
<span class="err">#</span><span class="w"> </span><span class="n">Anthropic</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="k">Key</span><span class="w"> </span><span class="p">(</span><span class="k">Get</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Anthropic</span><span class="w"> </span><span class="nl">Console</span><span class="p">:</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">console</span><span class="p">.</span><span class="n">anthropic</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">settings</span><span class="o">/</span><span class="n">keys</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="o">[</span><span class="n">&#39;ANTHROPIC_API_KEY&#39;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;YOUR_ANTHROPIC_API_KEY&#39;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;</span><span class="c1">--- REPLACE</span>

<span class="err">#</span><span class="w"> </span><span class="c1">--- Verify Keys (Optional Check) ---</span>
<span class="k">print</span><span class="p">(</span><span class="ss">&quot;API Keys Set:&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Google API Key set: {&#39;Yes&#39; if os.environ.get(&#39;GOOGLE_API_KEY&#39;) and os.environ[&#39;GOOGLE_API_KEY&#39;] != &#39;YOUR_GOOGLE_API_KEY&#39; else &#39;No (REPLACE PLACEHOLDER!)&#39;}&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;OpenAI API Key set: {&#39;Yes&#39; if os.environ.get(&#39;OPENAI_API_KEY&#39;) and os.environ[&#39;OPENAI_API_KEY&#39;] != &#39;YOUR_OPENAI_API_KEY&#39; else &#39;No (REPLACE PLACEHOLDER!)&#39;}&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Anthropic API Key set: {&#39;Yes&#39; if os.environ.get(&#39;ANTHROPIC_API_KEY&#39;) and os.environ[&#39;ANTHROPIC_API_KEY&#39;] != &#39;YOUR_ANTHROPIC_API_KEY&#39; else &#39;No (REPLACE PLACEHOLDER!)&#39;}&quot;</span><span class="p">)</span>

<span class="err">#</span><span class="w"> </span><span class="n">Configure</span><span class="w"> </span><span class="n">ADK</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="p">(</span><span class="ow">not</span><span class="w"> </span><span class="n">Vertex</span><span class="w"> </span><span class="n">AI</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">multi</span><span class="o">-</span><span class="n">model</span><span class="w"> </span><span class="n">setup</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="o">[</span><span class="n">&quot;GOOGLE_GENAI_USE_VERTEXAI&quot;</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;False&quot;</span>


<span class="err">#</span><span class="w"> </span><span class="nv">@markdown</span><span class="w"> </span><span class="o">**</span><span class="n">Security</span><span class="w"> </span><span class="nl">Note</span><span class="p">:</span><span class="o">**</span><span class="w"> </span><span class="n">It</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">best</span><span class="w"> </span><span class="n">practice</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">manage</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="n">securely</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">Colab</span><span class="w"> </span><span class="n">Secrets</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variables</span><span class="p">)</span><span class="w"> </span><span class="n">rather</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="n">hardcoding</span><span class="w"> </span><span class="n">them</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">notebook</span><span class="p">.</span><span class="w"> </span><span class="nf">Replace</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">placeholder</span><span class="w"> </span><span class="n">strings</span><span class="w"> </span><span class="n">above</span><span class="p">.</span>
</code></pre></div>

<h3 style="color:red;">✅ Define Model Constants for easier use:</h3>

<div class="codehilite"><pre><span></span><code><span class="c1"># --- Define Model Constants for easier use ---</span>

<span class="c1"># More supported models can be referenced here: https://ai.google.dev/gemini-api/docs/models#model-variations</span>
<span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;gemini-2.0-flash&quot;</span>

<span class="c1"># More supported models can be referenced here: https://docs.litellm.ai/docs/providers/openai#openai-chat-completion-models</span>
<span class="n">MODEL_GPT_4O</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;openai/gpt-4.1&quot;</span><span class="w"> </span><span class="c1"># You can also try: gpt-4.1-mini, gpt-4o etc.</span>

<span class="c1"># More supported models can be referenced here: https://docs.litellm.ai/docs/providers/anthropic</span>
<span class="n">MODEL_CLAUDE_SONNET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;anthropic/claude-sonnet-4-20250514&quot;</span><span class="w"> </span><span class="c1"># You can also try: claude-opus-4-20250514 , claude-3-7-sonnet-20250219 etc</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Environment configured.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 First Agent - Basic Weather Lookup</h3>
<p>Let's begin by building the fundamental component of our Weather Bot: a single agent capable of performing a specific task – looking up weather information. This involves creating two core pieces:</p>
<h3 style="color:red;">✅ A Tool:</h3>
<p>A Python function that equips the agent with the ability to fetch weather data.</p>
<h3 style="color:red;">✅ An Agent:</h3>
<p>The AI "brain" that understands the user's request, knows it has a weather tool, and decides when and how to use it.</p>
<h3 style="color:blue;">📌 Define the Tool (get_weather)</h3>
<p>In ADK, <strong>Tools</strong> are the building blocks that give agents concrete capabilities beyond just text generation. They are typically regular Python functions that perform specific actions, like calling an API, querying a database, or performing calculations.</p>
<p>Our first tool will provide a mock weather report. This allows us to focus on the agent structure without needing external API keys yet. Later, you could easily swap this mock function with one that calls a real weather service.</p>
<h3 style="color:red;">📌 Key Concept: Docstrings are Crucial!</h3>
<p>The agent's LLM relies heavily on the <code>function's docstring</code> to understand:</p>
<ul>
<li>What the tool does.?</li>
<li>When to use it.?</li>
<li>What arguments it requires (city: str).?</li>
<li>What information it returns.?</li>
</ul>
<h3 style="color:blue;">📌 Best Practice</h3>
<p>Write clear, descriptive, and accurate docstrings for your tools. This is essential for the LLM to use the tool correctly.</p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nv">@title</span><span class="w"> </span><span class="n">Define</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">get_weather</span><span class="w"> </span><span class="n">Tool</span>

<span class="n">def</span><span class="w"> </span><span class="n">get_weather</span><span class="p">(</span><span class="nl">city</span><span class="p">:</span><span class="w"> </span><span class="nf">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nl">dict</span><span class="p">:</span>
<span class="w">    </span><span class="ss">&quot;&quot;&quot;Retrieves the current weather report for a specified city.</span>

<span class="ss">    Args:</span>
<span class="ss">        city (str): The name of the city (e.g., &quot;</span><span class="k">New</span><span class="w"> </span><span class="n">York</span><span class="ss">&quot;, &quot;</span><span class="n">London</span><span class="ss">&quot;, &quot;</span><span class="n">Tokyo</span><span class="ss">&quot;).</span>

<span class="ss">    Returns:</span>
<span class="ss">        dict: A dictionary containing the weather information.</span>
<span class="ss">              Includes a &#39;status&#39; key (&#39;success&#39; or &#39;error&#39;).</span>
<span class="ss">              If &#39;success&#39;, includes a &#39;report&#39; key with weather details.</span>
<span class="ss">              If &#39;error&#39;, includes an &#39;error_message&#39; key.</span>
<span class="ss">    &quot;&quot;&quot;</span>

<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;--- Tool: get_weather called for city: {city} ---&quot;</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nf">Log</span><span class="w"> </span><span class="n">tool</span><span class="w"> </span><span class="n">execution</span>

<span class="w">    </span><span class="n">city_normalized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">city</span><span class="p">.</span><span class="nf">lower</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="ss">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Basic</span><span class="w"> </span><span class="n">normalization</span>


<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Mock</span><span class="w"> </span><span class="n">weather</span><span class="w"> </span><span class="k">data</span>
<span class="w">    </span><span class="n">mock_weather_db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="ss">&quot;newyork&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;status&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;success&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;report&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;The weather in New York is sunny with a temperature of 25°C.&quot;</span><span class="err">}</span><span class="p">,</span>
<span class="w">        </span><span class="ss">&quot;london&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;status&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;success&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;report&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;It&#39;s cloudy in London with a temperature of 15°C.&quot;</span><span class="err">}</span><span class="p">,</span>
<span class="w">        </span><span class="ss">&quot;tokyo&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;status&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;success&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;report&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;Tokyo is experiencing light rain and a temperature of 18°C.&quot;</span><span class="err">}</span><span class="p">,</span>
<span class="w">    </span><span class="err">}</span>


<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">city_normalized</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nl">mock_weather_db</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">mock_weather_db</span><span class="o">[</span><span class="n">city_normalized</span><span class="o">]</span>
<span class="w">    </span><span class="k">else</span><span class="err">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;status&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;error&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;error_message&quot;</span><span class="err">:</span><span class="w"> </span><span class="n">f</span><span class="ss">&quot;Sorry, I don&#39;t have weather information for &#39;{city}&#39;.&quot;</span><span class="err">}</span>

<span class="err">#</span><span class="w"> </span><span class="n">Example</span><span class="w"> </span><span class="n">tool</span><span class="w"> </span><span class="k">usage</span><span class="w"> </span><span class="p">(</span><span class="n">optional</span><span class="w"> </span><span class="n">test</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">get_weather</span><span class="p">(</span><span class="ss">&quot;New York&quot;</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">get_weather</span><span class="p">(</span><span class="ss">&quot;Paris&quot;</span><span class="p">))</span>
</code></pre></div>

<h3 style="color:blue;">📌 Define the Agent (weather_agent)</h3>

<p>An <code>Agent</code> in ADK orchestrates the interaction between the user, the LLM, and the available tools.</p>
<h3 style="color:blue;">📌 Agents configure it with several key parameters:</h3>

<h3 style="color:red;">✅ name:</h3>
<p>A unique identifier for this agent (e.g., "weather_agent_v1").</p>
<h3 style="color:red;">✅ model:</h3>
<p>Specifies which LLM to use (e.g., MODEL_GEMINI_2_0_FLASH).</p>
<h3 style="color:red;">✅ description:</h3>
<p>A concise summary of the agent's overall purpose. This becomes crucial later when other agents need to decide whether to delegate tasks to this agent.</p>
<h3 style="color:red;">✅ instruction:</h3>
<p>Detailed guidance for the LLM on how to behave, its persona, its goals, and specifically how and when to utilize its assigned <code>tools</code>.</p>
<h3 style="color:red;">✅ tools:</h3>
<p>A list containing the actual Python tool functions the agent is allowed to use (e.g., [get_weather]).</p>
<p><strong>Best Practice:</strong> Provide clear and specific instruction prompts. The more detailed the instructions, the better the LLM can understand its role and how to use its tools effectively. Be explicit about error handling if needed.</p>
<p><strong>Best Practice:</strong> Choose descriptive <code>name</code> and <code>description</code> values. These are used internally by ADK and are vital for features like automatic delegation </p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nv">@title</span><span class="w"> </span><span class="n">Define</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Weather</span><span class="w"> </span><span class="n">Agent</span>
<span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">constants</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">earlier</span>
<span class="n">AGENT_MODEL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Gemini</span>

<span class="n">weather_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Agent</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="o">=</span><span class="ss">&quot;weather_agent_v1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">model</span><span class="o">=</span><span class="n">AGENT_MODEL</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Gemini</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">LiteLlm</span><span class="w"> </span><span class="k">object</span>
<span class="w">    </span><span class="n">description</span><span class="o">=</span><span class="ss">&quot;Provides weather information for specific cities.&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">instruction</span><span class="o">=</span><span class="ss">&quot;You are a helpful weather assistant. &quot;</span>
<span class="w">                </span><span class="ss">&quot;When the user asks for the weather in a specific city, &quot;</span>
<span class="w">                </span><span class="ss">&quot;use the &#39;get_weather&#39; tool to find the information. &quot;</span>
<span class="w">                </span><span class="ss">&quot;If the tool returns an error, inform the user politely. &quot;</span>
<span class="w">                </span><span class="ss">&quot;If the tool is successful, present the weather report clearly.&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">tools</span><span class="o">=[</span><span class="n">get_weather</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Pass</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">directly</span>
<span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Agent &#39;{weather_agent.name}&#39; created using model &#39;{AGENT_MODEL}&#39;.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Setup Runner and Session Service:</h3>

<p>To manage conversations and execute the agent, we need two more components:</p>
<h3 style="color:red;">✅ SessionService:</h3>
<p>Responsible for managing conversation history and state for different users and sessions. The InMemorySessionService is a simple implementation that stores everything in memory, suitable for testing and simple applications. It keeps track of the messages exchanged. We'll explore state persistence later.</p>
<h3 style="color:red;">✅ Runner:</h3>
<p>The engine that orchestrates the interaction flow. It takes user input, routes it to the appropriate agent, manages calls to the LLM and tools based on the agent's logic, handles session updates via the <code>SessionService</code>, and yields events representing the progress of the interaction.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># @title Setup Session Service and Runner</span>

<span class="c1"># --- Session Management ---</span>
<span class="c1"># Key Concept: SessionService stores conversation history &amp; state.</span>
<span class="c1"># InMemorySessionService is simple, non-persistent storage for this tutorial.</span>
<span class="n">session_service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InMemorySessionService</span><span class="p">()</span>

<span class="c1"># Define constants for identifying the interaction context</span>
<span class="n">APP_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;weather_tutorial_app&quot;</span>
<span class="n">USER_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;user_1&quot;</span>
<span class="n">SESSION_ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;session_001&quot;</span><span class="w"> </span><span class="c1"># Using a fixed ID for simplicity</span>

<span class="c1"># Create the specific session where the conversation will happen</span>
<span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">session_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
<span class="w">    </span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
<span class="w">    </span><span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Session created: App=&#39;{APP_NAME}&#39;, User=&#39;{USER_ID}&#39;, Session=&#39;{SESSION_ID}&#39;&quot;</span><span class="p">)</span>

<span class="c1"># --- Runner ---</span>
<span class="c1"># Key Concept: Runner orchestrates the agent execution loop.</span>
<span class="n">runner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runner</span><span class="p">(</span>
<span class="w">    </span><span class="n">agent</span><span class="o">=</span><span class="n">weather_agent</span><span class="p">,</span><span class="w"> </span><span class="c1"># The agent we want to run</span>
<span class="w">    </span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span><span class="w">   </span><span class="c1"># Associates runs with our app</span>
<span class="w">    </span><span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span><span class="w"> </span><span class="c1"># Uses our session manager</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Runner created for agent &#39;{runner.agent.name}&#39;.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Interact with the Agent</h3>
<p>We need a way to send messages to our agent and receive its responses. Since LLM calls and tool executions can take time, ADK's Runner operates asynchronously.</p>
<p>We'll define an <code>async</code> helper function (<code>call_agent_async</code>) that:</p>
<ol>
<li>
<p>Takes a user query string.</p>
</li>
<li>
<p>Packages it into the ADK <code>Content</code> format.</p>
</li>
<li>
<p>Calls <code>runner.run_async</code>, providing the user/session context and the new message.</p>
</li>
<li>
<p>Iterates through the <strong>Events</strong> yielded by the runner. Events represent steps in the agent's execution (e.g., tool call requested, tool result received, intermediate LLM thought, final response).</p>
</li>
<li>
<p>Identifies and prints the final response event using <code>event.is_final_response()</code></p>
</li>
</ol>
<p><strong>Why</strong> <code>async?</code> Interactions with LLMs and potentially tools (like external APIs) are I/O-bound operations. Using <code>asyncio</code> allows the program to handle these operations efficiently without blocking execution.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># @title Define Agent Interaction Function</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span> <span class="c1"># For creating message Content/Parts</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">runner</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;Sends a query to the agent and prints the final response.&quot;&quot;&quot;</span>
  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;&gt;&gt; User Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

  <span class="c1"># Prepare the user&#39;s message in ADK format</span>
  <span class="n">content</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">query</span><span class="p">)])</span>

  <span class="n">final_response_text</span> <span class="o">=</span> <span class="s2">&quot;Agent did not produce a final response.&quot;</span> <span class="c1"># Default</span>

  <span class="c1"># Key Concept: run_async executes the agent logic and yields Events.</span>
  <span class="c1"># We iterate through events to find the final answer.</span>
  <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span> <span class="n">new_message</span><span class="o">=</span><span class="n">content</span><span class="p">):</span>
      <span class="c1"># You can uncomment the line below to see *all* events during execution</span>
      <span class="c1"># print(f&quot;  [Event] Author: {event.author}, Type: {type(event).__name__}, Final: {event.is_final_response()}, Content: {event.content}&quot;)</span>

      <span class="c1"># Key Concept: is_final_response() marks the concluding message for the turn.</span>
      <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_final_response</span><span class="p">():</span>
          <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
             <span class="c1"># Assuming text response in the first part</span>
             <span class="n">final_response_text</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
          <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">actions</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">escalate</span><span class="p">:</span> <span class="c1"># Handle potential errors/escalations</span>
             <span class="n">final_response_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Agent escalated: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">error_message</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;No specific message.&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="c1"># Add more checks here if needed (e.g., specific error codes)</span>
          <span class="k">break</span> <span class="c1"># Stop processing events once the final response is found</span>

  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;&lt;&lt; Agent Response: </span><span class="si">{</span><span class="n">final_response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Run the Conversation</h3>

<p>Finally, let's test our setup by sending a few queries to the agent. We wrap our <code>async</code> calls in a main <code>async</code> function and run it using <code>await</code>.</p>
<h3 style="color:red;">✅ Run the Initial Conversation:</h3>

<div class="codehilite"><pre><span></span><code><span class="c1"># @title Run the Initial Conversation</span>

<span class="c1"># We need an async function to await our interaction helper</span>
<span class="n">async</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">run_conversation</span><span class="p">():</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;What is the weather like in London?&quot;</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;How about Paris?&quot;</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span><span class="w"> </span><span class="c1"># Expecting the tool&#39;s error message</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;Tell me the weather in New York&quot;</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
<span class="w">                                       </span><span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>

<span class="c1"># Execute the conversation using await in an async context (like Colab/Jupyter)</span>
<span class="n">await</span><span class="w"> </span><span class="n">run_conversation</span><span class="p">()</span>

<span class="c1"># --- OR ---</span>

<span class="c1"># Uncomment the following lines if running as a standard Python script (.py file):</span>
<span class="c1"># import asyncio</span>
<span class="c1"># if __name__ == &quot;__main__&quot;:</span>
<span class="c1">#     try:</span>
<span class="c1">#         asyncio.run(run_conversation())</span>
<span class="c1">#     except Exception as e:</span>
<span class="c1">#         print(f&quot;An error occurred: {e}&quot;)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Multi-Model with LiteLLM</h3>

<p>We built a functional Weather Agent powered by a specific Gemini model. While effective, real-world applications often benefit from the flexibility to use different Large Language Models (LLMs). Why?</p>
<ul>
<li>
<p><strong>Performance:</strong> Some models excel at specific tasks (e.g., coding, reasoning, creative writing).</p>
</li>
<li>
<p><strong>Cost:</strong> Different models have varying price points.</p>
</li>
<li>
<p><strong>Capabilities:</strong> Models offer diverse features, context window sizes, and fine-tuning options.</p>
</li>
<li>
<p><strong>Availability/Redundancy:</strong> Having alternatives ensures your application remains functional even if one provider experiences issues.</p>
</li>
</ul>
<p>ADK makes switching between models seamless through its integration with the LiteLLM library. LiteLLM acts as a consistent interface to over 100 different LLMs.</p>
<ol>
<li>
<p>Learn how to configure an ADK <code>Agent</code> to use models from providers like OpenAI (GPT) and Anthropic (Claude) using the <code>LiteLlm</code> wrapper.</p>
</li>
<li>
<p>Learn how to configure an ADK Agent to use models from providers like OpenAI (GPT) and Anthropic (Claude) using the LiteLlm wrapper.</p>
</li>
<li>
<p>Interact with these different agents to observe potential variations in their responses, even when using the same underlying tool.</p>
</li>
</ol>
<h3 style="color:red;">✅ Import LiteLlm</h3>

<div class="codehilite"><pre><span></span><code><span class="c1"># @title 1. Import LiteLlm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.lite_llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLlm</span>
</code></pre></div>

<h3 style="color:red;">✅ Define and Test Multi-Model Agents</h3>

<p>Instead of passing only a model name string (which defaults to Google's Gemini models), we wrap the desired model identifier string within the LiteLlm class.</p>
<ul>
<li><strong>Key Concept:</strong> <code>LiteLlm</code> <strong>Wrapper:</strong> The <code>LiteLlm(model="provider/model_name")</code> syntax tells ADK to route requests for this agent through the LiteLLM library to the specified model provider.</li>
</ul>
<p><strong>Best Practice:</strong> Use constants for model names (like MODEL_GPT_4O, MODEL_CLAUDE_SONNET defined in Step 0) to avoid typos and make code easier to manage.</p>
<p><strong>Error Handling:</strong> We wrap the agent definitions in try...except blocks. This prevents the entire code cell from failing if an API key for a specific provider is missing or invalid.</p>
<h3 style="color:blue;">📌 First, let's create and test the agent using OpenAI's GPT-4o.</h3>

<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nv">@title</span><span class="w"> </span><span class="n">Define</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="n">GPT</span><span class="w"> </span><span class="n">Agent</span>

<span class="err">#</span><span class="w"> </span><span class="n">Make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">environment</span><span class="p">.</span>
<span class="err">#</span><span class="w"> </span><span class="n">Make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="s1">&#39;call_agent_async&#39;</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">earlier</span><span class="p">.</span>

<span class="err">#</span><span class="w"> </span><span class="c1">--- Agent using GPT-4o ---</span>
<span class="n">weather_agent_gpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Initialize</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">None</span>
<span class="n">runner_gpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="k">Initialize</span><span class="w"> </span><span class="n">runner</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">None</span>

<span class="k">try</span><span class="err">:</span>
<span class="w">    </span><span class="n">weather_agent_gpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Agent</span><span class="p">(</span>
<span class="w">        </span><span class="n">name</span><span class="o">=</span><span class="ss">&quot;weather_agent_gpt&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Key</span><span class="w"> </span><span class="nl">change</span><span class="p">:</span><span class="w"> </span><span class="n">Wrap</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">LiteLLM</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">identifier</span>
<span class="w">        </span><span class="n">model</span><span class="o">=</span><span class="n">LiteLlm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_GPT_4O</span><span class="p">),</span>
<span class="w">        </span><span class="n">description</span><span class="o">=</span><span class="ss">&quot;Provides weather information (using GPT-4o).&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">instruction</span><span class="o">=</span><span class="ss">&quot;You are a helpful weather assistant powered by GPT-4o. &quot;</span>
<span class="w">                    </span><span class="ss">&quot;Use the &#39;get_weather&#39; tool for city weather requests. &quot;</span>
<span class="w">                    </span><span class="ss">&quot;Clearly present successful reports or polite error messages based on the tool&#39;s output status.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">tools</span><span class="o">=[</span><span class="n">get_weather</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Re</span><span class="o">-</span><span class="k">use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">tool</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Agent &#39;{weather_agent_gpt.name}&#39; created using model &#39;{MODEL_GPT_4O}&#39;.&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">InMemorySessionService</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">simple</span><span class="p">,</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">persistent</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">tutorial</span><span class="p">.</span>
<span class="w">    </span><span class="n">session_service_gpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InMemorySessionService</span><span class="p">()</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">dedicated</span><span class="w"> </span><span class="n">service</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Define</span><span class="w"> </span><span class="n">constants</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">identifying</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">interaction</span><span class="w"> </span><span class="n">context</span>
<span class="w">    </span><span class="n">APP_NAME_GPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;weather_tutorial_app_gpt&quot;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Unique</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">test</span>
<span class="w">    </span><span class="n">USER_ID_GPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;user_1_gpt&quot;</span>
<span class="w">    </span><span class="n">SESSION_ID_GPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;session_001_gpt&quot;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">simplicity</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Create</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">specific</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">conversation</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">happen</span>
<span class="w">    </span><span class="n">session_gpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">session_service_gpt</span><span class="p">.</span><span class="n">create_session</span><span class="p">(</span>
<span class="w">        </span><span class="nf">app_name</span><span class="o">=</span><span class="n">APP_NAME_GPT</span><span class="p">,</span>
<span class="w">        </span><span class="nf">user_id</span><span class="o">=</span><span class="n">USER_ID_GPT</span><span class="p">,</span>
<span class="w">        </span><span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_GPT</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Session created: App=&#39;{APP_NAME_GPT}&#39;, User=&#39;{USER_ID_GPT}&#39;, Session=&#39;{SESSION_ID_GPT}&#39;&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runner</span><span class="w"> </span><span class="k">specific</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">agent</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">service</span>
<span class="w">    </span><span class="n">runner_gpt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runner</span><span class="p">(</span>
<span class="w">        </span><span class="n">agent</span><span class="o">=</span><span class="n">weather_agent_gpt</span><span class="p">,</span>
<span class="w">        </span><span class="nf">app_name</span><span class="o">=</span><span class="n">APP_NAME_GPT</span><span class="p">,</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">specific</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="n">name</span>
<span class="w">        </span><span class="n">session_service</span><span class="o">=</span><span class="n">session_service_gpt</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">specific</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">service</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Runner created for agent &#39;{runner_gpt.agent.name}&#39;.&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="c1">--- Test the GPT Agent ---</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;\n--- Testing GPT Agent ---&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Ensure</span><span class="w"> </span><span class="n">call_agent_async</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="n">runner</span><span class="p">,</span><span class="w"> </span><span class="nf">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;What&#39;s the weather in Tokyo?&quot;</span><span class="p">,</span>
<span class="w">                           </span><span class="n">runner</span><span class="o">=</span><span class="n">runner_gpt</span><span class="p">,</span>
<span class="w">                           </span><span class="nf">user_id</span><span class="o">=</span><span class="n">USER_ID_GPT</span><span class="p">,</span>
<span class="w">                           </span><span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_GPT</span><span class="p">)</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="c1">--- OR ---</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Uncomment</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">standard</span><span class="w"> </span><span class="n">Python</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="p">(.</span><span class="n">py</span><span class="w"> </span><span class="k">file</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">asyncio</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">__name__</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;__main__&quot;</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w">     </span><span class="k">try</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w">         </span><span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;What&#39;s the weather in Tokyo?&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="err">#</span><span class="w">                      </span><span class="n">runner</span><span class="o">=</span><span class="n">runner_gpt</span><span class="p">,</span>
<span class="w">    </span><span class="err">#</span><span class="w">                       </span><span class="nf">user_id</span><span class="o">=</span><span class="n">USER_ID_GPT</span><span class="p">,</span>
<span class="w">    </span><span class="err">#</span><span class="w">                       </span><span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_GPT</span><span class="p">)</span>
<span class="w">    </span><span class="err">#</span><span class="w">     </span><span class="ow">except</span><span class="w"> </span><span class="k">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">e</span><span class="p">:</span>
<span class="w">    </span><span class="err">#</span><span class="w">         </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;An error occurred: {e}&quot;</span><span class="p">)</span>

<span class="ow">except</span><span class="w"> </span><span class="k">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">e</span><span class="p">:</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;❌ Could not create or run GPT agent &#39;{MODEL_GPT_4O}&#39;. Check API Key and model name. Error: {e}&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 First, let's create and test the agent using Anthropic's Claude Sonnet.</h3>

<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nv">@title</span><span class="w"> </span><span class="n">Define</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Test</span><span class="w"> </span><span class="n">Claude</span><span class="w"> </span><span class="n">Agent</span>

<span class="err">#</span><span class="w"> </span><span class="n">Make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">environment</span><span class="p">.</span>
<span class="err">#</span><span class="w"> </span><span class="n">Make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="s1">&#39;call_agent_async&#39;</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">earlier</span><span class="p">.</span>

<span class="err">#</span><span class="w"> </span><span class="c1">--- Agent using Claude Sonnet ---</span>
<span class="n">weather_agent_claude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Initialize</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">None</span>
<span class="n">runner_claude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="k">Initialize</span><span class="w"> </span><span class="n">runner</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">None</span>

<span class="k">try</span><span class="err">:</span>
<span class="w">    </span><span class="n">weather_agent_claude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Agent</span><span class="p">(</span>
<span class="w">        </span><span class="n">name</span><span class="o">=</span><span class="ss">&quot;weather_agent_claude&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Key</span><span class="w"> </span><span class="nl">change</span><span class="p">:</span><span class="w"> </span><span class="n">Wrap</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">LiteLLM</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">identifier</span>
<span class="w">        </span><span class="n">model</span><span class="o">=</span><span class="n">LiteLlm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_CLAUDE_SONNET</span><span class="p">),</span>
<span class="w">        </span><span class="n">description</span><span class="o">=</span><span class="ss">&quot;Provides weather information (using Claude Sonnet).&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">instruction</span><span class="o">=</span><span class="ss">&quot;You are a helpful weather assistant powered by Claude Sonnet. &quot;</span>
<span class="w">                    </span><span class="ss">&quot;Use the &#39;get_weather&#39; tool for city weather requests. &quot;</span>
<span class="w">                    </span><span class="ss">&quot;Analyze the tool&#39;s dictionary output (&#39;status&#39;, &#39;report&#39;/&#39;error_message&#39;). &quot;</span>
<span class="w">                    </span><span class="ss">&quot;Clearly present successful reports or polite error messages.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">tools</span><span class="o">=[</span><span class="n">get_weather</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Re</span><span class="o">-</span><span class="k">use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">tool</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Agent &#39;{weather_agent_claude.name}&#39; created using model &#39;{MODEL_CLAUDE_SONNET}&#39;.&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">InMemorySessionService</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">simple</span><span class="p">,</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">persistent</span><span class="w"> </span><span class="n">storage</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">tutorial</span><span class="p">.</span>
<span class="w">    </span><span class="n">session_service_claude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InMemorySessionService</span><span class="p">()</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">dedicated</span><span class="w"> </span><span class="n">service</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Define</span><span class="w"> </span><span class="n">constants</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">identifying</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">interaction</span><span class="w"> </span><span class="n">context</span>
<span class="w">    </span><span class="n">APP_NAME_CLAUDE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;weather_tutorial_app_claude&quot;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Unique</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="n">USER_ID_CLAUDE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;user_1_claude&quot;</span>
<span class="w">    </span><span class="n">SESSION_ID_CLAUDE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;session_001_claude&quot;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">fixed</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">simplicity</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Create</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">specific</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">conversation</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">happen</span>
<span class="w">    </span><span class="n">session_claude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">session_service_claude</span><span class="p">.</span><span class="n">create_session</span><span class="p">(</span>
<span class="w">        </span><span class="nf">app_name</span><span class="o">=</span><span class="n">APP_NAME_CLAUDE</span><span class="p">,</span>
<span class="w">        </span><span class="nf">user_id</span><span class="o">=</span><span class="n">USER_ID_CLAUDE</span><span class="p">,</span>
<span class="w">        </span><span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_CLAUDE</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Session created: App=&#39;{APP_NAME_CLAUDE}&#39;, User=&#39;{USER_ID_CLAUDE}&#39;, Session=&#39;{SESSION_ID_CLAUDE}&#39;&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">runner</span><span class="w"> </span><span class="k">specific</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">agent</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">service</span>
<span class="w">    </span><span class="n">runner_claude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runner</span><span class="p">(</span>
<span class="w">        </span><span class="n">agent</span><span class="o">=</span><span class="n">weather_agent_claude</span><span class="p">,</span>
<span class="w">        </span><span class="nf">app_name</span><span class="o">=</span><span class="n">APP_NAME_CLAUDE</span><span class="p">,</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">specific</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="n">name</span>
<span class="w">        </span><span class="n">session_service</span><span class="o">=</span><span class="n">session_service_claude</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">specific</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">service</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;Runner created for agent &#39;{runner_claude.agent.name}&#39;.&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="c1">--- Test the Claude Agent ---</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;\n--- Testing Claude Agent ---&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Ensure</span><span class="w"> </span><span class="n">call_agent_async</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="n">runner</span><span class="p">,</span><span class="w"> </span><span class="nf">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span>
<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;Weather in London please.&quot;</span><span class="p">,</span>
<span class="w">                           </span><span class="n">runner</span><span class="o">=</span><span class="n">runner_claude</span><span class="p">,</span>
<span class="w">                           </span><span class="nf">user_id</span><span class="o">=</span><span class="n">USER_ID_CLAUDE</span><span class="p">,</span>
<span class="w">                           </span><span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_CLAUDE</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="c1">--- OR ---</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Uncomment</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">standard</span><span class="w"> </span><span class="n">Python</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="p">(.</span><span class="n">py</span><span class="w"> </span><span class="k">file</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="n">asyncio</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">__name__</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">&quot;__main__&quot;</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w">     </span><span class="k">try</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w">         </span><span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;Weather in London please.&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="err">#</span><span class="w">                      </span><span class="n">runner</span><span class="o">=</span><span class="n">runner_claude</span><span class="p">,</span>
<span class="w">    </span><span class="err">#</span><span class="w">                       </span><span class="nf">user_id</span><span class="o">=</span><span class="n">USER_ID_CLAUDE</span><span class="p">,</span>
<span class="w">    </span><span class="err">#</span><span class="w">                       </span><span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_CLAUDE</span><span class="p">)</span>
<span class="w">    </span><span class="err">#</span><span class="w">     </span><span class="ow">except</span><span class="w"> </span><span class="k">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">e</span><span class="p">:</span>
<span class="w">    </span><span class="err">#</span><span class="w">         </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;An error occurred: {e}&quot;</span><span class="p">)</span>


<span class="ow">except</span><span class="w"> </span><span class="k">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">e</span><span class="p">:</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;❌ Could not create or run Claude agent &#39;{MODEL_CLAUDE_SONNET}&#39;. Check API Key and model name. Error: {e}&quot;</span><span class="p">)</span>
</code></pre></div>

<ol>
<li>
<p>Each agent (weather_agent_gpt, weather_agent_claude) is created successfully (if API keys are valid).</p>
</li>
<li>
<p>A dedicated session and runner are set up for each.</p>
</li>
<li>
<p>Each agent correctly identifies the need to use the get_weather tool when processing the query (you'll see the <code>--- Tool: get_weather called... --- log</code>).</p>
</li>
<li>
<p>The underlying tool logic remains identical, always returning our mock data.</p>
</li>
<li>
<p>However, the <strong>final textual response</strong> generated by each agent might differ slightly in phrasing, tone, or formatting. This is because the instruction prompt is interpreted and executed by different LLMs (GPT-4o vs. Claude Sonnet).</p>
</li>
</ol>
<h3 style="color:blue;">📌 Building an Agent Team - Delegation for Greetings & Farewells.</h3>

<p>we built and experimented with a single agent focused solely on weather lookups. While effective for its specific task, real-world applications often involve handling a wider variety of user interactions. We could keep adding more tools and complex instructions to our single weather agent, but this can quickly become unmanageable and less efficient.</p>
<p>A more robust approach is to build an <strong>Agent Team</strong>. This involves:</p>
<ol>
<li>
<p>Creating multiple, <strong>specialized agents</strong>, each designed for a specific capability (e.g., one for weather, one for greetings, one for calculations).</p>
</li>
<li>
<p>Designating a <strong>root agent</strong> (or <code>orchestrator</code>) that receives the initial user request.</p>
</li>
<li>
<p>Enabling the root agent to <strong>delegate</strong> the request to the most appropriate specialized sub-agent based on the user's intent. </p>
</li>
</ol>
<h3 style="color:blue;">📌 Why build an Agent Team?</h3>

<h3 style="color:red;">✅ Modularity:</h3>
<p>Easier to develop, test, and maintain individual agents.</p>
<h3 style="color:red;">✅ Specialization:</h3>
<p>Each agent can be fine-tuned (instructions, model choice) for its specific task.</p>
<h3 style="color:red;">✅ Scalability:</h3>
<p>Simpler to add new capabilities by adding new agents.</p>
<h3 style="color:red;">✅ Efficiency:</h3>
<p>Allows using potentially simpler/cheaper models for simpler tasks (like greetings).</p>
<ol>
<li>
<p>Define simple tools for handling greetings (<code>say_hello</code>) and farewells (<code>say_goodbye</code>).</p>
</li>
<li>
<p>Create two new specialized sub-agents: <code>greeting_agent</code> and <code>farewell_agent</code>.</p>
</li>
<li>
<p>Update our main weather agent (<code>weather_agent_v2</code>) to act as the <strong>root agent</strong>.</p>
</li>
<li>
<p>Configure the root agent with its sub-agents, enabling <strong>automatic delegation</strong>.</p>
</li>
<li>
<p>Test the delegation flow by sending different types of requests to the root agent.</p>
</li>
</ol>
<h3 style="color:blue;">📌 Define Tools for Sub-Agents</h3>

<p>First, let's create the simple Python functions that will serve as tools for our new specialist agents. Remember, clear docstrings are vital for the agents that will use them.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># @title Define Tools for Greeting and Farewell Agents</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span> <span class="c1"># Make sure to import Optional</span>

<span class="c1"># Ensure &#39;get_weather&#39; from Step 1 is available if running this step independently.</span>
<span class="c1"># def get_weather(city: str) -&gt; dict: ... (from Step 1)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">say_hello</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides a simple greeting. If a name is provided, it will be used.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str, optional): The name of the person to greet. Defaults to a generic greeting if not provided.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: A friendly greeting message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">greeting</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hello, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: say_hello called with name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">greeting</span> <span class="o">=</span> <span class="s2">&quot;Hello there!&quot;</span> <span class="c1"># Default greeting if name is None or not explicitly passed</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: say_hello called without a specific name (name_arg_value: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">) ---&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">greeting</span>

<span class="k">def</span><span class="w"> </span><span class="nf">say_goodbye</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides a simple farewell message to conclude the conversation.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: say_goodbye called ---&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;Goodbye! Have a great day.&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Greeting and Farewell tools defined.&quot;</span><span class="p">)</span>

<span class="c1"># Optional self-test</span>
<span class="nb">print</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="s2">&quot;Alice&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">say_hello</span><span class="p">())</span> <span class="c1"># Test with no argument (should use default &quot;Hello there!&quot;)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span> <span class="c1"># Test with name explicitly as None (should use default &quot;Hello there!&quot;)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Define the Sub-Agents (Greeting & Farewell)</h3>

<p>Now, create the <code>Agent</code> instances for our specialists. Notice their highly focused <code>instruction</code> and, critically, their clear description. The <code>description</code> is the primary information the root agent uses to decide when to delegate to these sub-agents.</p>
<p><strong>Best Practice:</strong> Sub-agent <code>description</code> fields should accurately and concisely summarize their specific capability. This is crucial for effective automatic delegation.</p>
<p><strong>Best Practice:</strong> Sub-agent instruction fields should be tailored to their limited scope, telling them exactly what to do and what not to do (e.g., "Your only task is...").</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># @title Define Greeting and Farewell Sub-Agents</span>

<span class="c1"># If you want to use models other than Gemini, Ensure LiteLlm is imported and API keys are set (from Step 0/2)</span>
<span class="c1"># from google.adk.models.lite_llm import LiteLlm</span>
<span class="c1"># MODEL_GPT_4O, MODEL_CLAUDE_SONNET etc. should be defined</span>
<span class="c1"># Or else, continue to use: model = MODEL_GEMINI_2_0_FLASH</span>

<span class="c1"># --- Greeting Agent ---</span>
<span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
        <span class="c1"># Using a potentially different/cheaper model for a simple task</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
        <span class="c1"># model=LiteLlm(model=MODEL_GPT_4O), # If you would like to experiment with other models</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span>
        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Greeting Agent. Your ONLY task is to provide a friendly greeting to the user. &quot;</span>
                    <span class="s2">&quot;Use the &#39;say_hello&#39; tool to generate the greeting. &quot;</span>
                    <span class="s2">&quot;If the user provides their name, make sure to pass it to the tool. &quot;</span>
                    <span class="s2">&quot;Do not engage in any other conversation or tasks.&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple greetings and hellos using the &#39;say_hello&#39; tool.&quot;</span><span class="p">,</span> <span class="c1"># Crucial for delegation</span>
        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not create Greeting agent. Check API Key (</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># --- Farewell Agent ---</span>
<span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
        <span class="c1"># Can use the same or a different model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
        <span class="c1"># model=LiteLlm(model=MODEL_GPT_4O), # If you would like to experiment with other models</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span>
        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Farewell Agent. Your ONLY task is to provide a polite goodbye message. &quot;</span>
                    <span class="s2">&quot;Use the &#39;say_goodbye&#39; tool when the user indicates they are leaving or ending the conversation &quot;</span>
                    <span class="s2">&quot;(e.g., using words like &#39;bye&#39;, &#39;goodbye&#39;, &#39;thanks bye&#39;, &#39;see you&#39;). &quot;</span>
                    <span class="s2">&quot;Do not perform any other actions.&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple farewells and goodbyes using the &#39;say_goodbye&#39; tool.&quot;</span><span class="p">,</span> <span class="c1"># Crucial for delegation</span>
        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using model &#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not create Farewell agent. Check API Key (</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Define the Root Agent (Weather Agent v2) with Sub-Agents</h3>

<ul>
<li>
<p>Adding the <code>sub_agents</code> parameter: We pass a list containing the <code>greeting_agent</code> and <code>farewell_agent</code> instances we just created.</p>
</li>
<li>
<p>Updating the <code>instruction:</code> We explicitly tell the root agent about its sub-agents and when it should delegate tasks to them.</p>
</li>
</ul>
<h3 style="color:blue;">📌 Key Concept: Automatic Delegation (Auto Flow)</h3>

<p>enables automatic delegation. When the root agent receives a user query, its LLM considers not only its own instructions and tools but also the description of each sub-agent. If the LLM determines that a query aligns better with a sub-agent's described capability (e.g., "Handles simple greetings"), it will automatically generate a special internal action to transfer control to that sub-agent for that turn. The sub-agent then processes the query using its own model, instructions, and tools.</p>
<p><strong>Best Practice:</strong>
Ensure the root agent's instructions clearly guide its delegation decisions. Mention the sub-agents by name and describe the conditions under which delegation should occur.</p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nv">@title</span><span class="w"> </span><span class="n">Define</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Root</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">Sub</span><span class="o">-</span><span class="n">Agents</span>

<span class="err">#</span><span class="w"> </span><span class="n">Ensure</span><span class="w"> </span><span class="n">sub</span><span class="o">-</span><span class="n">agents</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">successfully</span><span class="w"> </span><span class="k">before</span><span class="w"> </span><span class="n">defining</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">agent</span><span class="p">.</span>
<span class="err">#</span><span class="w"> </span><span class="n">Also</span><span class="w"> </span><span class="n">ensure</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="w"> </span><span class="n">tool</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">defined</span><span class="p">.</span>
<span class="n">root_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>
<span class="n">runner_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Initialize</span><span class="w"> </span><span class="n">runner</span>

<span class="k">if</span><span class="w"> </span><span class="n">greeting_agent</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">farewell_agent</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Let</span><span class="s1">&#39;s use a capable Gemini model for the root agent to handle orchestration</span>
<span class="s1">    root_agent_model = MODEL_GEMINI_2_0_FLASH</span>

<span class="s1">    weather_agent_team = Agent(</span>
<span class="s1">        name=&quot;weather_agent_v2&quot;, # Give it a new version name</span>
<span class="s1">        model=root_agent_model,</span>
<span class="s1">        description=&quot;The main coordinator agent. Handles weather requests and delegates greetings/farewells to specialists.&quot;,</span>
<span class="s1">        instruction=&quot;You are the main Weather Agent coordinating a team. Your primary responsibility is to provide weather information. &quot;</span>
<span class="s1">                    &quot;Use the &#39;</span><span class="n">get_weather</span><span class="s1">&#39; tool ONLY for specific weather requests (e.g., &#39;</span><span class="n">weather</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">London</span><span class="s1">&#39;). &quot;</span>
<span class="s1">                    &quot;You have specialized sub-agents: &quot;</span>
<span class="s1">                    &quot;1. &#39;</span><span class="n">greeting_agent</span><span class="s1">&#39;: Handles simple greetings like &#39;</span><span class="n">Hi</span><span class="s1">&#39;, &#39;</span><span class="n">Hello</span><span class="s1">&#39;. Delegate to it for these. &quot;</span>
<span class="s1">                    &quot;2. &#39;</span><span class="n">farewell_agent</span><span class="s1">&#39;: Handles simple farewells like &#39;</span><span class="n">Bye</span><span class="s1">&#39;, &#39;</span><span class="n">See</span><span class="w"> </span><span class="n">you</span><span class="s1">&#39;. Delegate to it for these. &quot;</span>
<span class="s1">                    &quot;Analyze the user&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">query</span><span class="p">.</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">it</span><span class="s1">&#39;s a greeting, delegate to &#39;</span><span class="n">greeting_agent</span><span class="s1">&#39;. If it&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">farewell</span><span class="p">,</span><span class="w"> </span><span class="n">delegate</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="s1">&#39;farewell_agent&#39;</span><span class="p">.</span><span class="w"> </span><span class="ss">&quot;</span>
<span class="ss">                    &quot;</span><span class="k">If</span><span class="w"> </span><span class="n">it</span><span class="s1">&#39;s a weather request, handle it yourself using &#39;</span><span class="n">get_weather</span><span class="s1">&#39;. &quot;</span>
<span class="s1">                    &quot;For anything else, respond appropriately or state you cannot handle it.&quot;,</span>
<span class="s1">        tools=[get_weather], # Root agent still needs the weather tool for its core task</span>
<span class="s1">        # Key change: Link the sub-agents here!</span>
<span class="s1">        sub_agents=[greeting_agent, farewell_agent]</span>
<span class="s1">    )</span>
<span class="s1">    print(f&quot;✅ Root Agent &#39;</span><span class="err">{</span><span class="n">weather_agent_team</span><span class="p">.</span><span class="n">name</span><span class="err">}</span><span class="s1">&#39; created using model &#39;</span><span class="err">{</span><span class="n">root_agent_model</span><span class="err">}</span><span class="s1">&#39; with sub-agents: {[sa.name for sa in weather_agent_team.sub_agents]}&quot;)</span>

<span class="s1">else:</span>
<span class="s1">    print(&quot;❌ Cannot create root agent because one or more sub-agents failed to initialize or &#39;</span><span class="n">get_weather</span><span class="s1">&#39; tool is missing.&quot;)</span>
<span class="s1">    if not greeting_agent: print(&quot; - Greeting Agent is missing.&quot;)</span>
<span class="s1">    if not farewell_agent: print(&quot; - Farewell Agent is missing.&quot;)</span>
<span class="s1">    if &#39;</span><span class="n">get_weather</span><span class="err">&#39;</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="err">:</span><span class="w"> </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot; - get_weather function is missing.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Interact with the Agent Team</h3>

<div class="codehilite"><pre><span></span><code><span class="c1"># @title Interact with the Agent Team</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># Ensure asyncio is imported</span>

<span class="c1"># Ensure the root agent (e.g., &#39;weather_agent_team&#39; or &#39;root_agent&#39; from the previous cell) is defined.</span>
<span class="c1"># Ensure the call_agent_async function is defined.</span>

<span class="c1"># Check if the root agent variable exists before defining the conversation function</span>
<span class="n">root_agent_var_name</span> <span class="o">=</span> <span class="s1">&#39;root_agent&#39;</span> <span class="c1"># Default name from Step 3 guide</span>
<span class="k">if</span> <span class="s1">&#39;weather_agent_team&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="c1"># Check if user used this name instead</span>
    <span class="n">root_agent_var_name</span> <span class="o">=</span> <span class="s1">&#39;weather_agent_team&#39;</span>
<span class="k">elif</span> <span class="s1">&#39;root_agent&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Root agent (&#39;root_agent&#39; or &#39;weather_agent_team&#39;) not found. Cannot define run_team_conversation.&quot;</span><span class="p">)</span>
    <span class="c1"># Assign a dummy value to prevent NameError later if the code block runs anyway</span>
    <span class="n">root_agent</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Or set a flag to prevent execution</span>

<span class="c1"># Only define and run if the root agent exists</span>
<span class="k">if</span> <span class="n">root_agent_var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">root_agent_var_name</span><span class="p">]:</span>
    <span class="c1"># Define the main async function for the conversation logic.</span>
    <span class="c1"># The &#39;await&#39; keywords INSIDE this function are necessary for async operations.</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_team_conversation</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing Agent Team Delegation ---&quot;</span><span class="p">)</span>
        <span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
        <span class="n">APP_NAME</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_agent_team&quot;</span>
        <span class="n">USER_ID</span> <span class="o">=</span> <span class="s2">&quot;user_1_agent_team&quot;</span>
        <span class="n">SESSION_ID</span> <span class="o">=</span> <span class="s2">&quot;session_001_agent_team&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created: App=&#39;</span><span class="si">{</span><span class="n">APP_NAME</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">actual_root_agent</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">root_agent_var_name</span><span class="p">]</span>
        <span class="n">runner_agent_team</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span> <span class="c1"># Or use InMemoryRunner</span>
            <span class="n">agent</span><span class="o">=</span><span class="n">actual_root_agent</span><span class="p">,</span>
            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
            <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runner created for agent &#39;</span><span class="si">{</span><span class="n">actual_root_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># --- Interactions using await (correct within async def) ---</span>
        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;Hello there!&quot;</span><span class="p">,</span>
                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;What is the weather in New York?&quot;</span><span class="p">,</span>
                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;Thanks, bye!&quot;</span><span class="p">,</span>
                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>

    <span class="c1"># --- Execute the `run_team_conversation` async function ---</span>
    <span class="c1"># Choose ONE of the methods below based on your environment.</span>
    <span class="c1"># Note: This may require API keys for the models used!</span>

    <span class="c1"># METHOD 1: Direct await (Default for Notebooks/Async REPLs)</span>
    <span class="c1"># If your environment supports top-level await (like Colab/Jupyter notebooks),</span>
    <span class="c1"># it means an event loop is already running, so you can directly await the function.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting execution using &#39;await&#39; (default for notebooks)...&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">run_team_conversation</span><span class="p">()</span>

    <span class="c1"># METHOD 2: asyncio.run (For Standard Python Scripts [.py])</span>
    <span class="c1"># If running this code as a standard Python script from your terminal,</span>
    <span class="c1"># the script context is synchronous. `asyncio.run()` is needed to</span>
    <span class="c1"># create and manage an event loop to execute your async function.</span>
    <span class="c1"># To use this method:</span>
    <span class="c1"># 1. Comment out the `await run_team_conversation()` line above.</span>
    <span class="c1"># 2. Uncomment the following block:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    import asyncio</span>
<span class="sd">    if __name__ == &quot;__main__&quot;: # Ensures this runs only when script is executed directly</span>
<span class="sd">        print(&quot;Executing using &#39;asyncio.run()&#39; (for standard Python scripts)...&quot;)</span>
<span class="sd">        try:</span>
<span class="sd">            # This creates an event loop, runs your async function, and closes the loop.</span>
<span class="sd">            asyncio.run(run_team_conversation())</span>
<span class="sd">        except Exception as e:</span>
<span class="sd">            print(f&quot;An error occurred: {e}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<span class="k">else</span><span class="p">:</span>
    <span class="c1"># This message prints if the root agent variable wasn&#39;t found earlier</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Skipping agent team conversation execution as the root agent was not successfully defined in a previous step.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Adding Memory and Personalization with Session State</h3>

<p>So far, our agent team can handle different tasks through delegation, but each interaction starts fresh – the agents have no memory of past conversations or user preferences within a session. To create more sophisticated and context-aware experiences, agents need <strong>memory</strong>. ADK provides this through <strong>Session State</strong>.</p>
<h3 style="color:blue;">📌 What is Session State?</h3>

<ul>
<li>
<p>It's a Python dictionary (<code>session.state</code>) tied to a specific user session (identified by APP_NAME, USER_ID, SESSION_ID).</p>
</li>
<li>
<p>It persists information across multiple conversational turns within that session.</p>
</li>
<li>
<p>Agents and Tools can read from and write to this state, allowing them to remember details, adapt behavior, and personalize responses.</p>
</li>
</ul>
<h3 style="color:blue;">📌 How Agents Interact with State:</h3>

<ol>
<li>
<p><strong>ToolContext (Primary Method):</strong> Tools can accept a <code>ToolContext</code> object (automatically provided by ADK if declared as the last argument). This object gives direct access to the session state via <code>tool_context.state</code>, allowing tools to read preferences or save results during execution.</p>
</li>
<li>
<p><strong>output_key (Auto-Save Agent Response):</strong> An Agent can be configured with an <code>output_key="your_key"</code>. ADK will then automatically save the agent's final textual response for a turn into <code>session.state["your_key"]</code>.</p>
</li>
</ol>
<h3 style="color:blue;">📌 Initialize New Session Service and State</h3>

<p>To clearly demonstrate state management without interference from prior steps, we'll instantiate a new InMemorySessionService. We'll also create a session with an initial state defining the user's preferred temperature unit.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># @title 1. Initialize New Session Service and State</span>

<span class="c1"># Import necessary session components</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.sessions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionService</span>

<span class="c1"># Create a NEW session service instance for this state demonstration</span>
<span class="n">session_service_stateful</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ New InMemorySessionService created for state demonstration.&quot;</span><span class="p">)</span>

<span class="c1"># Define a NEW session ID for this part of the tutorial</span>
<span class="n">SESSION_ID_STATEFUL</span> <span class="o">=</span> <span class="s2">&quot;session_state_demo_001&quot;</span>
<span class="n">USER_ID_STATEFUL</span> <span class="o">=</span> <span class="s2">&quot;user_state_demo&quot;</span>

<span class="c1"># Define initial state data - user prefers Celsius initially</span>
<span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;Celsius&quot;</span>
<span class="p">}</span>

<span class="c1"># Create the session, providing the initial state</span>
<span class="n">session_stateful</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="c1"># Use the consistent app name</span>
    <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
    <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">,</span>
    <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span> <span class="c1"># &lt;&lt;&lt; Initialize state during creation</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Session &#39;</span><span class="si">{</span><span class="n">SESSION_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39; created for user &#39;</span><span class="si">{</span><span class="n">USER_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

<span class="c1"># Verify the initial state was set correctly</span>
<span class="n">retrieved_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
                                                         <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
                                                         <span class="n">session_id</span> <span class="o">=</span> <span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Initial Session State ---&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">retrieved_session</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">retrieved_session</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Could not retrieve session.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Create State-Aware Weather Tool (get_weather_stateful)</h3>

<p>Now, we create a new version of the weather tool. Its key feature is accepting <code>tool_context: ToolContext</code> which allows it to access <code>tool_context.state</code>. It will read the user_preference_temperature_unit and format the temperature accordingly.</p>
<ul>
<li>
<p><strong>Key Concept:</strong> ToolContext This object is the bridge allowing your tool logic to interact with the session's context, including reading and writing state variables. ADK injects it automatically if defined as the last parameter of your tool function.</p>
</li>
<li>
<p><strong>Best Practice:</strong> When reading from state, use dictionary.get('key', default_value) to handle cases where the key might not exist yet, ensuring your tool doesn't crash.</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.tools.tool_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolContext</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_weather_stateful</span><span class="p">(</span><span class="n">city</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieves weather, converts temp unit based on session state.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: get_weather_stateful called for </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

    <span class="c1"># --- Read preference from state ---</span>
    <span class="n">preferred_unit</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;Celsius&quot;</span><span class="p">)</span> <span class="c1"># Default to Celsius</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: Reading state &#39;user_preference_temperature_unit&#39;: </span><span class="si">{</span><span class="n">preferred_unit</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

    <span class="n">city_normalized</span> <span class="o">=</span> <span class="n">city</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Mock weather data (always stored in Celsius internally)</span>
    <span class="n">mock_weather_db</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;newyork&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;sunny&quot;</span><span class="p">},</span>
        <span class="s2">&quot;london&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;cloudy&quot;</span><span class="p">},</span>
        <span class="s2">&quot;tokyo&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;light rain&quot;</span><span class="p">},</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">city_normalized</span> <span class="ow">in</span> <span class="n">mock_weather_db</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">mock_weather_db</span><span class="p">[</span><span class="n">city_normalized</span><span class="p">]</span>
        <span class="n">temp_c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;temp_c&quot;</span><span class="p">]</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span>

        <span class="c1"># Format temperature based on state preference</span>
        <span class="k">if</span> <span class="n">preferred_unit</span> <span class="o">==</span> <span class="s2">&quot;Fahrenheit&quot;</span><span class="p">:</span>
            <span class="n">temp_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_c</span> <span class="o">*</span> <span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span> <span class="c1"># Calculate Fahrenheit</span>
            <span class="n">temp_unit</span> <span class="o">=</span> <span class="s2">&quot;°F&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Default to Celsius</span>
            <span class="n">temp_value</span> <span class="o">=</span> <span class="n">temp_c</span>
            <span class="n">temp_unit</span> <span class="o">=</span> <span class="s2">&quot;°C&quot;</span>

        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The weather in </span><span class="si">{</span><span class="n">city</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s2"> with a temperature of </span><span class="si">{</span><span class="n">temp_value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}{</span><span class="n">temp_unit</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="n">report</span><span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: Generated report in </span><span class="si">{</span><span class="n">preferred_unit</span><span class="si">}</span><span class="s2">. Result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

        <span class="c1"># Example of writing back to state (optional for this tool)</span>
        <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;last_city_checked_stateful&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">city</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: Updated state &#39;last_city_checked_stateful&#39;: </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Handle city not found</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Sorry, I don&#39;t have weather information for &#39;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Tool: City &#39;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">&#39; not found. ---&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ State-aware &#39;get_weather_stateful&#39; tool defined.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Redefine Sub-Agents and Update Root Agent</h3>

<p>To ensure this step is self-contained and builds correctly, we first redefine the greeting_agent and farewell_agent exactly as they were in Step 3. Then, we define our new root agent (weather_agent_v4_stateful):</p>
<ul>
<li>
<p>It uses the new get_weather_stateful tool.</p>
</li>
<li>
<p>It includes the greeting and farewell sub-agents for delegation.</p>
</li>
<li>
<p><strong>Crucially</strong>, it sets output_key="last_weather_report" which automatically saves its final weather response to the session state.</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="c1"># @title 3. Redefine Sub-Agents and Update Root Agent with output_key</span>

<span class="c1"># Ensure necessary imports: Agent, LiteLlm, Runner</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.lite_llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLlm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.runners</span><span class="w"> </span><span class="kn">import</span> <span class="n">Runner</span>
<span class="c1"># Ensure tools &#39;say_hello&#39;, &#39;say_goodbye&#39; are defined (from Step 3)</span>
<span class="c1"># Ensure model constants MODEL_GPT_4O, MODEL_GEMINI_2_0_FLASH etc. are defined</span>

<span class="c1"># --- Redefine Greeting Agent (from Step 3) ---</span>
<span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span>
        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Greeting Agent. Your ONLY task is to provide a friendly greeting using the &#39;say_hello&#39; tool. Do nothing else.&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple greetings and hellos using the &#39;say_hello&#39; tool.&quot;</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Greeting agent. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># --- Redefine Farewell Agent (from Step 3) ---</span>
<span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span>
        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the Farewell Agent. Your ONLY task is to provide a polite goodbye message using the &#39;say_goodbye&#39; tool. Do not perform any other actions.&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Handles simple farewells and goodbyes using the &#39;say_goodbye&#39; tool.&quot;</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Agent &#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; redefined.&quot;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Could not redefine Farewell agent. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># --- Define the Updated Root Agent ---</span>
<span class="n">root_agent_stateful</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">runner_root_stateful</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize runner</span>

<span class="c1"># Check prerequisites before creating the root agent</span>
<span class="k">if</span> <span class="n">greeting_agent</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>

    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span> <span class="c1"># Choose orchestration model</span>

    <span class="n">root_agent_stateful</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v4_stateful&quot;</span><span class="p">,</span> <span class="c1"># New version name</span>
        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Main agent: Provides weather (state-aware unit), delegates greetings/farewells, saves report to state.&quot;</span><span class="p">,</span>
        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;You are the main Weather Agent. Your job is to provide weather using &#39;get_weather_stateful&#39;. &quot;</span>
                    <span class="s2">&quot;The tool will format the temperature based on user preference stored in state. &quot;</span>
                    <span class="s2">&quot;Delegate simple greetings to &#39;greeting_agent&#39; and farewells to &#39;farewell_agent&#39;. &quot;</span>
                    <span class="s2">&quot;Handle only weather requests, greetings, and farewells.&quot;</span><span class="p">,</span>
        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather_stateful</span><span class="p">],</span> <span class="c1"># Use the state-aware tool</span>
        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">],</span> <span class="c1"># Include sub-agents</span>
        <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;last_weather_report&quot;</span> <span class="c1"># &lt;&lt;&lt; Auto-save agent&#39;s final weather response</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Root Agent &#39;</span><span class="si">{</span><span class="n">root_agent_stateful</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; created using stateful tool and output_key.&quot;</span><span class="p">)</span>

    <span class="c1"># --- Create Runner for this Root Agent &amp; NEW Session Service ---</span>
    <span class="n">runner_root_stateful</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
        <span class="n">agent</span><span class="o">=</span><span class="n">root_agent_stateful</span><span class="p">,</span>
        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_stateful</span> <span class="c1"># Use the NEW stateful session service</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Runner created for stateful root agent &#39;</span><span class="si">{</span><span class="n">runner_root_stateful</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; using stateful session service.&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ Cannot create stateful root agent. Prerequisites missing.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">greeting_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - greeting_agent definition missing.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">farewell_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - farewell_agent definition missing.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - get_weather_stateful tool missing.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Interact and Test State Flow</h3>

<p>Now, let's execute a conversation designed to test the state interactions using the runner_root_stateful (associated with our stateful agent and the session_service_stateful). We'll use the call_agent_async function defined earlier, ensuring we pass the correct runner, user ID (USER_ID_STATEFUL), and session ID (SESSION_ID_STATEFUL).</p>
<p>The conversation flow will be:</p>
<ol>
<li>
<p><strong>Check weather (London)</strong>
response (the weather report in Celsius) should get saved to state['last_weather_report'] via the output_key configuration.</p>
</li>
<li>
<p><strong>Manually update state:</strong>
We will directly modify the state stored within the <code>InMemorySessionService</code> instance (<code>session_service_stateful</code>).</p>
<p><strong>Why direct modification?</strong> The session_service.get_session() method returns a copy of the session. Modifying that copy wouldn't affect the state used in subsequent agent runs. For this testing scenario with InMemorySessionService, we access the internal sessions dictionary to change the actual stored state value for user_preference_temperature_unit to "Fahrenheit". Note: In real applications, state changes are typically triggered by tools or agent logic returning EventActions(state_delta=...), not direct manual updates.</p>
</li>
<li>
<p>Check weather again (New York): The get_weather_stateful tool should now read the updated "Fahrenheit" preference from the state and convert the temperature accordingly. The root agent's new response (weather in Fahrenheit) will overwrite the previous value in state['last_weather_report'] due to the output_key.</p>
</li>
<li>
<p>Greet the agent: Verify that delegation to the greeting_agent still works correctly alongside the stateful operations. This interaction will become the last response saved by output_key in this specific sequence.</p>
</li>
<li>
<p>Inspect final state: After the conversation, we retrieve the session one last time (getting a copy) and print its state to confirm the user_preference_temperature_unit is indeed "Fahrenheit", observe the final value saved by output_key (which will be the greeting in this run), and see the last_city_checked_stateful value written by the tool.</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># @title 4. Interact to Test State Flow and output_key</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># Ensure asyncio is imported</span>

<span class="c1"># Ensure the stateful runner (runner_root_stateful) is available from the previous cell</span>
<span class="c1"># Ensure call_agent_async, USER_ID_STATEFUL, SESSION_ID_STATEFUL, APP_NAME are defined</span>

<span class="k">if</span> <span class="s1">&#39;runner_root_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">runner_root_stateful</span><span class="p">:</span>
    <span class="c1"># Define the main async function for the stateful conversation logic.</span>
    <span class="c1"># The &#39;await&#39; keywords INSIDE this function are necessary for async operations.</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_stateful_conversation</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing State: Temp Unit Conversion &amp; output_key ---&quot;</span><span class="p">)</span>

        <span class="c1"># 1. Check weather (Uses initial state: Celsius)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Turn 1: Requesting weather in London (expect Celsius) ---&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;What&#39;s the weather in London?&quot;</span><span class="p">,</span>
                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
                              <span class="p">)</span>

        <span class="c1"># 2. Manually update state preference to Fahrenheit - DIRECTLY MODIFY STORAGE</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Manually Updating State: Setting unit to Fahrenheit ---&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Access the internal storage directly - THIS IS SPECIFIC TO InMemorySessionService for testing</span>
            <span class="c1"># NOTE: In production with persistent services (Database, VertexAI), you would</span>
            <span class="c1"># typically update state via agent actions or specific service APIs if available,</span>
            <span class="c1"># not by direct manipulation of internal storage.</span>
            <span class="n">stored_session</span> <span class="o">=</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">APP_NAME</span><span class="p">][</span><span class="n">USER_ID_STATEFUL</span><span class="p">][</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">]</span>
            <span class="n">stored_session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Fahrenheit&quot;</span>
            <span class="c1"># Optional: You might want to update the timestamp as well if any logic depends on it</span>
            <span class="c1"># import time</span>
            <span class="c1"># stored_session.last_update_time = time.time()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Stored session state updated. Current &#39;user_preference_temperature_unit&#39;: </span><span class="si">{</span><span class="n">stored_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span> <span class="c1"># Added .get for safety</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Error: Could not retrieve session &#39;</span><span class="si">{</span><span class="n">SESSION_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39; from internal storage for user &#39;</span><span class="si">{</span><span class="n">USER_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39; in app &#39;</span><span class="si">{</span><span class="n">APP_NAME</span><span class="si">}</span><span class="s2">&#39; to update state. Check IDs and if session was created. ---&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Error updating internal session state: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

        <span class="c1"># 3. Check weather again (Tool should now use Fahrenheit)</span>
        <span class="c1"># This will also update &#39;last_weather_report&#39; via output_key</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 2: Requesting weather in New York (expect Fahrenheit) ---&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;Tell me the weather in New York.&quot;</span><span class="p">,</span>
                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
                              <span class="p">)</span>

        <span class="c1"># 4. Test basic delegation (should still work)</span>
        <span class="c1"># This will update &#39;last_weather_report&#39; again, overwriting the NY weather report</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 3: Sending a greeting ---&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;Hi!&quot;</span><span class="p">,</span>
                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
                              <span class="p">)</span>

    <span class="c1"># --- Execute the `run_stateful_conversation` async function ---</span>
    <span class="c1"># Choose ONE of the methods below based on your environment.</span>

    <span class="c1"># METHOD 1: Direct await (Default for Notebooks/Async REPLs)</span>
    <span class="c1"># If your environment supports top-level await (like Colab/Jupyter notebooks),</span>
    <span class="c1"># it means an event loop is already running, so you can directly await the function.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting execution using &#39;await&#39; (default for notebooks)...&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">run_stateful_conversation</span><span class="p">()</span>

    <span class="c1"># METHOD 2: asyncio.run (For Standard Python Scripts [.py])</span>
    <span class="c1"># If running this code as a standard Python script from your terminal,</span>
    <span class="c1"># the script context is synchronous. `asyncio.run()` is needed to</span>
    <span class="c1"># create and manage an event loop to execute your async function.</span>
    <span class="c1"># To use this method:</span>
    <span class="c1"># 1. Comment out the `await run_stateful_conversation()` line above.</span>
    <span class="c1"># 2. Uncomment the following block:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    import asyncio</span>
<span class="sd">    if __name__ == &quot;__main__&quot;: # Ensures this runs only when script is executed directly</span>
<span class="sd">        print(&quot;Executing using &#39;asyncio.run()&#39; (for standard Python scripts)...&quot;)</span>
<span class="sd">        try:</span>
<span class="sd">            # This creates an event loop, runs your async function, and closes the loop.</span>
<span class="sd">            asyncio.run(run_stateful_conversation())</span>
<span class="sd">        except Exception as e:</span>
<span class="sd">            print(f&quot;An error occurred: {e}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --- Inspect final session state after the conversation ---</span>
    <span class="c1"># This block runs after either execution method completes.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Inspecting Final Session State ---&quot;</span><span class="p">)</span>
    <span class="n">final_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
                                                         <span class="n">user_id</span><span class="o">=</span> <span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
                                                         <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">final_session</span><span class="p">:</span>
        <span class="c1"># Use .get() for safer access to potentially missing keys</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Preference: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Last Weather Report (from output_key): </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_weather_report&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Last City Checked (by tool): </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_city_checked_stateful&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Print full state for detailed view</span>
        <span class="c1"># print(f&quot;Full State Dict: {final_session.state}&quot;) # For detailed view</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ Error: Could not retrieve final session state.&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Skipping state test conversation. Stateful root agent runner (&#39;runner_root_stateful&#39;) is not available.&quot;</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>
<p><strong>State Read:</strong> The weather tool (<code>get_weather_stateful</code>) correctly read <code>user_preference_temperature_unit</code> from state, initially using "Celsius" for London.</p>
</li>
<li>
<p><strong>State Update:</strong> The direct modification successfully changed the stored preference to "Fahrenheit".</p>
</li>
<li>
<p><strong>State Read (Updated):</strong> The tool subsequently read "Fahrenheit" when asked for New York's weather and performed the conversion.</p>
</li>
<li>
<p><strong>Tool State Write:</strong> The tool successfully wrote the last_city_checked_stateful ("New York" after the second weather check) into the state via tool_context.state.</p>
</li>
<li>
<p><strong>Delegation:</strong> The delegation to the greeting_agent for "Hi!" functioned correctly even after state modifications.</p>
</li>
<li>
<p><strong>output_key:</strong> The <code>output_key="last_weather_report"</code> successfully saved the root agent's final response for each turn where the root agent was the one ultimately responding. In this sequence, the last response was the greeting ("Hello, there!"), so that overwrote the weather report in the state key.</p>
</li>
<li>
<p><strong>Final State:</strong> The final check confirms the preference persisted as "Fahrenheit".</p>
</li>
</ul>
<p>You've now successfully integrated session state to personalize agent behavior using ToolContext, manually manipulated state for testing InMemorySessionService, and observed how output_key provides a simple mechanism for saving the agent's last response to state. This foundational understanding of state management is key as we proceed to implement safety guardrails using callbacks in the next steps.</p>
<h3 style="color:blue;">📌 Adding Safety - Input Guardrail with before_model_callback</h3>

<p>Our agent team is becoming more capable, remembering preferences and using tools effectively. However, in real-world scenarios, we often need safety mechanisms to control the agent's behavior before potentially problematic requests even reach the core Large Language Model (LLM).</p>
<p>ADK provides <strong>Callbacks</strong> – functions that allow you to hook into specific points in the agent's execution lifecycle. The before_model_callback is particularly useful for input safety.</p>
<h3 style="color:blue;">📌 What is before_model_callback?</h3>

<ul>
<li>
<p>It's a Python function you define that ADK executes just before an agent sends its compiled request (including conversation history, instructions, and the latest user message) to the underlying LLM.</p>
</li>
<li>
<p><strong>Purpose:</strong> Inspect the request, modify it if necessary, or block it entirely based on predefined rules.</p>
</li>
</ul>
<h3 style="color:blue;">📌 Common Use Cases:</h3>

<ul>
<li>
<p><strong>Input Validation/Filtering:</strong> Check if user input meets criteria or contains disallowed content (like PII or keywords).</p>
</li>
<li>
<p><strong>Guardrails:</strong> Prevent harmful, off-topic, or policy-violating requests from being processed by the LLM.</p>
</li>
<li>
<p><strong>Dynamic Prompt Modification:</strong> Add timely information (e.g., from session state) to the LLM request context just before sending.</p>
</li>
</ul>
<h3 style="color:blue;">📌 How it Works:</h3>

<ol>
<li>
<p>Define a function accepting <code>callback_context: CallbackContext</code> and <code>llm_request: LlmRequest</code>.</p>
<ul>
<li>
<p><code>callback_context:</code> Provides access to agent info, session state <code>(callback_context.state)</code>, etc.</p>
</li>
<li>
<p><code>llm_request:</code> Contains the full payload intended for the LLM <code>(contents, config)</code>.</p>
</li>
</ul>
</li>
<li>
<p>Inside the function:</p>
<ul>
<li>
<p><strong>Inspect:</strong> Examine llm_request.contents (especially the last user message).</p>
</li>
<li>
<p><strong>Modify (Use Caution):</strong> You can change parts of llm_request.</p>
</li>
<li>
<p><strong>Block (Guardrail):</strong> Return an <code>LlmResponse</code> object. ADK will send this response back immediately, skipping the LLM call for that turn.</p>
</li>
<li>
<p><strong>Allow:</strong> Return <code>None</code>. ADK proceeds to call the LLM with the (potentially modified) request.</p>
</li>
</ul>
</li>
</ol>
<p>In this step, we will:</p>
<ol>
<li>
<p>Define a <code>before_model_callback</code> function (<code>block_keyword_guardrail</code>) that checks the user's input for a specific keyword ("BLOCK").</p>
</li>
<li>
<p>Update our stateful root agent (<code>weather_agent_v4_stateful</code> from Step 4) to use this callback.</p>
</li>
<li>
<p>Create a new runner associated with this updated agent but using the same stateful session service to maintain state continuity.</p>
</li>
<li>
<p>Test the guardrail by sending both normal and keyword-containing requests.</p>
</li>
</ol>
<h3 style="color:blue;">📌 Define the Guardrail Callback Function:</h3>

<p>This function will inspect the last user message within the <code>llm_request</code> content. If it finds "BLOCK" (case-insensitive), it constructs and returns an <code>LlmResponse</code> to block the flow; otherwise, it returns None.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># @title 1. Define the before_model_callback Guardrail</span>

<span class="c1"># Ensure necessary imports are available</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents.callback_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">CallbackContext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.llm_request</span><span class="w"> </span><span class="kn">import</span> <span class="n">LlmRequest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.llm_response</span><span class="w"> </span><span class="kn">import</span> <span class="n">LlmResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span> <span class="c1"># For creating response content</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="k">def</span><span class="w"> </span><span class="nf">block_keyword_guardrail</span><span class="p">(</span>
    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span> <span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inspects the latest user message for &#39;BLOCK&#39;. If found, blocks the LLM call</span>
<span class="sd">    and returns a predefined LlmResponse. Otherwise, returns None to proceed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">agent_name</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">agent_name</span> <span class="c1"># Get the name of the agent whose model call is being intercepted</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: block_keyword_guardrail running for agent: </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

    <span class="c1"># Extract the text from the latest user message in the request history</span>
    <span class="n">last_user_message_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
        <span class="c1"># Find the most recent message with role &#39;user&#39;</span>
        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span> <span class="ow">and</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
                <span class="c1"># Assuming text is in the first part for simplicity</span>
                <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                    <span class="n">last_user_message_text</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span>
                    <span class="k">break</span> <span class="c1"># Found the last user message text</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Inspecting last user message: &#39;</span><span class="si">{</span><span class="n">last_user_message_text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; ---&quot;</span><span class="p">)</span> <span class="c1"># Log first 100 chars</span>

    <span class="c1"># --- Guardrail Logic ---</span>
    <span class="n">keyword_to_block</span> <span class="o">=</span> <span class="s2">&quot;BLOCK&quot;</span>
    <span class="k">if</span> <span class="n">keyword_to_block</span> <span class="ow">in</span> <span class="n">last_user_message_text</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span> <span class="c1"># Case-insensitive check</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Found &#39;</span><span class="si">{</span><span class="n">keyword_to_block</span><span class="si">}</span><span class="s2">&#39;. Blocking LLM call! ---&quot;</span><span class="p">)</span>
        <span class="c1"># Optionally, set a flag in state to record the block event</span>
        <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;guardrail_block_keyword_triggered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Set state &#39;guardrail_block_keyword_triggered&#39;: True ---&quot;</span><span class="p">)</span>

        <span class="c1"># Construct and return an LlmResponse to stop the flow and send this back instead</span>
        <span class="k">return</span> <span class="n">LlmResponse</span><span class="p">(</span>
            <span class="n">content</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span>
                <span class="n">role</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="c1"># Mimic a response from the agent&#39;s perspective</span>
                <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;I cannot process this request because it contains the blocked keyword &#39;</span><span class="si">{</span><span class="n">keyword_to_block</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)],</span>
            <span class="p">)</span>
            <span class="c1"># Note: You could also set an error_message field here if needed</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Keyword not found, allow the request to proceed to the LLM</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Keyword not found. Allowing LLM call for </span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">. ---&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Returning None signals ADK to continue normally</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ block_keyword_guardrail function defined.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Update Root Agent to Use the Callback:</h3>

<p>We redefine the root agent, adding the <code>before_model_callback</code> parameter and pointing it to our new guardrail function. We'll give it a new version name for clarity.</p>
<p><strong>Important:</strong> We need to redefine the sub-agents (<code>greeting_agent, farewell_agent</code>) and the stateful tool (<code>get_weather_stateful</code>) within this context if they are not already available from previous steps, ensuring the root agent definition has access to all its components.</p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nv">@title</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="k">Update</span><span class="w"> </span><span class="n">Root</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">before_model_callback</span>


<span class="err">#</span><span class="w"> </span><span class="c1">--- Redefine Sub-Agents (Ensures they exist in this context) ---</span>
<span class="n">greeting_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>
<span class="k">try</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">constant</span>
<span class="w">    </span><span class="n">greeting_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Agent</span><span class="p">(</span>
<span class="w">        </span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
<span class="w">        </span><span class="n">name</span><span class="o">=</span><span class="ss">&quot;greeting_agent&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Keep</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">consistency</span>
<span class="w">        </span><span class="n">instruction</span><span class="o">=</span><span class="ss">&quot;You are the Greeting Agent. Your ONLY task is to provide a friendly greeting using the &#39;say_hello&#39; tool. Do nothing else.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span><span class="o">=</span><span class="ss">&quot;Handles simple greetings and hellos using the &#39;say_hello&#39; tool.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">tools</span><span class="o">=[</span><span class="n">say_hello</span><span class="o">]</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;✅ Sub-Agent &#39;{greeting_agent.name}&#39; redefined.&quot;</span><span class="p">)</span>
<span class="ow">except</span><span class="w"> </span><span class="k">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">e</span><span class="p">:</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;❌ Could not redefine Greeting agent. Check Model/API Key ({greeting_agent.model}). Error: {e}&quot;</span><span class="p">)</span>

<span class="n">farewell_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>
<span class="k">try</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">constant</span>
<span class="w">    </span><span class="n">farewell_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Agent</span><span class="p">(</span>
<span class="w">        </span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
<span class="w">        </span><span class="n">name</span><span class="o">=</span><span class="ss">&quot;farewell_agent&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Keep</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">name</span>
<span class="w">        </span><span class="n">instruction</span><span class="o">=</span><span class="ss">&quot;You are the Farewell Agent. Your ONLY task is to provide a polite goodbye message using the &#39;say_goodbye&#39; tool. Do not perform any other actions.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span><span class="o">=</span><span class="ss">&quot;Handles simple farewells and goodbyes using the &#39;say_goodbye&#39; tool.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">tools</span><span class="o">=[</span><span class="n">say_goodbye</span><span class="o">]</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;✅ Sub-Agent &#39;{farewell_agent.name}&#39; redefined.&quot;</span><span class="p">)</span>
<span class="ow">except</span><span class="w"> </span><span class="k">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">e</span><span class="p">:</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;❌ Could not redefine Farewell agent. Check Model/API Key ({farewell_agent.model}). Error: {e}&quot;</span><span class="p">)</span>


<span class="err">#</span><span class="w"> </span><span class="c1">--- Define the Root Agent with the Callback ---</span>
<span class="n">root_agent_model_guardrail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>
<span class="n">runner_root_model_guardrail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>

<span class="err">#</span><span class="w"> </span><span class="k">Check</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="n">components</span><span class="w"> </span><span class="k">before</span><span class="w"> </span><span class="n">proceeding</span>
<span class="k">if</span><span class="w"> </span><span class="n">greeting_agent</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">farewell_agent</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="s1">&#39;get_weather_stateful&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="s1">&#39;block_keyword_guardrail&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="err">:</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">constant</span>
<span class="w">    </span><span class="n">root_agent_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MODEL_GEMINI_2_0_FLASH</span>

<span class="w">    </span><span class="n">root_agent_model_guardrail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Agent</span><span class="p">(</span>
<span class="w">        </span><span class="n">name</span><span class="o">=</span><span class="ss">&quot;weather_agent_v5_model_guardrail&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">New</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">clarity</span>
<span class="w">        </span><span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span><span class="o">=</span><span class="ss">&quot;Main agent: Handles weather, delegates greetings/farewells, includes input keyword guardrail.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">instruction</span><span class="o">=</span><span class="ss">&quot;You are the main Weather Agent. Provide weather using &#39;get_weather_stateful&#39;. &quot;</span>
<span class="w">                    </span><span class="ss">&quot;Delegate simple greetings to &#39;greeting_agent&#39; and farewells to &#39;farewell_agent&#39;. &quot;</span>
<span class="w">                    </span><span class="ss">&quot;Handle only weather requests, greetings, and farewells.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">tools</span><span class="o">=[</span><span class="n">get_weather_stateful</span><span class="o">]</span><span class="p">,</span>
<span class="w">        </span><span class="n">sub_agents</span><span class="o">=[</span><span class="n">greeting_agent, farewell_agent</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Reference</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">redefined</span><span class="w"> </span><span class="n">sub</span><span class="o">-</span><span class="n">agents</span>
<span class="w">        </span><span class="n">output_key</span><span class="o">=</span><span class="ss">&quot;last_weather_report&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Keep</span><span class="w"> </span><span class="n">output_key</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">4</span>
<span class="w">        </span><span class="n">before_model_callback</span><span class="o">=</span><span class="n">block_keyword_guardrail</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="n">Assign</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">guardrail</span><span class="w"> </span><span class="n">callback</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;✅ Root Agent &#39;{root_agent_model_guardrail.name}&#39; created with before_model_callback.&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="c1">--- Create Runner for this Agent, Using SAME Stateful Session Service ---</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Ensure</span><span class="w"> </span><span class="n">session_service_stateful</span><span class="w"> </span><span class="ow">exists</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;session_service_stateful&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="err">:</span>
<span class="w">        </span><span class="n">runner_root_model_guardrail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runner</span><span class="p">(</span>
<span class="w">            </span><span class="n">agent</span><span class="o">=</span><span class="n">root_agent_model_guardrail</span><span class="p">,</span>
<span class="w">            </span><span class="nf">app_name</span><span class="o">=</span><span class="nf">APP_NAME</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">consistent</span><span class="w"> </span><span class="nf">APP_NAME</span>
<span class="w">            </span><span class="n">session_service</span><span class="o">=</span><span class="n">session_service_stateful</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">4</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;✅ Runner created for guardrail agent &#39;{runner_root_model_guardrail.agent.name}&#39;, using stateful session service.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span><span class="err">:</span>
<span class="w">        </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;❌ Cannot create runner. &#39;session_service_stateful&#39; from Step 4 is missing.&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="err">:</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;❌ Cannot create root agent with model guardrail. One or more prerequisites are missing or failed initialization:&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nl">greeting_agent</span><span class="p">:</span><span class="w"> </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;   - Greeting Agent&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nl">farewell_agent</span><span class="p">:</span><span class="w"> </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;   - Farewell Agent&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;get_weather_stateful&#39;</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="err">:</span><span class="w"> </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;   - &#39;get_weather_stateful&#39; tool&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;block_keyword_guardrail&#39;</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="err">:</span><span class="w"> </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;   - &#39;block_keyword_guardrail&#39; callback&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Interact to Test the Guardrail:</h3>

<p>Let's test the guardrail's behavior. We'll use the same session (SESSION_ID_STATEFUL).</p>
<ol>
<li>
<p>Send a normal weather request (should pass the guardrail and execute).</p>
</li>
<li>
<p>Send a request containing "BLOCK" (should be intercepted by the callback).</p>
</li>
<li>
<p>Send a greeting (should pass the root agent's guardrail, be delegated, and execute normally).</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># @title 3. Interact to Test the Model Input Guardrail</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># Ensure asyncio is imported</span>

<span class="c1"># Ensure the runner for the guardrail agent is available</span>
<span class="k">if</span> <span class="s1">&#39;runner_root_model_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">runner_root_model_guardrail</span><span class="p">:</span>
    <span class="c1"># Define the main async function for the guardrail test conversation.</span>
    <span class="c1"># The &#39;await&#39; keywords INSIDE this function are necessary for async operations.</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_guardrail_test_conversation</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing Model Input Guardrail ---&quot;</span><span class="p">)</span>

        <span class="c1"># Use the runner for the agent with the callback and the existing stateful session ID</span>
        <span class="c1"># Define a helper lambda for cleaner interaction calls</span>
        <span class="n">interaction_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
                                                         <span class="n">runner_root_model_guardrail</span><span class="p">,</span>
                                                         <span class="n">USER_ID_STATEFUL</span><span class="p">,</span> <span class="c1"># Use existing user ID</span>
                                                         <span class="n">SESSION_ID_STATEFUL</span> <span class="c1"># Use existing session ID</span>
                                                        <span class="p">)</span>
        <span class="c1"># 1. Normal request (Callback allows, should use Fahrenheit from previous state change)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Turn 1: Requesting weather in London (expect allowed, Fahrenheit) ---&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;What is the weather in London?&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Request containing the blocked keyword (Callback intercepts)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 2: Requesting with blocked keyword (expect blocked) ---&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;BLOCK the request for weather in Tokyo&quot;</span><span class="p">)</span> <span class="c1"># Callback should catch &quot;BLOCK&quot;</span>

        <span class="c1"># 3. Normal greeting (Callback allows root agent, delegation happens)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 3: Sending a greeting (expect allowed) ---&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;Hello again&quot;</span><span class="p">)</span>

    <span class="c1"># --- Execute the `run_guardrail_test_conversation` async function ---</span>
    <span class="c1"># Choose ONE of the methods below based on your environment.</span>

    <span class="c1"># METHOD 1: Direct await (Default for Notebooks/Async REPLs)</span>
    <span class="c1"># If your environment supports top-level await (like Colab/Jupyter notebooks),</span>
    <span class="c1"># it means an event loop is already running, so you can directly await the function.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting execution using &#39;await&#39; (default for notebooks)...&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">run_guardrail_test_conversation</span><span class="p">()</span>

    <span class="c1"># METHOD 2: asyncio.run (For Standard Python Scripts [.py])</span>
    <span class="c1"># If running this code as a standard Python script from your terminal,</span>
    <span class="c1"># the script context is synchronous. `asyncio.run()` is needed to</span>
    <span class="c1"># create and manage an event loop to execute your async function.</span>
    <span class="c1"># To use this method:</span>
    <span class="c1"># 1. Comment out the `await run_guardrail_test_conversation()` line above.</span>
    <span class="c1"># 2. Uncomment the following block:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    import asyncio</span>
<span class="sd">    if __name__ == &quot;__main__&quot;: # Ensures this runs only when script is executed directly</span>
<span class="sd">        print(&quot;Executing using &#39;asyncio.run()&#39; (for standard Python scripts)...&quot;)</span>
<span class="sd">        try:</span>
<span class="sd">            # This creates an event loop, runs your async function, and closes the loop.</span>
<span class="sd">            asyncio.run(run_guardrail_test_conversation())</span>
<span class="sd">        except Exception as e:</span>
<span class="sd">            print(f&quot;An error occurred: {e}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --- Inspect final session state after the conversation ---</span>
    <span class="c1"># This block runs after either execution method completes.</span>
    <span class="c1"># Optional: Check state for the trigger flag set by the callback</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Inspecting Final Session State (After Guardrail Test) ---&quot;</span><span class="p">)</span>
    <span class="c1"># Use the session service instance associated with this stateful session</span>
    <span class="n">final_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
                                                         <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
                                                         <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">final_session</span><span class="p">:</span>
        <span class="c1"># Use .get() for safer access</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Guardrail Triggered Flag: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;guardrail_block_keyword_triggered&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set (or False)&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Last Weather Report: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_weather_report&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should be London weather if successful</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temperature Unit: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should be Fahrenheit</span>
        <span class="c1"># print(f&quot;Full State Dict: {final_session.state}&quot;) # For detailed view</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ Error: Could not retrieve final session state.&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Skipping model guardrail test. Runner (&#39;runner_root_model_guardrail&#39;) is not available.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Observe the execution flow:</h3>

<ol>
<li>
<p><strong>London Weather:</strong> The callback runs for <code>weather_agent_v5_model_guardrail</code>, inspects the message, prints "Keyword not found. Allowing LLM call.", and returns <code>None</code>. The agent proceeds, calls the <code>get_weather_stateful</code> tool (which uses the "Fahrenheit" preference from Step 4's state change), and returns the weather. This response updates <code>last_weather_report via output_key</code>.</p>
</li>
<li>
<p><strong>BLOCK Request:</strong> The callback runs again for <code>weather_agent_v5_model_guardrail</code>, inspects the message, finds "BLOCK", prints "Blocking LLM call!", sets the state flag, and returns the predefined LlmResponse. The agent's underlying LLM is never called for this turn. The user sees the callback's blocking message.</p>
</li>
<li>
<p><strong>Hello Again:</strong> The callback runs for weather_agent_v5_model_guardrail, allows the request. The root agent then delegates to greeting_agent. Note: The before_model_callback defined on the root agent does NOT automatically apply to sub-agents. The greeting_agent proceeds normally, calls its say_hello tool, and returns the greeting.</p>
</li>
</ol>
<p>You have successfully implemented an input safety layer! The before_model_callback provides a powerful mechanism to enforce rules and control agent behavior before expensive or potentially risky LLM calls are made. Next, we'll apply a similar concept to add guardrails around tool usage itself.</p>
<h3 style="color:blue;">📌 Adding Safety - Tool Argument Guardrail (before_tool_callback):</h3>

<p>In Step 5, we added a guardrail to inspect and potentially block user input before it reached the LLM. Now, we'll add another layer of control after the LLM has decided to use a tool but before that tool actually executes. This is useful for validating the arguments the LLM wants to pass to the tool.</p>
<p>ADK provides the <code>before_tool_callback</code> for this precise purpose.</p>
<h3 style="color:blue;">📌 What is before_tool_callback?</h3>

<ul>
<li>
<p>It's a Python function executed just before a specific tool function runs, after the LLM has requested its use and decided on the arguments.</p>
</li>
<li>
<p><strong>Purpose:</strong> Validate tool arguments, prevent tool execution based on specific inputs, modify arguments dynamically, or enforce resource usage policies.</p>
</li>
</ul>
<h3 style="color:blue;">📌 Common Use Cases:</h3>

<ul>
<li>
<p><strong>Argument Validation:</strong> Check if arguments provided by the LLM are valid, within allowed ranges, or conform to expected formats.</p>
</li>
<li>
<p><strong>Resource Protection:</strong> Prevent tools from being called with inputs that might be costly, access restricted data, or cause unwanted side effects (e.g., blocking API calls for certain parameters).</p>
</li>
<li>
<p><strong>Dynamic Argument Modification:</strong> Adjust arguments based on session state or other contextual information before the tool runs.</p>
</li>
</ul>
<p><strong>How it Works:</strong></p>
<ol>
<li>
<p>Define a function accepting <code>tool: BaseTool</code>, <code>args: Dict[str, Any]</code>, and <code>tool_context: ToolContext</code>.</p>
<ul>
<li>
<p><strong>tool:</strong> The tool object about to be called (inspect <code>tool.name</code>).</p>
</li>
<li>
<p><strong>args:</strong> The dictionary of arguments the LLM generated for the tool.</p>
</li>
<li>
<p><strong>tool_context:</strong> Provides access to session state (tool_context.state), agent info, etc.</p>
</li>
</ul>
</li>
<li>
<p>Inside the function:</p>
<ul>
<li>
<p><strong>Inspect:</strong> Examine the <code>tool.name</code> and the args dictionary.</p>
</li>
<li>
<p><strong>Modify:</strong> Change values within the <code>args</code> dictionary directly. If you return <code>None</code>, the tool runs with these modified args.</p>
</li>
<li>
<p><strong>Block/Override (Guardrail):</strong> Return a <strong>dictionary</strong>. ADK treats this dictionary as the result of the tool call, completely skipping the execution of the original tool function. The dictionary should ideally match the expected return format of the tool it's blocking.</p>
</li>
<li>
<p><strong>Allow:</strong> Return <code>None</code>. ADK proceeds to execute the actual tool function with the (potentially modified) arguments.</p>
</li>
</ul>
</li>
</ol>
<p><strong>In this step, we will:</strong></p>
<ol>
<li>
<p>Define a <code>before_tool_callback</code> function (<code>block_paris_tool_guardrail</code>) that specifically checks if the <code>get_weather_stateful</code> tool is called with the city "Paris".</p>
</li>
<li>
<p>If "Paris" is detected, the callback will block the tool and return a custom error dictionary.</p>
</li>
<li>
<p>Update our root agent (<code>weather_agent_v6_tool_guardrail</code>) to include both the <code>before_model_callback</code> and this new <code>before_tool_callback</code>.</p>
</li>
<li>
<p>Create a new runner for this agent, using the same stateful session service.</p>
</li>
<li>
<p>Test the flow by requesting weather for allowed cities and the blocked city ("Paris").</p>
</li>
</ol>
<h3 style="color:blue;">📌 Define the Tool Guardrail Callback Function</h3>

<p>This function targets the <code>get_weather_stateful</code> tool. It checks the city argument. If it's "Paris", it returns an error dictionary that looks like the tool's own error response. Otherwise, it allows the tool to run by returning None.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># @title 1. Define the before_tool_callback Guardrail</span>

<span class="c1"># Ensure necessary imports are available</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.tools.base_tool</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseTool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.tools.tool_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolContext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span> <span class="c1"># For type hints</span>

<span class="k">def</span><span class="w"> </span><span class="nf">block_paris_tool_guardrail</span><span class="p">(</span>
    <span class="n">tool</span><span class="p">:</span> <span class="n">BaseTool</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if &#39;get_weather_stateful&#39; is called for &#39;Paris&#39;.</span>
<span class="sd">    If so, blocks the tool execution and returns a specific error dictionary.</span>
<span class="sd">    Otherwise, allows the tool call to proceed by returning None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tool_name</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span>
    <span class="n">agent_name</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">agent_name</span> <span class="c1"># Agent attempting the tool call</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: block_paris_tool_guardrail running for tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; in agent &#39;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&#39; ---&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Inspecting args: </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>

    <span class="c1"># --- Guardrail Logic ---</span>
    <span class="n">target_tool_name</span> <span class="o">=</span> <span class="s2">&quot;get_weather_stateful&quot;</span> <span class="c1"># Match the function name used by FunctionTool</span>
    <span class="n">blocked_city</span> <span class="o">=</span> <span class="s2">&quot;paris&quot;</span>

    <span class="c1"># Check if it&#39;s the correct tool and the city argument matches the blocked city</span>
    <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="n">target_tool_name</span><span class="p">:</span>
        <span class="n">city_argument</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;city&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># Safely get the &#39;city&#39; argument</span>
        <span class="k">if</span> <span class="n">city_argument</span> <span class="ow">and</span> <span class="n">city_argument</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">blocked_city</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Detected blocked city &#39;</span><span class="si">{</span><span class="n">city_argument</span><span class="si">}</span><span class="s2">&#39;. Blocking tool execution! ---&quot;</span><span class="p">)</span>
            <span class="c1"># Optionally update state</span>
            <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;guardrail_tool_block_triggered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Set state &#39;guardrail_tool_block_triggered&#39;: True ---&quot;</span><span class="p">)</span>

            <span class="c1"># Return a dictionary matching the tool&#39;s expected output format for errors</span>
            <span class="c1"># This dictionary becomes the tool&#39;s result, skipping the actual tool run.</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
                <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Policy restriction: Weather checks for &#39;</span><span class="si">{</span><span class="n">city_argument</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; are currently disabled by a tool guardrail.&quot;</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: City &#39;</span><span class="si">{</span><span class="n">city_argument</span><span class="si">}</span><span class="s2">&#39; is allowed for tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39;. ---&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; is not the target tool. Allowing. ---&quot;</span><span class="p">)</span>


    <span class="c1"># If the checks above didn&#39;t return a dictionary, allow the tool to execute</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Callback: Allowing tool &#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39; to proceed. ---&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Returning None allows the actual tool function to run</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ block_paris_tool_guardrail function defined.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Update Root Agent to Use Both Callbacks</h3>

<p>We redefine the root agent again (<code>weather_agent_v6_tool_guardrail</code>), this time adding the <code>before_tool_callback</code>parameter alongside the <code>before_model_callback</code></p>
<p>Self-Contained Execution Note: Ensure all prerequisites (sub-agents, tools, <code>before_model_callback</code>) are defined or available in the execution context before defining this agent.</p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nv">@title</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="k">Update</span><span class="w"> </span><span class="n">Root</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">BOTH</span><span class="w"> </span><span class="n">Callbacks</span><span class="w"> </span><span class="p">(</span><span class="n">Self</span><span class="o">-</span><span class="n">Contained</span><span class="p">)</span>

<span class="err">#</span><span class="w"> </span><span class="c1">--- Ensure Prerequisites are Defined ---</span>
<span class="err">#</span><span class="w"> </span><span class="p">(</span><span class="k">Include</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">ensure</span><span class="w"> </span><span class="n">execution</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">definitions</span><span class="w"> </span><span class="k">for</span><span class="err">:</span><span class="w"> </span><span class="n">Agent</span><span class="p">,</span><span class="w"> </span><span class="n">LiteLlm</span><span class="p">,</span><span class="w"> </span><span class="n">Runner</span><span class="p">,</span><span class="w"> </span><span class="n">ToolContext</span><span class="p">,</span>
<span class="err">#</span><span class="w">  </span><span class="n">MODEL</span><span class="w"> </span><span class="n">constants</span><span class="p">,</span><span class="w"> </span><span class="n">say_hello</span><span class="p">,</span><span class="w"> </span><span class="n">say_goodbye</span><span class="p">,</span><span class="w"> </span><span class="n">greeting_agent</span><span class="p">,</span><span class="w"> </span><span class="n">farewell_agent</span><span class="p">,</span>
<span class="err">#</span><span class="w">  </span><span class="n">get_weather_stateful</span><span class="p">,</span><span class="w"> </span><span class="n">block_keyword_guardrail</span><span class="p">,</span><span class="w"> </span><span class="n">block_paris_tool_guardrail</span><span class="p">)</span>

<span class="err">#</span><span class="w"> </span><span class="c1">--- Redefine Sub-Agents (Ensures they exist in this context) ---</span>
<span class="n">greeting_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>
<span class="k">try</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">constant</span>
<span class="w">    </span><span class="n">greeting_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Agent</span><span class="p">(</span>
<span class="w">        </span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
<span class="w">        </span><span class="n">name</span><span class="o">=</span><span class="ss">&quot;greeting_agent&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Keep</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">consistency</span>
<span class="w">        </span><span class="n">instruction</span><span class="o">=</span><span class="ss">&quot;You are the Greeting Agent. Your ONLY task is to provide a friendly greeting using the &#39;say_hello&#39; tool. Do nothing else.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span><span class="o">=</span><span class="ss">&quot;Handles simple greetings and hellos using the &#39;say_hello&#39; tool.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">tools</span><span class="o">=[</span><span class="n">say_hello</span><span class="o">]</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;✅ Sub-Agent &#39;{greeting_agent.name}&#39; redefined.&quot;</span><span class="p">)</span>
<span class="ow">except</span><span class="w"> </span><span class="k">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">e</span><span class="p">:</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;❌ Could not redefine Greeting agent. Check Model/API Key ({greeting_agent.model}). Error: {e}&quot;</span><span class="p">)</span>

<span class="n">farewell_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>
<span class="k">try</span><span class="err">:</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">constant</span>
<span class="w">    </span><span class="n">farewell_agent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Agent</span><span class="p">(</span>
<span class="w">        </span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
<span class="w">        </span><span class="n">name</span><span class="o">=</span><span class="ss">&quot;farewell_agent&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Keep</span><span class="w"> </span><span class="n">original</span><span class="w"> </span><span class="n">name</span>
<span class="w">        </span><span class="n">instruction</span><span class="o">=</span><span class="ss">&quot;You are the Farewell Agent. Your ONLY task is to provide a polite goodbye message using the &#39;say_goodbye&#39; tool. Do not perform any other actions.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span><span class="o">=</span><span class="ss">&quot;Handles simple farewells and goodbyes using the &#39;say_goodbye&#39; tool.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">tools</span><span class="o">=[</span><span class="n">say_goodbye</span><span class="o">]</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;✅ Sub-Agent &#39;{farewell_agent.name}&#39; redefined.&quot;</span><span class="p">)</span>
<span class="ow">except</span><span class="w"> </span><span class="k">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">e</span><span class="p">:</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;❌ Could not redefine Farewell agent. Check Model/API Key ({farewell_agent.model}). Error: {e}&quot;</span><span class="p">)</span>

<span class="err">#</span><span class="w"> </span><span class="c1">--- Define the Root Agent with Both Callbacks ---</span>
<span class="n">root_agent_tool_guardrail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>
<span class="n">runner_root_tool_guardrail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">None</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;greeting_agent&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">greeting_agent</span><span class="w"> </span><span class="ow">and</span>
<span class="w">    </span><span class="s1">&#39;farewell_agent&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">farewell_agent</span><span class="w"> </span><span class="ow">and</span>
<span class="w">    </span><span class="s1">&#39;get_weather_stateful&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span>
<span class="w">    </span><span class="s1">&#39;block_keyword_guardrail&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="w"> </span><span class="ow">and</span>
<span class="w">    </span><span class="s1">&#39;block_paris_tool_guardrail&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">())</span><span class="err">:</span>

<span class="w">    </span><span class="n">root_agent_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MODEL_GEMINI_2_0_FLASH</span>

<span class="w">    </span><span class="n">root_agent_tool_guardrail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Agent</span><span class="p">(</span>
<span class="w">        </span><span class="n">name</span><span class="o">=</span><span class="ss">&quot;weather_agent_v6_tool_guardrail&quot;</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="k">New</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="n">name</span>
<span class="w">        </span><span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span><span class="o">=</span><span class="ss">&quot;Main agent: Handles weather, delegates, includes input AND tool guardrails.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">instruction</span><span class="o">=</span><span class="ss">&quot;You are the main Weather Agent. Provide weather using &#39;get_weather_stateful&#39;. &quot;</span>
<span class="w">                    </span><span class="ss">&quot;Delegate greetings to &#39;greeting_agent&#39; and farewells to &#39;farewell_agent&#39;. &quot;</span>
<span class="w">                    </span><span class="ss">&quot;Handle only weather, greetings, and farewells.&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">tools</span><span class="o">=[</span><span class="n">get_weather_stateful</span><span class="o">]</span><span class="p">,</span>
<span class="w">        </span><span class="n">sub_agents</span><span class="o">=[</span><span class="n">greeting_agent, farewell_agent</span><span class="o">]</span><span class="p">,</span>
<span class="w">        </span><span class="n">output_key</span><span class="o">=</span><span class="ss">&quot;last_weather_report&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="n">before_model_callback</span><span class="o">=</span><span class="n">block_keyword_guardrail</span><span class="p">,</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">Keep</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">guardrail</span>
<span class="w">        </span><span class="n">before_tool_callback</span><span class="o">=</span><span class="n">block_paris_tool_guardrail</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="k">Add</span><span class="w"> </span><span class="n">tool</span><span class="w"> </span><span class="n">guardrail</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;✅ Root Agent &#39;{root_agent_tool_guardrail.name}&#39; created with BOTH callbacks.&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="c1">--- Create Runner, Using SAME Stateful Session Service ---</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="s1">&#39;session_service_stateful&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">globals</span><span class="p">()</span><span class="err">:</span>
<span class="w">        </span><span class="n">runner_root_tool_guardrail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runner</span><span class="p">(</span>
<span class="w">            </span><span class="n">agent</span><span class="o">=</span><span class="n">root_agent_tool_guardrail</span><span class="p">,</span>
<span class="w">            </span><span class="nf">app_name</span><span class="o">=</span><span class="nf">APP_NAME</span><span class="p">,</span>
<span class="w">            </span><span class="n">session_service</span><span class="o">=</span><span class="n">session_service_stateful</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="k">Use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">Step</span><span class="w"> </span><span class="mi">4</span><span class="o">/</span><span class="mi">5</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="ss">&quot;✅ Runner created for tool guardrail agent &#39;{runner_root_tool_guardrail.agent.name}&#39;, using stateful session service.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span><span class="err">:</span>
<span class="w">        </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;❌ Cannot create runner. &#39;session_service_stateful&#39; from Step 4/5 is missing.&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="err">:</span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;❌ Cannot create root agent with tool guardrail. Prerequisites missing.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Interact to Test the Tool Guardrail</h3>

<ol>
<li>
<p>Request weather for "New York": Passes both callbacks, tool executes (using Fahrenheit preference from state).</p>
</li>
<li>
<p>Request weather for "Paris": Passes <code>before_model_callback</code>. LLM decides to call <code>get_weather_stateful(city='Paris'). before_tool_callback</code> intercepts, blocks the tool, and returns the error dictionary. Agent relays this error.</p>
</li>
<li>
<p>Request weather for "London": Passes both callbacks, tool executes normally.</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># @title 3. Interact to Test the Tool Argument Guardrail</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># Ensure asyncio is imported</span>

<span class="c1"># Ensure the runner for the tool guardrail agent is available</span>
<span class="k">if</span> <span class="s1">&#39;runner_root_tool_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">runner_root_tool_guardrail</span><span class="p">:</span>
    <span class="c1"># Define the main async function for the tool guardrail test conversation.</span>
    <span class="c1"># The &#39;await&#39; keywords INSIDE this function are necessary for async operations.</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_tool_guardrail_test</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Testing Tool Argument Guardrail (&#39;Paris&#39; blocked) ---&quot;</span><span class="p">)</span>

        <span class="c1"># Use the runner for the agent with both callbacks and the existing stateful session</span>
        <span class="c1"># Define a helper lambda for cleaner interaction calls</span>
        <span class="n">interaction_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
                                                         <span class="n">runner_root_tool_guardrail</span><span class="p">,</span>
                                                         <span class="n">USER_ID_STATEFUL</span><span class="p">,</span> <span class="c1"># Use existing user ID</span>
                                                         <span class="n">SESSION_ID_STATEFUL</span> <span class="c1"># Use existing session ID</span>
                                                        <span class="p">)</span>
        <span class="c1"># 1. Allowed city (Should pass both callbacks, use Fahrenheit state)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Turn 1: Requesting weather in New York (expect allowed) ---&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;What&#39;s the weather in New York?&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Blocked city (Should pass model callback, but be blocked by tool callback)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 2: Requesting weather in Paris (expect blocked by tool guardrail) ---&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;How about Paris?&quot;</span><span class="p">)</span> <span class="c1"># Tool callback should intercept this</span>

        <span class="c1"># 3. Another allowed city (Should work normally again)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Turn 3: Requesting weather in London (expect allowed) ---&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;Tell me the weather in London.&quot;</span><span class="p">)</span>

    <span class="c1"># --- Execute the `run_tool_guardrail_test` async function ---</span>
    <span class="c1"># Choose ONE of the methods below based on your environment.</span>

    <span class="c1"># METHOD 1: Direct await (Default for Notebooks/Async REPLs)</span>
    <span class="c1"># If your environment supports top-level await (like Colab/Jupyter notebooks),</span>
    <span class="c1"># it means an event loop is already running, so you can directly await the function.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting execution using &#39;await&#39; (default for notebooks)...&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">run_tool_guardrail_test</span><span class="p">()</span>

    <span class="c1"># METHOD 2: asyncio.run (For Standard Python Scripts [.py])</span>
    <span class="c1"># If running this code as a standard Python script from your terminal,</span>
    <span class="c1"># the script context is synchronous. `asyncio.run()` is needed to</span>
    <span class="c1"># create and manage an event loop to execute your async function.</span>
    <span class="c1"># To use this method:</span>
    <span class="c1"># 1. Comment out the `await run_tool_guardrail_test()` line above.</span>
    <span class="c1"># 2. Uncomment the following block:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    import asyncio</span>
<span class="sd">    if __name__ == &quot;__main__&quot;: # Ensures this runs only when script is executed directly</span>
<span class="sd">        print(&quot;Executing using &#39;asyncio.run()&#39; (for standard Python scripts)...&quot;)</span>
<span class="sd">        try:</span>
<span class="sd">            # This creates an event loop, runs your async function, and closes the loop.</span>
<span class="sd">            asyncio.run(run_tool_guardrail_test())</span>
<span class="sd">        except Exception as e:</span>
<span class="sd">            print(f&quot;An error occurred: {e}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --- Inspect final session state after the conversation ---</span>
    <span class="c1"># This block runs after either execution method completes.</span>
    <span class="c1"># Optional: Check state for the tool block trigger flag</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Inspecting Final Session State (After Tool Guardrail Test) ---&quot;</span><span class="p">)</span>
    <span class="c1"># Use the session service instance associated with this stateful session</span>
    <span class="n">final_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
                                                         <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
                                                         <span class="n">session_id</span><span class="o">=</span> <span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">final_session</span><span class="p">:</span>
        <span class="c1"># Use .get() for safer access</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tool Guardrail Triggered Flag: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;guardrail_tool_block_triggered&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set (or False)&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Last Weather Report: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_weather_report&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should be London weather if successful</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temperature Unit: </span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Not Set&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Should be Fahrenheit</span>
        <span class="c1"># print(f&quot;Full State Dict: {final_session.state}&quot;) # For detailed view</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ Error: Could not retrieve final session state.&quot;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ Skipping tool guardrail test. Runner (&#39;runner_root_tool_guardrail&#39;) is not available.&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 style="color:blue;">📌 Key Takeaways:</h3>

<ul>
<li>
<p><strong>Agents &amp; Tools:</strong> The fundamental building blocks for defining capabilities and reasoning. Clear instructions and docstrings are paramount.</p>
</li>
<li>
<p><strong>Runners &amp; Session Services:</strong> The engine and memory management system that orchestrate agent execution and maintain conversational context.</p>
</li>
<li>
<p><strong>Delegation:</strong> Designing multi-agent teams allows for specialization, modularity, and better management of complex tasks. Agent description is key for auto-flow.</p>
</li>
<li>
<p><strong>Session State (ToolContext, output_key):</strong> Essential for creating context-aware, personalized, and multi-turn conversational agents.</p>
</li>
<li>
<p><strong>Callbacks (before_model, before_tool):</strong> Powerful hooks for implementing safety, validation, policy enforcement, and dynamic modifications before critical operations (LLM calls or tool execution).</p>
</li>
<li>
<p><strong>Flexibility (LiteLlm):</strong> ADK empowers you to choose the best LLM for the job, balancing performance, cost, and features.</p>
</li>
</ul>
<h3 style="color:blue;">📌 ADK and enhance your application:</h3>

<ol>
<li>
<p><strong>Real Weather API:</strong> Replace the mock_weather_db in your get_weather tool with a call to a real weather API (like OpenWeatherMap, WeatherAPI).</p>
</li>
<li>
<p><strong>More Complex State:</strong> Store more user preferences (e.g., preferred location, notification settings) or conversation summaries in the session state.</p>
</li>
<li>
<p><strong>Refine Delegation:</strong> Experiment with different root agent instructions or sub-agent descriptions to fine-tune the delegation logic. Could you add a "forecast" agent?</p>
</li>
<li>
<p><strong>Advanced Callbacks:</strong></p>
<ul>
<li>
<p>Use <code>after_model_callback</code> to potentially reformat or sanitize the LLM's response after it's generated.</p>
</li>
<li>
<p>Use <code>after_tool_callback</code> to process or log the results returned by a tool.</p>
</li>
<li>
<p>Implement <code>before_agent_callback</code> or <code>after_agent_callback</code> for agent-level entry/exit logic.</p>
</li>
</ul>
</li>
<li>
<p><strong>Error Handling:</strong> Improve how the agent handles tool errors or unexpected API responses. Maybe add retry logic within a tool.</p>
</li>
<li>
<p><strong>Persistent Session Storage:</strong> Explore alternatives to InMemorySessionService for storing session state persistently (e.g., using databases like Firestore or Cloud SQL – requires custom implementation or future ADK integrations).</p>
</li>
<li>
<p><strong>Streaming UI:</strong> Integrate your agent team with a web framework (like FastAPI, as shown in the ADK Streaming Quickstart) to create a real-time chat interface.</p>
</li>
</ol>
<table>
<thead>
<tr>
<th><strong>Service</strong></th>
<th><strong>Description</strong></th>
<th><strong>Service Type</strong></th>
<th><strong>SaaS / Shelf-Managed</strong></th>
<th><strong>Use Case Example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Vertex AI Studio</td>
<td>Rapid prototyping and testing of generative AI models</td>
<td>Platform</td>
<td>SaaS</td>
<td>Quickly experiment with LLMs for text generation</td>
</tr>
<tr>
<td>Vertex AI Agent Builder</td>
<td>No-code generative AI agents grounded in organizational data</td>
<td>Platform</td>
<td>SaaS</td>
<td>Build chatbots for internal IT helpdesk without coding</td>
</tr>
<tr>
<td>Generative AI Document Summarization</td>
<td>Summarizes documents using Vertex AI and stores in BigQuery</td>
<td>SaaS</td>
<td>SaaS</td>
<td>Automatically summarize lengthy legal or medical documents</td>
</tr>
<tr>
<td>Gemini for Google Cloud</td>
<td>AI-powered assistance for writing, coding, and data analysis</td>
<td>SaaS</td>
<td>SaaS</td>
<td>Use AI to assist developers with code generation and debugging</td>
</tr>
<tr>
<td>Veo 2</td>
<td>AI video model for generation and editing with cinematic features</td>
<td>SaaS</td>
<td>SaaS</td>
<td>Create promotional videos with AI-based editing</td>
</tr>
<tr>
<td>Imagen 3</td>
<td>Text-to-image model with advanced editing</td>
<td>SaaS</td>
<td>SaaS</td>
<td>Generate marketing images from text descriptions</td>
</tr>
<tr>
<td>Chirp 3</td>
<td>Synthetic speech model for realistic voice and transcription</td>
<td>SaaS</td>
<td>SaaS</td>
<td>Develop realistic voice assistants and transcription services</td>
</tr>
<tr>
<td>Lyria</td>
<td>Text-to-music generation model</td>
<td>SaaS</td>
<td>SaaS</td>
<td>Generate background music tracks for apps or games</td>
</tr>
<tr>
<td>Vertex AI Platform</td>
<td>Unified platform for building, deploying ML models</td>
<td>Platform</td>
<td>SaaS</td>
<td>Deploy production-grade ML models for customer churn prediction</td>
</tr>
<tr>
<td>Vertex AI Notebooks</td>
<td>Environments for model development (e.g., Colab, Workbench)</td>
<td>Platform</td>
<td>SaaS</td>
<td>Collaborative data science and model development</td>
</tr>
<tr>
<td>AutoML</td>
<td>Train custom ML models with minimal effort</td>
<td>Platform</td>
<td>SaaS</td>
<td>Build custom image classifiers without deep ML expertise</td>
</tr>
<tr>
<td>Natural Language API</td>
<td>Sentiment analysis and entity recognition from text</td>
<td>API</td>
<td>SaaS</td>
<td>Analyze customer reviews for sentiment trends</td>
</tr>
<tr>
<td>Speech-to-Text API</td>
<td>Converts speech into text</td>
<td>API</td>
<td>SaaS</td>
<td>Transcribe customer service calls in real-time</td>
</tr>
<tr>
<td>Text-to-Speech API</td>
<td>Generates natural-sounding speech</td>
<td>API</td>
<td>SaaS</td>
<td>Create audio narration for e-learning courses</td>
</tr>
<tr>
<td>Translation API</td>
<td>Translates text into multiple languages</td>
<td>API</td>
<td>SaaS</td>
<td>Provide multilingual support on websites and apps</td>
</tr>
<tr>
<td>Dialogflow API</td>
<td>Conversational interface for chatbots and voice apps</td>
<td>API</td>
<td>SaaS</td>
<td>Build customer support chatbots for websites</td>
</tr>
<tr>
<td>Vision API</td>
<td>Image labeling, face detection, OCR</td>
<td>API</td>
<td>SaaS</td>
<td>Automate product tagging in e-commerce</td>
</tr>
<tr>
<td>Video Intelligence API</td>
<td>Video content analysis and object tracking</td>
<td>API</td>
<td>SaaS</td>
<td>Detect and index objects and actions in surveillance videos</td>
</tr>
<tr>
<td>Vertex AI Vision</td>
<td>Build and deploy computer vision applications</td>
<td>Platform</td>
<td>SaaS</td>
<td>Develop quality control systems for manufacturing</td>
</tr>
<tr>
<td>Document AI API</td>
<td>Extracts data from structured/unstructured documents</td>
<td>API</td>
<td>SaaS</td>
<td>Extract invoice details automatically for accounts payable</td>
</tr>
<tr>
<td>Document Warehouse API</td>
<td>Stores and retrieves processed documents</td>
<td>API</td>
<td>SaaS</td>
<td>Centralize storage of processed contract documents</td>
</tr>
<tr>
<td>Dialogflow CX/ES</td>
<td>Build advanced conversational agents</td>
<td>Platform</td>
<td>SaaS</td>
<td>Create sophisticated virtual assistants with complex workflows</td>
</tr>
<tr>
<td>Agent Assist</td>
<td>Real-time agent support with AI suggestions</td>
<td>SaaS</td>
<td>SaaS</td>
<td>Provide call center agents with live help and suggestions</td>
</tr>
<tr>
<td>Contact Center AI</td>
<td>AI-powered virtual agents for customer service</td>
<td>SaaS</td>
<td>SaaS</td>
<td>Automate customer inquiries with virtual agents</td>
</tr>
<tr>
<td>Vertex AI Search</td>
<td>Semantic search and Q\&amp;A experiences</td>
<td>Platform</td>
<td>SaaS</td>
<td>Implement intelligent document search within enterprise systems</td>
</tr>
<tr>
<td>Recommendations AI</td>
<td>Product recommendations using ML</td>
<td>SaaS</td>
<td>SaaS</td>
<td>Personalized product suggestions for e-commerce</td>
</tr>
<tr>
<td>Retail Search</td>
<td>AI-driven retail site search with personalization</td>
<td>SaaS</td>
<td>SaaS</td>
<td>Enhance online retail search with personalized results</td>
</tr>
<tr>
<td>Translation Hub</td>
<td>Manage and translate large content volumes</td>
<td>SaaS</td>
<td>SaaS</td>
<td>Localize marketing content for global audiences</td>
</tr>
<tr>
<td>Agentspace</td>
<td>Automation using agents and Gemini models</td>
<td>Platform</td>
<td>SaaS</td>
<td>Automate workflows with AI agents interacting on your behalf</td>
</tr>
</tbody>
</table>
<p><img alt="alt text" src="./image/gcp-1.png" /></p>
<p><img alt="alt text" src="./image/gcp-2.png" /></p>
<p><img alt="alt text" src="./image/gcp-3.png" /></p>
<p><a href="https://youtu.be/OSB8QijrEIA">Agentspace</a></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../azure.html" class="btn btn-neutral float-left" title="AZURE"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="Agents.html" class="btn btn-neutral float-right" title="Agents">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../azure.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="Agents.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
