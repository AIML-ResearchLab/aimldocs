<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Ganesh kinkar Giri" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Langgraph - AIML documents</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Langgraph";
        var mkdocs_page_input_path = "AIML/AgenticAI/langgraph.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../index.html" class="icon icon-home"> AIML documents
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">AIML</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Programing</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Programing/python.html">PYTHON</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Statistic</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" >Descriptive Statistics</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Measures of Central Tendency</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Central-Tendency/Mean.html">Mean</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Central-Tendency/Median.html">Median</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Central-Tendency/Mode.html">Mode</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Measures of Position (Relative Standing)</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Position-Relative-Standing/Percentiles.html">Percentiles</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Position-Relative-Standing/Quartiles.html">Quartiles</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Position-Relative-Standing/Deciles.html">Deciles</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Position-Relative-Standing/Z-Score.html">Z-Score</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Shape of the Distribution</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Shape-of-the-Distribution/Skewness.html">Skewness</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Shape-of-the-Distribution/Kurtosis.html">Kurtosis</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Visualization Tools</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/Histogram.html">Histogram</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/BarChart.html">Bar Chart</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/PieChart.html">Pie Chart</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/BoxPlot.html">Box Plot</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/LinePlot.html">Line Plot</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Visualization-Tools/DotPlot.html">Dot Plot</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Measures of Dispersion (Variability)</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Dispersion/Range.html">Range</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Dispersion/Variance.html">Variance</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Dispersion/StandardDeviation.html">Standard Deviation</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Dispersion/InterquartileRange.html">Interquartile Range(IQR)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/DescriptiveStatistics/Measures-of-Dispersion/CofficientVariation.html">Cofficient of Variation</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Inferential Statistics</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" >Population and Sample</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Population-and-Sample/Population.html">Population</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Population-and-Sample/Sample.html">Sample</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Population-and-Sample/SamplingMethods.html">Sampling Methods</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Estimation</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Estimation/PointEstimation.html">Point Estimation</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Estimation/IntervalEstimation.html">Interval Estimation</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Estimation/MarginError.html">Margin of Error</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Regression and Correlation Analysis</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Regression-and-Correlation-Analysis/LinearRegression.html">Linear Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Regression-and-Correlation-Analysis/LogisticRegression.html">Logistic Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Regression-and-Correlation-Analysis/MultipleRegression.html">Multiple Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Regression-and-Correlation-Analysis/CorrelationCoefficients.html">Correlation Coefficients</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Hypothesis Testing</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/NullHypothesis.html">Null Hypothesis (H₀)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/AlternativeHypothesis.html">Alternative Hypothesis (H₁)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/TestStatistic.html">Test Statistic</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/pvalue.html">p-value</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/SignificanceLevel.html">Significance Level (α)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/TypeIError.html">Type I Error (α)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/TypeIIError.html">Type II Error (β)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Hypothesis-Testing/PoweroftheTest.html">Power of the Test</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Parametric Tests</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Parametric-Tests/t-test.html">t-test</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Parametric-Tests/z-test.html">z-test</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Parametric-Tests/ANOVA.html">ANOVA</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Parametric-Tests/F-test.html">F-test</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Non-Parametric Tests</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Non-Parametric-Tests/Mann-WhitneyU.html">Mann-Whitney U</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Non-Parametric-Tests/Kruskal-Wallis.html">Kruskal-Wallis</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Non-Parametric-Tests/Wilcoxon.html">Wilcoxon</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Non-Parametric-Tests/Chi-square.html">Chi-square</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Resampling Methods</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Resampling-Methods/Bootstrapping.html">Bootstrapping</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Resampling-Methods/Jackknife.html">Jackknife</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Analysis of Variance (ANOVA)</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/ANOVA/One-way-ANOVA.html">One-way ANOVA</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/ANOVA/Two-way-ANOVA.html">Two-way ANOVA</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/ANOVA/Post-hoc-Tests.html">Post-hoc Tests</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Probability Theory</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Probability-Theory/ProbabilityDistributions.html">Probability Distributions</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Probability-Theory/CentralLimitTheorem.html">Central Limit Theorem</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../Statistic/InferentialStatistics/Probability-Theory/BayesianInference.html">Bayesian Inference</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Time Series</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Trend.html">Trend</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Seasonality.html">Seasonality</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Cyclic.html">Cyclic</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Noise.html">Irregular/Noise</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Stationarity.html">Stationarity</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Non-stationary.html">Non-stationary</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Autocorrelation.html">Autocorrelation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Lag.html">Lag</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/MovingAverages.html">Moving Averages</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Holt-Winters.html">Holt-Winters Method</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Additive.html">Additive</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Multiplicative.html">Multiplicative</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/AR.html">AR (Auto Regression)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/ARIMA.html">ARIMA</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Arimax.html">Arimax</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Sarimax.html">Sarimax</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Smoothing.html">Smoothing</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/AutomatedForecasting.html">Automated Forecasting</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/AutomatedTimeSeries.html">Automated Time Series</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../Statistic/TimeSeries/Multivariate.html">Uni, Bi and Multivariate</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Statistic/metrics.html">Metrics Evaluation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Statistic/timeseries.html">Time Series Old</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Statistic/statistic-details.html">Statistic Details</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Data manipulation and analysis</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Data-manipulation-and-analysis/data-manipulation-analysis.html">PANDAS</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Data Processing</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Data-processing/sql.html">Basic SQL</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Data-processing/sql-datascience.html">Using SQL for Data Science</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Data-processing/unstructured-data.html">Unstructured Data</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Data-processing/exploratory-data-analysis.html">Exploratory Data Analysis(EDA)</a>
                </li>
                <li class="toctree-l2"><a class="" href="../../Data-processing/building-ml-models-on-text-data.md">Building ML Models on Text Data</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Databases</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Databases/PostgreSQL.html">PostgreSQL</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Databases/MySQL.html">MySQL</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Databases/MongoDB.html">MongoDB</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Machine Learning</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../MachineLearning/Overview.html">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Supervised Learning</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/Overview.html">Overview</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/Regression.html">Regression</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/Classification.html">Classification</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/CrossValidation.html">Cross Validation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/HyperparameterTuning.html">Hyperparameter Tuning</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/TuningDecisionThreshold.html">Tuning decision threshold</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Regression Models</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/SimpleLinearRegression.html">Simple Linear Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/MultipleLinearRegression.html">Multiple Linear Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/PolynomialRegression.html">Polynomial Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/RidgeLassoRegression.html">Ridge & Lasso Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/SupportVectorRegression.html">Support Vector Regression (SVR)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/DecisionTreeRegression.html">Decision Tree Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/RegressionModels/RandomForestRegression.html">Random Forest Regression</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Linear Classification Models</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/LinearClassificationModels/LogisticRegression.html">Logistic Regression</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/LinearClassificationModels/SupportVectorMachines.html">Support Vector Machines</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/LinearClassificationModels/SinglelayerPerceptron.html">Single-layer Perceptron</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/LinearClassificationModels/StochasticGradientDescent.html">Stochastic Gradient Descent (SGD)</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Non-linear Classification Models</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/DecisionTreeClassification.html">Decision Tree Classification</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/KNearestNeighbours.html">K-Nearest Neighbours</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/NaiveBayes.html">Naive Bayes</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/RandomForests.html">Random Forests</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/AdaBoost.html">AdaBoost</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/BaggingClassifier.html">Bagging Classifier</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/Ensemblelearningclassifiers.html">Ensemble learning classifiers</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../MachineLearning/SupervisedLearning/NonlinearClassificationModels/KernelSVM.html">Kernel SVM</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Unsupervised Learning</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/UnsupervisedLearning/overview.html">Overview</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/UnsupervisedLearning/Clustering.html">Clustering</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/UnsupervisedLearning/Pca.html">Principal Component Analysis(PCA)</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Reinforcement Learning</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../MachineLearning/ReinforcementLearning/ReinforcementLearning.html">Overview</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Linear Algebra</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../LinearAlgebra/Overview.html">Overview</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Deep Learning</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../DeepLearning/Overview.html">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../DeepLearning/Vanishing.html">Vanishing and Exploding Gradients Problems</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Components of Neural Networks</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/LayersNeuralNetworks.html">Layers in Neural Networks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/WeightsBiases.html">Weights and Biases</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/ForwardPropagation.html">Forward Propagation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/ActivationFunctions.html">Activation Functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/LossFunctions.html">Loss Functions</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/Backpropagation.html">Backpropagation</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Components/LearningRate.html">Learning Rate</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Optimization Algorithm</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/GradientDescent.html">Gradient Descent</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/SGD.html">Stochastic Gradient Descent (SGD)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/Adam.html">Adam (Adaptive Moment Estimation)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/BatchNormalization.html">Batch Normalization</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/Mini-batch-GD.html">Mini-batch Gradient Descent</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/Momentum-based-GO.html">Momentum-based Gradient Optimizer</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/AdagradOptimizer.html">Adagrad Optimizer</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/OptimizationAlgorithm/RMSPropOptimizer.html">RMSProp Optimizer</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Models</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/FNN.html">Feedforward Neural Network (FNN)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" >Recurrent Neural Network (RNN)</a>
    <ul>
                <li class="toctree-l4"><a class="reference internal" href="../../DeepLearning/Models/RNN.html">Recurrent Neural Network (RNN)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../DeepLearning/Models/LSTM.html">LSTM (Long Short-Term Memory)</a>
                </li>
                <li class="toctree-l4"><a class="reference internal" href="../../DeepLearning/Models/GRU.html">GRU (Gated Recurrent Unit)</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/CNN.html">Convolutional Neural Network (CNN)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/RBFN.html">Radial Basis Function Network (RBFN)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/ComputerVision.html">Computer Vision</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/GANs.html">Generative Adversarial Networks (GANs)</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/Transformer.html">Transformer Networks</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/Autoencoders.html">Autoencoders</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../DeepLearning/Models/SOM.html">Self-Organizing Maps (SOM)</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Natural Language Processing(NLP)</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../NLP/overview.html">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../NLP/nlpdetails.html">NLP Details</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Retrieval-Augmented Generation(RAG)</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../RAG/rag.html">RAG</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >AI agents</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../AIagents/aiagents.html">AI agents</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Agentic AI</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../AgenticAI/general.html">general</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../AgenticAI/overview.html">Overview</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../AgenticAI/crewai.html">crewai</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../AgenticAI/LangGraph.html">LangGraph</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../AgenticAI/AutoGen.html">AutoGen</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../AgenticAI/aws.html">AWS</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../AgenticAI/azure.html">AZURE</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" >Agent Development Kit</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../AgenticAI/GCP/adk.html">ADK</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../AgenticAI/GCP/Agents.html">Agents</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../AgenticAI/GCP/Tools.html">Tools</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../AgenticAI/GCP/a2a.html">Tools</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >MCPModel Context Protocol (MCP)</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../MCP/mcp.html">MCP</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Models Details information</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Models/Ollama.html">Ollama</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Note Book</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Notebook/allnotebook.html">All Notebook</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">AIML documents</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Langgraph</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p><img alt="langgraph" src="image/langgraph.png" /></p>
<h1 id="langgraph">LangGraph<a class="headerlink" href="#langgraph" title="Permanent link">#</a></h1>
<p>LangGraph is a low-level orchestration framework for building controllable agents.
While langchain provides integrations and composable components to streamline LLM application development, the LangGraph library enables agent orchestration — offering customizable architectures, long-term memory, and human-in-the-loop to reliably handle complex tasks.</p>
<h1 id="install-the-library">Install the Library<a class="headerlink" href="#install-the-library" title="Permanent link">#</a></h1>
<div class="codehilite"><pre><span></span><code>pip install -U langgraph
pip install -U langchain-anthropic
</code></pre></div>

<h1 id="simple-example-below-of-how-to-create-a-react-agent">Simple example below of how to create a ReAct agent.<a class="headerlink" href="#simple-example-below-of-how-to-create-a-react-agent" title="Permanent link">#</a></h1>
<div class="codehilite"><pre><span></span><code><span class="c1"># This code depends on pip install langchain[anthropic]</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.prebuilt</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_react_agent</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="c1"># Load environment variables</span>
<span class="n">load_dotenv</span><span class="p">()</span>

<span class="c1"># Retrieve API tokens from .env</span>
<span class="n">ANTHROPIC_API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Call to surf the web.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;sf&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;san francisco&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="s2">&quot;It&#39;s 60 degrees and foggy.&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;It&#39;s 90 degrees and sunny.&quot;</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">create_react_agent</span><span class="p">(</span><span class="s2">&quot;anthropic:claude-3-7-sonnet-latest&quot;</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">search</span><span class="p">])</span>
<span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;what is the weather in sf&quot;</span><span class="p">}]}</span>
<span class="p">)</span>
</code></pre></div>

<h1 id="why-use-langgraph">Why use LangGraph?<a class="headerlink" href="#why-use-langgraph" title="Permanent link">#</a></h1>
<p>LangGraph is useful for building <strong>robust, modular, and scalable AI agents</strong>.It extends LangChain with graph-based execution, making it ideal for <strong>multi-agent workflows, streaming, and fine-grained control</strong>.</p>
<p>Developers choose LangGraph for:</p>
<ol>
<li>
<p><strong>Reliability and controllability:</strong> </p>
<ul>
<li>Ensures <strong>structured execution</strong> of agent tasks.</li>
<li>Supports <strong>moderation checks</strong>, human approvals, and context persistence for long-running workflows.</li>
</ul>
</li>
<li>
<p><strong>Low-level and extensible:</strong> </p>
<ul>
<li>Provides <strong>full control</strong> over agent behavior using <strong>custom nodes and state management</strong>.</li>
<li>Ideal for <strong>multi-agent collaboration</strong>, where each agent has a defined role.</li>
</ul>
</li>
<li>
<p><strong>First-Class Streaming Support:</strong></p>
<ul>
<li>Supports <strong>token-by-token streaming</strong>, making it great for <strong>real-time insights</strong> into agent decisions.</li>
<li>Allows <strong>intermediate step streaming</strong>, improving <strong>observability and debugging</strong>.</li>
</ul>
</li>
</ol>
<h1 id="where-is-langgraph-useful">Where is LangGraph Useful?<a class="headerlink" href="#where-is-langgraph-useful" title="Permanent link">#</a></h1>
<ul>
<li><strong>Multi-Agent Systems:</strong> When you need <strong>multiple specialized agents</strong> working together.</li>
<li><strong>Long-Running Workflows:</strong> If your agents need <strong>context persistence</strong> over time.</li>
<li><strong>Interactive Applications:</strong> When <strong>streaming responses</strong> improve user experience.</li>
</ul>
<p>LangGraph can be useful for designing complex AI pipelines where different agents handle different tasks while <strong>maintaining control and visibility</strong>. </p>
<p>LangGraph is already <strong>trusted in production</strong> by major companies for AI-powered automation, making it a solid choice for building <strong>scalable, reliable, and controllable AI agents</strong>.</p>
<h1 id="real-world-use-cases-of-langgraph">Real-World Use Cases of LangGraph<a class="headerlink" href="#real-world-use-cases-of-langgraph" title="Permanent link">#</a></h1>
<ul>
<li><strong>Klarna → Customer Support Bot</strong><ul>
<li>Handles <strong>85 million</strong> active users.</li>
<li>Manages customer inquiries with <strong>multi-step workflows and automation</strong>.</li>
</ul>
</li>
<li><strong>Elastic → Security AI Assistant</strong><ul>
<li>Helps with <strong>threat detection and security analysis</strong>.</li>
<li>Uses <strong>multi-agent collaboration</strong> for investigating security alerts.</li>
</ul>
</li>
<li><strong>Uber → Automated Unit Test Generation</strong><ul>
<li>Generates and refines <strong>unit tests for developers</strong>.</li>
<li>Uses LangGraph for <strong>agent-based coding assistants</strong>.</li>
</ul>
</li>
<li><strong>Replit → AI-Powered Code Generation</strong><ul>
<li>Assists developers in <strong>writing, debugging, and optimizing code</strong>.</li>
<li>Uses LangGraph’s <strong>streaming and multi-agent capabilities</strong>.</li>
</ul>
</li>
</ul>
<h1 id="langgraphs-ecosystem-integrations">LangGraph’s Ecosystem &amp; Integrations<a class="headerlink" href="#langgraphs-ecosystem-integrations" title="Permanent link">#</a></h1>
<p>LangGraph works <strong>standalone</strong> but integrates seamlessly with <strong>LangChain tools</strong>, making it easier to build, evaluate, and deploy AI agents.</p>
<h1 id="key-integrations-for-better-llm-application-development">Key Integrations for Better LLM Application Development<a class="headerlink" href="#key-integrations-for-better-llm-application-development" title="Permanent link">#</a></h1>
<ul>
<li>
<p><strong>LangSmith (Agent Evaluation &amp; Debugging)</strong></p>
<ul>
<li>Debugs <strong>poor-performing LLM runs</strong> and optimizes workflows.</li>
<li>Evaluates <strong>agent trajectories</strong> to improve decision-making.</li>
<li>Provides <strong>observability</strong> in production.</li>
</ul>
</li>
<li>
<p><strong>LangGraph Platform (Scaling &amp; Deployment)</strong></p>
<ul>
<li>Deploys <strong>long-running, stateful AI agents</strong> at scale.</li>
<li>Allows <strong>agent discovery, reuse, and configuration</strong> across teams.</li>
<li>Features <strong>LangGraph Studio</strong> for <strong>visual prototyping</strong> and fast iteration.</li>
</ul>
</li>
</ul>
<h1 id="to-integrate-langgraph-langsmith-into-your-ai-projects">To integrate LangGraph + LangSmith into your AI projects<a class="headerlink" href="#to-integrate-langgraph-langsmith-into-your-ai-projects" title="Permanent link">#</a></h1>
<p><strong>Set Up LangGraph with LangSmith for Debugging &amp; Observability</strong>
- <strong>Install Dependencies</strong>
    - First, install LangGraph, LangSmith, and LangChain:</p>
<div class="codehilite"><pre><span></span><code>        pip install langgraph langsmith langchain
</code></pre></div>

<ul>
<li><strong>Set Up LangSmith API Key</strong>
    Sign up for LangSmith at smith.langchain.com and get your API key.</li>
</ul>
<div class="codehilite"><pre><span></span><code>        https://smith.langchain.com/
        LANGCHAIN_API_KEY=&quot;your_actual_api_key&quot;
</code></pre></div>

<p>Then, set it in your environment:</p>
<ul>
<li><strong>Enable Debugging for Agents</strong></li>
</ul>
<div class="codehilite"><pre><span></span><code>        <span class="c1"># This code depends on pip install langchain[anthropic]</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.prebuilt</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_react_agent</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">dotenv</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_dotenv</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">langsmith</span><span class="w"> </span><span class="kn">import</span> <span class="n">traceable</span>


        <span class="c1"># Load environment variables</span>
        <span class="n">load_dotenv</span><span class="p">()</span>

        <span class="n">LANGCHAIN_API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LANGCHAIN_API_KEY&quot;</span><span class="p">)</span>
        <span class="n">OPENAI_API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>


        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LANGCHAIN_TRACING_V2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;LANGCHAIN_PROJECT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>

        <span class="c1"># Define the function</span>
        <span class="nd">@traceable</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Call to surf the web.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;sf&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;san francisco&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="s2">&quot;It&#39;s 60 degrees and foggy.&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;It&#39;s 90 degrees and sunny.&quot;</span>

        <span class="c1"># Use OpenAI&#39;s GPT model</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4-turbo&quot;</span><span class="p">)</span>

        <span class="c1"># Create the agent</span>
        <span class="n">agent</span> <span class="o">=</span> <span class="n">create_react_agent</span><span class="p">(</span><span class="n">llm</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">search</span><span class="p">])</span>

        <span class="c1"># Invoke the agent</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;What is the weather in SF?&quot;</span><span class="p">}]})</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>Now, all agent runs will be logged in LangSmith for debugging.</li>
</ul>
<p><strong>Visualizing &amp; Debugging Agent Trajectories in LangSmith</strong></p>
<p>Once the agent is running, go to LangSmith UI and check:</p>
<ul>
<li>Logs of each agent action (inputs, outputs, reasoning).</li>
<li>Failure points in decision-making.</li>
<li>Performance metrics to optimize.</li>
</ul>
<p><img alt="langsmith" src="image/langsmith.png" /></p>
<p><img alt="langsmith" src="image/langsmith-1.png" /></p>
<p><strong>Scaling with LangGraph Platform (Long-Running Agents &amp; Deployment)</strong></p>
<ul>
<li>To make your AI <strong>stateful and scalable</strong>, use <strong>LangGraph Platform:</strong></li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">langgraph</span><span class="o">[</span><span class="n">platform</span><span class="o">]</span>
</code></pre></div>

<ul>
<li>Deploy <strong>long-running agents</strong> with <strong>stateful memory</strong>.</li>
<li>Use <strong>LangGraph Studio</strong> for <strong>drag-and-drop workflow design</strong>.</li>
<li>Share &amp; configure agents <strong>across teams</strong>.</li>
</ul>
<h1 id="graph-api-basics">Graph API Basics<a class="headerlink" href="#graph-api-basics" title="Permanent link">#</a></h1>
<h2 id="how-to-update-graph-state-from-nodes">How to update graph state from nodes<a class="headerlink" href="#how-to-update-graph-state-from-nodes" title="Permanent link">#</a></h2>
<p><strong>Define state</strong>
State in <strong>LangGraph</strong> can be a <strong>TypedDict</strong>, <strong>Pydantic</strong> model, or dataclass. </p>
<p><strong>State:</strong>
The first thing you do when you define a graph is define the State of the graph. The State consists of the schema of the graph as well as reducer functions which specify how to apply updates to the state.
The schema of the State will be the input schema to all Nodes and Edges in the graph, and can be either a TypedDict or a Pydantic model. All Nodes will emit updates to the State which are then applied using the specified reducer function.</p>
<p><strong>Schema:</strong>
The main documented way to specify the schema of a graph is by using TypedDict. However, we also support using a Pydantic BaseModel as your graph state to add default values and additional data validation.</p>
<h2 id="how-to-use-pydantic-model-as-graph-state">How to use Pydantic model as graph state<a class="headerlink" href="#how-to-use-pydantic-model-as-graph-state" title="Permanent link">#</a></h2>
<p><strong>First we need to install the packages required</strong></p>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="nf">%capture</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">langgraph</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_env</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>


<span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="input-validation">Input Validation<a class="headerlink" href="#input-validation" title="Permanent link">#</a></h2>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>


<span class="c1"># The overall state of the graph (this is the public state shared across nodes)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OverallState</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">def</span><span class="w"> </span><span class="nf">node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">OverallState</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;goodbye&quot;</span><span class="p">}</span>


<span class="c1"># Build the state graph</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">OverallState</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>  <span class="c1"># node_1 is the first node</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">)</span>  <span class="c1"># Start the graph with node_1</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>  <span class="c1"># End the graph after node_1</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

<span class="c1"># Test the graph with a valid input</span>
<span class="n">graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">})</span>
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>{&#39;a&#39;: &#39;goodbye&#39;}
</code></pre></div>

<p><strong>Invoke the graph with an invalid input</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">try</span><span class="o">:</span>
<span class="w">    </span><span class="n">graph</span><span class="p">.</span><span class="n">invoke</span><span class="p">(</span><span class="err">{</span><span class="s2">&quot;a&quot;</span><span class="o">:</span><span class="w"> </span><span class="mi">123</span><span class="err">}</span><span class="p">)</span><span class="w">  </span><span class="c1"># Should be a string</span>
<span class="k">except</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">e</span><span class="o">:</span>
<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;An exception was raised because `a` is an integer rather than a string.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">An</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">raised</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n n-Quoted">`a`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="kt">integer</span><span class="w"> </span><span class="n">rather</span><span class="w"> </span><span class="k">than</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">string</span><span class="p">.</span>
<span class="mi">1</span><span class="w"> </span><span class="k">validation</span><span class="w"> </span><span class="k">error</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">OverallState</span>
<span class="n">a</span>
<span class="w">  </span><span class="n">Input</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="k">string</span><span class="w"> </span><span class="err">[</span><span class="k">type</span><span class="o">=</span><span class="n">string_type</span><span class="p">,</span><span class="w"> </span><span class="n">input_value</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="n">input_type</span><span class="o">=</span><span class="kt">int</span><span class="err">]</span>
<span class="w">    </span><span class="k">For</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">visit</span><span class="w"> </span><span class="n">https</span><span class="o">://</span><span class="k">errors</span><span class="p">.</span><span class="n">pydantic</span><span class="p">.</span><span class="n">dev</span><span class="o">/</span><span class="mf">2.9</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">string_type</span>
</code></pre></div>

<h2 id="multiple-nodes">Multiple Nodes<a class="headerlink" href="#multiple-nodes" title="Permanent link">#</a></h2>
<p>Run-time validation will also work in a multi-node graph. In the example below bad_node updates a to an integer.</p>
<p>Because run-time validation occurs on inputs, the validation error will occur when ok_node is called (not when bad_node returns an update to the state which is inconsistent with the schema).</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>


<span class="c1"># The overall state of the graph (this is the public state shared across nodes)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OverallState</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bad_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">OverallState</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">123</span>  <span class="c1"># Invalid</span>
    <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ok_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">OverallState</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;goodbye&quot;</span><span class="p">}</span>


<span class="c1"># Build the state graph</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">OverallState</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">bad_node</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">ok_node</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;bad_node&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;bad_node&quot;</span><span class="p">,</span> <span class="s2">&quot;ok_node&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;ok_node&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

<span class="c1"># Test the graph with a valid input</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;hello&quot;</span><span class="p">})</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An exception was raised because bad_node sets `a` to an integer.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">An</span><span class="w"> </span><span class="n">exception</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">raised</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">bad_node</span><span class="w"> </span><span class="k">set</span><span class="n">s</span><span class="w"> </span><span class="n n-Quoted">`a`</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="kt">integer</span><span class="p">.</span>
<span class="mi">1</span><span class="w"> </span><span class="k">validation</span><span class="w"> </span><span class="k">error</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">OverallState</span>
<span class="n">a</span>
<span class="w">  </span><span class="n">Input</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="k">string</span><span class="w"> </span><span class="err">[</span><span class="k">type</span><span class="o">=</span><span class="n">string_type</span><span class="p">,</span><span class="w"> </span><span class="n">input_value</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="n">input_type</span><span class="o">=</span><span class="kt">int</span><span class="err">]</span>
<span class="w">    </span><span class="k">For</span><span class="w"> </span><span class="n">further</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">visit</span><span class="w"> </span><span class="n">https</span><span class="o">://</span><span class="k">errors</span><span class="p">.</span><span class="n">pydantic</span><span class="p">.</span><span class="n">dev</span><span class="o">/</span><span class="mf">2.9</span><span class="o">/</span><span class="n">v</span><span class="o">/</span><span class="n">string_type</span>
</code></pre></div>

<h2 id="advanced-pydantic-model-usage">Advanced Pydantic Model Usage<a class="headerlink" href="#advanced-pydantic-model-usage" title="Permanent link">#</a></h2>
<p>This section covers more advanced topics when using Pydantic models with LangGraph.</p>
<p><strong>Serialization Behavior</strong></p>
<p>When using Pydantic models as state schemas, it's important to understand how serialization works, especially when: - Passing Pydantic objects as inputs - Receiving outputs from the graph - Working with nested Pydantic models</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>


<span class="k">class</span><span class="w"> </span><span class="nc">NestedModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ComplexState</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">count</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">nested</span><span class="p">:</span> <span class="n">NestedModel</span>


<span class="k">def</span><span class="w"> </span><span class="nf">process_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ComplexState</span><span class="p">):</span>
    <span class="c1"># Node receives a validated Pydantic object</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input state type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nested type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">nested</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Return a dictionary update</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">text</span> <span class="o">+</span> <span class="s2">&quot; processed&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}</span>


<span class="c1"># Build the graph</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">ComplexState</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="n">process_node</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;process&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;process&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

<span class="c1"># Create a Pydantic instance for input</span>
<span class="n">input_state</span> <span class="o">=</span> <span class="n">ComplexState</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="n">NestedModel</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input object type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">input_state</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Invoke graph with a Pydantic instance</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">input_state</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output content: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Convert back to Pydantic model if needed</span>
<span class="n">output_model</span> <span class="o">=</span> <span class="n">ComplexState</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted back to Pydantic: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">output_model</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Runtime Type Coercion</strong>
Pydantic performs runtime type coercion for certain data types. This can be helpful but also lead to unexpected behavior if you're not aware of it.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CoercionExample</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="c1"># Pydantic will coerce string numbers to integers</span>
    <span class="n">number</span><span class="p">:</span> <span class="nb">int</span>
    <span class="c1"># Pydantic will parse string booleans to bool</span>
    <span class="n">flag</span><span class="p">:</span> <span class="nb">bool</span>


<span class="k">def</span><span class="w"> </span><span class="nf">inspect_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">CoercionExample</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;number: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2"> (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">number</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flag: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">flag</span><span class="si">}</span><span class="s2"> (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{}</span>


<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">CoercionExample</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;inspect&quot;</span><span class="p">,</span> <span class="n">inspect_node</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;inspect&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;inspect&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

<span class="c1"># Demonstrate coercion with string inputs that will be converted</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="s2">&quot;42&quot;</span><span class="p">,</span> <span class="s2">&quot;flag&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">})</span>

<span class="c1"># This would fail with a validation error</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="s2">&quot;not-a-number&quot;</span><span class="p">,</span> <span class="s2">&quot;flag&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">})</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Expected validation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Working with Message Models</strong>
When working with LangChain message types in your state schema, there are important considerations for serialization. You should use AnyMessage (rather than BaseMessage) for proper serialization/deserialization when using message objects over the wire:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">HumanMessage</span><span class="p">,</span> <span class="n">AIMessage</span><span class="p">,</span> <span class="n">AnyMessage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ChatState</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">]</span>
    <span class="n">context</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_message</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">ChatState</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">messages</span> <span class="o">+</span> <span class="p">[</span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;Hello there!&quot;</span><span class="p">)]}</span>


<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">ChatState</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;add_message&quot;</span><span class="p">,</span> <span class="n">add_message</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;add_message&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;add_message&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

<span class="c1"># Create input with a message</span>
<span class="n">initial_state</span> <span class="o">=</span> <span class="n">ChatState</span><span class="p">(</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;Hi&quot;</span><span class="p">)],</span> <span class="n">context</span><span class="o">=</span><span class="s2">&quot;Customer support chat&quot;</span>
<span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">initial_state</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Convert back to Pydantic model to see message types</span>
<span class="n">output_model</span> <span class="o">=</span> <span class="n">ChatState</span><span class="p">(</span><span class="o">**</span><span class="n">result</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_model</span><span class="o">.</span><span class="n">messages</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="graphs">Graphs<a class="headerlink" href="#graphs" title="Permanent link">#</a></h2>
<p>At its core, LangGraph models agent workflows as graphs. You define the behavior of your agents using three key components:</p>
<ol>
<li>
<p><strong>State:</strong> A shared data structure that represents the current snapshot of your application. It can be any Python type, but is typically a TypedDict or Pydantic BaseModel.</p>
</li>
<li>
<p><strong>Nodes:</strong> Python functions that encode the logic of your agents. They receive the current State as input, perform some computation or side-effect, and return an updated State.</p>
</li>
<li>
<p><strong>Edges:</strong> Python functions that determine which Node to execute next based on the current State. They can be conditional branches or fixed transitions.</p>
</li>
</ol>
<p>By composing Nodes and Edges, you can create complex, looping workflows that evolve the State over time. The real power, though, comes from how LangGraph manages that State.</p>
<p>To emphasize: Nodes and Edges are nothing more than Python functions - they can contain an LLM or just good ol' Python code.</p>
<p><strong>In short:</strong> <strong>nodes</strong> do the work. <strong>edges</strong> tell what to do next.</p>
<p>LangGraph's underlying graph algorithm uses message passing to define a general program. When a Node completes its operation, it sends messages along one or more edges to other node(s).</p>
<p>These recipient nodes then execute their functions, pass the resulting messages to the next set of nodes, and the process continues.</p>
<p>A super-step can be considered a single iteration over the graph nodes. Nodes that run in parallel are part of the same super-step, while nodes that run sequentially belong to separate super-steps. At the start of graph execution, all nodes begin in an inactive state. A node becomes active when it receives a new message (state) on any of its incoming edges (or "channels"). The active node then runs its function and responds with updates. At the end of each super-step, nodes with no incoming messages vote to halt by marking themselves as inactive. The graph execution terminates when all nodes are inactive and no messages are in transit.</p>
<p><strong>StateGraph:</strong>
The StateGraph class is the main graph class to use. This is parameterized by a user defined State object.</p>
<p><strong>Compiling your graph:</strong>
To build your graph, you first define the <strong>state</strong>, you then add <strong>nodes</strong> and <strong>edges</strong>, and then you compile it. What exactly is compiling your graph and why is it needed?</p>
<p>Compiling is a pretty simple step. It provides a few basic checks on the structure of your graph (no orphaned nodes, etc). It is also where you can specify runtime args like <strong>checkpointers</strong> and <strong>breakpoints</strong>. You compile your graph by just calling the <strong>.compile</strong> method:</p>
<div class="codehilite"><pre><span></span><code>graph = graph_builder.compile(...)
</code></pre></div>

<p><strong>Note:</strong> You MUST compile your graph before you can use it.</p>
<p><strong>Multiple schemas</strong>
Typically, all graph nodes communicate with a single schema. This means that they will read and write to the same state channels. But, there are cases where we want more control over this:</p>
<ul>
<li>Internal nodes can pass information that is not required in the graph's input / output.</li>
<li>We may also want to use different input / output schemas for the graph. The output might, for example, only contain a single relevant output key.</li>
</ul>
<p>It is possible to have nodes write to private state channels inside the graph for internal node communication. We can simply define a private schema, <strong>PrivateState</strong>.</p>
<p><strong>Let's look at an example:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="n">InputState</span>(<span class="n">TypedDict</span>):
    <span class="n">user_input:</span> <span class="n">str</span>

<span class="k">class</span> <span class="n">OutputState</span>(<span class="n">TypedDict</span>):
    <span class="n">graph_output:</span> <span class="n">str</span>

<span class="k">class</span> <span class="n">OverallState</span>(<span class="n">TypedDict</span>):
    <span class="n">foo:</span> <span class="n">str</span>
    <span class="n">user_input:</span> <span class="n">str</span>
    <span class="n">graph_output:</span> <span class="n">str</span>

<span class="k">class</span> <span class="n">PrivateState</span>(<span class="n">TypedDict</span>):
    <span class="n">bar:</span> <span class="n">str</span>

<span class="n">def</span> <span class="n">node_1</span>(<span class="n">state:</span> <span class="n">InputState</span>) -&gt; <span class="n">OverallState:</span>
    <span class="c1"># Write to OverallState</span>
    <span class="k">return</span> {<span class="s">&quot;foo&quot;</span>: <span class="k">state</span>[<span class="s">&quot;user_input&quot;</span>] + <span class="s">&quot; name&quot;</span>}

<span class="n">def</span> <span class="n">node_2</span>(<span class="n">state:</span> <span class="n">OverallState</span>) -&gt; <span class="n">PrivateState:</span>
    <span class="c1"># Read from OverallState, write to PrivateState</span>
    <span class="k">return</span> {<span class="s">&quot;bar&quot;</span>: <span class="k">state</span>[<span class="s">&quot;foo&quot;</span>] + <span class="s">&quot; is&quot;</span>}

<span class="n">def</span> <span class="n">node_3</span>(<span class="n">state:</span> <span class="n">PrivateState</span>) -&gt; <span class="n">OutputState:</span>
    <span class="c1"># Read from PrivateState, write to OutputState</span>
    <span class="k">return</span> {<span class="s">&quot;graph_output&quot;</span>: <span class="k">state</span>[<span class="s">&quot;bar&quot;</span>] + <span class="s">&quot; Lance&quot;</span>}

<span class="n">builder</span> = <span class="n">StateGraph</span>(<span class="n">OverallState</span>,<span class="n">input</span>=<span class="n">InputState</span>,<span class="n">output</span>=<span class="n">OutputState</span>)
<span class="n">builder</span>.<span class="n">add_node</span>(<span class="s">&quot;node_1&quot;</span>, <span class="n">node_1</span>)
<span class="n">builder</span>.<span class="n">add_node</span>(<span class="s">&quot;node_2&quot;</span>, <span class="n">node_2</span>)
<span class="n">builder</span>.<span class="n">add_node</span>(<span class="s">&quot;node_3&quot;</span>, <span class="n">node_3</span>)
<span class="n">builder</span>.<span class="n">add_edge</span>(<span class="n">START</span>, <span class="s">&quot;node_1&quot;</span>)
<span class="n">builder</span>.<span class="n">add_edge</span>(<span class="s">&quot;node_1&quot;</span>, <span class="s">&quot;node_2&quot;</span>)
<span class="n">builder</span>.<span class="n">add_edge</span>(<span class="s">&quot;node_2&quot;</span>, <span class="s">&quot;node_3&quot;</span>)
<span class="n">builder</span>.<span class="n">add_edge</span>(<span class="s">&quot;node_3&quot;</span>, <span class="k">END</span>)

<span class="n">graph</span> = <span class="n">builder</span>.<span class="n">compile</span>()
<span class="n">graph</span>.<span class="n">invoke</span>({<span class="s">&quot;user_input&quot;</span>:<span class="s">&quot;My&quot;</span>})
{<span class="s">&#39;graph_output&#39;</span>: <span class="s">&#39;My name is Lance&#39;</span>}
</code></pre></div>

<p>There are two subtle and important points to note here:</p>
<ol>
<li>
<p>We pass state: InputState as the input schema to node_1. But, we write out to foo, a channel in OverallState. How can we write out to a state channel that is not included in the input schema? This is because a node can write to any state channel in the graph state. The graph state is the union of of the state channels defined at initialization, which includes OverallState and the filters InputState and OutputState.</p>
</li>
<li>
<p>We initialize the graph with StateGraph(OverallState,input=InputState,output=OutputState). So, how can we write to PrivateState in node_2? How does the graph gain access to this schema if it was not passed in the StateGraph initialization? We can do this because nodes can also declare additional state channels as long as the state schema definition exists. In this case, the PrivateState schema is defined, so we can add bar as a new state channel in the graph and write to it.</p>
</li>
</ol>
<h2 id="reducers">Reducers<a class="headerlink" href="#reducers" title="Permanent link">#</a></h2>
<p>Reducers are key to understanding how updates from nodes are applied to the State. Each key in the State has its own independent reducer function. If no reducer function is explicitly specified then it is assumed that all updates to that key should override it. There are a few different types of reducers, starting with the default type of reducer:</p>
<p><strong>Default Reducer</strong></p>
<p>These two examples show how to use the default reducer:</p>
<p><strong>Example A:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">foo</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">bar</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

<p>In this example, no reducer functions are specified for any key. Let's assume the input to the graph is {"foo": 1, "bar": ["hi"]}. Let's then assume the first Node returns {"foo": 2}. This is treated as an update to the state. Notice that the Node does not need to return the whole State schema - just an update. After applying this update, the State would then be {"foo": 2, "bar": ["hi"]}. If the second node returns {"bar": ["bye"]} then the State would then be {"foo": 2, "bar": ["bye"]}</p>
<p><strong>Example B:</strong></p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">operator</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>

<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">foo</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">bar</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">add</span><span class="p">]</span>
</code></pre></div>

<p>In this example, we've used the Annotated type to specify a reducer function (operator.add) for the second key (bar). Note that the first key remains unchanged. Let's assume the input to the graph is {"foo": 1, "bar": ["hi"]}. Let's then assume the first Node returns {"foo": 2}. This is treated as an update to the state. Notice that the Node does not need to return the whole State schema - just an update. After applying this update, the State would then be {"foo": 2, "bar": ["hi"]}. If the second node returns {"bar": ["bye"]} then the State would then be {"foo": 2, "bar": ["hi", "bye"]}. Notice here that the bar key is updated by adding the two lists together.</p>
<h2 id="working-with-messages-in-graph-state">Working with Messages in Graph State<a class="headerlink" href="#working-with-messages-in-graph-state" title="Permanent link">#</a></h2>
<p><strong>Why use messages?</strong></p>
<p>Most modern LLM providers have a chat model interface that accepts a list of messages as input. LangChain's ChatModel in particular accepts a list of Message objects as inputs. These messages come in a variety of forms such as HumanMessage (user input) or AIMessage (LLM response). To read more about what message objects are, please refer to this conceptual guide.</p>
<p><strong>Using Messages in your Graph</strong>
In many cases, it is helpful to store prior conversation history as a list of messages in your graph state. To do so, we can add a key (channel) to the graph state that stores a list of Message objects and annotate it with a reducer function (see messages key in the example below). The reducer function is vital to telling the graph how to update the list of Message objects in the state with each state update (for example, when a node sends an update). If you don't specify a reducer, every state update will overwrite the list of messages with the most recently provided value. If you wanted to simply append messages to the existing list, you could use operator.add as a reducer.</p>
<p>However, you might also want to manually update messages in your graph state (e.g. human-in-the-loop). If you were to use operator.add, the manual state updates you send to the graph would be appended to the existing list of messages, instead of updating existing messages. To avoid that, you need a reducer that can keep track of message IDs and overwrite existing messages, if updated. To achieve this, you can use the prebuilt add_messages function. For brand new messages, it will simply append to existing list, but it will also handle the updates for existing messages correctly.</p>
<p><strong>Serialization</strong>
In addition to keeping track of message IDs, the add_messages function will also try to deserialize messages into LangChain Message objects whenever a state update is received on the messages channel. See more information on LangChain serialization/deserialization here. This allows sending graph inputs / state updates in the following format:</p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">supported</span>
<span class="p">{</span><span class="s">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">HumanMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="s">&quot;message&quot;</span><span class="p">)]}</span>

<span class="err">#</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">also</span><span class="w"> </span><span class="nx">supported</span>
<span class="p">{</span><span class="s">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;human&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;message&quot;</span><span class="p">}]}</span>
</code></pre></div>

<p>Since the state updates are always deserialized into LangChain Messages when using add_messages, you should use dot notation to access message attributes, like state["messages"][-1].content. Below is an example of a graph that uses add_messages as it's reducer function.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">AnyMessage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="k">class</span><span class="w"> </span><span class="nc">GraphState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">AnyMessage</span><span class="p">],</span> <span class="n">add_messages</span><span class="p">]</span>
</code></pre></div>

<p><strong>MessagesState</strong></p>
<p>Since having a list of messages in your state is so common, there exists a prebuilt state called MessagesState which makes it easy to use messages. MessagesState is defined with a single messages key which is a list of AnyMessage objects and uses the add_messages reducer. Typically, there is more state to track than just messages, so we see people subclass this state and add more fields, like:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">MessagesState</span>

<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">MessagesState</span><span class="p">):</span>
    <span class="n">documents</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

<h2 id="nodes">Nodes<a class="headerlink" href="#nodes" title="Permanent link">#</a></h2>
<p>In LangGraph, nodes are typically python functions (sync or async) where the first positional argument is the state, and (optionally), the second positional argument is a "config", containing optional configurable parameters (such as a thread_id).</p>
<p>Similar to NetworkX, you add these nodes to a graph using the add_node method:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.runnables</span><span class="w"> </span><span class="kn">import</span> <span class="n">RunnableConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span>

<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">my_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;In node: &quot;</span><span class="p">,</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;user_id&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Hello, </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">}</span>


<span class="c1"># The second argument is optional</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_other_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">state</span>


<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;my_node&quot;</span><span class="p">,</span> <span class="n">my_node</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;other_node&quot;</span><span class="p">,</span> <span class="n">my_other_node</span><span class="p">)</span>
<span class="o">...</span>
</code></pre></div>

<p>Behind the scenes, functions are converted to RunnableLambdas, which add batch and async support to your function, along with native tracing and debugging.</p>
<p>If you add a node to a graph without specifying a name, it will be given a default name equivalent to the function name.</p>
<div class="codehilite"><pre><span></span><code>builder.add_node(my_node)
<span class="gh">#</span> You can then create edges to/from this node by referencing it as `&quot;my_node&quot;`
</code></pre></div>

<h2 id="start-node">START Node<a class="headerlink" href="#start-node" title="Permanent link">#</a></h2>
<p>The START Node is a special node that represents the node that sends user input to the graph. The main purpose for referencing this node is to determine which nodes should be called first.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">START</span>

<span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;node_a&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="end-node">END Node<a class="headerlink" href="#end-node" title="Permanent link">#</a></h2>
<p>The END Node is a special node that represents a terminal node. This node is referenced when you want to denote which edges have no actions after they are done.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">END</span>

<span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;node_a&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
</code></pre></div>

<h2 id="edges">Edges<a class="headerlink" href="#edges" title="Permanent link">#</a></h2>
<p>Edges define how the logic is routed and how the graph decides to stop. This is a big part of how your agents work and how different nodes communicate with each other. There are a few key types of edges:</p>
<ul>
<li><strong>Normal Edges:</strong> Go directly from one node to the next.</li>
<li><strong>Conditional Edges:</strong> Call a function to determine which node(s) to go to next.</li>
<li><strong>Entry Point:</strong> Which node to call first when user input arrives.</li>
<li><strong>Conditional Entry Point:</strong> Call a function to determine which node(s) to call first when user input arrives.</li>
</ul>
<p>A node can have MULTIPLE outgoing edges. If a node has multiple out-going edges, all of those destination nodes will be executed in parallel as a part of the next superstep.</p>
<p><strong>Normal Edges:</strong>
If you always want to go from node A to node B, you can use the add_edge method directly.</p>
<div class="codehilite"><pre><span></span><code>graph.add_edge(&quot;node_a&quot;, &quot;node_b&quot;)
</code></pre></div>

<p><strong>Conditional Edges:</strong>
If you want to optionally route to 1 or more edges (or optionally terminate), you can use the add_conditional_edges method. This method accepts the name of a node and a "routing function" to call after that node is executed:</p>
<div class="codehilite"><pre><span></span><code>graph.add_conditional_edges(&quot;node_a&quot;, routing_function)
</code></pre></div>

<p>Similar to nodes, the routing_function accepts the current state of the graph and returns a value.</p>
<p>By default, the return value routing_function is used as the name of the node (or list of nodes) to send the state to next. All those nodes will be run in parallel as a part of the next superstep.</p>
<p>You can optionally provide a dictionary that maps the routing_function's output to the name of the next node.</p>
<div class="codehilite"><pre><span></span><code>graph.add_conditional_edges(&quot;node_a&quot;, routing_function, {True: &quot;node_b&quot;, False: &quot;node_c&quot;})
</code></pre></div>

<p><strong>Note:</strong> Use Command instead of conditional edges if you want to combine state updates and routing in a single function.</p>
<p><strong>Command</strong>
It can be useful to combine control flow (edges) and state updates (nodes). For example, you might want to BOTH perform state updates AND decide which node to go to next in the SAME node. LangGraph provides a way to do so by returning a Command object from node functions:</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">my_node</span><span class="p">(</span><span class="n">state</span><span class="o">:</span><span class="w"> </span><span class="n">State</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Command</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s">&quot;my_other_node&quot;</span><span class="p">]]</span><span class="o">:</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">Command</span><span class="p">(</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">update</span>
<span class="w">        </span><span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;bar&quot;</span><span class="p">},</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="n">flow</span>
<span class="w">        </span><span class="n">goto</span><span class="o">=</span><span class="s">&quot;my_other_node&quot;</span>
<span class="w">    </span><span class="p">)</span>
</code></pre></div>

<p>With Command you can also achieve dynamic control flow behavior (identical to conditional edges):</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">my_node</span><span class="p">(</span><span class="n">state</span><span class="o">:</span><span class="w"> </span><span class="n">State</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Command</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s">&quot;my_other_node&quot;</span><span class="p">]]</span><span class="o">:</span>
<span class="w">    </span><span class="nf">if</span><span class="w"> </span><span class="n">state</span><span class="p">[</span><span class="s">&quot;foo&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;bar&quot;</span><span class="o">:</span>
<span class="w">        </span><span class="kr">return</span><span class="w"> </span><span class="n">Command</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;baz&quot;</span><span class="p">},</span><span class="w"> </span><span class="n">goto</span><span class="o">=</span><span class="s">&quot;my_other_node&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Important</strong>
When returning Command in your node functions, you must add return type annotations with the list of node names the node is routing to, e.g. Command[Literal["my_other_node"]]. This is necessary for the graph rendering and tells LangGraph that my_node can navigate to my_other_node.</p>
<h2 id="when-should-i-use-command-instead-of-conditional-edges">When should I use Command instead of conditional edges?<a class="headerlink" href="#when-should-i-use-command-instead-of-conditional-edges" title="Permanent link">#</a></h2>
<p>Use Command when you need to both update the graph state and route to a different node. For example, when implementing multi-agent handoffs where it's important to route to a different agent and pass some information to that agent.</p>
<p>Use conditional edges to route between nodes conditionally without updating the state.</p>
<h2 id="navigating-to-a-node-in-a-parent-graph">Navigating to a node in a parent graph<a class="headerlink" href="#navigating-to-a-node-in-a-parent-graph" title="Permanent link">#</a></h2>
<p>If you are using subgraphs, you might want to navigate from a node within a subgraph to a different subgraph (i.e. a different node in the parent graph). To do so, you can specify graph=Command.PARENT in Command:</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">my_node</span><span class="p">(</span><span class="n">state</span><span class="o">:</span><span class="w"> </span><span class="n">State</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Command</span><span class="err">[</span><span class="n">Literal</span><span class="err">[</span><span class="s2">&quot;other_subgraph&quot;</span><span class="err">]]</span><span class="o">:</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Command</span><span class="p">(</span>
<span class="w">        </span><span class="k">update</span><span class="o">=</span><span class="err">{</span><span class="s2">&quot;foo&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;bar&quot;</span><span class="err">}</span><span class="p">,</span>
<span class="w">        </span><span class="n">goto</span><span class="o">=</span><span class="s2">&quot;other_subgraph&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># where `other_subgraph` is a node in the parent graph</span>
<span class="w">        </span><span class="n">graph</span><span class="o">=</span><span class="n">Command</span><span class="p">.</span><span class="n">PARENT</span>
<span class="w">    </span><span class="p">)</span>
</code></pre></div>

<p><strong>Note:</strong> Setting graph to Command.PARENT will navigate to the closest parent graph.</p>
<p><strong>State updates with Command.PARENT</strong>
When you send updates from a subgraph node to a parent graph node for a key that's shared by both parent and subgraph state schemas, you must define a reducer for the key you're updating in the parent graph state. See this example.</p>
<h2 id="using-inside-tools">Using inside tools<a class="headerlink" href="#using-inside-tools" title="Permanent link">#</a></h2>
<p>A common use case is updating graph state from inside a tool. For example, in a customer support application you might want to look up customer information based on their account number or ID in the beginning of the conversation. To update the graph state from the tool, you can return Command(update={"my_custom_key": "foo", "messages": [...]}) from the tool:</p>
<div class="codehilite"><pre><span></span><code><span class="err">@</span><span class="k">tool</span>
<span class="n">def</span><span class="w"> </span><span class="n">lookup_user_info</span><span class="p">(</span><span class="n">tool_call_id</span><span class="p">:</span><span class="w"> </span><span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">InjectedToolCallId</span><span class="p">],</span><span class="w"> </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use this to look up user information to better assist them with their questions.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">user_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_user_info</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;configurable&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Command</span><span class="p">(</span>
<span class="w">        </span><span class="n">update</span><span class="o">=</span><span class="p">{</span>
<span class="w">            </span><span class="c1"># update the state keys</span>
<span class="w">            </span><span class="s2">&quot;user_info&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">user_info</span><span class="p">,</span>
<span class="w">            </span><span class="c1"># update the message history</span>
<span class="w">            </span><span class="s2">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">ToolMessage</span><span class="p">(</span><span class="s2">&quot;Successfully looked up user information&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_call_id</span><span class="o">=</span><span class="n">tool_call_id</span><span class="p">)]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">)</span>
</code></pre></div>

<h2 id="human-in-the-loop">Human-in-the-loop<a class="headerlink" href="#human-in-the-loop" title="Permanent link">#</a></h2>
<p>Command is an important part of human-in-the-loop workflows: when using interrupt() to collect user input, Command is then used to supply the input and resume execution via Command(resume="User input"). Check out this conceptual guide for more information.</p>
<h2 id="persistence">Persistence<a class="headerlink" href="#persistence" title="Permanent link">#</a></h2>
<p>LangGraph provides built-in persistence for your agent's state using checkpointers. Checkpointers save snapshots of the graph state at every superstep, allowing resumption at any time. This enables features like human-in-the-loop interactions, memory management, and fault-tolerance. You can even directly manipulate a graph's state after its execution using the appropriate get and update methods. For more details, see the persistence conceptual guide.</p>
<h2 id="threads">Threads<a class="headerlink" href="#threads" title="Permanent link">#</a></h2>
<p>Threads in LangGraph represent individual sessions or conversations between your graph and a user. When using checkpointing, turns in a single conversation (and even steps within a single graph execution) are organized by a unique thread ID.</p>
<h2 id="storage">Storage<a class="headerlink" href="#storage" title="Permanent link">#</a></h2>
<p>LangGraph provides built-in document storage through the BaseStore interface. Unlike checkpointers, which save state by thread ID, stores use custom namespaces for organizing data. This enables cross-thread persistence, allowing agents to maintain long-term memories, learn from past interactions, and accumulate knowledge over time. Common use cases include storing user profiles, building knowledge bases, and managing global preferences across all threads.</p>
<h2 id="graph-migrations">Graph Migrations<a class="headerlink" href="#graph-migrations" title="Permanent link">#</a></h2>
<p>LangGraph can easily handle migrations of graph definitions (nodes, edges, and state) even when using a checkpointer to track state.</p>
<ul>
<li>For threads at the end of the graph (i.e. not interrupted) you can change the entire topology of the graph (i.e. all nodes and edges, remove, add, rename, etc)</li>
<li>For threads currently interrupted, we support all topology changes other than renaming / removing nodes (as that thread could now be about to enter a node that no longer exists) -- if this is a blocker please reach out and we can prioritize a solution.</li>
<li>For modifying state, we have full backwards and forwards compatibility for adding and removing keys</li>
<li>State keys that are renamed lose their saved state in existing threads</li>
<li>State keys whose types change in incompatible ways could currently cause issues in threads with state from before the change -- if this is a blocker please reach out and we can prioritize a solution.</li>
</ul>
<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">#</a></h2>
<p>When creating a graph, you can also mark that certain parts of the graph are configurable. This is commonly done to enable easily switching between models or system prompts. This allows you to create a single "cognitive architecture" (the graph) but have multiple different instance of it.</p>
<p>You can optionally specify a config_schema when creating a graph.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="n">ConfigSchema</span>(<span class="n">TypedDict</span>):
    <span class="n">llm:</span> <span class="n">str</span>

<span class="n">graph</span> = <span class="n">StateGraph</span>(<span class="n">State</span>, <span class="n">config_schema</span>=<span class="n">ConfigSchema</span>)
</code></pre></div>

<p>You can then pass this configuration into the graph using the configurable config field.</p>
<div class="codehilite"><pre><span></span><code>config = {&quot;configurable&quot;: {&quot;llm&quot;: &quot;anthropic&quot;}}

graph.invoke(inputs, config=config)
</code></pre></div>

<p>You can then access and use this configuration inside a node:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">def</span><span class="w"> </span><span class="nx">node_a</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">):</span>
<span class="w">    </span><span class="nx">llm_type</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;configurable&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{}).</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;llm&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;openai&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">llm</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">get_llm</span><span class="p">(</span><span class="nx">llm_type</span><span class="p">)</span>
<span class="w">    </span><span class="o">...</span>
</code></pre></div>

<h2 id="recursion-limit">Recursion Limit<a class="headerlink" href="#recursion-limit" title="Permanent link">#</a></h2>
<p>The recursion limit sets the maximum number of super-steps the graph can execute during a single execution. Once the limit is reached, LangGraph will raise GraphRecursionError. By default this value is set to 25 steps. The recursion limit can be set on any graph at runtime, and is passed to .invoke/.stream via the config dictionary. Importantly, recursion_limit is a standalone config key and should not be passed inside the configurable key as all other user-defined configuration. See the example below:</p>
<div class="codehilite"><pre><span></span><code>graph.invoke(inputs, config={&quot;recursion_limit&quot;: 5, &quot;configurable&quot;:{&quot;llm&quot;: &quot;anthropic&quot;}})
</code></pre></div>

<h2 id="interrupt">interrupt<a class="headerlink" href="#interrupt" title="Permanent link">#</a></h2>
<p>Use the interrupt function to pause the graph at specific points to collect user input. The interrupt function surfaces interrupt information to the client, allowing the developer to collect user input, validate the graph state, or make decisions before resuming execution.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">interrupt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">human_approval_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">interrupt</span><span class="p">(</span>
        <span class="c1"># This value will be sent to the client.</span>
        <span class="c1"># It can be any JSON serializable value.</span>
        <span class="p">{</span><span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;is it ok to continue?&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="o">...</span>
</code></pre></div>

<p>Resuming the graph is done by passing a Command object to the graph with the resume key set to the value returned by the interrupt function.</p>
<h2 id="breakpoints">Breakpoints<a class="headerlink" href="#breakpoints" title="Permanent link">#</a></h2>
<p>Breakpoints pause graph execution at specific points and enable stepping through execution step by step. Breakpoints are powered by LangGraph's persistence layer, which saves the state after each graph step. Breakpoints can also be used to enable human-in-the-loop workflows, though we recommend using the interrupt function for this purpose.</p>
<p>Read more about breakpoints in the Breakpoints conceptual guide.</p>
<h2 id="subgraphs">Subgraphs<a class="headerlink" href="#subgraphs" title="Permanent link">#</a></h2>
<p>A subgraph is a graph that is used as a node in another graph. This is nothing more than the age-old concept of encapsulation, applied to LangGraph. Some reasons for using subgraphs are:</p>
<ul>
<li>building multi-agent systems</li>
<li>when you want to reuse a set of nodes in multiple graphs, which maybe share some state, you can define them once in a subgraph and then use them in multiple parent graphs</li>
<li>when you want different teams to work on different parts of the graph independently, you can define each part as a subgraph, and as long as the subgraph interface (the input and output schemas) is respected, the parent graph can be built without knowing any details of the subgraph</li>
</ul>
<p>There are two ways to add subgraphs to a parent graph:</p>
<ul>
<li>add a node with the compiled subgraph: this is useful when the parent graph and the subgraph share state keys and you don't need to transform state on the way in or out</li>
</ul>
<div class="codehilite"><pre><span></span><code>builder.add_node(&quot;subgraph&quot;, subgraph_builder.compile())
</code></pre></div>

<ul>
<li>add a node with a function that invokes the subgraph: this is useful when the parent graph and the subgraph have different state schemas and you need to transform state before or after calling the subgraph</li>
</ul>
<div class="codehilite"><pre><span></span><code>subgraph = subgraph_builder.compile()

def call_subgraph(state: State):
    return subgraph.invoke({&quot;subgraph_key&quot;: state[&quot;parent_key&quot;]})

builder.add_node(&quot;subgraph&quot;, call_subgraph)
</code></pre></div>

<h2 id="as-a-compiled-graph">As a compiled graph<a class="headerlink" href="#as-a-compiled-graph" title="Permanent link">#</a></h2>
<p>The simplest way to create subgraph nodes is by using a compiled subgraph directly. When doing so, it is important that the parent graph and the subgraph state schemas share at least one key which they can use to communicate. If your graph and subgraph do not share any keys, you should write a function invoking the subgraph instead.</p>
<p><strong>Note:</strong> If you pass extra keys to the subgraph node (i.e., in addition to the shared keys), they will be ignored by the subgraph node. Similarly, if you return extra keys from the subgraph, they will be ignored by the parent graph.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">foo</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SubgraphState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">foo</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># note that this key is shared with the parent graph state</span>
    <span class="n">bar</span><span class="p">:</span> <span class="nb">str</span>

<span class="c1"># Define subgraph</span>
<span class="k">def</span><span class="w"> </span><span class="nf">subgraph_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">SubgraphState</span><span class="p">):</span>
    <span class="c1"># note that this subgraph node can communicate with the parent graph via the shared &quot;foo&quot; key</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;bar&quot;</span><span class="p">}</span>

<span class="n">subgraph_builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">SubgraphState</span><span class="p">)</span>
<span class="n">subgraph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">subgraph_node</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">subgraph</span> <span class="o">=</span> <span class="n">subgraph_builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

<span class="c1"># Define parent graph</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;subgraph&quot;</span><span class="p">,</span> <span class="n">subgraph</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<h2 id="as-a-function">As a function<a class="headerlink" href="#as-a-function" title="Permanent link">#</a></h2>
<p>You might want to define a subgraph with a completely different schema. In this case, you can create a node function that invokes the subgraph. This function will need to transform the input (parent) state to the subgraph state before invoking the subgraph, and transform the results back to the parent state before returning the state update from the node.</p>
<div class="codehilite"><pre><span></span><code><span class="n">class</span><span class="w"> </span><span class="n">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">)</span><span class="o">:</span>
<span class="w">    </span><span class="n">foo</span><span class="o">:</span><span class="w"> </span><span class="n">str</span>

<span class="n">class</span><span class="w"> </span><span class="n">SubgraphState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">)</span><span class="o">:</span>
<span class="w">    </span><span class="c1"># note that none of these keys are shared with the parent graph state</span>
<span class="w">    </span><span class="n">bar</span><span class="o">:</span><span class="w"> </span><span class="n">str</span>
<span class="w">    </span><span class="n">baz</span><span class="o">:</span><span class="w"> </span><span class="n">str</span>

<span class="c1"># Define subgraph</span>
<span class="n">def</span><span class="w"> </span><span class="n">subgraph_node</span><span class="p">(</span><span class="n">state</span><span class="o">:</span><span class="w"> </span><span class="n">SubgraphState</span><span class="p">)</span><span class="o">:</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="err">{</span><span class="s2">&quot;bar&quot;</span><span class="o">:</span><span class="w"> </span><span class="n">state</span><span class="err">[</span><span class="s2">&quot;bar&quot;</span><span class="err">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;baz&quot;</span><span class="err">}</span>

<span class="n">subgraph_builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(</span><span class="n">SubgraphState</span><span class="p">)</span>
<span class="n">subgraph_builder</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">subgraph_node</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">subgraph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgraph_builder</span><span class="p">.</span><span class="n">compile</span><span class="p">()</span>

<span class="c1"># Define parent graph</span>
<span class="n">def</span><span class="w"> </span><span class="n">node</span><span class="p">(</span><span class="n">state</span><span class="o">:</span><span class="w"> </span><span class="n">State</span><span class="p">)</span><span class="o">:</span>
<span class="w">    </span><span class="c1"># transform the state to the subgraph state</span>
<span class="w">    </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgraph</span><span class="p">.</span><span class="n">invoke</span><span class="p">(</span><span class="err">{</span><span class="s2">&quot;bar&quot;</span><span class="o">:</span><span class="w"> </span><span class="n">state</span><span class="err">[</span><span class="s2">&quot;foo&quot;</span><span class="err">]}</span><span class="p">)</span>
<span class="w">    </span><span class="c1"># transform response back to the parent state</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="err">{</span><span class="s2">&quot;foo&quot;</span><span class="o">:</span><span class="w"> </span><span class="n">response</span><span class="err">[</span><span class="s2">&quot;bar&quot;</span><span class="err">]}</span>

<span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
<span class="c1"># note that we are using `node` function instead of a compiled subgraph</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<h2 id="visualization">Visualization<a class="headerlink" href="#visualization" title="Permanent link">#</a></h2>
<p>It's often nice to be able to visualize graphs, especially as they get more complex. LangGraph comes with several built-in ways to visualize graphs.
<a href="https://langchain-ai.github.io/langgraph/how-tos/visualization/">visualize</a></p>
<h2 id="streaming">Streaming<a class="headerlink" href="#streaming" title="Permanent link">#</a></h2>
<p>LangGraph is built with first class support for streaming, including streaming updates from graph nodes during the execution, streaming tokens from LLM calls and more. See this conceptual guide for more information.
<a href="https://langchain-ai.github.io/langgraph/concepts/streaming/">streaming</a></p>
<h2 id="how-to-create-branches-for-parallel-node-execution">How to create branches for parallel node execution¶<a class="headerlink" href="#how-to-create-branches-for-parallel-node-execution" title="Permanent link">#</a></h2>
<p>Parallel execution of nodes is essential to speed up overall graph operation. LangGraph offers native support for parallel execution of nodes, which can significantly enhance the performance of graph-based workflows. This parallelization is achieved through fan-out and fan-in mechanisms, utilizing both standard edges and conditional_edges. Below are some examples showing how to add create branching dataflows that work for you.</p>
<h2 id="how-to-run-graph-nodes-in-parallel">How to run graph nodes in parallel<a class="headerlink" href="#how-to-run-graph-nodes-in-parallel" title="Permanent link">#</a></h2>
<p>In this example, we fan out from Node A to B and C and then fan in to D. With our state, we specify the reducer add operation. This will combine or accumulate values for the specific key in the State, rather than simply overwriting the existing value. For lists, this means concatenating the new list with the existing list. See this guide for more detail on updating state with reducers.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>


<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="c1"># The operator.add reducer fn makes this append-only</span>
    <span class="n">aggregate</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding &quot;A&quot; to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">b</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding &quot;B&quot; to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding &quot;C&quot; to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding &quot;D&quot; to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]}</span>


<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>

<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">()))</span>
</code></pre></div>

<p>With the reducer, you can see that the values added in each node are accumulated.</p>
<div class="codehilite"><pre><span></span><code><span class="n">graph</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span><span class="s">&quot;aggregate&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[]},</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;configurable&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;thread_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;foo&quot;</span><span class="p">}})</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Adding &quot;A&quot; to []
Adding &quot;B&quot; to [&#39;A&#39;]
Adding &quot;C&quot; to [&#39;A&#39;]
Adding &quot;D&quot; to [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;]
</code></pre></div>

<p><strong>Note:</strong> In the above example, nodes "b" and "c" are executed concurrently in the same superstep. Because they are in the same step, node "d" executes after both "b" and "c" are finished.</p>
<p>Importantly, updates from a parallel superstep may not be ordered consistently. If you need a consistent, predetermined ordering of updates from a parallel superstep, you should write the outputs to a separate field in the state together with a value with which to order them.</p>
<h2 id="parallel-node-fan-out-and-fan-in-with-extra-steps">Parallel node fan-out and fan-in with extra steps<a class="headerlink" href="#parallel-node-fan-out-and-fan-in-with-extra-steps" title="Permanent link">#</a></h2>
<p>The above example showed how to fan-out and fan-in when each path was only one step. But what if one path had more than one step? Let's add a node b_2 in the "b" branch:</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">b_2</span><span class="p">(</span><span class="nl">state:</span><span class="w"> </span><span class="n">State</span><span class="p">)</span><span class="o">:</span>
<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="n">f</span><span class="p">&#39;</span><span class="n">Adding</span><span class="w"> </span><span class="s">&quot;B_2&quot;</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="p">{</span><span class="n">state</span><span class="p">[</span><span class="s">&quot;aggregate&quot;</span><span class="p">]}&#39;)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;aggregate&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;B_2&quot;</span><span class="p">]}</span>


<span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">b_2</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;b&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;c&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;b_2&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_edge</span><span class="p">([</span><span class="s">&quot;b_2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;c&quot;</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;d&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">&quot;d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">END</span><span class="p">)</span>
<span class="n">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>

<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">()))</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">graph</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span><span class="s">&quot;aggregate&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[]})</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Adding &quot;A&quot; to []
Adding &quot;B&quot; to [&#39;A&#39;]
Adding &quot;C&quot; to [&#39;A&#39;]
Adding &quot;B_2&quot; to [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;]
Adding &quot;D&quot; to [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;B_2&#39;]
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="p">{&#39;</span><span class="n">aggregate</span><span class="p">&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&#39;</span><span class="n">B_2</span><span class="p">&#39;,</span><span class="w"> </span><span class="sc">&#39;D&#39;</span><span class="p">]}</span>
</code></pre></div>

<p><strong>Note:</strong> In the above example, nodes "b" and "c" are executed concurrently in the same superstep. What happens in the next step?</p>
<p>We use add_edge(["b_2", "c"], "d") here to force node "d" to only run when both nodes "b_2" and "c" have finished execution. If we added two separate edges, node "d" would run twice: after node b2 finishes and once again after node c (in whichever order those nodes finish).</p>
<h2 id="conditional-branching">Conditional Branching<a class="headerlink" href="#conditional-branching" title="Permanent link">#</a></h2>
<p>If your fan-out is not deterministic, you can use add_conditional_edges directly.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Sequence</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>


<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">aggregate</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>
    <span class="c1"># Add a key to the state. We will set this key to determine</span>
    <span class="c1"># how we branch.</span>
    <span class="n">which</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding &quot;A&quot; to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">b</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding &quot;B&quot; to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding &quot;C&quot; to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding &quot;D&quot; to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">e</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding &quot;E&quot; to </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">]}</span>


<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">route_bc_or_cd</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;which&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;cd&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]</span>


<span class="n">intermediates</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">]</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
    <span class="s2">&quot;a&quot;</span><span class="p">,</span>
    <span class="n">route_bc_or_cd</span><span class="p">,</span>
    <span class="n">intermediates</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">intermediates</span><span class="p">:</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">)</span>

<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>

<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">()))</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">graph</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span><span class="s">&quot;aggregate&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="s">&quot;which&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;bc&quot;</span><span class="p">})</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">graph</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span><span class="s">&quot;aggregate&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="s">&quot;which&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;cd&quot;</span><span class="p">})</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Adding &quot;A&quot; to []
Adding &quot;C&quot; to [&#39;A&#39;]
Adding &quot;D&quot; to [&#39;A&#39;]
Adding &quot;E&quot; to [&#39;A&#39;, &#39;C&#39;, &#39;D&#39;]
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="p">{&#39;</span><span class="n">aggregate</span><span class="p">&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;D&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;E&#39;</span><span class="p">],</span><span class="w"> </span><span class="p">&#39;</span><span class="n">which</span><span class="p">&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">&#39;</span><span class="n">cd</span><span class="p">&#39;}</span>
</code></pre></div>

<h2 id="how-to-create-map-reduce-branches-for-parallel-execution">How to create map-reduce branches for parallel execution<a class="headerlink" href="#how-to-create-map-reduce-branches-for-parallel-execution" title="Permanent link">#</a></h2>
<p>Map-reduce operations are essential for efficient task decomposition and parallel processing. This approach involves breaking a task into smaller sub-tasks, processing each sub-task in parallel, and aggregating the results across all of the completed sub-tasks.</p>
<p>Consider this example: given a general topic from the user, generate a list of related subjects, generate a joke for each subject, and select the best joke from the resulting list. In this design pattern, a first node may generate a list of objects (e.g., related subjects) and we want to apply some other node (e.g., generate a joke) to all those objects (e.g., subjects). However, two main challenges arise.</p>
<p>(1) the number of objects (e.g., subjects) may be unknown ahead of time (meaning the number of edges may not be known) when we lay out the graph and (2) the input State to the downstream Node should be different (one for each generated object).</p>
<p>LangGraph addresses these challenges through its Send API. By utilizing conditional edges, Send can distribute different states (e.g., subjects) to multiple instances of a node (e.g., joke generation). Importantly, the sent state can differ from the core graph's state, allowing for flexible and dynamic workflow management.</p>
<p><img alt="map-reduce" src="image/map-reduce.png" /></p>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">#</a></h2>
<p>First, let's install the required packages and set our API keys</p>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="nf">%capture</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">langchain</span><span class="o">-</span><span class="n">anthropic</span><span class="w"> </span><span class="n">langgraph</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_env</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>


<span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="define-the-graph">Define the graph<a class="headerlink" href="#define-the-graph" title="Permanent link">#</a></h2>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatAnthropic</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">Send</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">END</span><span class="p">,</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>

<span class="c1"># Model and prompts</span>
<span class="c1"># Define model and prompts we will use</span>
<span class="n">subjects_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Generate a comma separated list of between 2 and 5 examples related to: </span><span class="si">{topic}</span><span class="s2">.&quot;&quot;&quot;</span>
<span class="n">joke_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Generate a joke about </span><span class="si">{subject}</span><span class="s2">&quot;&quot;&quot;</span>
<span class="n">best_joke_prompt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Below are a bunch of jokes about </span><span class="si">{topic}</span><span class="s2">. Select the best one! Return the ID of the best one.</span>

<span class="si">{jokes}</span><span class="s2">&quot;&quot;&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Subjects</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">subjects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Joke</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">joke</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BestJoke</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Index of the best joke, starting with 0&quot;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-5-sonnet-20240620&quot;</span><span class="p">)</span>

<span class="c1"># Graph components: define the components that will make up the graph</span>


<span class="c1"># This will be the overall state of the main graph.</span>
<span class="c1"># It will contain a topic (which we expect the user to provide)</span>
<span class="c1"># and then will generate a list of subjects, and then a joke for</span>
<span class="c1"># each subject</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OverallState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">subjects</span><span class="p">:</span> <span class="nb">list</span>
    <span class="c1"># Notice here we use the operator.add</span>
    <span class="c1"># This is because we want combine all the jokes we generate</span>
    <span class="c1"># from individual nodes back into one list - this is essentially</span>
    <span class="c1"># the &quot;reduce&quot; part</span>
    <span class="n">jokes</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>
    <span class="n">best_selected_joke</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># This will be the state of the node that we will &quot;map&quot; all</span>
<span class="c1"># subjects to in order to generate a joke</span>
<span class="k">class</span><span class="w"> </span><span class="nc">JokeState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span>


<span class="c1"># This is the function we will use to generate the subjects of the jokes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_topics</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">OverallState</span><span class="p">):</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">subjects_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;topic&quot;</span><span class="p">])</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">Subjects</span><span class="p">)</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;subjects&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">subjects</span><span class="p">}</span>


<span class="c1"># Here we generate a joke, given a subject</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_joke</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">JokeState</span><span class="p">):</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">joke_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">])</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">Joke</span><span class="p">)</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;jokes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">joke</span><span class="p">]}</span>


<span class="c1"># Here we define the logic to map out over the generated subjects</span>
<span class="c1"># We will use this as an edge in the graph</span>
<span class="k">def</span><span class="w"> </span><span class="nf">continue_to_jokes</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">OverallState</span><span class="p">):</span>
    <span class="c1"># We will return a list of `Send` objects</span>
    <span class="c1"># Each `Send` object consists of the name of a node in the graph</span>
    <span class="c1"># as well as the state to send to that node</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Send</span><span class="p">(</span><span class="s2">&quot;generate_joke&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">})</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;subjects&quot;</span><span class="p">]]</span>


<span class="c1"># Here we will judge the best joke</span>
<span class="k">def</span><span class="w"> </span><span class="nf">best_joke</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">OverallState</span><span class="p">):</span>
    <span class="n">jokes</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;jokes&quot;</span><span class="p">])</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">best_joke_prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;topic&quot;</span><span class="p">],</span> <span class="n">jokes</span><span class="o">=</span><span class="n">jokes</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">BestJoke</span><span class="p">)</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;best_selected_joke&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;jokes&quot;</span><span class="p">][</span><span class="n">response</span><span class="o">.</span><span class="n">id</span><span class="p">]}</span>


<span class="c1"># Construct the graph: here we put everything together to construct our graph</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">OverallState</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;generate_topics&quot;</span><span class="p">,</span> <span class="n">generate_topics</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;generate_joke&quot;</span><span class="p">,</span> <span class="n">generate_joke</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;best_joke&quot;</span><span class="p">,</span> <span class="n">best_joke</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;generate_topics&quot;</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;generate_topics&quot;</span><span class="p">,</span> <span class="n">continue_to_jokes</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;generate_joke&quot;</span><span class="p">])</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;generate_joke&quot;</span><span class="p">,</span> <span class="s2">&quot;best_joke&quot;</span><span class="p">)</span>
<span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;best_joke&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>

<span class="n">Image</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">())</span>
</code></pre></div>

<h2 id="use-the-graph">Use the graph<a class="headerlink" href="#use-the-graph" title="Permanent link">#</a></h2>
<div class="codehilite"><pre><span></span><code>#<span class="w"> </span><span class="k">Call</span><span class="w"> </span><span class="nl">the</span><span class="w"> </span><span class="nv">graph</span>:<span class="w"> </span><span class="nv">here</span><span class="w"> </span><span class="nv">we</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="nl">it</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">generate</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">list</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">jokes</span>
<span class="k">for</span><span class="w"> </span><span class="nv">s</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">app</span>.<span class="nv">stream</span><span class="ss">(</span>{<span class="s2">&quot;topic&quot;</span>:<span class="w"> </span><span class="s2">&quot;animals&quot;</span>}<span class="ss">)</span>:
<span class="w">    </span><span class="nv">print</span><span class="ss">(</span><span class="nv">s</span><span class="ss">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>{&#39;generate_topics&#39;: {&#39;subjects&#39;: [&#39;Lions&#39;, &#39;Elephants&#39;, &#39;Penguins&#39;, &#39;Dolphins&#39;]}}
{&#39;generate_joke&#39;: {&#39;jokes&#39;: [&quot;Why don&#39;t elephants use computers? They&#39;re afraid of the mouse!&quot;]}}
{&#39;generate_joke&#39;: {&#39;jokes&#39;: [&quot;Why don&#39;t dolphins use smartphones? Because they&#39;re afraid of phishing!&quot;]}}
{&#39;generate_joke&#39;: {&#39;jokes&#39;: [&quot;Why don&#39;t you see penguins in Britain? Because they&#39;re afraid of Wales!&quot;]}}
{&#39;generate_joke&#39;: {&#39;jokes&#39;: [&quot;Why don&#39;t lions like fast food? Because they can&#39;t catch it!&quot;]}}
{&#39;best_joke&#39;: {&#39;best_selected_joke&#39;: &quot;Why don&#39;t dolphins use smartphones? Because they&#39;re afraid of phishing!&quot;}}
</code></pre></div>

<h2 id="how-to-create-and-control-loops">How to create and control loops<a class="headerlink" href="#how-to-create-and-control-loops" title="Permanent link">#</a></h2>
<p>When creating a graph with a loop, we require a mechanism for terminating execution. This is most commonly done by adding a conditional edge that routes to the END node once we reach some termination condition.</p>
<p>You can also set the graph recursion limit when invoking or streaming the graph. The recursion limit sets the number of supersteps that the graph is allowed to execute before it raises an error. Read more about the concept of recursion limits here.</p>
<p>Let's consider a simple graph with a loop to better understand how these mechanisms work.</p>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">#</a></h2>
<p>When creating a loop, you can include a conditional edge that specifies a termination condition:</p>
<div class="codehilite"><pre><span></span><code><span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="n">def</span> <span class="n">route</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="kr">END</span><span class="p">]:</span>
    <span class="n">if</span> <span class="n">termination_condition</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
        <span class="n">return</span> <span class="kr">END</span>
    <span class="n">else</span><span class="p">:</span>
        <span class="n">return</span> <span class="s">&quot;a&quot;</span>

<span class="n">builder</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
<span class="n">builder</span><span class="p">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="p">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<p>To control the recursion limit, specify "recursion_limit" in the config. This will raise a GraphRecursionError, which you can catch and handle:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphRecursionError</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;recursion_limit&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="k">except</span> <span class="n">GraphRecursionError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recursion Error&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="define-the-graph_1">Define the graph<a class="headerlink" href="#define-the-graph_1" title="Permanent link">#</a></h2>
<p>Let's define a graph with a simple loop. Note that we use a conditional edge to implement a termination condition.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>


<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="c1"># The operator.add reducer fn makes this append-only</span>
    <span class="n">aggregate</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Node A sees </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">b</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Node B sees </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]}</span>


<span class="c1"># Define nodes</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>


<span class="c1"># Define edges</span>
<span class="k">def</span><span class="w"> </span><span class="nf">route</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;b&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">END</span>


<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>

<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">()))</span>
</code></pre></div>

<p>This architecture is similar to a ReAct agent in which node "a" is a tool-calling model, and node "b" represents the tools.</p>
<p>In our route conditional edge, we specify that we should end after the "aggregate" list in the state passes a threshold length.</p>
<p>Invoking the graph, we see that we alternate between nodes "a" and "b" before terminating once we reach the termination condition.</p>
<div class="codehilite"><pre><span></span><code><span class="n">graph</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span><span class="s">&quot;aggregate&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[]})</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Node A sees []
Node B sees [&#39;A&#39;]
Node A sees [&#39;A&#39;, &#39;B&#39;]
Node B sees [&#39;A&#39;, &#39;B&#39;, &#39;A&#39;]
Node A sees [&#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;]
Node B sees [&#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;]
Node A sees [&#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;]
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="p">{&#39;</span><span class="n">aggregate</span><span class="p">&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;B&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;A&#39;</span><span class="p">]}</span>
</code></pre></div>

<h2 id="impose-a-recursion-limit">Impose a recursion limit<a class="headerlink" href="#impose-a-recursion-limit" title="Permanent link">#</a></h2>
<p>In some applications, we may not have a guarantee that we will reach a given termination condition. In these cases, we can set the graph's recursion limit. This will raise a GraphRecursionError after a given number of supersteps. We can then catch and handle this exception:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphRecursionError</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[]},</span> <span class="p">{</span><span class="s2">&quot;recursion_limit&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
<span class="k">except</span> <span class="n">GraphRecursionError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recursion Error&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Node A sees []
Node B sees [&#39;A&#39;]
Node A sees [&#39;A&#39;, &#39;B&#39;]
Node B sees [&#39;A&#39;, &#39;B&#39;, &#39;A&#39;]
Recursion Error
</code></pre></div>

<h2 id="loops-with-branches">Loops with branches<a class="headerlink" href="#loops-with-branches" title="Permanent link">#</a></h2>
<p>To better understand how the recursion limit works, let's consider a more complex example. Below we implement a loop, but one step fans out into two nodes:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>


<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">aggregate</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Node A sees </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">b</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Node B sees </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Node C sees </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Node D sees </span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]}</span>


<span class="c1"># Define nodes</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>


<span class="c1"># Define edges</span>
<span class="k">def</span><span class="w"> </span><span class="nf">route</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;aggregate&quot;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;b&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">END</span>


<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">route</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">([</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;d&quot;</span><span class="p">],</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>

<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">()))</span>
</code></pre></div>

<p>This graph looks complex, but can be conceptualized as loop of supersteps:</p>
<ol>
<li>Node A</li>
<li>Node B</li>
<li>Nodes C and D</li>
<li>Node A</li>
<li>...
We have a loop of four supersteps, where nodes C and D are executed concurrently.</li>
</ol>
<p>Invoking the graph as before, we see that we complete two full "laps" before hitting the termination condition:</p>
<div class="codehilite"><pre><span></span><code><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">graph</span><span class="p">.</span><span class="n">invoke</span><span class="p">({</span><span class="s">&quot;aggregate&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[]})</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Node A sees []
Node B sees [&#39;A&#39;]
Node D sees [&#39;A&#39;, &#39;B&#39;]
Node C sees [&#39;A&#39;, &#39;B&#39;]
Node A sees [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;]
Node B sees [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;A&#39;]
Node D sees [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;A&#39;, &#39;B&#39;]
Node C sees [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;A&#39;, &#39;B&#39;]
Node A sees [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;]
</code></pre></div>

<p>However, if we set the recursion limit to four, we only complete one lap because each lap is four supersteps:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphRecursionError</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;aggregate&quot;</span><span class="p">:</span> <span class="p">[]},</span> <span class="p">{</span><span class="s2">&quot;recursion_limit&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
<span class="k">except</span> <span class="n">GraphRecursionError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recursion Error&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Node A sees []
Node B sees [&#39;A&#39;]
Node C sees [&#39;A&#39;, &#39;B&#39;]
Node D sees [&#39;A&#39;, &#39;B&#39;]
Node A sees [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;]
Recursion Error
</code></pre></div>

<h2 id="how-to-visualize-your-graph">How to visualize your graph<a class="headerlink" href="#how-to-visualize-your-graph" title="Permanent link">#</a></h2>
<h2 id="set-up-graph">Set up Graph<a class="headerlink" href="#set-up-graph" title="Permanent link">#</a></h2>
<p>You can visualize any arbitrary Graph, including StateGraph. Let's have some fun by drawing fractals :).</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph.message</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_messages</span>


<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">add_messages</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyNode</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Called node </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">route</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;entry_node&quot;</span><span class="p">,</span> <span class="s2">&quot;__end__&quot;</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;__end__&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;entry_node&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_fractal_nodes</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">current_node</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">max_level</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">max_level</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Number of nodes to create at this level</span>
    <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># Adjust randomness as needed</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_nodes</span><span class="p">):</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">node_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;node_</span><span class="si">{</span><span class="n">current_node</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">nm</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">MyNode</span><span class="p">(</span><span class="n">node_name</span><span class="p">))</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">current_node</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>

        <span class="c1"># Recursively add more nodes</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mf">0.2</span> <span class="ow">and</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">max_level</span><span class="p">:</span>
            <span class="n">add_fractal_nodes</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_level</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">node_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># End</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="s2">&quot;__end__&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_fractal_graph</span><span class="p">(</span><span class="n">max_level</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
    <span class="n">entry_point</span> <span class="o">=</span> <span class="s2">&quot;entry_node&quot;</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">entry_point</span><span class="p">,</span> <span class="n">MyNode</span><span class="p">(</span><span class="n">entry_point</span><span class="p">))</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">)</span>

    <span class="n">add_fractal_nodes</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_level</span><span class="p">)</span>

    <span class="c1"># Optional: set a finish point if required</span>
    <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">entry_point</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>  <span class="c1"># or any specific node</span>

    <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">build_fractal_graph</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>

<h2 id="mermaid">Mermaid<a class="headerlink" href="#mermaid" title="Permanent link">#</a></h2>
<p>We can also convert a graph class into Mermaid syntax.</p>
<div class="codehilite"><pre><span></span><code>print(app.get_graph().draw_mermaid())
</code></pre></div>

<div class="codehilite"><pre><span></span><code>%%{init:<span class="w"> </span>{&#39;flowchart&#39;:<span class="w"> </span>{&#39;curve&#39;:<span class="w"> </span>&#39;linear&#39;}}}%%
graph<span class="w"> </span>TD;
<span class="w">    </span>__start__([<span class="nt">&lt;p&gt;</span>__start__<span class="nt">&lt;/p&gt;</span>]):::first
<span class="w">    </span>entry_node(entry_node)
<span class="w">    </span>node_entry_node_A(node_entry_node_A)
<span class="w">    </span>node_entry_node_B(node_entry_node_B)
<span class="w">    </span>node_node_entry_node_B_A(node_node_entry_node_B_A)
<span class="w">    </span>node_node_entry_node_B_B(node_node_entry_node_B_B)
<span class="w">    </span>node_node_entry_node_B_C(node_node_entry_node_B_C)
<span class="w">    </span>__end__([<span class="nt">&lt;p&gt;</span>__end__<span class="nt">&lt;/p&gt;</span>]):::last
<span class="w">    </span>__start__<span class="w"> </span>--&gt;<span class="w"> </span>entry_node;
<span class="w">    </span>entry_node<span class="w"> </span>--&gt;<span class="w"> </span>__end__;
<span class="w">    </span>entry_node<span class="w"> </span>--&gt;<span class="w"> </span>node_entry_node_A;
<span class="w">    </span>entry_node<span class="w"> </span>--&gt;<span class="w"> </span>node_entry_node_B;
<span class="w">    </span>node_entry_node_B<span class="w"> </span>--&gt;<span class="w"> </span>node_node_entry_node_B_A;
<span class="w">    </span>node_entry_node_B<span class="w"> </span>--&gt;<span class="w"> </span>node_node_entry_node_B_B;
<span class="w">    </span>node_entry_node_B<span class="w"> </span>--&gt;<span class="w"> </span>node_node_entry_node_B_C;
<span class="w">    </span>node_entry_node_A<span class="w"> </span>-.-&gt;<span class="w"> </span>entry_node;
<span class="w">    </span>node_entry_node_A<span class="w"> </span>-.-&gt;<span class="w"> </span>__end__;
<span class="w">    </span>node_node_entry_node_B_A<span class="w"> </span>-.-&gt;<span class="w"> </span>entry_node;
<span class="w">    </span>node_node_entry_node_B_A<span class="w"> </span>-.-&gt;<span class="w"> </span>__end__;
<span class="w">    </span>node_node_entry_node_B_B<span class="w"> </span>-.-&gt;<span class="w"> </span>entry_node;
<span class="w">    </span>node_node_entry_node_B_B<span class="w"> </span>-.-&gt;<span class="w"> </span>__end__;
<span class="w">    </span>node_node_entry_node_B_C<span class="w"> </span>-.-&gt;<span class="w"> </span>entry_node;
<span class="w">    </span>node_node_entry_node_B_C<span class="w"> </span>-.-&gt;<span class="w"> </span>__end__;
<span class="w">    </span>classDef<span class="w"> </span>default<span class="w"> </span>fill:#f2f0ff,line-height:1.2
<span class="w">    </span>classDef<span class="w"> </span>first<span class="w"> </span>fill-opacity:0
<span class="w">    </span>classDef<span class="w"> </span>last<span class="w"> </span>fill:#bfb6fc
</code></pre></div>

<h2 id="png">PNG<a class="headerlink" href="#png" title="Permanent link">#</a></h2>
<p>If preferred, we could render the Graph into a .png. Here we could use three options:</p>
<ul>
<li>Using Mermaid.ink API (does not require additional packages)</li>
<li>Using Mermaid + Pyppeteer (requires pip install pyppeteer)</li>
<li>Using graphviz (which requires pip install graphviz)</li>
</ul>
<h2 id="using-mermaidink">Using Mermaid.Ink<a class="headerlink" href="#using-mermaidink" title="Permanent link">#</a></h2>
<p>By default, draw_mermaid_png() uses Mermaid.Ink's API to generate the diagram.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.runnables.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">CurveStyle</span><span class="p">,</span> <span class="n">MermaidDrawMethod</span><span class="p">,</span> <span class="n">NodeStyles</span>

<span class="n">display</span><span class="p">(</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">app</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">(</span>
            <span class="n">draw_method</span><span class="o">=</span><span class="n">MermaidDrawMethod</span><span class="o">.</span><span class="n">API</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<p><img alt="Mermaid" src="image/Mermaid.png" /></p>
<h2 id="using-mermaid-pyppeteer">Using Mermaid + Pyppeteer<a class="headerlink" href="#using-mermaid-pyppeteer" title="Permanent link">#</a></h2>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="nf">%capture</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="n">pyppeteer</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="n">nest_asyncio</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">nest_asyncio</span>

<span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>  <span class="c1"># Required for Jupyter Notebook to run async functions</span>

<span class="n">display</span><span class="p">(</span>
    <span class="n">Image</span><span class="p">(</span>
        <span class="n">app</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">(</span>
            <span class="n">curve_style</span><span class="o">=</span><span class="n">CurveStyle</span><span class="o">.</span><span class="n">LINEAR</span><span class="p">,</span>
            <span class="n">node_colors</span><span class="o">=</span><span class="n">NodeStyles</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="s2">&quot;#ffdfba&quot;</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="s2">&quot;#baffc9&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;#fad7de&quot;</span><span class="p">),</span>
            <span class="n">wrap_label_n_words</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
            <span class="n">output_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">draw_method</span><span class="o">=</span><span class="n">MermaidDrawMethod</span><span class="o">.</span><span class="n">PYPPETEER</span><span class="p">,</span>
            <span class="n">background_color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<p><img alt="Pyppeteer" src="image/Pyppeteer.png" /></p>
<h2 id="using-graphviz">Using Graphviz<a class="headerlink" href="#using-graphviz" title="Permanent link">#</a></h2>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="nf">%capture</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">pygraphviz</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="k">try</span><span class="o">:</span>
<span class="w">    </span><span class="n">display</span><span class="o">(</span><span class="n">Image</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="na">get_graph</span><span class="o">().</span><span class="n">draw_png</span><span class="o">()))</span>
<span class="n">except</span><span class="w"> </span><span class="n">ImportError</span><span class="o">:</span>
<span class="w">    </span><span class="n">print</span><span class="o">(</span>
<span class="w">        </span><span class="s2">&quot;You likely need to install dependencies for pygraphviz, see more here https://github.com/pygraphviz/pygraphviz/blob/main/INSTALL.txt&quot;</span>
<span class="w">    </span><span class="o">)</span>
</code></pre></div>

<p><img alt="Graphviz" src="image/Graphviz.png" /></p>
<h1 id="fine-grained-control">Fine-grained Control<a class="headerlink" href="#fine-grained-control" title="Permanent link">#</a></h1>
<h2 id="how-to-combine-control-flow-and-state-updates-with-command">How to combine control flow and state updates with Command<a class="headerlink" href="#how-to-combine-control-flow-and-state-updates-with-command" title="Permanent link">#</a></h2>
<p>It can be useful to combine control flow (edges) and state updates (nodes). For example, you might want to BOTH perform state updates AND decide which node to go to next in the SAME node. LangGraph provides a way to do so by returning a Command object from node functions:</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">my_node</span><span class="p">(</span><span class="n">state</span><span class="o">:</span><span class="w"> </span><span class="n">State</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Command</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s">&quot;my_other_node&quot;</span><span class="p">]]</span><span class="o">:</span>
<span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="n">Command</span><span class="p">(</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">update</span>
<span class="w">        </span><span class="n">update</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;foo&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;bar&quot;</span><span class="p">},</span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">control</span><span class="w"> </span><span class="n">flow</span>
<span class="w">        </span><span class="n">goto</span><span class="o">=</span><span class="s">&quot;my_other_node&quot;</span>
<span class="w">    </span><span class="p">)</span>
</code></pre></div>

<p>If you are using subgraphs, you might want to navigate from a node within a subgraph to a different subgraph (i.e. a different node in the parent graph). To do so, you can specify graph=Command.PARENT in Command:</p>
<div class="codehilite"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">my_node</span><span class="p">(</span><span class="n">state</span><span class="o">:</span><span class="w"> </span><span class="n">State</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Command</span><span class="err">[</span><span class="n">Literal</span><span class="err">[</span><span class="s2">&quot;my_other_node&quot;</span><span class="err">]]</span><span class="o">:</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Command</span><span class="p">(</span>
<span class="w">        </span><span class="k">update</span><span class="o">=</span><span class="err">{</span><span class="s2">&quot;foo&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;bar&quot;</span><span class="err">}</span><span class="p">,</span>
<span class="w">        </span><span class="n">goto</span><span class="o">=</span><span class="s2">&quot;other_subgraph&quot;</span><span class="p">,</span><span class="w">  </span><span class="c1"># where `other_subgraph` is a node in the parent graph</span>
<span class="w">        </span><span class="n">graph</span><span class="o">=</span><span class="n">Command</span><span class="p">.</span><span class="n">PARENT</span>
<span class="w">    </span><span class="p">)</span>
</code></pre></div>

<h2 id="how-to-add-node-retry-policies">How to add node retry policies<a class="headerlink" href="#how-to-add-node-retry-policies" title="Permanent link">#</a></h2>
<p>There are many use cases where you may wish for your node to have a custom retry policy, for example if you are calling an API, querying a database, or calling an LLM, etc.</p>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="nf">%capture</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">langgraph</span><span class="w"> </span><span class="n">langchain_anthropic</span><span class="w"> </span><span class="n">langchain_community</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_env</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>


<span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">)</span>
</code></pre></div>

<p>In order to configure the retry policy, you have to pass the retry parameter to the add_node. The retry parameter takes in a RetryPolicy named tuple object. Below we instantiate a RetryPolicy object with the default parameters:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.pregel</span><span class="w"> </span><span class="kn">import</span> <span class="n">RetryPolicy</span>

<span class="n">RetryPolicy</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>RetryPolicy(initial_interval=0.5, backoff_factor=2.0, max_interval=128.0, max_attempts=3, jitter=True, retry_on=&lt;function default_retry_on at 0x78b964b89940&gt;)
</code></pre></div>

<p>By default, the retry_on parameter uses the default_retry_on function, which retries on any exception except for the following:</p>
<ul>
<li>ValueError</li>
<li>TypeError</li>
<li>ArithmeticError</li>
<li>ImportError</li>
<li>LookupError</li>
<li>NameError</li>
<li>SyntaxError</li>
<li>RuntimeError</li>
<li>ReferenceError</li>
<li>StopIteration</li>
<li>StopAsyncIteration</li>
<li>OSError</li>
</ul>
<p>In addition, for exceptions from popular http request libraries such as requests and httpx it only retries on 5xx status codes.</p>
<h2 id="passing-a-retry-policy-to-a-node">Passing a retry policy to a node<a class="headerlink" href="#passing-a-retry-policy-to-a-node" title="Permanent link">#</a></h2>
<p>Lastly, we can pass RetryPolicy objects when we call the add_node function. In the example below we pass two different retry policies to each of our nodes:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatAnthropic</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseMessage</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">END</span><span class="p">,</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_community.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLDatabase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">AIMessage</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLDatabase</span><span class="o">.</span><span class="n">from_uri</span><span class="p">(</span><span class="s2">&quot;sqlite:///:memory:&quot;</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;claude-2.1&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AgentState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">messages</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">query_database</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="n">query_result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM Artist LIMIT 10;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">query_result</span><span class="p">)]}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">call_model</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">response</span><span class="p">]}</span>


<span class="c1"># Define a new graph</span>
<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">AgentState</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
    <span class="s2">&quot;query_database&quot;</span><span class="p">,</span>
    <span class="n">query_database</span><span class="p">,</span>
    <span class="n">retry</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span><span class="n">retry_on</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">call_model</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="n">RetryPolicy</span><span class="p">(</span><span class="n">max_attempts</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;query_database&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;query_database&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>

<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<h2 id="how-to-return-state-before-hitting-recursion-limit">How to return state before hitting recursion limit<a class="headerlink" href="#how-to-return-state-before-hitting-recursion-limit" title="Permanent link">#</a></h2>
<p>Setting the graph recursion limit can help you control how long your graph will stay running, but if the recursion limit is hit your graph returns an error - which may not be ideal for all use cases. Instead you may wish to return the value of the state just before the recursion limit is hit. This how-to will show you how to do this.</p>
<h2 id="without-returning-state">Without returning state<a class="headerlink" href="#without-returning-state" title="Permanent link">#</a></h2>
<p>We are going to define a dummy graph in this example that will always hit the recursion limit. First, we will implement it without returning the state and show that it hits the recursion limit. This graph is based on the ReAct architecture, but instead of actually making decisions and taking actions it just loops forever.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>


<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">action_result</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">def</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">END</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;action&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">decision_node</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;keep going!&quot;</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">action_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="c1"># Do your action here ...</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action_result&quot;</span><span class="p">:</span> <span class="s2">&quot;what a great result!&quot;</span><span class="p">}</span>


<span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;decision&quot;</span><span class="p">,</span> <span class="n">decision_node</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">action_node</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;decision&quot;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;decision&quot;</span><span class="p">,</span> <span class="n">router</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">])</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;decision&quot;</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">display</span>

<span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">get_graph</span><span class="p">()</span><span class="o">.</span><span class="n">draw_mermaid_png</span><span class="p">()))</span>
</code></pre></div>

<p>Let's verify that our graph will always hit the recursion limit:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">GraphRecursionError</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;hi!&quot;</span><span class="p">})</span>
<span class="k">except</span> <span class="n">GraphRecursionError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recursion Error&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Recursion Error
</code></pre></div>

<h2 id="with-returning-state">With returning state<a class="headerlink" href="#with-returning-state" title="Permanent link">#</a></h2>
<p>To avoid hitting the recursion limit, we can introduce a new key to our state called remaining_steps. It will keep track of number of steps until reaching the recursion limit. We can then check the value of remaining_steps to determine whether we should terminate the graph execution and return the state to the user without causing the RecursionError.</p>
<p>To do so, we will use a special RemainingSteps annotation. Under the hood, it creates a special ManagedValue channel -- a state channel that will exist for the duration of our graph run and no longer.</p>
<p>Since our action node is going to always induce at least 2 extra steps to our graph (since the action node ALWAYS calls the decision node afterwards), we will use this channel to check if we are within 2 steps of the limit.</p>
<p>Now, when we run our graph we should receive no errors and instead get the last value of the state before the recursion limit was hit.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.managed.is_last_step</span><span class="w"> </span><span class="kn">import</span> <span class="n">RemainingSteps</span>


<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">action_result</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">remaining_steps</span><span class="p">:</span> <span class="n">RemainingSteps</span>


<span class="k">def</span><span class="w"> </span><span class="nf">router</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="c1"># Force the agent to end</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;remaining_steps&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">END</span>
    <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">END</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;action&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">decision_node</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;keep going!&quot;</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">action_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="c1"># Do your action here ...</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;action_result&quot;</span><span class="p">:</span> <span class="s2">&quot;what a great result!&quot;</span><span class="p">}</span>


<span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;decision&quot;</span><span class="p">,</span> <span class="n">decision_node</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">action_node</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;decision&quot;</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;decision&quot;</span><span class="p">,</span> <span class="n">router</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">])</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;decision&quot;</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>app.invoke({&quot;value&quot;: &quot;hi!&quot;})
</code></pre></div>

<div class="codehilite"><pre><span></span><code>{&#39;value&#39;: &#39;keep going!&#39;, &#39;action_result&#39;: &#39;what a great result!&#39;}
</code></pre></div>

<h2 id="persistence_1">Persistence<a class="headerlink" href="#persistence_1" title="Permanent link">#</a></h2>
<p>LangGraph Persistence makes it easy to persist state across graph runs (per-thread persistence) and across threads (cross-thread persistence). These how-to guides show how to add persistence to your graph.</p>
<h2 id="how-to-add-thread-level-persistence-to-your-graph">How to add thread-level persistence to your graph<a class="headerlink" href="#how-to-add-thread-level-persistence-to-your-graph" title="Permanent link">#</a></h2>
<p>Many AI applications need memory to share context across multiple interactions. In LangGraph, this kind of memory can be added to any StateGraph using thread-level persistence .</p>
<p>When creating any LangGraph graph, you can set it up to persist its state by adding a checkpointer when compiling the graph:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemorySaver</span>

<span class="n">checkpointer</span> <span class="o">=</span> <span class="n">MemorySaver</span><span class="p">()</span>
<span class="n">graph</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">)</span>
</code></pre></div>

<p><strong>Note:</strong> If you need memory that is shared across multiple conversations or users (cross-thread persistence), check out this how-to guide.</p>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="nf">%capture</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">langgraph</span><span class="w"> </span><span class="n">langchain_anthropic</span>
</code></pre></div>

<p>Next, we need to set API key for Anthropic (the LLM we will use).</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_env</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>


<span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="define-graph">Define graph<a class="headerlink" href="#define-graph" title="Permanent link">#</a></h2>
<p>We will be using a single-node graph that calls a chat model.</p>
<p>Let's first define the model we'll be using:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatAnthropic</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-5-sonnet-20240620&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Now we can define our StateGraph and add our model-calling node:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">MessagesState</span><span class="p">,</span> <span class="n">START</span>


<span class="k">def</span><span class="w"> </span><span class="nf">call_model</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">MessagesState</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>


<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">MessagesState</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;call_model&quot;</span><span class="p">,</span> <span class="n">call_model</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;call_model&quot;</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
</code></pre></div>

<p>If we try to use this graph, the context of the conversation will not be persisted across interactions:</p>
<div class="codehilite"><pre><span></span><code><span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;hi! I&#39;m bob&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">graph</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="err">{</span><span class="ss">&quot;messages&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="o">[</span><span class="n">&quot;messages&quot;</span><span class="o">][</span><span class="n">-1</span><span class="o">]</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>

<span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;what&#39;s my name?&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">graph</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="err">{</span><span class="ss">&quot;messages&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="o">[</span><span class="n">&quot;messages&quot;</span><span class="o">][</span><span class="n">-1</span><span class="o">]</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="o">================================</span>[<span class="mi">1</span><span class="nv">m</span><span class="w"> </span><span class="nv">Human</span><span class="w"> </span><span class="nv">Message</span><span class="w"> </span>[<span class="mi">0</span><span class="nv">m</span><span class="o">=================================</span>

<span class="nv">hi</span><span class="o">!</span><span class="w"> </span><span class="nv">I</span><span class="err">&#39;m bob</span>
<span class="err">==================================[1m Ai Message [0m==================================</span>

<span class="nv">Hello</span><span class="w"> </span><span class="nv">Bob</span><span class="o">!</span><span class="w"> </span><span class="nv">It</span><span class="err">&#39;s nice to meet you. How are you doing today? Is there anything I can help you with or would you like to chat about something in particular?</span>
<span class="err">================================[1m Human Message [0m=================================</span>

<span class="nv">what</span><span class="err">&#39;s my name?</span>
<span class="err">==================================[1m Ai Message [0m==================================</span>

<span class="nv">I</span><span class="w"> </span><span class="nv">apologize</span>,<span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="nv">don</span><span class="s1">&#39;t have access to your personal information, including your name. I&#39;</span><span class="nv">m</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">AI</span><span class="w"> </span><span class="nv">language</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="nv">designed</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">provide</span><span class="w"> </span><span class="nv">general</span><span class="w"> </span><span class="nv">information</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">answer</span><span class="w"> </span><span class="nv">questions</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">best</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">my</span><span class="w"> </span><span class="nv">ability</span><span class="w"> </span><span class="nv">based</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">my</span><span class="w"> </span><span class="nv">training</span><span class="w"> </span><span class="nv">data</span>.<span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="nv">don</span><span class="s1">&#39;t have any information about individual users or their personal details. If you&#39;</span><span class="nv">d</span><span class="w"> </span><span class="nv">like</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">share</span><span class="w"> </span><span class="nv">your</span><span class="w"> </span><span class="nv">name</span>,<span class="w"> </span><span class="nv">you</span><span class="s1">&#39;re welcome to do so, but I won&#39;</span><span class="nv">t</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">able</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">recall</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">future</span><span class="w"> </span><span class="nv">conversations</span>.
</code></pre></div>

<h2 id="add-persistence">Add persistence<a class="headerlink" href="#add-persistence" title="Permanent link">#</a></h2>
<p>To add in persistence, we need to pass in a Checkpointer when compiling the graph.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemorySaver</span>

<span class="n">memory</span> <span class="o">=</span> <span class="n">MemorySaver</span><span class="p">()</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
<span class="c1"># If you&#39;re using LangGraph Cloud or LangGraph Studio, you don&#39;t need to pass the checkpointer when compiling the graph, since it&#39;s done automatically.</span>
</code></pre></div>

<p>We can now interact with the agent and see that it remembers previous messages!</p>
<div class="codehilite"><pre><span></span><code><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;configurable&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;thread_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;1&quot;</span><span class="err">}}</span>
<span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;hi! I&#39;m bob&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">graph</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="err">{</span><span class="ss">&quot;messages&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="o">[</span><span class="n">&quot;messages&quot;</span><span class="o">][</span><span class="n">-1</span><span class="o">]</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<p>You can always resume previous threads:</p>
<div class="codehilite"><pre><span></span><code><span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;what&#39;s my name?&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">graph</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="err">{</span><span class="ss">&quot;messages&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="o">[</span><span class="n">&quot;messages&quot;</span><span class="o">][</span><span class="n">-1</span><span class="o">]</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>================================[1m Human Message [0m=================================

what&#39;s my name?
==================================[1m Ai Message [0m==================================

Your name is Bob, as you introduced yourself at the beginning of our conversation.
</code></pre></div>

<p>If we want to start a new conversation, we can pass in a different thread_id. Poof! All the memories are gone!</p>
<div class="codehilite"><pre><span></span><code><span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;what&#39;s my name?&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">graph</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span>
<span class="w">    </span><span class="err">{</span><span class="ss">&quot;messages&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="err">}</span><span class="p">,</span>
<span class="w">    </span><span class="err">{</span><span class="ss">&quot;configurable&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;thread_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;2&quot;</span><span class="err">}}</span><span class="p">,</span>
<span class="w">    </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">,</span>
<span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="o">[</span><span class="n">&quot;messages&quot;</span><span class="o">][</span><span class="n">-1</span><span class="o">]</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="o">================================</span>[<span class="mi">1</span><span class="nv">m</span><span class="w"> </span><span class="nv">Human</span><span class="w"> </span><span class="nv">Message</span><span class="w"> </span>[<span class="mi">0</span><span class="nv">m</span><span class="o">=================================</span>

<span class="nv">what</span><span class="err">&#39;s is my name?</span>
<span class="err">==================================[1m Ai Message [0m==================================</span>

<span class="nv">I</span><span class="w"> </span><span class="nv">apologize</span>,<span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="nv">don</span><span class="s1">&#39;t have access to your personal information, including your name. As an AI language model, I don&#39;</span><span class="nv">t</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">any</span><span class="w"> </span><span class="nv">information</span><span class="w"> </span><span class="nv">about</span><span class="w"> </span><span class="nv">individual</span><span class="w"> </span><span class="nv">users</span><span class="w"> </span><span class="nv">unless</span><span class="w"> </span><span class="nv">it</span><span class="s1">&#39;s provided within the conversation. If you&#39;</span><span class="nv">d</span><span class="w"> </span><span class="nv">like</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">share</span><span class="w"> </span><span class="nv">your</span><span class="w"> </span><span class="nv">name</span>,<span class="w"> </span><span class="nv">you</span><span class="s1">&#39;re welcome to do so, but otherwise, I won&#39;</span><span class="nv">t</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">able</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">know</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">guess</span><span class="w"> </span><span class="nv">it</span>.
</code></pre></div>

<h2 id="how-to-add-thread-level-persistence-to-a-subgraph">How to add thread-level persistence to a subgraph<a class="headerlink" href="#how-to-add-thread-level-persistence-to-a-subgraph" title="Permanent link">#</a></h2>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="nf">%capture</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">langgraph</span>
</code></pre></div>

<h2 id="define-the-graph-with-persistence">Define the graph with persistence<a class="headerlink" href="#define-the-graph-with-persistence" title="Permanent link">#</a></h2>
<p>To add persistence to a graph with subgraphs, all you need to do is pass a checkpointer when compiling the parent graph. LangGraph will automatically propagate the checkpointer to the child subgraphs.</p>
<p><strong>Note:</strong> You shouldn't provide a checkpointer when compiling a subgraph. Instead, you must define a single checkpointer that you pass to parent_graph.compile(), and LangGraph will automatically propagate the checkpointer to the child subgraphs. If you pass the checkpointer to the subgraph.compile(), it will simply be ignored. This also applies when you add a node function that invokes the subgraph.</p>
<p>Let's define a simple graph with a single subgraph node to show how to do this.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">START</span><span class="p">,</span> <span class="n">StateGraph</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemorySaver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>


<span class="c1"># subgraph</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SubgraphState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">foo</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># note that this key is shared with the parent graph state</span>
    <span class="n">bar</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">def</span><span class="w"> </span><span class="nf">subgraph_node_1</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">SubgraphState</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;bar&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">subgraph_node_2</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">SubgraphState</span><span class="p">):</span>
    <span class="c1"># note that this node is using a state key (&#39;bar&#39;) that is only available in the subgraph</span>
    <span class="c1"># and is sending update on the shared state key (&#39;foo&#39;)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">]}</span>


<span class="n">subgraph_builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">SubgraphState</span><span class="p">)</span>
<span class="n">subgraph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">subgraph_node_1</span><span class="p">)</span>
<span class="n">subgraph_builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">subgraph_node_2</span><span class="p">)</span>
<span class="n">subgraph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;subgraph_node_1&quot;</span><span class="p">)</span>
<span class="n">subgraph_builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;subgraph_node_1&quot;</span><span class="p">,</span> <span class="s2">&quot;subgraph_node_2&quot;</span><span class="p">)</span>
<span class="n">subgraph</span> <span class="o">=</span> <span class="n">subgraph_builder</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>


<span class="c1"># parent graph</span>


<span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">foo</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">def</span><span class="w"> </span><span class="nf">node_1</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;hi! &quot;</span> <span class="o">+</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]}</span>


<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">State</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;node_1&quot;</span><span class="p">,</span> <span class="n">node_1</span><span class="p">)</span>
<span class="c1"># note that we&#39;re adding the compiled subgraph as a node to the parent graph</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;node_2&quot;</span><span class="p">,</span> <span class="n">subgraph</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;node_1&quot;</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;node_1&quot;</span><span class="p">,</span> <span class="s2">&quot;node_2&quot;</span><span class="p">)</span>
</code></pre></div>

<p>We can now compile the graph with an in-memory checkpointer (MemorySaver).</p>
<div class="codehilite"><pre><span></span><code>checkpointer = MemorySaver()
# You must only pass checkpointer when compiling the parent graph.
# LangGraph will automatically propagate the checkpointer to the child subgraphs.
graph = builder.compile(checkpointer=checkpointer)
</code></pre></div>

<h2 id="verify-persistence-works">Verify persistence works<a class="headerlink" href="#verify-persistence-works" title="Permanent link">#</a></h2>
<p>Let's now run the graph and inspect the persisted state for both the parent graph and the subgraph to verify that persistence works. We should expect to see the final execution results for both the parent and subgraph in state.values.</p>
<div class="codehilite"><pre><span></span><code>config = {&quot;configurable&quot;: {&quot;thread_id&quot;: &quot;1&quot;}}
</code></pre></div>

<div class="codehilite"><pre><span></span><code>for _, chunk in graph.stream({&quot;foo&quot;: &quot;foo&quot;}, config, subgraphs=True):
    print(chunk)
</code></pre></div>

<div class="codehilite"><pre><span></span><code>{&#39;node_1&#39;: {&#39;foo&#39;: &#39;hi! foo&#39;}}
{&#39;subgraph_node_1&#39;: {&#39;bar&#39;: &#39;bar&#39;}}
{&#39;subgraph_node_2&#39;: {&#39;foo&#39;: &#39;hi! foobar&#39;}}
{&#39;node_2&#39;: {&#39;foo&#39;: &#39;hi! foobar&#39;}}
</code></pre></div>

<p>We can now view the parent graph state by calling graph.get_state() with the same config that we used to invoke the graph.</p>
<div class="codehilite"><pre><span></span><code>graph.get_state(config).values
</code></pre></div>

<div class="codehilite"><pre><span></span><code>{&#39;foo&#39;: &#39;hi! foobar&#39;}
</code></pre></div>

<p>To view the subgraph state, we need to do two things:</p>
<ol>
<li>Find the most recent config value for the subgraph</li>
<li>Use graph.get_state() to retrieve that value for the most recent subgraph config.</li>
</ol>
<p>To find the correct config, we can examine the state history from the parent graph and find the state snapshot before we return results from node_2 (the node with subgraph):</p>
<div class="codehilite"><pre><span></span><code>state_with_subgraph = [
    s for s in graph.get_state_history(config) if s.next == (&quot;node_2&quot;,)
][0]
</code></pre></div>

<p>The state snapshot will include the list of tasks to be executed next. When using subgraphs, the tasks will contain the config that we can use to retrieve the subgraph state:</p>
<div class="codehilite"><pre><span></span><code>subgraph_config = state_with_subgraph.tasks[0].state
subgraph_config
</code></pre></div>

<div class="codehilite"><pre><span></span><code>{&#39;configurable&#39;: {&#39;thread_id&#39;: &#39;1&#39;,
  &#39;checkpoint_ns&#39;: &#39;node_2:6ef111a6-f290-7376-0dfc-a4152307bc5b&#39;}}
</code></pre></div>

<div class="codehilite"><pre><span></span><code>graph.get_state(subgraph_config).values
</code></pre></div>

<div class="codehilite"><pre><span></span><code>{&#39;foo&#39;: &#39;hi! foobar&#39;, &#39;bar&#39;: &#39;bar&#39;}
</code></pre></div>

<h2 id="how-to-add-cross-thread-persistence-to-your-graph">How to add cross-thread persistence to your graph<a class="headerlink" href="#how-to-add-cross-thread-persistence-to-your-graph" title="Permanent link">#</a></h2>
<p>In the previous guide you learned how to persist graph state across multiple interactions on a single thread. LangGraph also allows you to persist data across multiple threads. For instance, you can store information about users (their names or preferences) in a shared memory and reuse them in the new conversational threads.</p>
<p>In this guide, we will show how to construct and use a graph that has a shared memory implemented using the Store interface.</p>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="nf">%capture</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">langchain_openai</span><span class="w"> </span><span class="n">langgraph</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_env</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>


<span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">)</span>
<span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="define-store">Define store<a class="headerlink" href="#define-store" title="Permanent link">#</a></h2>
<p>In this example we will create a graph that will be able to retrieve information about a user's preferences. We will do so by defining an InMemoryStore - an object that can store data in memory and query that data. We will then pass the store object when compiling the graph. This allows each node in the graph to access the store: when you define node functions, you can define store keyword argument, and LangGraph will automatically pass the store object you compiled the graph with.</p>
<p>When storing objects using the Store interface you define two things:</p>
<ul>
<li>the namespace for the object, a tuple (similar to directories)</li>
<li>the object key (similar to filenames)</li>
</ul>
<p>In our example, we'll be using ("memories", <user_id>) as namespace and random UUID as key for each new memory.</p>
<p>Importantly, to determine the user, we will be passing user_id via the config keyword argument of the node function.</p>
<p>Let's first define an InMemoryStore already populated with some memories about the users.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.store.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>

<span class="n">in_memory_store</span> <span class="o">=</span> <span class="n">InMemoryStore</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;embed&quot;</span><span class="p">:</span> <span class="n">OpenAIEmbeddings</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">),</span>
        <span class="s2">&quot;dims&quot;</span><span class="p">:</span> <span class="mi">1536</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="create-graph">Create graph<a class="headerlink" href="#create-graph" title="Permanent link">#</a></h2>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypedDict</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatAnthropic</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.runnables</span><span class="w"> </span><span class="kn">import</span> <span class="n">RunnableConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">MessagesState</span><span class="p">,</span> <span class="n">START</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemorySaver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.store.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseStore</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-5-sonnet-20240620&quot;</span><span class="p">)</span>


<span class="c1"># NOTE: we&#39;re passing the Store param to the node --</span>
<span class="c1"># this is the Store we compile the graph with</span>
<span class="k">def</span><span class="w"> </span><span class="nf">call_model</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">MessagesState</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;memories&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">memories</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
    <span class="n">info</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">])</span>
    <span class="n">system_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;You are a helpful assistant talking to the user. User info: </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Store new memories if the user asks the model to remember</span>
    <span class="n">last_message</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;remember&quot;</span> <span class="ow">in</span> <span class="n">last_message</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="s2">&quot;User name is Bob&quot;</span>
        <span class="n">store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">memory</span><span class="p">})</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
        <span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">}]</span> <span class="o">+</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>


<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">MessagesState</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;call_model&quot;</span><span class="p">,</span> <span class="n">call_model</span><span class="p">)</span>
<span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;call_model&quot;</span><span class="p">)</span>

<span class="c1"># NOTE: we&#39;re passing the store object here when compiling the graph</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">MemorySaver</span><span class="p">(),</span> <span class="n">store</span><span class="o">=</span><span class="n">in_memory_store</span><span class="p">)</span>
<span class="c1"># If you&#39;re using LangGraph Cloud or LangGraph Studio, you don&#39;t need to pass the store or checkpointer when compiling the graph, since it&#39;s done automatically.</span>
</code></pre></div>

<h2 id="run-the-graph">Run the graph!<a class="headerlink" href="#run-the-graph" title="Permanent link">#</a></h2>
<p>Now let's specify a user ID in the config and tell the model our name:</p>
<div class="codehilite"><pre><span></span><code><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;configurable&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;thread_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;user_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;1&quot;</span><span class="err">}}</span>
<span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;Hi! Remember: my name is Bob&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">graph</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="err">{</span><span class="ss">&quot;messages&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="o">[</span><span class="n">&quot;messages&quot;</span><span class="o">][</span><span class="n">-1</span><span class="o">]</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>================================[1m Human Message [0m=================================

Hi! Remember: my name is Bob
==================================[1m Ai Message [0m==================================

Hello Bob! It&#39;s nice to meet you. I&#39;ll remember that your name is Bob. How can I assist you today?
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;configurable&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;thread_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;2&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;user_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;1&quot;</span><span class="err">}}</span>
<span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;what is my name?&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">graph</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="err">{</span><span class="ss">&quot;messages&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="o">[</span><span class="n">&quot;messages&quot;</span><span class="o">][</span><span class="n">-1</span><span class="o">]</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>================================[1m Human Message [0m=================================

what is my name?
==================================[1m Ai Message [0m==================================

Your name is Bob.
</code></pre></div>

<p>We can now inspect our in-memory store and verify that we have in fact saved the memories for the user:</p>
<div class="codehilite"><pre><span></span><code>for memory in in_memory_store.search((&quot;memories&quot;, &quot;1&quot;)):
    print(memory.value)
</code></pre></div>

<div class="codehilite"><pre><span></span><code>{&#39;data&#39;: &#39;User name is Bob&#39;}
</code></pre></div>

<p>Let's now run the graph for another user to verify that the memories about the first user are self contained:</p>
<div class="codehilite"><pre><span></span><code><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;configurable&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;thread_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;3&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;user_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;2&quot;</span><span class="err">}}</span>
<span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;what is my name?&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">graph</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="err">{</span><span class="ss">&quot;messages&quot;</span><span class="err">:</span><span class="w"> </span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="err">}</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="o">[</span><span class="n">&quot;messages&quot;</span><span class="o">][</span><span class="n">-1</span><span class="o">]</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="o">================================</span>[<span class="mi">1</span><span class="nv">m</span><span class="w"> </span><span class="nv">Human</span><span class="w"> </span><span class="nv">Message</span><span class="w"> </span>[<span class="mi">0</span><span class="nv">m</span><span class="o">=================================</span>

<span class="nv">what</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">my</span><span class="w"> </span><span class="nv">name</span>?
<span class="o">==================================</span>[<span class="mi">1</span><span class="nv">m</span><span class="w"> </span><span class="nv">Ai</span><span class="w"> </span><span class="nv">Message</span><span class="w"> </span>[<span class="mi">0</span><span class="nv">m</span><span class="o">==================================</span>

<span class="nv">I</span><span class="w"> </span><span class="nv">apologize</span>,<span class="w"> </span><span class="nv">but</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="nv">don</span><span class="s1">&#39;t have any information about your name. As an AI assistant, I don&#39;</span><span class="nv">t</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">access</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">personal</span><span class="w"> </span><span class="nv">information</span><span class="w"> </span><span class="nv">about</span><span class="w"> </span><span class="nv">users</span><span class="w"> </span><span class="nv">unless</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">has</span><span class="w"> </span><span class="nv">been</span><span class="w"> </span><span class="nv">specifically</span><span class="w"> </span><span class="nv">shared</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">our</span><span class="w"> </span><span class="nv">conversation</span>.<span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">you</span><span class="s1">&#39;d like, you can tell me your name and I&#39;</span><span class="nv">ll</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">happy</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">use</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">our</span><span class="w"> </span><span class="nv">discussion</span>.
</code></pre></div>

<h1 id="how-to-use-postgres-checkpointer-for-persistence">How to use Postgres checkpointer for persistence<a class="headerlink" href="#how-to-use-postgres-checkpointer-for-persistence" title="Permanent link">#</a></h1>
<p>When creating LangGraph agents, you can also set them up so that they persist their state. This allows you to do things like interact with an agent multiple times and have it remember previous interactions.</p>
<p>This how-to guide shows how to use Postgres as the backend for persisting checkpoint state using the <strong>langgraph-checkpoint-postgres</strong> library.</p>
<p>For demonstration purposes we add persistence to the pre-built create react agent.</p>
<p>In general, you can add a checkpointer to any custom graph that you build like this:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateGraph</span>

<span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="o">....</span><span class="p">)</span>
<span class="c1"># ... define the graph</span>
<span class="n">checkpointer</span> <span class="o">=</span> <span class="c1"># postgres checkpointer (see examples below)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">)</span>
<span class="o">...</span>
</code></pre></div>

<h2 id="setup_1">Setup<a class="headerlink" href="#setup_1" title="Permanent link">#</a></h2>
<p>You will need access to a postgres instance. 
Next, let's install the required packages and set our API keys</p>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="nf">%capture</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">psycopg</span><span class="w"> </span><span class="n">psycopg</span><span class="o">-</span><span class="n">pool</span><span class="w"> </span><span class="n">langgraph</span><span class="w"> </span><span class="n">langgraph</span><span class="o">-</span><span class="n">checkpoint</span><span class="o">-</span><span class="n">postgres</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_env</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>


<span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="define-model-and-tools-for-the-graph">Define model and tools for the graph<a class="headerlink" href="#define-model-and-tools-for-the-graph" title="Permanent link">#</a></h2>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">tool</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatOpenAI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.prebuilt</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_react_agent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.postgres</span><span class="w"> </span><span class="kn">import</span> <span class="n">PostgresSaver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.postgres.aio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncPostgresSaver</span>


<span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_weather</span><span class="p">(</span><span class="n">city</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;nyc&quot;</span><span class="p">,</span> <span class="s2">&quot;sf&quot;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use this to get weather information.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">city</span> <span class="o">==</span> <span class="s2">&quot;nyc&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;It might be cloudy in nyc&quot;</span>
    <span class="k">elif</span> <span class="n">city</span> <span class="o">==</span> <span class="s2">&quot;sf&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;It&#39;s always sunny in sf&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;Unknown city&quot;</span><span class="p">)</span>


<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_weather</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>

<h2 id="use-sync-connection">Use sync connection<a class="headerlink" href="#use-sync-connection" title="Permanent link">#</a></h2>
<p>This sets up a synchronous connection to the database.</p>
<p>Synchronous connections execute operations in a blocking manner, meaning each operation waits for completion before moving to the next one. The DB_URI is the database connection URI, with the protocol used for connecting to a PostgreSQL database, authentication, and host where database is running. The connection_kwargs dictionary defines additional parameters for the database connection.</p>
<div class="codehilite"><pre><span></span><code><span class="n">DB_URI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;postgresql://postgres:postgres@localhost:5442/postgres?sslmode=disable&quot;</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>connection_kwargs = {
    &quot;autocommit&quot;: True,
    &quot;prepare_threshold&quot;: 0,
}
</code></pre></div>

<h2 id="with-a-connection-pool">With a connection pool<a class="headerlink" href="#with-a-connection-pool" title="Permanent link">#</a></h2>
<p>This manages a pool of reusable database connections: - Advantages: Efficient resource utilization, improved performance for frequent connections - Best for: Applications with many short-lived database operations</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">psycopg_pool</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConnectionPool</span>

<span class="k">with</span> <span class="n">ConnectionPool</span><span class="p">(</span>
    <span class="c1"># Example configuration</span>
    <span class="n">conninfo</span><span class="o">=</span><span class="n">DB_URI</span><span class="p">,</span>
    <span class="n">max_size</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">kwargs</span><span class="o">=</span><span class="n">connection_kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">checkpointer</span> <span class="o">=</span> <span class="n">PostgresSaver</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>

    <span class="c1"># NOTE: you need to call .setup() the first time you&#39;re using your checkpointer</span>
    <span class="n">checkpointer</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

    <span class="n">graph</span> <span class="o">=</span> <span class="n">create_react_agent</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">}}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="s2">&quot;what&#39;s the weather in sf&quot;</span><span class="p">)]},</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">checkpointer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>res
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="p">{</span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">HumanMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="s">&quot;what&#39;s the weather in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="mi">735</span><span class="nx">b7deb</span><span class="o">-</span><span class="nx">b0fe</span><span class="o">-</span><span class="mi">4</span><span class="nx">ad5</span><span class="o">-</span><span class="mi">8920</span><span class="o">-</span><span class="mi">2</span><span class="nx">a3c69bbe9f7</span><span class="err">&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">AIMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">additional_kwargs</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_lJHMDYgfgRdiEAGfFsEhqqKV</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">arguments</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;city&quot;</span><span class="p">:</span><span class="s">&quot;sf&quot;</span><span class="p">}</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">}]},</span><span class="w"> </span><span class="nx">response_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">token_usage</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">completion_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">prompt_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">model_name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">gpt</span><span class="o">-</span><span class="mi">4</span><span class="nx">o</span><span class="o">-</span><span class="nx">mini</span><span class="o">-</span><span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">18</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">system_fingerprint</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">fp_48196bc67a</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finish_reason</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">logprobs</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">},</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">run</span><span class="o">-</span><span class="nx">c56b3e04</span><span class="o">-</span><span class="mi">08</span><span class="nx">a9</span><span class="o">-</span><span class="mi">4</span><span class="nx">a59</span><span class="o">-</span><span class="nx">b3f5</span><span class="o">-</span><span class="nx">ee52d0ef0656</span><span class="o">-</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tool_calls</span><span class="p">=[{</span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">args</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">city</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">sf</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_lJHMDYgfgRdiEAGfFsEhqqKV</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_call</span><span class="err">&#39;</span><span class="p">}],</span><span class="w"> </span><span class="nx">usage_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">input_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">output_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">}),</span>
<span class="w">  </span><span class="nx">ToolMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="s">&quot;It&#39;s always sunny in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="mi">0644</span><span class="nx">bf7b</span><span class="o">-</span><span class="mi">4</span><span class="nx">d1b</span><span class="o">-</span><span class="mi">4</span><span class="nx">ebe</span><span class="o">-</span><span class="nx">afa1</span><span class="o">-</span><span class="nx">d2169ccce582</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tool_call_id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">call_lJHMDYgfgRdiEAGfFsEhqqKV</span><span class="err">&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">AIMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">The</span><span class="w"> </span><span class="nx">weather</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">San</span><span class="w"> </span><span class="nx">Francisco</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">always</span><span class="w"> </span><span class="nx">sunny</span><span class="p">!</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">response_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">token_usage</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">completion_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">prompt_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">model_name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">gpt</span><span class="o">-</span><span class="mi">4</span><span class="nx">o</span><span class="o">-</span><span class="nx">mini</span><span class="o">-</span><span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">18</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">system_fingerprint</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">fp_48196bc67a</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finish_reason</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">stop</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">logprobs</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">},</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">run</span><span class="o">-</span><span class="mi">1</span><span class="nx">ed9b8d0</span><span class="o">-</span><span class="mi">9</span><span class="nx">b50</span><span class="o">-</span><span class="mi">4</span><span class="nx">b87</span><span class="o">-</span><span class="nx">b3a2</span><span class="o">-</span><span class="mi">9860</span><span class="nx">f51e9fd1</span><span class="o">-</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">usage_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">input_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">output_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">})]}</span>
<span class="w">  </span><span class="err">```</span>

<span class="w">  </span><span class="err">```</span>
<span class="w">  </span><span class="nx">checkpoint</span>
<span class="w">  </span><span class="err">```</span>

<span class="w">  </span><span class="err">```</span>
<span class="w">  </span><span class="p">{</span><span class="sc">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">3</span><span class="nx">b19</span><span class="o">-</span><span class="mi">6</span><span class="nx">ce8</span><span class="o">-</span><span class="mi">8003</span><span class="o">-</span><span class="mi">18</span><span class="nx">d0f60634be</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w"> </span><span class="err">&#39;</span><span class="nx">ts</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span><span class="nx">T15</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="m m-Double">42.108605</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w"> </span><span class="err">&#39;</span><span class="nx">current_tasks</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w"> </span><span class="err">&#39;</span><span class="nx">pending_sends</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w"> </span><span class="err">&#39;</span><span class="nx">versions_seen</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000004.022986</span><span class="nx">cd20ae85c77ea298a383f69ba8</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">   </span><span class="err">&#39;</span><span class="nx">start</span><span class="p">:</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000002</span><span class="p">.</span><span class="nx">d6f25946c3108fc12f27abbcf9b4cedc</span><span class="err">&#39;</span><span class="p">},</span>
<span class="w">  </span><span class="err">&#39;</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">branch</span><span class="p">:</span><span class="nx">agent</span><span class="p">:</span><span class="nx">should_continue</span><span class="p">:</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000003.065</span><span class="nx">d90dd7f7cd091f0233855210bb2af</span><span class="err">&#39;</span><span class="p">},</span>
<span class="w">  </span><span class="err">&#39;</span><span class="nx">__input__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">  </span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000001</span><span class="p">.</span><span class="nx">ab89befb52cc0e91e106ef7f500ea033</span><span class="err">&#39;</span><span class="p">}},</span>
<span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_versions</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000005.065</span><span class="nx">d90dd7f7cd091f0233855210bb2af</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="err">&#39;</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000005</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000005</span><span class="p">.</span><span class="nx">b9adc75836c78af94af1d6811340dd13</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000002</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="err">&#39;</span><span class="nx">start</span><span class="p">:</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000003</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="err">&#39;</span><span class="nx">branch</span><span class="p">:</span><span class="nx">agent</span><span class="p">:</span><span class="nx">should_continue</span><span class="p">:</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000004</span><span class="p">.</span><span class="err">&#39;</span><span class="p">},</span>
<span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_values</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">HumanMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="s">&quot;what&#39;s the weather in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="mi">735</span><span class="nx">b7deb</span><span class="o">-</span><span class="nx">b0fe</span><span class="o">-</span><span class="mi">4</span><span class="nx">ad5</span><span class="o">-</span><span class="mi">8920</span><span class="o">-</span><span class="mi">2</span><span class="nx">a3c69bbe9f7</span><span class="err">&#39;</span><span class="p">),</span>
<span class="w">   </span><span class="nx">AIMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">additional_kwargs</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_lJHMDYgfgRdiEAGfFsEhqqKV</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">arguments</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;city&quot;</span><span class="p">:</span><span class="s">&quot;sf&quot;</span><span class="p">}</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">}]},</span><span class="w"> </span><span class="nx">response_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">token_usage</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">completion_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">prompt_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">model_name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">gpt</span><span class="o">-</span><span class="mi">4</span><span class="nx">o</span><span class="o">-</span><span class="nx">mini</span><span class="o">-</span><span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">18</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">system_fingerprint</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">fp_48196bc67a</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finish_reason</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">logprobs</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">},</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">run</span><span class="o">-</span><span class="nx">c56b3e04</span><span class="o">-</span><span class="mi">08</span><span class="nx">a9</span><span class="o">-</span><span class="mi">4</span><span class="nx">a59</span><span class="o">-</span><span class="nx">b3f5</span><span class="o">-</span><span class="nx">ee52d0ef0656</span><span class="o">-</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tool_calls</span><span class="p">=[{</span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">args</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">city</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">sf</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_lJHMDYgfgRdiEAGfFsEhqqKV</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_call</span><span class="err">&#39;</span><span class="p">}],</span><span class="w"> </span><span class="nx">usage_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">input_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">output_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">}),</span>
<span class="w">   </span><span class="nx">ToolMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="s">&quot;It&#39;s always sunny in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="mi">0644</span><span class="nx">bf7b</span><span class="o">-</span><span class="mi">4</span><span class="nx">d1b</span><span class="o">-</span><span class="mi">4</span><span class="nx">ebe</span><span class="o">-</span><span class="nx">afa1</span><span class="o">-</span><span class="nx">d2169ccce582</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tool_call_id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">call_lJHMDYgfgRdiEAGfFsEhqqKV</span><span class="err">&#39;</span><span class="p">),</span>
<span class="w">   </span><span class="nx">AIMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">The</span><span class="w"> </span><span class="nx">weather</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">San</span><span class="w"> </span><span class="nx">Francisco</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">always</span><span class="w"> </span><span class="nx">sunny</span><span class="p">!</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">response_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">token_usage</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">completion_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">prompt_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">model_name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">gpt</span><span class="o">-</span><span class="mi">4</span><span class="nx">o</span><span class="o">-</span><span class="nx">mini</span><span class="o">-</span><span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">18</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">system_fingerprint</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">fp_48196bc67a</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finish_reason</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">stop</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">logprobs</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">},</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">run</span><span class="o">-</span><span class="mi">1</span><span class="nx">ed9b8d0</span><span class="o">-</span><span class="mi">9</span><span class="nx">b50</span><span class="o">-</span><span class="mi">4</span><span class="nx">b87</span><span class="o">-</span><span class="nx">b3a2</span><span class="o">-</span><span class="mi">9860</span><span class="nx">f51e9fd1</span><span class="o">-</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">usage_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">input_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">output_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">})]}}</span>
<span class="w">   </span><span class="err">```</span>

<span class="w">   </span><span class="err">##</span><span class="w"> </span><span class="nx">With</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">connection</span>
<span class="w">   </span><span class="nx">This</span><span class="w"> </span><span class="nx">creates</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">single</span><span class="p">,</span><span class="w"> </span><span class="nx">dedicated</span><span class="w"> </span><span class="nx">connection</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">database</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Advantages</span><span class="p">:</span><span class="w"> </span><span class="nx">Simple</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">use</span><span class="p">,</span><span class="w"> </span><span class="nx">suitable</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">longer</span><span class="w"> </span><span class="nx">transactions</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Best</span><span class="w"> </span><span class="k">for</span><span class="p">:</span><span class="w"> </span><span class="nx">Applications</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">fewer</span><span class="p">,</span><span class="w"> </span><span class="nx">longer</span><span class="o">-</span><span class="nx">lived</span><span class="w"> </span><span class="nx">database</span><span class="w"> </span><span class="nx">operations</span>

<span class="w">   </span><span class="err">```</span>
<span class="w">   </span><span class="nx">from</span><span class="w"> </span><span class="nx">psycopg</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="nx">Connection</span>


<span class="nx">with</span><span class="w"> </span><span class="nx">Connection</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">DB_URI</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="nx">connection_kwargs</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nx">conn</span><span class="p">:</span>
<span class="w">    </span><span class="nx">checkpointer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">PostgresSaver</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">NOTE</span><span class="p">:</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">call</span><span class="w"> </span><span class="p">.</span><span class="nx">setup</span><span class="p">()</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">first</span><span class="w"> </span><span class="nx">time</span><span class="w"> </span><span class="nx">you</span><span class="err">&#39;</span><span class="nx">re</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">checkpointer</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">checkpointer</span><span class="p">.</span><span class="nx">setup</span><span class="p">()</span>
<span class="w">    </span><span class="nx">graph</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">create_react_agent</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">=</span><span class="nx">tools</span><span class="p">,</span><span class="w"> </span><span class="nx">checkpointer</span><span class="p">=</span><span class="nx">checkpointer</span><span class="p">)</span>
<span class="w">    </span><span class="nx">config</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;configurable&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;thread_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2&quot;</span><span class="p">}}</span>
<span class="w">    </span><span class="nx">res</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">invoke</span><span class="p">({</span><span class="s">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[(</span><span class="s">&quot;human&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;what&#39;s the weather in sf&quot;</span><span class="p">)]},</span><span class="w"> </span><span class="nx">config</span><span class="p">)</span>

<span class="w">    </span><span class="nx">checkpoint_tuple</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">checkpointer</span><span class="p">.</span><span class="nx">get_tuple</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>checkpoint_tuple
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">CheckpointTuple</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-4650-6bfc-8003-1c5488f19318&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">checkpoint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-4650-6bfc-8003-1c5488f19318&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ts&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2024-08-08T15:32:43.284551+00:00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;current_tasks&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;pending_sends&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="s1">&#39;versions_seen&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;branch:agent:should_continue:tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;__input__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000001.ab89befb52cc0e91e106ef7f500ea033&#39;</span><span class="p">}},</span><span class="w"> </span><span class="s1">&#39;channel_versions&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000005.065d90dd7f7cd091f0233855210bb2af&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000005.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000005.af9f229d2c4e14f4866eb37f72ec39f6&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;branch:agent:should_continue:tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000004.&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;channel_values&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;agent&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;what&#39;s the weather in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;7a14f96c-2d88-454f-9520-0e0287a4abbb&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tool_calls&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_NcL4dBTYu4kSPGMKdxztdpjN&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;arguments&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{&quot;city&quot;:&quot;sf&quot;}&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">}]},</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_48196bc67a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_calls&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-39adbf2c-36ef-40f6-9cad-8e1f8167fc19-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_calls</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;args&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;sf&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_NcL4dBTYu4kSPGMKdxztdpjN&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_call&#39;</span><span class="p">}],</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">}),</span><span class="w"> </span><span class="n">ToolMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;It&#39;s always sunny in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;c9f82354-3225-40a8-bf54-81f3e199043b&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_call_id</span><span class="o">=</span><span class="s1">&#39;call_NcL4dBTYu4kSPGMKdxztdpjN&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;The weather in San Francisco is always sunny!&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_48196bc67a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;stop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-83888be3-d681-42ca-ad67-e2f5ee8550de-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">})]}},</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;source&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;loop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writes&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;The weather in San Francisco is always sunny!&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;stop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_48196bc67a&#39;</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-83888be3-d681-42ca-ad67-e2f5ee8550de-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">})]}}},</span><span class="w"> </span><span class="n">parent_config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-4087-681a-8002-88a5738f76f1&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">pending_writes</span><span class="o">=</span><span class="p">[])</span>
</code></pre></div>

<h2 id="with-a-connection-string">With a connection string<a class="headerlink" href="#with-a-connection-string" title="Permanent link">#</a></h2>
<p>This creates a connection based on a connection string: - Advantages: Simplicity, encapsulates connection details - Best for: Quick setup or when connection details are provided as a string</p>
<div class="codehilite"><pre><span></span><code><span class="n">with</span><span class="w"> </span><span class="n">PostgresSaver</span><span class="o">.</span><span class="n">from_conn_string</span><span class="p">(</span><span class="n">DB_URI</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">checkpointer</span><span class="p">:</span>
<span class="w">    </span><span class="n">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_react_agent</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span><span class="w"> </span><span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">)</span>
<span class="w">    </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;3&quot;</span><span class="p">}}</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">graph</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[(</span><span class="s2">&quot;human&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;what&#39;s the weather in sf&quot;</span><span class="p">)]},</span><span class="w"> </span><span class="n">config</span><span class="p">)</span>

<span class="w">    </span><span class="n">checkpoint_tuples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">config</span><span class="p">))</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>checkpoint_tuples
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="n">CheckpointTuple</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-5024-6476-8003-cf0a750e6b37&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">checkpoint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-5024-6476-8003-cf0a750e6b37&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ts&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2024-08-08T15:32:44.314900+00:00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;current_tasks&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;pending_sends&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="s1">&#39;versions_seen&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;branch:agent:should_continue:tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;__input__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000001.ab89befb52cc0e91e106ef7f500ea033&#39;</span><span class="p">}},</span><span class="w"> </span><span class="s1">&#39;channel_versions&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000005.065d90dd7f7cd091f0233855210bb2af&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000005.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000005.3f8b8d9923575b911e17157008ab75ac&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;branch:agent:should_continue:tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000004.&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;channel_values&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;agent&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;what&#39;s the weather in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;5bf79d15-6332-4bf5-89bd-ee192b31ed84&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tool_calls&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_9y3q1BiwW7zGh2gk2faInTRk&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;arguments&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{&quot;city&quot;:&quot;sf&quot;}&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">}]},</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_507c9469a1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_calls&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-2958adc7-f6a4-415d-ade1-5ee77e0b9276-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_calls</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;args&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;sf&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_9y3q1BiwW7zGh2gk2faInTRk&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_call&#39;</span><span class="p">}],</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">}),</span><span class="w"> </span><span class="n">ToolMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;It&#39;s always sunny in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;cac4f90a-dc3e-4bfa-940f-1c630289a583&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_call_id</span><span class="o">=</span><span class="s1">&#39;call_9y3q1BiwW7zGh2gk2faInTRk&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;The weather in San Francisco is always sunny!&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_48196bc67a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;stop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-97d3fb7a-3d2e-4090-84f4-dafdfe44553f-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">})]}},</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;source&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;loop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writes&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;The weather in San Francisco is always sunny!&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;stop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_48196bc67a&#39;</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-97d3fb7a-3d2e-4090-84f4-dafdfe44553f-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">84</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">94</span><span class="p">})]}}},</span><span class="w"> </span><span class="n">parent_config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-4b3d-6430-8002-b5c99d2eb4db&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">pending_writes</span><span class="o">=</span><span class="n">None</span><span class="p">),</span>
<span class="w"> </span><span class="n">CheckpointTuple</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-4b3d-6430-8002-b5c99d2eb4db&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">checkpoint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-4b3d-6430-8002-b5c99d2eb4db&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ts&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2024-08-08T15:32:43.800857+00:00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;current_tasks&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;pending_sends&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="s1">&#39;versions_seen&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;branch:agent:should_continue:tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;__input__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000001.ab89befb52cc0e91e106ef7f500ea033&#39;</span><span class="p">}},</span><span class="w"> </span><span class="s1">&#39;channel_versions&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000004.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000004.1195f50946feaedb0bae1fdbfadc806b&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;branch:agent:should_continue:tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000004.&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;channel_values&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tools&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;what&#39;s the weather in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;5bf79d15-6332-4bf5-89bd-ee192b31ed84&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tool_calls&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_9y3q1BiwW7zGh2gk2faInTRk&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;arguments&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{&quot;city&quot;:&quot;sf&quot;}&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">}]},</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_507c9469a1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_calls&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-2958adc7-f6a4-415d-ade1-5ee77e0b9276-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_calls</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;args&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;sf&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_9y3q1BiwW7zGh2gk2faInTRk&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_call&#39;</span><span class="p">}],</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">}),</span><span class="w"> </span><span class="n">ToolMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;It&#39;s always sunny in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;cac4f90a-dc3e-4bfa-940f-1c630289a583&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_call_id</span><span class="o">=</span><span class="s1">&#39;call_9y3q1BiwW7zGh2gk2faInTRk&#39;</span><span class="p">)]}},</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;source&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;loop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writes&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">ToolMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;It&#39;s always sunny in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;cac4f90a-dc3e-4bfa-940f-1c630289a583&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_call_id</span><span class="o">=</span><span class="s1">&#39;call_9y3q1BiwW7zGh2gk2faInTRk&#39;</span><span class="p">)]}}},</span><span class="w"> </span><span class="n">parent_config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-4b30-6078-8001-eaf8c9bd8844&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">pending_writes</span><span class="o">=</span><span class="n">None</span><span class="p">),</span>
<span class="w"> </span><span class="n">CheckpointTuple</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-4b30-6078-8001-eaf8c9bd8844&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">checkpoint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-4b30-6078-8001-eaf8c9bd8844&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ts&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2024-08-08T15:32:43.795440+00:00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;current_tasks&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;pending_sends&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="s1">&#39;versions_seen&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;__input__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000001.ab89befb52cc0e91e106ef7f500ea033&#39;</span><span class="p">}},</span><span class="w"> </span><span class="s1">&#39;channel_versions&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.bab5fb3a70876f600f5f2fd46945ce5f&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;branch:agent:should_continue:tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;channel_values&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;agent&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;what&#39;s the weather in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;5bf79d15-6332-4bf5-89bd-ee192b31ed84&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tool_calls&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_9y3q1BiwW7zGh2gk2faInTRk&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;arguments&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{&quot;city&quot;:&quot;sf&quot;}&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">}]},</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_507c9469a1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_calls&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-2958adc7-f6a4-415d-ade1-5ee77e0b9276-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_calls</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;args&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;sf&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_9y3q1BiwW7zGh2gk2faInTRk&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_call&#39;</span><span class="p">}],</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">})],</span><span class="w"> </span><span class="s1">&#39;branch:agent:should_continue:tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;agent&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;source&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;loop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writes&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tool_calls&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_9y3q1BiwW7zGh2gk2faInTRk&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;arguments&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{&quot;city&quot;:&quot;sf&quot;}&#39;</span><span class="p">}}]},</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_calls&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_507c9469a1&#39;</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-2958adc7-f6a4-415d-ade1-5ee77e0b9276-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_calls</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;args&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;sf&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_9y3q1BiwW7zGh2gk2faInTRk&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_call&#39;</span><span class="p">}],</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">57</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">71</span><span class="p">})]}}},</span><span class="w"> </span><span class="n">parent_config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-46d7-6116-8000-8976b7c89a2f&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">pending_writes</span><span class="o">=</span><span class="n">None</span><span class="p">),</span>
<span class="w"> </span><span class="n">CheckpointTuple</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-46d7-6116-8000-8976b7c89a2f&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">checkpoint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-46d7-6116-8000-8976b7c89a2f&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ts&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2024-08-08T15:32:43.339573+00:00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;current_tasks&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;pending_sends&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="s1">&#39;versions_seen&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;__input__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000001.ab89befb52cc0e91e106ef7f500ea033&#39;</span><span class="p">}},</span><span class="w"> </span><span class="s1">&#39;channel_versions&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.ba0c90d32863686481f7fe5eab9ecdf0&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;channel_values&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;what&#39;s the weather in sf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;5bf79d15-6332-4bf5-89bd-ee192b31ed84&#39;</span><span class="p">)],</span><span class="w"> </span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;source&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;loop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writes&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">},</span><span class="w"> </span><span class="n">parent_config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-46ce-6c64-bfff-ef7fe2663573&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">pending_writes</span><span class="o">=</span><span class="n">None</span><span class="p">),</span>
<span class="w"> </span><span class="n">CheckpointTuple</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-46ce-6c64-bfff-ef7fe2663573&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">checkpoint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-46ce-6c64-bfff-ef7fe2663573&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ts&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2024-08-08T15:32:43.336188+00:00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;current_tasks&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;pending_sends&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="s1">&#39;versions_seen&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;__input__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{}},</span><span class="w"> </span><span class="s1">&#39;channel_versions&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000001.ab89befb52cc0e91e106ef7f500ea033&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;channel_values&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[[</span><span class="s1">&#39;human&#39;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;what&#39;s the weather in sf&quot;</span><span class="p">]]}}},</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;source&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;input&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writes&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[[</span><span class="s1">&#39;human&#39;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;what&#39;s the weather in sf&quot;</span><span class="p">]]}},</span><span class="w"> </span><span class="n">parent_config</span><span class="o">=</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">pending_writes</span><span class="o">=</span><span class="n">None</span><span class="p">)]</span>
<span class="w"> </span><span class="err">```</span>

<span class="w"> </span><span class="c1">## Use async connection</span>
<span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">sets</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">asynchronous</span><span class="w"> </span><span class="n">connection</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">database</span><span class="o">.</span>

<span class="n">Async</span><span class="w"> </span><span class="n">connections</span><span class="w"> </span><span class="n">allow</span><span class="w"> </span><span class="n">non</span><span class="o">-</span><span class="n">blocking</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">operations</span><span class="o">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">means</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">parts</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">database</span><span class="w"> </span><span class="n">operations</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">complete</span><span class="o">.</span><span class="w"> </span><span class="n">It</span><span class="s1">&#39;s particularly useful in high-concurrency scenarios or when dealing with I/O-bound operations.</span>


<span class="c1">## With a connection pool</span>
</code></pre></div>

<p>from psycopg_pool import AsyncConnectionPool</p>
<p>async with AsyncConnectionPool(
    # Example configuration
    conninfo=DB_URI,
    max_size=20,
    kwargs=connection_kwargs,
) as pool:
    checkpointer = AsyncPostgresSaver(pool)</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># NOTE: you need to call .setup() the first time you&#39;re using your checkpointer</span>
<span class="n">await</span><span class="w"> </span><span class="n">checkpointer</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="n">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_react_agent</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span><span class="w"> </span><span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">)</span>
<span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4&quot;</span><span class="p">}}</span>
<span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span>
<span class="w">    </span><span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[(</span><span class="s2">&quot;human&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;what&#39;s the weather in nyc&quot;</span><span class="p">)]},</span><span class="w"> </span><span class="n">config</span>
<span class="p">)</span>

<span class="n">checkpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">checkpointer</span><span class="o">.</span><span class="n">aget</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>checkpoint</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{'v': 1,
 'id': '1ef559b7-5cc9-6460-8003-8655824c0944',
 'ts': '2024-08-08T15:32:45.640793+00:00',
 'current_tasks': {},
 'pending_sends': [],
 'versions_seen': {'agent': {'tools': '00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8',
   'start:agent': '00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc'},
  'tools': {'branch:agent:should_continue:tools': '00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af'},
  '<strong>input</strong>': {},
  '<strong>start</strong>': {'<strong>start</strong>': '00000000000000000000000000000001.0e148ae3debe753278387e84f786e863'}},
 'channel_versions': {'agent': '00000000000000000000000000000005.065d90dd7f7cd091f0233855210bb2af',
  'tools': '00000000000000000000000000000005.',
  'messages': '00000000000000000000000000000005.d869fc7231619df0db74feed624efe41',
  '<strong>start</strong>': '00000000000000000000000000000002.',
  'start:agent': '00000000000000000000000000000003.',
  'branch:agent:should_continue:tools': '00000000000000000000000000000004.'},
 'channel_values': {'agent': 'agent',
  'messages': [HumanMessage(content="what's the weather in nyc", id='d883b8a0-99de-486d-91a2-bcfa7f25dc05'),
   AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_H6TAYfyd6AnaCrkQGs6Q2fVp', 'function': {'arguments': '{"city":"nyc"}', 'name': 'get_weather'}, 'type': 'function'}]}, response_metadata={'token_usage': {'completion_tokens': 15, 'prompt_tokens': 58, 'total_tokens': 73}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-6f542f84-ad73-444c-8ef7-b5ea75a2e09b-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'nyc'}, 'id': 'call_H6TAYfyd6AnaCrkQGs6Q2fVp', 'type': 'tool_call'}], usage_metadata={'input_tokens': 58, 'output_tokens': 15, 'total_tokens': 73}),
   ToolMessage(content='It might be cloudy in nyc', name='get_weather', id='c0e52254-77a4-4ea9-a2b7-61dd2d65ec68', tool_call_id='call_H6TAYfyd6AnaCrkQGs6Q2fVp'),
   AIMessage(content='The weather in NYC might be cloudy.', response_metadata={'token_usage': {'completion_tokens': 9, 'prompt_tokens': 88, 'total_tokens': 97}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'stop', 'logprobs': None}, id='run-977140d4-7582-40c3-b2b6-31b542c430a3-0', usage_metadata={'input_tokens': 88, 'output_tokens': 9, 'total_tokens': 97})]}}
   ```</p>
<h2 id="with-a-connection">With a connection<a class="headerlink" href="#with-a-connection" title="Permanent link">#</a></h2>
<div class="codehilite"><pre><span></span><code>   <span class="kn">from</span><span class="w"> </span><span class="nn">psycopg</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncConnection</span>

<span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">AsyncConnection</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DB_URI</span><span class="p">,</span> <span class="o">**</span><span class="n">connection_kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">checkpointer</span> <span class="o">=</span> <span class="n">AsyncPostgresSaver</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">graph</span> <span class="o">=</span> <span class="n">create_react_agent</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">}}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="s2">&quot;what&#39;s the weather in nyc&quot;</span><span class="p">)]},</span> <span class="n">config</span>
    <span class="p">)</span>
    <span class="n">checkpoint_tuple</span> <span class="o">=</span> <span class="k">await</span> <span class="n">checkpointer</span><span class="o">.</span><span class="n">aget_tuple</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>checkpoint_tuple
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">CheckpointTuple</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-65b4-60ca-8003-1ef4b620559a&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">checkpoint</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-65b4-60ca-8003-1ef4b620559a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ts&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;2024-08-08T15:32:46.575814+00:00&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;current_tasks&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;pending_sends&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="s1">&#39;versions_seen&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;branch:agent:should_continue:tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;__input__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000001.0e148ae3debe753278387e84f786e863&#39;</span><span class="p">}},</span><span class="w"> </span><span class="s1">&#39;channel_versions&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000005.065d90dd7f7cd091f0233855210bb2af&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000005.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000005.1557a6006d58f736d5cb2dd5c5f10111&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__start__&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000002.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;start:agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000003.&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;branch:agent:should_continue:tools&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;00000000000000000000000000000004.&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;channel_values&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;agent&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;what&#39;s the weather in nyc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;935e7732-b288-49bd-9ec2-1f7610cc38cb&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">additional_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tool_calls&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_94KtjtPmsiaj7T8yXvL7Ef31&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;arguments&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;{&quot;city&quot;:&quot;nyc&quot;}&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">}]},</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">73</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_48196bc67a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_calls&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-790c929a-7982-49e7-af67-2cbe4a86373b-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_calls</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;args&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;city&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;nyc&#39;</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;call_94KtjtPmsiaj7T8yXvL7Ef31&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;tool_call&#39;</span><span class="p">}],</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">73</span><span class="p">}),</span><span class="w"> </span><span class="n">ToolMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;It might be cloudy in nyc&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_weather&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;b2dc1073-abc4-4492-8982-434a7e32e445&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tool_call_id</span><span class="o">=</span><span class="s1">&#39;call_94KtjtPmsiaj7T8yXvL7Ef31&#39;</span><span class="p">),</span><span class="w"> </span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;The weather in NYC might be cloudy.&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_48196bc67a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;stop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-7e8a7f16-d8e1-457a-89f3-192102396449-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">})]}},</span><span class="w"> </span><span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;step&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;source&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;loop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;writes&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;agent&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;messages&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;The weather in NYC might be cloudy.&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">response_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;logprobs&#39;</span><span class="p">:</span><span class="w"> </span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;model_name&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;gpt-4o-mini-2024-07-18&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;token_usage&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prompt_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;completion_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">},</span><span class="w"> </span><span class="s1">&#39;finish_reason&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;stop&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;system_fingerprint&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;fp_48196bc67a&#39;</span><span class="p">},</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s1">&#39;run-7e8a7f16-d8e1-457a-89f3-192102396449-0&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">usage_metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;input_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;output_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;total_tokens&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">})]}}},</span><span class="w"> </span><span class="n">parent_config</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;configurable&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;thread_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_ns&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;checkpoint_id&#39;</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;1ef559b7-62ae-6128-8002-c04af82bcd41&#39;</span><span class="p">}},</span><span class="w"> </span><span class="n">pending_writes</span><span class="o">=</span><span class="p">[])</span>
</code></pre></div>

<h2 id="with-a-connection-string_1">With a connection string<a class="headerlink" href="#with-a-connection-string_1" title="Permanent link">#</a></h2>
<div class="codehilite"><pre><span></span><code><span class="n">async</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">AsyncPostgresSaver</span><span class="o">.</span><span class="n">from_conn_string</span><span class="p">(</span><span class="n">DB_URI</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">checkpointer</span><span class="p">:</span>
<span class="w">    </span><span class="n">graph</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_react_agent</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span><span class="w"> </span><span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">)</span>
<span class="w">    </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;6&quot;</span><span class="p">}}</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span>
<span class="w">        </span><span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[(</span><span class="s2">&quot;human&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;what&#39;s the weather in nyc&quot;</span><span class="p">)]},</span><span class="w"> </span><span class="n">config</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">checkpoint_tuples</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">c</span><span class="w"> </span><span class="n">async</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">checkpointer</span><span class="o">.</span><span class="n">alist</span><span class="p">(</span><span class="n">config</span><span class="p">)]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>checkpoint_tuples
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="nx">CheckpointTuple</span><span class="p">(</span><span class="nx">config</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">configurable</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">thread_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">723</span><span class="nx">c</span><span class="o">-</span><span class="mi">67</span><span class="nx">de</span><span class="o">-</span><span class="mi">8003</span><span class="o">-</span><span class="mi">63</span><span class="nx">bd4eab35af</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="nx">checkpoint</span><span class="p">={</span><span class="sc">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">723</span><span class="nx">c</span><span class="o">-</span><span class="mi">67</span><span class="nx">de</span><span class="o">-</span><span class="mi">8003</span><span class="o">-</span><span class="mi">63</span><span class="nx">bd4eab35af</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">ts</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span><span class="nx">T15</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="m m-Double">47.890003</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">current_tasks</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">pending_sends</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">versions_seen</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000004.022986</span><span class="nx">cd20ae85c77ea298a383f69ba8</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">start</span><span class="p">:</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000002</span><span class="p">.</span><span class="nx">d6f25946c3108fc12f27abbcf9b4cedc</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">branch</span><span class="p">:</span><span class="nx">agent</span><span class="p">:</span><span class="nx">should_continue</span><span class="p">:</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000003.065</span><span class="nx">d90dd7f7cd091f0233855210bb2af</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__input__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000001.0</span><span class="nx">e148ae3debe753278387e84f786e863</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_versions</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000005.065</span><span class="nx">d90dd7f7cd091f0233855210bb2af</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000005</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000005</span><span class="p">.</span><span class="nx">b6fe2a26011590cfe8fd6a39151a9e92</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000002</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">start</span><span class="p">:</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000003</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">branch</span><span class="p">:</span><span class="nx">agent</span><span class="p">:</span><span class="nx">should_continue</span><span class="p">:</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000004</span><span class="p">.</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_values</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">HumanMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="s">&quot;what&#39;s the weather in nyc&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="mi">977</span><span class="nx">ddb90</span><span class="o">-</span><span class="mi">9991</span><span class="o">-</span><span class="mi">44</span><span class="nx">cb</span><span class="o">-</span><span class="mi">9</span><span class="nx">f73</span><span class="o">-</span><span class="mi">361</span><span class="nx">c6dd21396</span><span class="err">&#39;</span><span class="p">),</span><span class="w"> </span><span class="nx">AIMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">additional_kwargs</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_QIFCuh4zfP9owpjToycJiZf7</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">arguments</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;city&quot;</span><span class="p">:</span><span class="s">&quot;nyc&quot;</span><span class="p">}</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">}]},</span><span class="w"> </span><span class="nx">response_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">token_usage</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">completion_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">prompt_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">73</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">model_name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">gpt</span><span class="o">-</span><span class="mi">4</span><span class="nx">o</span><span class="o">-</span><span class="nx">mini</span><span class="o">-</span><span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">18</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">system_fingerprint</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">fp_48196bc67a</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finish_reason</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">logprobs</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">},</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">run</span><span class="o">-</span><span class="mi">47</span><span class="nx">b10c48</span><span class="o">-</span><span class="mi">4</span><span class="nx">db3</span><span class="o">-</span><span class="mi">46</span><span class="nx">d8</span><span class="o">-</span><span class="nx">b4fa</span><span class="o">-</span><span class="nx">e021818e01c5</span><span class="o">-</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tool_calls</span><span class="p">=[{</span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">args</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">city</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">nyc</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_QIFCuh4zfP9owpjToycJiZf7</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_call</span><span class="err">&#39;</span><span class="p">}],</span><span class="w"> </span><span class="nx">usage_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">input_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">output_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">73</span><span class="p">}),</span><span class="w"> </span><span class="nx">ToolMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">It</span><span class="w"> </span><span class="nx">might</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">cloudy</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">nyc</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="mi">798</span><span class="nx">c520f</span><span class="o">-</span><span class="mi">4</span><span class="nx">f9a</span><span class="o">-</span><span class="mi">4</span><span class="nx">f6d</span><span class="o">-</span><span class="nx">a389</span><span class="o">-</span><span class="nx">da721eb4d4ce</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tool_call_id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">call_QIFCuh4zfP9owpjToycJiZf7</span><span class="err">&#39;</span><span class="p">),</span><span class="w"> </span><span class="nx">AIMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">The</span><span class="w"> </span><span class="nx">weather</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">NYC</span><span class="w"> </span><span class="nx">might</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">cloudy</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">response_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">token_usage</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">completion_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">prompt_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">model_name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">gpt</span><span class="o">-</span><span class="mi">4</span><span class="nx">o</span><span class="o">-</span><span class="nx">mini</span><span class="o">-</span><span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">18</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">system_fingerprint</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">fp_48196bc67a</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finish_reason</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">stop</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">logprobs</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">},</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">run</span><span class="o">-</span><span class="mi">4</span><span class="nx">a34e05d</span><span class="o">-</span><span class="mi">8</span><span class="nx">bcf</span><span class="o">-</span><span class="mi">41</span><span class="nx">ad</span><span class="o">-</span><span class="nx">adc3</span><span class="o">-</span><span class="mi">715919</span><span class="nx">fde64c</span><span class="o">-</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">usage_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">input_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">output_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">})]}},</span><span class="w"> </span><span class="nx">metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">step</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">source</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">loop</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">writes</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">AIMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">The</span><span class="w"> </span><span class="nx">weather</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">NYC</span><span class="w"> </span><span class="nx">might</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">cloudy</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">response_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">logprobs</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">model_name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">gpt</span><span class="o">-</span><span class="mi">4</span><span class="nx">o</span><span class="o">-</span><span class="nx">mini</span><span class="o">-</span><span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">18</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">token_usage</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">prompt_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">completion_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finish_reason</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">stop</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">system_fingerprint</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">fp_48196bc67a</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">run</span><span class="o">-</span><span class="mi">4</span><span class="nx">a34e05d</span><span class="o">-</span><span class="mi">8</span><span class="nx">bcf</span><span class="o">-</span><span class="mi">41</span><span class="nx">ad</span><span class="o">-</span><span class="nx">adc3</span><span class="o">-</span><span class="mi">715919</span><span class="nx">fde64c</span><span class="o">-</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">usage_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">input_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">output_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="p">})]}}},</span><span class="w"> </span><span class="nx">parent_config</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">configurable</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">thread_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">6</span><span class="nx">bf5</span><span class="o">-</span><span class="mi">63</span><span class="nx">c6</span><span class="o">-</span><span class="mi">8002</span><span class="o">-</span><span class="nx">ed990dbbc96e</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="nx">pending_writes</span><span class="p">=</span><span class="nx">None</span><span class="p">),</span>
<span class="w"> </span><span class="nx">CheckpointTuple</span><span class="p">(</span><span class="nx">config</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">configurable</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">thread_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">6</span><span class="nx">bf5</span><span class="o">-</span><span class="mi">63</span><span class="nx">c6</span><span class="o">-</span><span class="mi">8002</span><span class="o">-</span><span class="nx">ed990dbbc96e</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="nx">checkpoint</span><span class="p">={</span><span class="sc">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">6</span><span class="nx">bf5</span><span class="o">-</span><span class="mi">63</span><span class="nx">c6</span><span class="o">-</span><span class="mi">8002</span><span class="o">-</span><span class="nx">ed990dbbc96e</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">ts</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span><span class="nx">T15</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="m m-Double">47.231667</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">current_tasks</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">pending_sends</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">versions_seen</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">start</span><span class="p">:</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000002</span><span class="p">.</span><span class="nx">d6f25946c3108fc12f27abbcf9b4cedc</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">branch</span><span class="p">:</span><span class="nx">agent</span><span class="p">:</span><span class="nx">should_continue</span><span class="p">:</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000003.065</span><span class="nx">d90dd7f7cd091f0233855210bb2af</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__input__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000001.0</span><span class="nx">e148ae3debe753278387e84f786e863</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_versions</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000004</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000004.022986</span><span class="nx">cd20ae85c77ea298a383f69ba8</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000004</span><span class="p">.</span><span class="nx">c9074f2a41f05486b5efb86353dc75c0</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000002</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">start</span><span class="p">:</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000003</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">branch</span><span class="p">:</span><span class="nx">agent</span><span class="p">:</span><span class="nx">should_continue</span><span class="p">:</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000004</span><span class="p">.</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_values</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">HumanMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="s">&quot;what&#39;s the weather in nyc&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="mi">977</span><span class="nx">ddb90</span><span class="o">-</span><span class="mi">9991</span><span class="o">-</span><span class="mi">44</span><span class="nx">cb</span><span class="o">-</span><span class="mi">9</span><span class="nx">f73</span><span class="o">-</span><span class="mi">361</span><span class="nx">c6dd21396</span><span class="err">&#39;</span><span class="p">),</span><span class="w"> </span><span class="nx">AIMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">additional_kwargs</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_QIFCuh4zfP9owpjToycJiZf7</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">arguments</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;city&quot;</span><span class="p">:</span><span class="s">&quot;nyc&quot;</span><span class="p">}</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">}]},</span><span class="w"> </span><span class="nx">response_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">token_usage</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">completion_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">prompt_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">73</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">model_name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">gpt</span><span class="o">-</span><span class="mi">4</span><span class="nx">o</span><span class="o">-</span><span class="nx">mini</span><span class="o">-</span><span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">18</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">system_fingerprint</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">fp_48196bc67a</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finish_reason</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">logprobs</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">},</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">run</span><span class="o">-</span><span class="mi">47</span><span class="nx">b10c48</span><span class="o">-</span><span class="mi">4</span><span class="nx">db3</span><span class="o">-</span><span class="mi">46</span><span class="nx">d8</span><span class="o">-</span><span class="nx">b4fa</span><span class="o">-</span><span class="nx">e021818e01c5</span><span class="o">-</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tool_calls</span><span class="p">=[{</span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">args</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">city</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">nyc</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_QIFCuh4zfP9owpjToycJiZf7</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_call</span><span class="err">&#39;</span><span class="p">}],</span><span class="w"> </span><span class="nx">usage_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">input_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">output_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">73</span><span class="p">}),</span><span class="w"> </span><span class="nx">ToolMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">It</span><span class="w"> </span><span class="nx">might</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">cloudy</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">nyc</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="mi">798</span><span class="nx">c520f</span><span class="o">-</span><span class="mi">4</span><span class="nx">f9a</span><span class="o">-</span><span class="mi">4</span><span class="nx">f6d</span><span class="o">-</span><span class="nx">a389</span><span class="o">-</span><span class="nx">da721eb4d4ce</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tool_call_id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">call_QIFCuh4zfP9owpjToycJiZf7</span><span class="err">&#39;</span><span class="p">)]}},</span><span class="w"> </span><span class="nx">metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">step</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">source</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">loop</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">writes</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">ToolMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">It</span><span class="w"> </span><span class="nx">might</span><span class="w"> </span><span class="nx">be</span><span class="w"> </span><span class="nx">cloudy</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">nyc</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="mi">798</span><span class="nx">c520f</span><span class="o">-</span><span class="mi">4</span><span class="nx">f9a</span><span class="o">-</span><span class="mi">4</span><span class="nx">f6d</span><span class="o">-</span><span class="nx">a389</span><span class="o">-</span><span class="nx">da721eb4d4ce</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tool_call_id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">call_QIFCuh4zfP9owpjToycJiZf7</span><span class="err">&#39;</span><span class="p">)]}}},</span><span class="w"> </span><span class="nx">parent_config</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">configurable</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">thread_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">6</span><span class="nx">be0</span><span class="o">-</span><span class="mi">6926</span><span class="o">-</span><span class="mi">8001</span><span class="o">-</span><span class="mi">1</span><span class="nx">a8ce73baf9e</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="nx">pending_writes</span><span class="p">=</span><span class="nx">None</span><span class="p">),</span>
<span class="w"> </span><span class="nx">CheckpointTuple</span><span class="p">(</span><span class="nx">config</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">configurable</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">thread_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">6</span><span class="nx">be0</span><span class="o">-</span><span class="mi">6926</span><span class="o">-</span><span class="mi">8001</span><span class="o">-</span><span class="mi">1</span><span class="nx">a8ce73baf9e</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="nx">checkpoint</span><span class="p">={</span><span class="sc">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">6</span><span class="nx">be0</span><span class="o">-</span><span class="mi">6926</span><span class="o">-</span><span class="mi">8001</span><span class="o">-</span><span class="mi">1</span><span class="nx">a8ce73baf9e</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">ts</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span><span class="nx">T15</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="m m-Double">47.223198</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">current_tasks</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">pending_sends</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">versions_seen</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">start</span><span class="p">:</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000002</span><span class="p">.</span><span class="nx">d6f25946c3108fc12f27abbcf9b4cedc</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__input__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000001.0</span><span class="nx">e148ae3debe753278387e84f786e863</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_versions</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000003.065</span><span class="nx">d90dd7f7cd091f0233855210bb2af</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000003.097</span><span class="nx">b5407d709b297591f1ef5d50c8368</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000002</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">start</span><span class="p">:</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000003</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">branch</span><span class="p">:</span><span class="nx">agent</span><span class="p">:</span><span class="nx">should_continue</span><span class="p">:</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000003.065</span><span class="nx">d90dd7f7cd091f0233855210bb2af</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_values</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">HumanMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="s">&quot;what&#39;s the weather in nyc&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="mi">977</span><span class="nx">ddb90</span><span class="o">-</span><span class="mi">9991</span><span class="o">-</span><span class="mi">44</span><span class="nx">cb</span><span class="o">-</span><span class="mi">9</span><span class="nx">f73</span><span class="o">-</span><span class="mi">361</span><span class="nx">c6dd21396</span><span class="err">&#39;</span><span class="p">),</span><span class="w"> </span><span class="nx">AIMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">additional_kwargs</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_QIFCuh4zfP9owpjToycJiZf7</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">arguments</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;city&quot;</span><span class="p">:</span><span class="s">&quot;nyc&quot;</span><span class="p">}</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">}]},</span><span class="w"> </span><span class="nx">response_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">token_usage</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">completion_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">prompt_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">73</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">model_name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">gpt</span><span class="o">-</span><span class="mi">4</span><span class="nx">o</span><span class="o">-</span><span class="nx">mini</span><span class="o">-</span><span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">18</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">system_fingerprint</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">fp_48196bc67a</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finish_reason</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">logprobs</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">},</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">run</span><span class="o">-</span><span class="mi">47</span><span class="nx">b10c48</span><span class="o">-</span><span class="mi">4</span><span class="nx">db3</span><span class="o">-</span><span class="mi">46</span><span class="nx">d8</span><span class="o">-</span><span class="nx">b4fa</span><span class="o">-</span><span class="nx">e021818e01c5</span><span class="o">-</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tool_calls</span><span class="p">=[{</span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">args</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">city</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">nyc</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_QIFCuh4zfP9owpjToycJiZf7</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_call</span><span class="err">&#39;</span><span class="p">}],</span><span class="w"> </span><span class="nx">usage_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">input_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">output_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">73</span><span class="p">})],</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">branch</span><span class="p">:</span><span class="nx">agent</span><span class="p">:</span><span class="nx">should_continue</span><span class="p">:</span><span class="nx">tools</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="nx">metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">step</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">source</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">loop</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">writes</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">AIMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">additional_kwargs</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_QIFCuh4zfP9owpjToycJiZf7</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">function</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">arguments</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="p">{</span><span class="s">&quot;city&quot;</span><span class="p">:</span><span class="s">&quot;nyc&quot;</span><span class="p">}</span><span class="err">&#39;</span><span class="p">}}]},</span><span class="w"> </span><span class="nx">response_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">logprobs</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">model_name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">gpt</span><span class="o">-</span><span class="mi">4</span><span class="nx">o</span><span class="o">-</span><span class="nx">mini</span><span class="o">-</span><span class="mi">2024</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">18</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">token_usage</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">prompt_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">completion_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">finish_reason</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_calls</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">system_fingerprint</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">fp_48196bc67a</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="nx">run</span><span class="o">-</span><span class="mi">47</span><span class="nx">b10c48</span><span class="o">-</span><span class="mi">4</span><span class="nx">db3</span><span class="o">-</span><span class="mi">46</span><span class="nx">d8</span><span class="o">-</span><span class="nx">b4fa</span><span class="o">-</span><span class="nx">e021818e01c5</span><span class="o">-</span><span class="mi">0</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">tool_calls</span><span class="p">=[{</span><span class="err">&#39;</span><span class="nx">name</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">get_weather</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">args</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">city</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">nyc</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">call_QIFCuh4zfP9owpjToycJiZf7</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="k">type</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">tool_call</span><span class="err">&#39;</span><span class="p">}],</span><span class="w"> </span><span class="nx">usage_metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">input_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">output_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">total_tokens</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">73</span><span class="p">})]}}},</span><span class="w"> </span><span class="nx">parent_config</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">configurable</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">thread_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">663</span><span class="nx">d</span><span class="o">-</span><span class="mi">60</span><span class="nx">b4</span><span class="o">-</span><span class="mi">8000</span><span class="o">-</span><span class="mi">10</span><span class="nx">a8922bffbf</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="nx">pending_writes</span><span class="p">=</span><span class="nx">None</span><span class="p">),</span>
<span class="w"> </span><span class="nx">CheckpointTuple</span><span class="p">(</span><span class="nx">config</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">configurable</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">thread_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">663</span><span class="nx">d</span><span class="o">-</span><span class="mi">60</span><span class="nx">b4</span><span class="o">-</span><span class="mi">8000</span><span class="o">-</span><span class="mi">10</span><span class="nx">a8922bffbf</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="nx">checkpoint</span><span class="p">={</span><span class="sc">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">663</span><span class="nx">d</span><span class="o">-</span><span class="mi">60</span><span class="nx">b4</span><span class="o">-</span><span class="mi">8000</span><span class="o">-</span><span class="mi">10</span><span class="nx">a8922bffbf</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">ts</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span><span class="nx">T15</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="m m-Double">46.631935</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">current_tasks</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">pending_sends</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">versions_seen</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">__input__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000001.0</span><span class="nx">e148ae3debe753278387e84f786e863</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_versions</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000002.2</span><span class="nx">a79db8da664e437bdb25ea804457ca7</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000002</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">start</span><span class="p">:</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">00000000000000000000000000000002</span><span class="p">.</span><span class="nx">d6f25946c3108fc12f27abbcf9b4cedc</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_values</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nx">HumanMessage</span><span class="p">(</span><span class="nx">content</span><span class="p">=</span><span class="s">&quot;what&#39;s the weather in nyc&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">=</span><span class="err">&#39;</span><span class="mi">977</span><span class="nx">ddb90</span><span class="o">-</span><span class="mi">9991</span><span class="o">-</span><span class="mi">44</span><span class="nx">cb</span><span class="o">-</span><span class="mi">9</span><span class="nx">f73</span><span class="o">-</span><span class="mi">361</span><span class="nx">c6dd21396</span><span class="err">&#39;</span><span class="p">)],</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">start</span><span class="p">:</span><span class="nx">agent</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="nx">metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">step</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">source</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">loop</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">writes</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="nx">None</span><span class="p">},</span><span class="w"> </span><span class="nx">parent_config</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">configurable</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">thread_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">6637</span><span class="o">-</span><span class="mi">6</span><span class="nx">d4e</span><span class="o">-</span><span class="nx">bfff</span><span class="o">-</span><span class="mi">6</span><span class="nx">cecf690c3cb</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="nx">pending_writes</span><span class="p">=</span><span class="nx">None</span><span class="p">),</span>
<span class="w"> </span><span class="nx">CheckpointTuple</span><span class="p">(</span><span class="nx">config</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">configurable</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">thread_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="sc">&#39;6&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_ns</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">checkpoint_id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">6637</span><span class="o">-</span><span class="mi">6</span><span class="nx">d4e</span><span class="o">-</span><span class="nx">bfff</span><span class="o">-</span><span class="mi">6</span><span class="nx">cecf690c3cb</span><span class="err">&#39;</span><span class="p">}},</span><span class="w"> </span><span class="nx">checkpoint</span><span class="p">={</span><span class="sc">&#39;v&#39;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">id</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">1</span><span class="nx">ef559b7</span><span class="o">-</span><span class="mi">6637</span><span class="o">-</span><span class="mi">6</span><span class="nx">d4e</span><span class="o">-</span><span class="nx">bfff</span><span class="o">-</span><span class="mi">6</span><span class="nx">cecf690c3cb</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">ts</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="mi">2024</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">08</span><span class="nx">T15</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="m m-Double">46.629806</span><span class="o">+</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">current_tasks</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">pending_sends</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">versions_seen</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">__input__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{}},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_versions</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="m m-Double">00000000000000000000000000000001.0</span><span class="nx">e148ae3debe753278387e84f786e863</span><span class="err">&#39;</span><span class="p">},</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">channel_values</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">__start__</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[[</span><span class="err">&#39;</span><span class="nx">human</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;what&#39;s the weather in nyc&quot;</span><span class="p">]]}}},</span><span class="w"> </span><span class="nx">metadata</span><span class="p">={</span><span class="err">&#39;</span><span class="nx">step</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">source</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">input</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">writes</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">&#39;</span><span class="nx">messages</span><span class="err">&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">[[</span><span class="err">&#39;</span><span class="nx">human</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;what&#39;s the weather in nyc&quot;</span><span class="p">]]}},</span><span class="w"> </span><span class="nx">parent_config</span><span class="p">=</span><span class="nx">None</span><span class="p">,</span><span class="w"> </span><span class="nx">pending_writes</span><span class="p">=</span><span class="nx">None</span><span class="p">)]</span>
<span class="w"> </span><span class="err">```</span>

<span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">How</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">MongoDB</span><span class="w"> </span><span class="nx">checkpointer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">persistence</span>

<span class="w"> </span><span class="nx">When</span><span class="w"> </span><span class="nx">creating</span><span class="w"> </span><span class="nx">LangGraph</span><span class="w"> </span><span class="nx">agents</span><span class="p">,</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">also</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">them</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="nx">so</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">they</span><span class="w"> </span><span class="nx">persist</span><span class="w"> </span><span class="nx">their</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="w"> </span><span class="nx">This</span><span class="w"> </span><span class="nx">allows</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">do</span><span class="w"> </span><span class="nx">things</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="nx">interact</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">agent</span><span class="w"> </span><span class="nx">multiple</span><span class="w"> </span><span class="nx">times</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="nx">remember</span><span class="w"> </span><span class="nx">previous</span><span class="w"> </span><span class="nx">interactions</span><span class="p">.</span>

<span class="nx">This</span><span class="w"> </span><span class="nx">reference</span><span class="w"> </span><span class="nx">implementation</span><span class="w"> </span><span class="nx">shows</span><span class="w"> </span><span class="nx">how</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">MongoDB</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">backend</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">persisting</span><span class="w"> </span><span class="nx">checkpoint</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">langgraph</span><span class="o">-</span><span class="nx">checkpoint</span><span class="o">-</span><span class="nx">mongodb</span><span class="w"> </span><span class="kn">library</span><span class="p">.</span>

<span class="nx">For</span><span class="w"> </span><span class="nx">demonstration</span><span class="w"> </span><span class="nx">purposes</span><span class="w"> </span><span class="nx">we</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">persistence</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">prebuilt</span><span class="w"> </span><span class="nx">ReAct</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span>

<span class="nx">In</span><span class="w"> </span><span class="nx">general</span><span class="p">,</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">checkpointer</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="nx">custom</span><span class="w"> </span><span class="nx">graph</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="nx">this</span><span class="p">:</span>
</code></pre></div>

<p>from langgraph.graph import StateGraph</p>
<p>builder = StateGraph(...)</p>
<h1 id="define-the-graph_2">... define the graph<a class="headerlink" href="#define-the-graph_2" title="Permanent link">#</a></h1>
<p>checkpointer = # mongodb checkpointer (see examples below)
graph = builder.compile(checkpointer=checkpointer)
...</p>
<div class="codehilite"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="nx">Setup</span>
<span class="nx">To</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">MongoDB</span><span class="w"> </span><span class="nx">checkpointer</span><span class="p">,</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">will</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">MongoDB</span><span class="w"> </span><span class="nx">cluster</span><span class="p">.</span><span class="w"> </span><span class="nx">Follow</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">guide</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">cluster</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">don</span><span class="err">&#39;</span><span class="nx">t</span><span class="w"> </span><span class="nx">already</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">one</span><span class="p">.</span>

<span class="nx">Next</span><span class="p">,</span><span class="w"> </span><span class="kd">let</span><span class="err">&#39;</span><span class="nx">s</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">required</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">our</span><span class="w"> </span><span class="nx">API</span><span class="w"> </span><span class="nx">keys</span>
</code></pre></div>

<p>%%capture --no-stderr
%pip install -U pymongo langgraph langgraph-checkpoint-mongodb</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>import getpass
import os</p>
<p>def _set_env(var: str):
    if not os.environ.get(var):
        os.environ[var] = getpass.getpass(f"{var}: ")</p>
<p>_set_env("OPENAI_API_KEY")</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>OPENAI_API_KEY:  ········</p>
<div class="codehilite"><pre><span></span><code><span class="c1">## Define model and tools for the graph</span>
</code></pre></div>

<p>from typing import Literal</p>
<p>from langchain_core.tools import tool
from langchain_openai import ChatOpenAI
from langgraph.prebuilt import create_react_agent</p>
<p>@tool
def get_weather(city: Literal["nyc", "sf"]):
    """Use this to get weather information."""
    if city == "nyc":
        return "It might be cloudy in nyc"
    elif city == "sf":
        return "It's always sunny in sf"
    else:
        raise AssertionError("Unknown city")</p>
<p>tools = [get_weather]
model = ChatOpenAI(model_name="gpt-4o-mini", temperature=0)</p>
<div class="codehilite"><pre><span></span><code>##<span class="w"> </span><span class="nv">MongoDB</span><span class="w"> </span><span class="nv">checkpointer</span><span class="w"> </span><span class="nv">usage</span>
##<span class="w"> </span><span class="nv">With</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">connection</span><span class="w"> </span><span class="nv">string</span>

<span class="nv">This</span><span class="w"> </span><span class="nv">creates</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">connection</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">MongoDB</span><span class="w"> </span><span class="nv">directly</span><span class="w"> </span><span class="nv">using</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">connection</span><span class="w"> </span><span class="nv">string</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">your</span><span class="w"> </span><span class="nv">cluster</span>.<span class="w"> </span><span class="nv">This</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">ideal</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">use</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">scripts</span>,<span class="w"> </span><span class="nv">one</span><span class="o">-</span><span class="nv">off</span><span class="w"> </span><span class="nv">operations</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">short</span><span class="o">-</span><span class="nv">lived</span><span class="w"> </span><span class="nv">applications</span>.
</code></pre></div>

<p>from langgraph.checkpoint.mongodb import MongoDBSaver</p>
<p>MONGODB_URI = "localhost:27017"  # replace this with your connection string</p>
<p>with MongoDBSaver.from_conn_string(MONGODB_URI) as checkpointer:
    graph = create_react_agent(model, tools=tools, checkpointer=checkpointer)
    config = {"configurable": {"thread_id": "1"}}
    response = graph.invoke(
        {"messages": [("human", "what's the weather in sf")]}, config
    )</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>response</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{'messages': [HumanMessage(content="what's the weather in sf", additional_kwargs={}, response_metadata={}, id='729afd6a-fdc0-4192-a255-1dac065c79b2'),
  AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_YqaO8oU3BhGmIz9VHTxqGyyN', 'function': {'arguments': '{"city":"sf"}', 'name': 'get_weather'}, 'type': 'function'}], 'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 14, 'prompt_tokens': 57, 'total_tokens': 71, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_39a40c96a0', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-b45c0c12-c68e-4392-92dd-5d325d0a9f60-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'sf'}, 'id': 'call_YqaO8oU3BhGmIz9VHTxqGyyN', 'type': 'tool_call'}], usage_metadata={'input_tokens': 57, 'output_tokens': 14, 'total_tokens': 71, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}),
  ToolMessage(content="It's always sunny in sf", name='get_weather', id='0c72eb29-490b-44df-898f-8454c314eac1', tool_call_id='call_YqaO8oU3BhGmIz9VHTxqGyyN'),
  AIMessage(content='The weather in San Francisco is always sunny!', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 10, 'prompt_tokens': 84, 'total_tokens': 94, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_818c284075', 'finish_reason': 'stop', 'logprobs': None}, id='run-33f54c91-0ba9-48b7-9b25-5a972bbdeea9-0', usage_metadata={'input_tokens': 84, 'output_tokens': 10, 'total_tokens': 94, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})]}
  ```</p>
<p>## Using the MongoDB client
  This creates a connection to MongoDB using the MongoDB client. This is ideal for long-running applications since it allows you to reuse the client instance for multiple database operations without needing to reinitialize the connection each time.</p>
<p>```
  from pymongo import MongoClient</p>
<p>mongodb_client = MongoClient(MONGODB_URI)</p>
<p>checkpointer = MongoDBSaver(mongodb_client)
graph = create_react_agent(model, tools=tools, checkpointer=checkpointer)
config = {"configurable": {"thread_id": "2"}}
response = graph.invoke({"messages": [("user", "What's the weather in sf?")]}, config)</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>response</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{'messages': [HumanMessage(content="What's the weather in sf?", additional_kwargs={}, response_metadata={}, id='4ce68bee-a843-4b08-9c02-7a0e3b010110'),
  AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_MvGxq9IU9wvW9mfYKSALHtGu', 'function': {'arguments': '{"city":"sf"}', 'name': 'get_weather'}, 'type': 'function'}], 'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 14, 'prompt_tokens': 57, 'total_tokens': 71, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_6fc10e10eb', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-9712c5a4-376c-4812-a0c4-1b522334a59d-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'sf'}, 'id': 'call_MvGxq9IU9wvW9mfYKSALHtGu', 'type': 'tool_call'}], usage_metadata={'input_tokens': 57, 'output_tokens': 14, 'total_tokens': 71, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}),
  ToolMessage(content="It's always sunny in sf", name='get_weather', id='b4eed38d-bcaf-4497-ad08-f21ccd6a8c30', tool_call_id='call_MvGxq9IU9wvW9mfYKSALHtGu'),
  AIMessage(content='The weather in San Francisco is always sunny!', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 10, 'prompt_tokens': 84, 'total_tokens': 94, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_6fc10e10eb', 'finish_reason': 'stop', 'logprobs': None}, id='run-c6c4ad75-89ef-4b4f-9ca4-bd52ccb0729b-0', usage_metadata={'input_tokens': 84, 'output_tokens': 10, 'total_tokens': 94, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})]}</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<h1 id="retrieve-the-latest-checkpoint-for-the-given-thread-id">Retrieve the latest checkpoint for the given thread ID<a class="headerlink" href="#retrieve-the-latest-checkpoint-for-the-given-thread-id" title="Permanent link">#</a></h1>
<h1 id="to-retrieve-a-specific-checkpoint-pass-the-checkpoint_id-in-the-config">To retrieve a specific checkpoint, pass the checkpoint_id in the config<a class="headerlink" href="#to-retrieve-a-specific-checkpoint-pass-the-checkpoint_id-in-the-config" title="Permanent link">#</a></h1>
<p>checkpointer.get_tuple(config)</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>CheckpointTuple(config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1efb8c75-9262-68b4-8003-1ac1ef198757'}}, checkpoint={'v': 1, 'ts': '2024-12-12T20:26:20.545003+00:00', 'id': '1efb8c75-9262-68b4-8003-1ac1ef198757', 'channel_values': {'messages': [HumanMessage(content="What's the weather in sf?", additional_kwargs={}, response_metadata={}, id='4ce68bee-a843-4b08-9c02-7a0e3b010110'), AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_MvGxq9IU9wvW9mfYKSALHtGu', 'function': {'arguments': '{"city":"sf"}', 'name': 'get_weather'}, 'type': 'function'}], 'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 14, 'prompt_tokens': 57, 'total_tokens': 71, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_6fc10e10eb', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-9712c5a4-376c-4812-a0c4-1b522334a59d-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'sf'}, 'id': 'call_MvGxq9IU9wvW9mfYKSALHtGu', 'type': 'tool_call'}], usage_metadata={'input_tokens': 57, 'output_tokens': 14, 'total_tokens': 71, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}), ToolMessage(content="It's always sunny in sf", name='get_weather', id='b4eed38d-bcaf-4497-ad08-f21ccd6a8c30', tool_call_id='call_MvGxq9IU9wvW9mfYKSALHtGu'), AIMessage(content='The weather in San Francisco is always sunny!', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 10, 'prompt_tokens': 84, 'total_tokens': 94, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_6fc10e10eb', 'finish_reason': 'stop', 'logprobs': None}, id='run-c6c4ad75-89ef-4b4f-9ca4-bd52ccb0729b-0', usage_metadata={'input_tokens': 84, 'output_tokens': 10, 'total_tokens': 94, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})], 'agent': 'agent'}, 'channel_versions': {'<strong>start</strong>': 2, 'messages': 5, 'start:agent': 3, 'agent': 5, 'branch:agent:should_continue:tools': 4, 'tools': 5}, 'versions_seen': {'<strong>input</strong>': {}, '<strong>start</strong>': {'<strong>start</strong>': 1}, 'agent': {'start:agent': 2, 'tools': 4}, 'tools': {'branch:agent:should_continue:tools': 3}}, 'pending_sends': []}, metadata={'source': 'loop', 'writes': {'agent': {'messages': [AIMessage(content='The weather in San Francisco is always sunny!', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 10, 'prompt_tokens': 84, 'total_tokens': 94, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_6fc10e10eb', 'finish_reason': 'stop', 'logprobs': None}, id='run-c6c4ad75-89ef-4b4f-9ca4-bd52ccb0729b-0', usage_metadata={'input_tokens': 84, 'output_tokens': 10, 'total_tokens': 94, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})]}}, 'thread_id': '2', 'step': 3, 'parents': {}}, parent_config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1efb8c75-8d89-6ffe-8002-84a4312c4fed'}}, pending_writes=[])</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<h1 id="remember-to-close-the-connection-after-youre-done">Remember to close the connection after you're done<a class="headerlink" href="#remember-to-close-the-connection-after-youre-done" title="Permanent link">#</a></h1>
<p>mongodb_client.close()</p>
<div class="codehilite"><pre><span></span><code>##<span class="w"> </span><span class="nv">Using</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">async</span><span class="w"> </span><span class="nv">connection</span>
<span class="nv">This</span><span class="w"> </span><span class="nv">creates</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">short</span><span class="o">-</span><span class="nv">lived</span><span class="w"> </span><span class="nv">asynchronous</span><span class="w"> </span><span class="nv">connection</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">MongoDB</span>.

<span class="nv">Async</span><span class="w"> </span><span class="nv">connections</span><span class="w"> </span><span class="nv">allow</span><span class="w"> </span><span class="nv">non</span><span class="o">-</span><span class="nv">blocking</span><span class="w"> </span><span class="nv">database</span><span class="w"> </span><span class="nv">operations</span>.<span class="w"> </span><span class="nv">This</span><span class="w"> </span><span class="nv">means</span><span class="w"> </span><span class="nv">other</span><span class="w"> </span><span class="nv">parts</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">your</span><span class="w"> </span><span class="nv">application</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="nv">running</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nv">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">database</span><span class="w"> </span><span class="nv">operations</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">complete</span>.<span class="w"> </span><span class="nv">It</span><span class="err">&#39;s particularly useful in high-concurrency scenarios or when dealing with I/O-bound operations.</span>
</code></pre></div>

<p>from langgraph.checkpoint.mongodb.aio import AsyncMongoDBSaver</p>
<p>async with AsyncMongoDBSaver.from_conn_string(MONGODB_URI) as checkpointer:
    graph = create_react_agent(model, tools=tools, checkpointer=checkpointer)
    config = {"configurable": {"thread_id": "3"}}
    response = await graph.ainvoke(
        {"messages": [("user", "What's the weather in sf?")]}, config
    )</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>response</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{'messages': [HumanMessage(content="What's the weather in sf?", additional_kwargs={}, response_metadata={}, id='fed70fe6-1b2e-4481-9bfc-063df3b587dc'),
  AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_miRiF3vPQv98wlDHl6CeRxBy', 'function': {'arguments': '{"city":"sf"}', 'name': 'get_weather'}, 'type': 'function'}], 'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 14, 'prompt_tokens': 57, 'total_tokens': 71, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_6fc10e10eb', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-7f2d5153-973e-4a9e-8b71-a77625c342cf-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'sf'}, 'id': 'call_miRiF3vPQv98wlDHl6CeRxBy', 'type': 'tool_call'}], usage_metadata={'input_tokens': 57, 'output_tokens': 14, 'total_tokens': 71, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}),
  ToolMessage(content="It's always sunny in sf", name='get_weather', id='49035e8e-8aee-4d9d-88ab-9a1bc10ecbd3', tool_call_id='call_miRiF3vPQv98wlDHl6CeRxBy'),
  AIMessage(content='The weather in San Francisco is always sunny!', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 10, 'prompt_tokens': 84, 'total_tokens': 94, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_6fc10e10eb', 'finish_reason': 'stop', 'logprobs': None}, id='run-9403d502-391e-4407-99fd-eec8ed184e50-0', usage_metadata={'input_tokens': 84, 'output_tokens': 10, 'total_tokens': 94, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})]}</p>
<div class="codehilite"><pre><span></span><code>## Using the async MongoDB client
This routes connections to MongoDB through an asynchronous MongoDB client.
</code></pre></div>

<p>from pymongo import AsyncMongoClient</p>
<p>async_mongodb_client = AsyncMongoClient(MONGODB_URI)</p>
<p>checkpointer = AsyncMongoDBSaver(async_mongodb_client)
graph = create_react_agent(model, tools=tools, checkpointer=checkpointer)
config = {"configurable": {"thread_id": "4"}}
response = await graph.ainvoke(
    {"messages": [("user", "What's the weather in sf?")]}, config
)</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>response</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{'messages': [HumanMessage(content="What's the weather in sf?", additional_kwargs={}, response_metadata={}, id='58282e2b-4cc1-40a1-8e65-420a2177bbd6'),
  AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_SJFViVHl1tYTZDoZkNN3ePhJ', 'function': {'arguments': '{"city":"sf"}', 'name': 'get_weather'}, 'type': 'function'}], 'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 14, 'prompt_tokens': 57, 'total_tokens': 71, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_bba3c8e70b', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-131af8c1-d388-4d7f-9137-da59ebd5fefd-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'sf'}, 'id': 'call_SJFViVHl1tYTZDoZkNN3ePhJ', 'type': 'tool_call'}], usage_metadata={'input_tokens': 57, 'output_tokens': 14, 'total_tokens': 71, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}),
  ToolMessage(content="It's always sunny in sf", name='get_weather', id='6090a56f-177b-4d3f-b16a-9c05f23800e3', tool_call_id='call_SJFViVHl1tYTZDoZkNN3ePhJ'),
  AIMessage(content='The weather in San Francisco is always sunny!', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 10, 'prompt_tokens': 84, 'total_tokens': 94, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_6fc10e10eb', 'finish_reason': 'stop', 'logprobs': None}, id='run-6ff5ddf5-6e13-4126-8df9-81c8638355fc-0', usage_metadata={'input_tokens': 84, 'output_tokens': 10, 'total_tokens': 94, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})]}</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<h1 id="retrieve-the-latest-checkpoint-for-the-given-thread-id_1">Retrieve the latest checkpoint for the given thread ID<a class="headerlink" href="#retrieve-the-latest-checkpoint-for-the-given-thread-id_1" title="Permanent link">#</a></h1>
<h1 id="to-retrieve-a-specific-checkpoint-pass-the-checkpoint_id-in-the-config_1">To retrieve a specific checkpoint, pass the checkpoint_id in the config<a class="headerlink" href="#to-retrieve-a-specific-checkpoint-pass-the-checkpoint_id-in-the-config_1" title="Permanent link">#</a></h1>
<p>latest_checkpoint = await checkpointer.aget_tuple(config)
print(latest_checkpoint)</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>CheckpointTuple(config={'configurable': {'thread_id': '4', 'checkpoint_ns': '', 'checkpoint_id': '1efb8c76-21f4-6d10-8003-9496e1754e93'}}, checkpoint={'v': 1, 'ts': '2024-12-12T20:26:35.599560+00:00', 'id': '1efb8c76-21f4-6d10-8003-9496e1754e93', 'channel_values': {'messages': [HumanMessage(content="What's the weather in sf?", additional_kwargs={}, response_metadata={}, id='58282e2b-4cc1-40a1-8e65-420a2177bbd6'), AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_SJFViVHl1tYTZDoZkNN3ePhJ', 'function': {'arguments': '{"city":"sf"}', 'name': 'get_weather'}, 'type': 'function'}], 'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 14, 'prompt_tokens': 57, 'total_tokens': 71, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_bba3c8e70b', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-131af8c1-d388-4d7f-9137-da59ebd5fefd-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'sf'}, 'id': 'call_SJFViVHl1tYTZDoZkNN3ePhJ', 'type': 'tool_call'}], usage_metadata={'input_tokens': 57, 'output_tokens': 14, 'total_tokens': 71, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}), ToolMessage(content="It's always sunny in sf", name='get_weather', id='6090a56f-177b-4d3f-b16a-9c05f23800e3', tool_call_id='call_SJFViVHl1tYTZDoZkNN3ePhJ'), AIMessage(content='The weather in San Francisco is always sunny!', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 10, 'prompt_tokens': 84, 'total_tokens': 94, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_6fc10e10eb', 'finish_reason': 'stop', 'logprobs': None}, id='run-6ff5ddf5-6e13-4126-8df9-81c8638355fc-0', usage_metadata={'input_tokens': 84, 'output_tokens': 10, 'total_tokens': 94, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})], 'agent': 'agent'}, 'channel_versions': {'<strong>start</strong>': 2, 'messages': 5, 'start:agent': 3, 'agent': 5, 'branch:agent:should_continue:tools': 4, 'tools': 5}, 'versions_seen': {'<strong>input</strong>': {}, '<strong>start</strong>': {'<strong>start</strong>': 1}, 'agent': {'start:agent': 2, 'tools': 4}, 'tools': {'branch:agent:should_continue:tools': 3}}, 'pending_sends': []}, metadata={'source': 'loop', 'writes': {'agent': {'messages': [AIMessage(content='The weather in San Francisco is always sunny!', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 10, 'prompt_tokens': 84, 'total_tokens': 94, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_6fc10e10eb', 'finish_reason': 'stop', 'logprobs': None}, id='run-6ff5ddf5-6e13-4126-8df9-81c8638355fc-0', usage_metadata={'input_tokens': 84, 'output_tokens': 10, 'total_tokens': 94, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})]}}, 'thread_id': '4', 'step': 3, 'parents': {}}, parent_config={'configurable': {'thread_id': '4', 'checkpoint_ns': '', 'checkpoint_id': '1efb8c76-1c6c-6474-8002-9c2595cd481c'}}, pending_writes=[])</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<h1 id="remember-to-close-the-connection-after-youre-done_1">Remember to close the connection after you're done<a class="headerlink" href="#remember-to-close-the-connection-after-youre-done_1" title="Permanent link">#</a></h1>
<p>await async_mongodb_client.close()</p>
<div class="codehilite"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="nx">How</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">custom</span><span class="w"> </span><span class="nx">checkpointer</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">Redis</span>
<span class="nx">When</span><span class="w"> </span><span class="nx">creating</span><span class="w"> </span><span class="nx">LangGraph</span><span class="w"> </span><span class="nx">agents</span><span class="p">,</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">also</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">them</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="nx">so</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">they</span><span class="w"> </span><span class="nx">persist</span><span class="w"> </span><span class="nx">their</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="w"> </span><span class="nx">This</span><span class="w"> </span><span class="nx">allows</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">do</span><span class="w"> </span><span class="nx">things</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="nx">interact</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">agent</span><span class="w"> </span><span class="nx">multiple</span><span class="w"> </span><span class="nx">times</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="nx">remember</span><span class="w"> </span><span class="nx">previous</span><span class="w"> </span><span class="nx">interactions</span><span class="p">.</span>

<span class="nx">This</span><span class="w"> </span><span class="nx">reference</span><span class="w"> </span><span class="nx">implementation</span><span class="w"> </span><span class="nx">shows</span><span class="w"> </span><span class="nx">how</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">Redis</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">backend</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">persisting</span><span class="w"> </span><span class="nx">checkpoint</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="w"> </span><span class="nx">Make</span><span class="w"> </span><span class="nx">sure</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">Redis</span><span class="w"> </span><span class="nx">running</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="mi">6379</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">going</span><span class="w"> </span><span class="nx">through</span><span class="w"> </span><span class="nx">this</span><span class="w"> </span><span class="nx">guide</span><span class="p">.</span>

<span class="nx">For</span><span class="w"> </span><span class="nx">demonstration</span><span class="w"> </span><span class="nx">purposes</span><span class="w"> </span><span class="nx">we</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">persistence</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">pre</span><span class="o">-</span><span class="nx">built</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">react</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span>

<span class="nx">In</span><span class="w"> </span><span class="nx">general</span><span class="p">,</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">can</span><span class="w"> </span><span class="nx">add</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">checkpointer</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="nx">custom</span><span class="w"> </span><span class="nx">graph</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="nx">this</span><span class="p">:</span>
</code></pre></div>

<p>from langgraph.graph import StateGraph</p>
<p>builder = StateGraph(....)</p>
<h1 id="define-the-graph_3">... define the graph<a class="headerlink" href="#define-the-graph_3" title="Permanent link">#</a></h1>
<p>checkpointer = # redis checkpointer (see examples below)
graph = builder.compile(checkpointer=checkpointer)
...</p>
<div class="codehilite"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="nx">Setup</span>
<span class="nx">First</span><span class="p">,</span><span class="w"> </span><span class="kd">let</span><span class="err">&#39;</span><span class="nx">s</span><span class="w"> </span><span class="nx">install</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">required</span><span class="w"> </span><span class="nx">packages</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nx">our</span><span class="w"> </span><span class="nx">API</span><span class="w"> </span><span class="nx">keys</span>
</code></pre></div>

<p>%%capture --no-stderr
%pip install -U redis langgraph langchain_openai</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>import getpass
import os</p>
<p>def _set_env(var: str):
    if not os.environ.get(var):
        os.environ[var] = getpass.getpass(f"{var}: ")</p>
<p>_set_env("OPENAI_API_KEY")</p>
<div class="codehilite"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="nx">Checkpointer</span><span class="w"> </span><span class="nx">implementation</span>
<span class="err">##</span><span class="w"> </span><span class="nx">Define</span><span class="w"> </span><span class="nx">imports</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">helper</span><span class="w"> </span><span class="nx">functions</span>

<span class="nx">First</span><span class="p">,</span><span class="w"> </span><span class="kd">let</span><span class="err">&#39;</span><span class="nx">s</span><span class="w"> </span><span class="nx">define</span><span class="w"> </span><span class="nx">some</span><span class="w"> </span><span class="nx">imports</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">shared</span><span class="w"> </span><span class="nx">utilities</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">both</span><span class="w"> </span><span class="nx">RedisSaver</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">AsyncRedisSaver</span>
</code></pre></div>

<p>"""Implementation of a langgraph checkpoint saver using Redis."""
from contextlib import asynccontextmanager, contextmanager
from typing import (
    Any,
    AsyncGenerator,
    AsyncIterator,
    Iterator,
    List,
    Optional,
    Tuple,
)</p>
<p>from langchain_core.runnables import RunnableConfig</p>
<p>from langgraph.checkpoint.base import (
    WRITES_IDX_MAP,
    BaseCheckpointSaver,
    ChannelVersions,
    Checkpoint,
    CheckpointMetadata,
    CheckpointTuple,
    PendingWrite,
    get_checkpoint_id,
)
from langgraph.checkpoint.serde.base import SerializerProtocol
from redis import Redis
from redis.asyncio import Redis as AsyncRedis</p>
<p>REDIS_KEY_SEPARATOR = "$"</p>
<h1 id="utilities-shared-by-both-redissaver-and-asyncredissaver">Utilities shared by both RedisSaver and AsyncRedisSaver<a class="headerlink" href="#utilities-shared-by-both-redissaver-and-asyncredissaver" title="Permanent link">#</a></h1>
<p>def _make_redis_checkpoint_key(
    thread_id: str, checkpoint_ns: str, checkpoint_id: str
) -&gt; str:
    return REDIS_KEY_SEPARATOR.join(
        ["checkpoint", thread_id, checkpoint_ns, checkpoint_id]
    )</p>
<p>def _make_redis_checkpoint_writes_key(
    thread_id: str,
    checkpoint_ns: str,
    checkpoint_id: str,
    task_id: str,
    idx: Optional[int],
) -&gt; str:
    if idx is None:
        return REDIS_KEY_SEPARATOR.join(
            ["writes", thread_id, checkpoint_ns, checkpoint_id, task_id]
        )</p>
<div class="codehilite"><pre><span></span><code>return REDIS_KEY_SEPARATOR.join(
    [&quot;writes&quot;, thread_id, checkpoint_ns, checkpoint_id, task_id, str(idx)]
)
</code></pre></div>

<p>def _parse_redis_checkpoint_key(redis_key: str) -&gt; dict:
    namespace, thread_id, checkpoint_ns, checkpoint_id = redis_key.split(
        REDIS_KEY_SEPARATOR
    )
    if namespace != "checkpoint":
        raise ValueError("Expected checkpoint key to start with 'checkpoint'")</p>
<div class="codehilite"><pre><span></span><code>return {
    &quot;thread_id&quot;: thread_id,
    &quot;checkpoint_ns&quot;: checkpoint_ns,
    &quot;checkpoint_id&quot;: checkpoint_id,
}
</code></pre></div>

<p>def _parse_redis_checkpoint_writes_key(redis_key: str) -&gt; dict:
    namespace, thread_id, checkpoint_ns, checkpoint_id, task_id, idx = redis_key.split(
        REDIS_KEY_SEPARATOR
    )
    if namespace != "writes":
        raise ValueError("Expected checkpoint key to start with 'checkpoint'")</p>
<div class="codehilite"><pre><span></span><code>return {
    &quot;thread_id&quot;: thread_id,
    &quot;checkpoint_ns&quot;: checkpoint_ns,
    &quot;checkpoint_id&quot;: checkpoint_id,
    &quot;task_id&quot;: task_id,
    &quot;idx&quot;: idx,
}
</code></pre></div>

<p>def _filter_keys(
    keys: List[str], before: Optional[RunnableConfig], limit: Optional[int]
) -&gt; list:
    """Filter and sort Redis keys based on optional criteria."""
    if before:
        keys = [
            k
            for k in keys
            if _parse_redis_checkpoint_key(k.decode())["checkpoint_id"]
            &lt; before["configurable"]["checkpoint_id"]
        ]</p>
<div class="codehilite"><pre><span></span><code>keys = sorted(
    keys,
    key=lambda k: _parse_redis_checkpoint_key(k.decode())[&quot;checkpoint_id&quot;],
    reverse=True,
)
if limit:
    keys = keys[:limit]
return keys
</code></pre></div>

<p>def <em>load_writes(
    serde: SerializerProtocol, task_id_to_data: dict[tuple[str, str], dict]
) -&gt; list[PendingWrite]:
    """Deserialize pending writes."""
    writes = [
        (
            task_id,
            data[b"channel"].decode(),
            serde.loads_typed((data[b"type"].decode(), data[b"value"])),
        )
        for (task_id, </em>), data in task_id_to_data.items()
    ]
    return writes</p>
<p>def _parse_redis_checkpoint_data(
    serde: SerializerProtocol,
    key: str,
    data: dict,
    pending_writes: Optional[List[PendingWrite]] = None,
) -&gt; Optional[CheckpointTuple]:
    """Parse checkpoint data retrieved from Redis."""
    if not data:
        return None</p>
<div class="codehilite"><pre><span></span><code><span class="n">parsed_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_parse_redis_checkpoint_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parsed_key</span><span class="p">[</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]</span>
<span class="n">checkpoint_ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parsed_key</span><span class="p">[</span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">]</span>
<span class="n">checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parsed_key</span><span class="p">[</span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">]</span>
<span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">thread_id</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">checkpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serde</span><span class="o">.</span><span class="n">loads_typed</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;checkpoint&quot;</span><span class="p">]))</span>
<span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serde</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">b</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<span class="n">parent_checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;parent_checkpoint_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="n">parent_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">thread_id</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">parent_checkpoint_id</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">parent_checkpoint_id</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="n">None</span>
<span class="p">)</span>
<span class="k">return</span><span class="w"> </span><span class="n">CheckpointTuple</span><span class="p">(</span>
<span class="w">    </span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
<span class="w">    </span><span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
<span class="w">    </span><span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
<span class="w">    </span><span class="n">parent_config</span><span class="o">=</span><span class="n">parent_config</span><span class="p">,</span>
<span class="w">    </span><span class="n">pending_writes</span><span class="o">=</span><span class="n">pending_writes</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="nx">RedisSaver</span>
<span class="nx">Below</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">implementation</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">RedisSaver</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="nx">synchronous</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">graph</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">e</span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="nx">invoke</span><span class="p">(),</span><span class="w"> </span><span class="p">.</span><span class="nx">stream</span><span class="p">()).</span><span class="w"> </span><span class="nx">RedisSaver</span><span class="w"> </span><span class="nx">implements</span><span class="w"> </span><span class="nx">four</span><span class="w"> </span><span class="nx">methods</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">required</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="nx">checkpointer</span><span class="p">:</span>

<span class="o">-</span><span class="w"> </span><span class="p">.</span><span class="nx">put</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Store</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">checkpoint</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">its</span><span class="w"> </span><span class="nx">configuration</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">metadata</span><span class="p">.</span>
<span class="o">-</span><span class="w"> </span><span class="p">.</span><span class="nx">put_writes</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Store</span><span class="w"> </span><span class="nx">intermediate</span><span class="w"> </span><span class="nx">writes</span><span class="w"> </span><span class="nx">linked</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">checkpoint</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">e</span><span class="p">.</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="nx">writes</span><span class="p">).</span>
<span class="o">-</span><span class="w"> </span><span class="p">.</span><span class="nx">get_tuple</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Fetch</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">checkpoint</span><span class="w"> </span><span class="nx">tuple</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">given</span><span class="w"> </span><span class="nx">configuration</span><span class="w"> </span><span class="p">(</span><span class="nx">thread_id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">checkpoint_id</span><span class="p">).</span>
<span class="o">-</span><span class="w"> </span><span class="p">.</span><span class="nx">list</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">checkpoints</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">given</span><span class="w"> </span><span class="nx">configuration</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">filter</span><span class="w"> </span><span class="nx">criteria</span><span class="p">.</span>
</code></pre></div>

<p>class RedisSaver(BaseCheckpointSaver):
    """Redis-based checkpoint saver implementation."""</p>
<div class="codehilite"><pre><span></span><code><span class="n">conn</span><span class="p">:</span><span class="w"> </span><span class="n">Redis</span>

<span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p">:</span><span class="w"> </span><span class="n">Redis</span><span class="p">):</span>
<span class="w">    </span><span class="n">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
<span class="w">    </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span>

<span class="err">@</span><span class="n">classmethod</span>
<span class="err">@</span><span class="n">contextmanager</span>
<span class="n">def</span><span class="w"> </span><span class="n">from_conn_info</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">,</span><span class="w"> </span><span class="n">db</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Iterator</span><span class="p">[</span><span class="s2">&quot;RedisSaver&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">    </span><span class="n">try</span><span class="p">:</span>
<span class="w">        </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
<span class="w">        </span><span class="nb">yield</span><span class="w"> </span><span class="n">RedisSaver</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
<span class="w">    </span><span class="n">finally</span><span class="p">:</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">conn</span><span class="p">:</span>
<span class="w">            </span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">def</span><span class="w"> </span><span class="n">put</span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="p">,</span>
<span class="w">    </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="p">,</span>
<span class="w">    </span><span class="n">checkpoint</span><span class="p">:</span><span class="w"> </span><span class="n">Checkpoint</span><span class="p">,</span>
<span class="w">    </span><span class="n">metadata</span><span class="p">:</span><span class="w"> </span><span class="n">CheckpointMetadata</span><span class="p">,</span>
<span class="w">    </span><span class="n">new_versions</span><span class="p">:</span><span class="w"> </span><span class="n">ChannelVersions</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save a checkpoint to Redis.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (RunnableConfig): The config to associate with the checkpoint.</span>
<span class="sd">        checkpoint (Checkpoint): The checkpoint to save.</span>
<span class="sd">        metadata (CheckpointMetadata): Additional metadata to save with the checkpoint.</span>
<span class="sd">        new_versions (ChannelVersions): New channel versions as of this write.</span>

<span class="sd">    Returns:</span>
<span class="sd">        RunnableConfig: Updated configuration after storing the checkpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">parent_checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_make_redis_checkpoint_key</span><span class="p">(</span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">)</span>

<span class="w">    </span><span class="n">type_</span><span class="p">,</span><span class="w"> </span><span class="n">serialized_checkpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="o">.</span><span class="n">dumps_typed</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="w">    </span><span class="n">serialized_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
<span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;checkpoint&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">serialized_checkpoint</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">type_</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">serialized_metadata</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;parent_checkpoint_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">parent_checkpoint_id</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">parent_checkpoint_id</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">thread_id</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="n">def</span><span class="w"> </span><span class="n">put_writes</span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="p">,</span>
<span class="w">    </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="p">,</span>
<span class="w">    </span><span class="n">writes</span><span class="p">:</span><span class="w"> </span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]],</span>
<span class="w">    </span><span class="n">task_id</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store intermediate writes linked to a checkpoint.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (RunnableConfig): Configuration of the related checkpoint.</span>
<span class="sd">        writes (Sequence[Tuple[str, Any]]): List of writes to store, each as (channel, value) pair.</span>
<span class="sd">        task_id (str): Identifier for the task creating the writes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">]</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">writes</span><span class="p">):</span>
<span class="w">        </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_make_redis_checkpoint_writes_key</span><span class="p">(</span>
<span class="w">            </span><span class="n">thread_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">checkpoint_ns</span><span class="p">,</span>
<span class="w">            </span><span class="n">checkpoint_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">task_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">WRITES_IDX_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">),</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="n">type_</span><span class="p">,</span><span class="w"> </span><span class="n">serialized_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="o">.</span><span class="n">dumps_typed</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;channel&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">type_</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">serialized_value</span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">all</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">WRITES_IDX_MAP</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">writes</span><span class="p">):</span>
<span class="w">            </span><span class="c1"># Use HSET which will overwrite existing values</span>
<span class="w">            </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># Use HSETNX which will not overwrite existing values</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hsetnx</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>

<span class="n">def</span><span class="w"> </span><span class="n">get_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">CheckpointTuple</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a checkpoint tuple from Redis.</span>

<span class="sd">    This method retrieves a checkpoint tuple from Redis based on the</span>
<span class="sd">    provided config. If the config contains a &quot;checkpoint_id&quot; key, the checkpoint with</span>
<span class="sd">    the matching thread ID and checkpoint ID is retrieved. Otherwise, the latest checkpoint</span>
<span class="sd">    for the given thread ID is retrieved.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (RunnableConfig): The config to use for retrieving the checkpoint.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[CheckpointTuple]: The retrieved checkpoint tuple, or None if no matching checkpoint was found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_checkpoint_id</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">checkpoint_ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">checkpoint_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_get_checkpoint_key</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">checkpoint_key</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">None</span>

<span class="w">    </span><span class="n">checkpoint_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">checkpoint_key</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># load pending writes</span>
<span class="w">    </span><span class="n">checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="n">checkpoint_id</span>
<span class="w">        </span><span class="ow">or</span><span class="w"> </span><span class="n">_parse_redis_checkpoint_key</span><span class="p">(</span><span class="n">checkpoint_key</span><span class="p">)[</span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">pending_writes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_load_pending_writes</span><span class="p">(</span>
<span class="w">        </span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_parse_redis_checkpoint_data</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_key</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_data</span><span class="p">,</span><span class="w"> </span><span class="n">pending_writes</span><span class="o">=</span><span class="n">pending_writes</span>
<span class="w">    </span><span class="p">)</span>

<span class="n">def</span><span class="w"> </span><span class="n">list</span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="p">,</span>
<span class="w">    </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">],</span>
<span class="w">    </span><span class="o">*</span><span class="p">,</span>
<span class="w">    </span><span class="c1"># TODO: implement filtering</span>
<span class="w">    </span><span class="n">filter</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>
<span class="w">    </span><span class="n">before</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>
<span class="w">    </span><span class="n">limit</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb nb-Type">int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Iterator</span><span class="p">[</span><span class="n">CheckpointTuple</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List checkpoints from the database.</span>

<span class="sd">    This method retrieves a list of checkpoint tuples from Redis based</span>
<span class="sd">    on the provided config. The checkpoints are ordered by checkpoint ID in descending order (newest first).</span>

<span class="sd">    Args:</span>
<span class="sd">        config (RunnableConfig): The config to use for listing the checkpoints.</span>
<span class="sd">        filter (Optional[Dict[str, Any]]): Additional filtering criteria for metadata. Defaults to None.</span>
<span class="sd">        before (Optional[RunnableConfig]): If provided, only checkpoints before the specified checkpoint ID are returned. Defaults to None.</span>
<span class="sd">        limit (Optional[int]): The maximum number of checkpoints to return. Defaults to None.</span>

<span class="sd">    Yields:</span>
<span class="sd">        Iterator[CheckpointTuple]: An iterator of checkpoint tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_make_redis_checkpoint_key</span><span class="p">(</span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_filter_keys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span><span class="w"> </span><span class="n">before</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">keys</span><span class="p">:</span>
<span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="sa">b</span><span class="s2">&quot;checkpoint&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="sa">b</span><span class="s2">&quot;metadata&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">data</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># load pending writes</span>
<span class="w">            </span><span class="n">checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_parse_redis_checkpoint_key</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">())[</span>
<span class="w">                </span><span class="s2">&quot;checkpoint_id&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">            </span><span class="n">pending_writes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_load_pending_writes</span><span class="p">(</span>
<span class="w">                </span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">            </span><span class="nb">yield</span><span class="w"> </span><span class="n">_parse_redis_checkpoint_data</span><span class="p">(</span>
<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">pending_writes</span><span class="o">=</span><span class="n">pending_writes</span>
<span class="w">            </span><span class="p">)</span>

<span class="n">def</span><span class="w"> </span><span class="n">_load_pending_writes</span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">thread_id</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">List</span><span class="p">[</span><span class="n">PendingWrite</span><span class="p">]:</span>
<span class="w">    </span><span class="n">writes_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_make_redis_checkpoint_writes_key</span><span class="p">(</span>
<span class="w">        </span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">None</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">matching_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">writes_key</span><span class="p">)</span>
<span class="w">    </span><span class="n">parsed_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="n">_parse_redis_checkpoint_writes_key</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">matching_keys</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">    </span><span class="n">pending_writes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_load_writes</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="p">,</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="n">parsed_key</span><span class="p">[</span><span class="s2">&quot;task_id&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">parsed_key</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]):</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">parsed_key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sorted</span><span class="p">(</span>
<span class="w">                </span><span class="n">zip</span><span class="p">(</span><span class="n">matching_keys</span><span class="p">,</span><span class="w"> </span><span class="n">parsed_keys</span><span class="p">),</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="n">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pending_writes</span>

<span class="n">def</span><span class="w"> </span><span class="n">_get_checkpoint_key</span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">thread_id</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the Redis key for a checkpoint.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">_make_redis_checkpoint_key</span><span class="p">(</span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">)</span>

<span class="w">    </span><span class="n">all_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">_make_redis_checkpoint_key</span><span class="p">(</span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">all_keys</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">None</span>

<span class="w">    </span><span class="n">latest_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span>
<span class="w">        </span><span class="n">all_keys</span><span class="p">,</span>
<span class="w">        </span><span class="n">key</span><span class="o">=</span><span class="n">lambda</span><span class="w"> </span><span class="n">k</span><span class="p">:</span><span class="w"> </span><span class="n">_parse_redis_checkpoint_key</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">decode</span><span class="p">())[</span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">latest_key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="nx">AsyncRedis</span>
<span class="nx">Below</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">reference</span><span class="w"> </span><span class="nx">implementation</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">AsyncRedisSaver</span><span class="w"> </span><span class="p">(</span><span class="k">for</span><span class="w"> </span><span class="nx">asynchronous</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">graph</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="p">.</span><span class="nx">e</span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="nx">ainvoke</span><span class="p">(),</span><span class="w"> </span><span class="p">.</span><span class="nx">astream</span><span class="p">()).</span><span class="w"> </span><span class="nx">AsyncRedisSaver</span><span class="w"> </span><span class="nx">implements</span><span class="w"> </span><span class="nx">four</span><span class="w"> </span><span class="nx">methods</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">required</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="nx">async</span><span class="w"> </span><span class="nx">checkpointer</span><span class="p">:</span>

<span class="o">-</span><span class="w"> </span><span class="p">.</span><span class="nx">aput</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Store</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">checkpoint</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">its</span><span class="w"> </span><span class="nx">configuration</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">metadata</span><span class="p">.</span>
<span class="o">-</span><span class="w"> </span><span class="p">.</span><span class="nx">aput_writes</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Store</span><span class="w"> </span><span class="nx">intermediate</span><span class="w"> </span><span class="nx">writes</span><span class="w"> </span><span class="nx">linked</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">checkpoint</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="p">.</span><span class="nx">e</span><span class="p">.</span><span class="w"> </span><span class="nx">pending</span><span class="w"> </span><span class="nx">writes</span><span class="p">).</span>
<span class="o">-</span><span class="w"> </span><span class="p">.</span><span class="nx">aget_tuple</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Fetch</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">checkpoint</span><span class="w"> </span><span class="nx">tuple</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">given</span><span class="w"> </span><span class="nx">configuration</span><span class="w"> </span><span class="p">(</span><span class="nx">thread_id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">checkpoint_id</span><span class="p">).</span>
<span class="o">-</span><span class="w"> </span><span class="p">.</span><span class="nx">alist</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">checkpoints</span><span class="w"> </span><span class="nx">that</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">given</span><span class="w"> </span><span class="nx">configuration</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">filter</span><span class="w"> </span><span class="nx">criteria</span><span class="p">.</span>
</code></pre></div>

<p>class AsyncRedisSaver(BaseCheckpointSaver):
    """Async redis-based checkpoint saver implementation."""</p>
<div class="codehilite"><pre><span></span><code><span class="n">conn</span><span class="p">:</span><span class="w"> </span><span class="n">AsyncRedis</span>

<span class="n">def</span><span class="w"> </span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p">:</span><span class="w"> </span><span class="n">AsyncRedis</span><span class="p">):</span>
<span class="w">    </span><span class="n">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
<span class="w">    </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">conn</span>

<span class="err">@</span><span class="n">classmethod</span>
<span class="err">@</span><span class="n">asynccontextmanager</span>
<span class="n">async</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">from_conn_info</span><span class="p">(</span>
<span class="w">    </span><span class="n">cls</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">int</span><span class="p">,</span><span class="w"> </span><span class="n">db</span><span class="p">:</span><span class="w"> </span><span class="nb nb-Type">int</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">AsyncIterator</span><span class="p">[</span><span class="s2">&quot;AsyncRedisSaver&quot;</span><span class="p">]:</span>
<span class="w">    </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span>
<span class="w">    </span><span class="n">try</span><span class="p">:</span>
<span class="w">        </span><span class="n">conn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AsyncRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
<span class="w">        </span><span class="nb">yield</span><span class="w"> </span><span class="n">AsyncRedisSaver</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
<span class="w">    </span><span class="n">finally</span><span class="p">:</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">conn</span><span class="p">:</span>
<span class="w">            </span><span class="n">await</span><span class="w"> </span><span class="n">conn</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>

<span class="n">async</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">aput</span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="p">,</span>
<span class="w">    </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="p">,</span>
<span class="w">    </span><span class="n">checkpoint</span><span class="p">:</span><span class="w"> </span><span class="n">Checkpoint</span><span class="p">,</span>
<span class="w">    </span><span class="n">metadata</span><span class="p">:</span><span class="w"> </span><span class="n">CheckpointMetadata</span><span class="p">,</span>
<span class="w">    </span><span class="n">new_versions</span><span class="p">:</span><span class="w"> </span><span class="n">ChannelVersions</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save a checkpoint to the database asynchronously.</span>

<span class="sd">    This method saves a checkpoint to Redis. The checkpoint is associated</span>
<span class="sd">    with the provided config and its parent config (if any).</span>

<span class="sd">    Args:</span>
<span class="sd">        config (RunnableConfig): The config to associate with the checkpoint.</span>
<span class="sd">        checkpoint (Checkpoint): The checkpoint to save.</span>
<span class="sd">        metadata (CheckpointMetadata): Additional metadata to save with the checkpoint.</span>
<span class="sd">        new_versions (ChannelVersions): New channel versions as of this write.</span>

<span class="sd">    Returns:</span>
<span class="sd">        RunnableConfig: Updated configuration after storing the checkpoint.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">parent_checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_make_redis_checkpoint_key</span><span class="p">(</span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">)</span>

<span class="w">    </span><span class="n">type_</span><span class="p">,</span><span class="w"> </span><span class="n">serialized_checkpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="o">.</span><span class="n">dumps_typed</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="w">    </span><span class="n">serialized_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
<span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;checkpoint&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">serialized_checkpoint</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">type_</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;metadata&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">serialized_metadata</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;parent_checkpoint_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">parent_checkpoint_id</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">parent_checkpoint_id</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">await</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">thread_id</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="n">async</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">aput_writes</span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="p">,</span>
<span class="w">    </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="p">,</span>
<span class="w">    </span><span class="n">writes</span><span class="p">:</span><span class="w"> </span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]],</span>
<span class="w">    </span><span class="n">task_id</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store intermediate writes linked to a checkpoint asynchronously.</span>

<span class="sd">    This method saves intermediate writes associated with a checkpoint to the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (RunnableConfig): Configuration of the related checkpoint.</span>
<span class="sd">        writes (Sequence[Tuple[str, Any]]): List of writes to store, each as (channel, value) pair.</span>
<span class="sd">        task_id (str): Identifier for the task creating the writes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">]</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">writes</span><span class="p">):</span>
<span class="w">        </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_make_redis_checkpoint_writes_key</span><span class="p">(</span>
<span class="w">            </span><span class="n">thread_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">checkpoint_ns</span><span class="p">,</span>
<span class="w">            </span><span class="n">checkpoint_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">task_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">WRITES_IDX_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">),</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="n">type_</span><span class="p">,</span><span class="w"> </span><span class="n">serialized_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="o">.</span><span class="n">dumps_typed</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;channel&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">type_</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="n">serialized_value</span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">all</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">WRITES_IDX_MAP</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">writes</span><span class="p">):</span>
<span class="w">            </span><span class="c1"># Use HSET which will overwrite existing values</span>
<span class="w">            </span><span class="n">await</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">mapping</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># Use HSETNX which will not overwrite existing values</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="w">                </span><span class="n">await</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hsetnx</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">field</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>

<span class="n">async</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">aget_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="n">RunnableConfig</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">CheckpointTuple</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a checkpoint tuple from Redis asynchronously.</span>

<span class="sd">    This method retrieves a checkpoint tuple from Redis based on the</span>
<span class="sd">    provided config. If the config contains a &quot;checkpoint_id&quot; key, the checkpoint with</span>
<span class="sd">    the matching thread ID and checkpoint ID is retrieved. Otherwise, the latest checkpoint</span>
<span class="sd">    for the given thread ID is retrieved.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (RunnableConfig): The config to use for retrieving the checkpoint.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[CheckpointTuple]: The retrieved checkpoint tuple, or None if no matching checkpoint was found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_checkpoint_id</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="n">checkpoint_ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="n">checkpoint_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_aget_checkpoint_key</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">checkpoint_key</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">None</span>
<span class="w">    </span><span class="n">checkpoint_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">checkpoint_key</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># load pending writes</span>
<span class="w">    </span><span class="n">checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="n">checkpoint_id</span>
<span class="w">        </span><span class="ow">or</span><span class="w"> </span><span class="n">_parse_redis_checkpoint_key</span><span class="p">(</span><span class="n">checkpoint_key</span><span class="p">)[</span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">pending_writes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_aload_pending_writes</span><span class="p">(</span>
<span class="w">        </span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">_parse_redis_checkpoint_data</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_key</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_data</span><span class="p">,</span><span class="w"> </span><span class="n">pending_writes</span><span class="o">=</span><span class="n">pending_writes</span>
<span class="w">    </span><span class="p">)</span>

<span class="n">async</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">alist</span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="p">,</span>
<span class="w">    </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">],</span>
<span class="w">    </span><span class="o">*</span><span class="p">,</span>
<span class="w">    </span><span class="c1"># TODO: implement filtering</span>
<span class="w">    </span><span class="n">filter</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">Any</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>
<span class="w">    </span><span class="n">before</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="n">RunnableConfig</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>
<span class="w">    </span><span class="n">limit</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb nb-Type">int</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">CheckpointTuple</span><span class="p">,</span><span class="w"> </span><span class="n">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List checkpoints from Redis asynchronously.</span>

<span class="sd">    This method retrieves a list of checkpoint tuples from Redis based</span>
<span class="sd">    on the provided config. The checkpoints are ordered by checkpoint ID in descending order (newest first).</span>

<span class="sd">    Args:</span>
<span class="sd">        config (Optional[RunnableConfig]): Base configuration for filtering checkpoints.</span>
<span class="sd">        filter (Optional[Dict[str, Any]]): Additional filtering criteria for metadata.</span>
<span class="sd">        before (Optional[RunnableConfig]): If provided, only checkpoints before the specified checkpoint ID are returned. Defaults to None.</span>
<span class="sd">        limit (Optional[int]): Maximum number of checkpoints to return.</span>

<span class="sd">    Yields:</span>
<span class="sd">        AsyncIterator[CheckpointTuple]: An asynchronous iterator of matching checkpoint tuples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">checkpoint_ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;checkpoint_ns&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_make_redis_checkpoint_key</span><span class="p">(</span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_filter_keys</span><span class="p">(</span><span class="n">await</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span><span class="w"> </span><span class="n">before</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">keys</span><span class="p">:</span>
<span class="w">        </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="sa">b</span><span class="s2">&quot;checkpoint&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="sa">b</span><span class="s2">&quot;metadata&quot;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">data</span><span class="p">:</span>
<span class="w">            </span><span class="n">checkpoint_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_parse_redis_checkpoint_key</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">())[</span>
<span class="w">                </span><span class="s2">&quot;checkpoint_id&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">            </span><span class="n">pending_writes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_aload_pending_writes</span><span class="p">(</span>
<span class="w">                </span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">            </span><span class="nb">yield</span><span class="w"> </span><span class="n">_parse_redis_checkpoint_data</span><span class="p">(</span>
<span class="w">                </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">pending_writes</span><span class="o">=</span><span class="n">pending_writes</span>
<span class="w">            </span><span class="p">)</span>

<span class="n">async</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">_aload_pending_writes</span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">thread_id</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">List</span><span class="p">[</span><span class="n">PendingWrite</span><span class="p">]:</span>
<span class="w">    </span><span class="n">writes_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_make_redis_checkpoint_writes_key</span><span class="p">(</span>
<span class="w">        </span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">None</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="n">matching_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">writes_key</span><span class="p">)</span>
<span class="w">    </span><span class="n">parsed_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="n">_parse_redis_checkpoint_writes_key</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">matching_keys</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">    </span><span class="n">pending_writes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_load_writes</span><span class="p">(</span>
<span class="w">        </span><span class="bp">self</span><span class="o">.</span><span class="n">serde</span><span class="p">,</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="n">parsed_key</span><span class="p">[</span><span class="s2">&quot;task_id&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">parsed_key</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]):</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">parsed_key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sorted</span><span class="p">(</span>
<span class="w">                </span><span class="n">zip</span><span class="p">(</span><span class="n">matching_keys</span><span class="p">,</span><span class="w"> </span><span class="n">parsed_keys</span><span class="p">),</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="n">lambda</span><span class="w"> </span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pending_writes</span>

<span class="n">async</span><span class="w"> </span><span class="n">def</span><span class="w"> </span><span class="n">_aget_checkpoint_key</span><span class="p">(</span>
<span class="w">    </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">thread_id</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">:</span><span class="w"> </span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">:</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Asynchronously determine the Redis key for a checkpoint.&quot;&quot;&quot;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">_make_redis_checkpoint_key</span><span class="p">(</span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_id</span><span class="p">)</span>

<span class="w">    </span><span class="n">all_keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">conn</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span>
<span class="w">        </span><span class="n">_make_redis_checkpoint_key</span><span class="p">(</span><span class="n">thread_id</span><span class="p">,</span><span class="w"> </span><span class="n">checkpoint_ns</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">all_keys</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">None</span>

<span class="w">    </span><span class="n">latest_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span>
<span class="w">        </span><span class="n">all_keys</span><span class="p">,</span>
<span class="w">        </span><span class="n">key</span><span class="o">=</span><span class="n">lambda</span><span class="w"> </span><span class="n">k</span><span class="p">:</span><span class="w"> </span><span class="n">_parse_redis_checkpoint_key</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">decode</span><span class="p">())[</span><span class="s2">&quot;checkpoint_id&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">latest_key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">## Setup model and tools for the graph</span>
</code></pre></div>

<p>from typing import Literal
from langchain_core.runnables import ConfigurableField
from langchain_core.tools import tool
from langchain_openai import ChatOpenAI
from langgraph.prebuilt import create_react_agent</p>
<p>@tool
def get_weather(city: Literal["nyc", "sf"]):
    """Use this to get weather information."""
    if city == "nyc":
        return "It might be cloudy in nyc"
    elif city == "sf":
        return "It's always sunny in sf"
    else:
        raise AssertionError("Unknown city")</p>
<p>tools = [get_weather]
model = ChatOpenAI(model_name="gpt-4o-mini", temperature=0)</p>
<div class="codehilite"><pre><span></span><code>## Use sync connection
</code></pre></div>

<p>with RedisSaver.from_conn_info(host="localhost", port=6379, db=0) as checkpointer:
    graph = create_react_agent(model, tools=tools, checkpointer=checkpointer)
    config = {"configurable": {"thread_id": "1"}}
    res = graph.invoke({"messages": [("human", "what's the weather in sf")]}, config)</p>
<div class="codehilite"><pre><span></span><code>latest_checkpoint = checkpointer.get(config)
latest_checkpoint_tuple = checkpointer.get_tuple(config)
checkpoint_tuples = list(checkpointer.list(config))
</code></pre></div>

<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>latest_checkpoint</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{'v': 1,
 'ts': '2024-08-09T01:56:48.328315+00:00',
 'id': '1ef55f2a-3614-69b4-8003-2181cff935cc',
 'channel_values': {'messages': [HumanMessage(content="what's the weather in sf", id='f911e000-75a1-41f6-8e38-77bb086c2ecf'),
   AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_l5e5YcTJDJYOdvi4scBy9n2I', 'function': {'arguments': '{"city":"sf"}', 'name': 'get_weather'}, 'type': 'function'}]}, response_metadata={'token_usage': {'completion_tokens': 14, 'prompt_tokens': 57, 'total_tokens': 71}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-4f1531f1-067c-4e16-8b62-7a6b663e93bd-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'sf'}, 'id': 'call_l5e5YcTJDJYOdvi4scBy9n2I', 'type': 'tool_call'}], usage_metadata={'input_tokens': 57, 'output_tokens': 14, 'total_tokens': 71}),
   ToolMessage(content="It's always sunny in sf", name='get_weather', id='e27bb3a1-1798-494a-b4ad-2deadda8b2bf', tool_call_id='call_l5e5YcTJDJYOdvi4scBy9n2I'),
   AIMessage(content='The weather in San Francisco is always sunny!', response_metadata={'token_usage': {'completion_tokens': 10, 'prompt_tokens': 84, 'total_tokens': 94}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'stop', 'logprobs': None}, id='run-ad546b5a-70ce-404e-9656-dcc6ecd482d3-0', usage_metadata={'input_tokens': 84, 'output_tokens': 10, 'total_tokens': 94})],
  'agent': 'agent'},
 'channel_versions': {'<strong>start</strong>': '00000000000000000000000000000002.',
  'messages': '00000000000000000000000000000005.16e98d6f7ece7598829eddf1b33a33c4',
  'start:agent': '00000000000000000000000000000003.',
  'agent': '00000000000000000000000000000005.065d90dd7f7cd091f0233855210bb2af',
  'branch:agent:should_continue:tools': '00000000000000000000000000000004.',
  'tools': '00000000000000000000000000000005.'},
 'versions_seen': {'<strong>input</strong>': {},
  '<strong>start</strong>': {'<strong>start</strong>': '00000000000000000000000000000001.ab89befb52cc0e91e106ef7f500ea033'},
  'agent': {'start:agent': '00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc',
   'tools': '00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8'},
  'tools': {'branch:agent:should_continue:tools': '00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af'}},
 'pending_sends': [],
 'current_tasks': {}}</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>latest_checkpoint_tuple</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>CheckpointTuple(config={'configurable': {'thread_id': '1', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-3614-69b4-8003-2181cff935cc'}}, checkpoint={'v': 1, 'ts': '2024-08-09T01:56:48.328315+00:00', 'id': '1ef55f2a-3614-69b4-8003-2181cff935cc', 'channel_values': {'messages': [HumanMessage(content="what's the weather in sf", id='f911e000-75a1-41f6-8e38-77bb086c2ecf'), AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_l5e5YcTJDJYOdvi4scBy9n2I', 'function': {'arguments': '{"city":"sf"}', 'name': 'get_weather'}, 'type': 'function'}]}, response_metadata={'token_usage': {'completion_tokens': 14, 'prompt_tokens': 57, 'total_tokens': 71}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-4f1531f1-067c-4e16-8b62-7a6b663e93bd-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'sf'}, 'id': 'call_l5e5YcTJDJYOdvi4scBy9n2I', 'type': 'tool_call'}], usage_metadata={'input_tokens': 57, 'output_tokens': 14, 'total_tokens': 71}), ToolMessage(content="It's always sunny in sf", name='get_weather', id='e27bb3a1-1798-494a-b4ad-2deadda8b2bf', tool_call_id='call_l5e5YcTJDJYOdvi4scBy9n2I'), AIMessage(content='The weather in San Francisco is always sunny!', response_metadata={'token_usage': {'completion_tokens': 10, 'prompt_tokens': 84, 'total_tokens': 94}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'stop', 'logprobs': None}, id='run-ad546b5a-70ce-404e-9656-dcc6ecd482d3-0', usage_metadata={'input_tokens': 84, 'output_tokens': 10, 'total_tokens': 94})], 'agent': 'agent'}, 'channel_versions': {'<strong>start</strong>': '00000000000000000000000000000002.', 'messages': '00000000000000000000000000000005.16e98d6f7ece7598829eddf1b33a33c4', 'start:agent': '00000000000000000000000000000003.', 'agent': '00000000000000000000000000000005.065d90dd7f7cd091f0233855210bb2af', 'branch:agent:should_continue:tools': '00000000000000000000000000000004.', 'tools': '00000000000000000000000000000005.'}, 'versions_seen': {'<strong>input</strong>': {}, '<strong>start</strong>': {'<strong>start</strong>': '00000000000000000000000000000001.ab89befb52cc0e91e106ef7f500ea033'}, 'agent': {'start:agent': '00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc', 'tools': '00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8'}, 'tools': {'branch:agent:should_continue:tools': '00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af'}}, 'pending_sends': [], 'current_tasks': {}}, metadata={'source': 'loop', 'writes': {'agent': {'messages': [AIMessage(content='The weather in San Francisco is always sunny!', response_metadata={'token_usage': {'completion_tokens': 10, 'prompt_tokens': 84, 'total_tokens': 94}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'stop', 'logprobs': None}, id='run-ad546b5a-70ce-404e-9656-dcc6ecd482d3-0', usage_metadata={'input_tokens': 84, 'output_tokens': 10, 'total_tokens': 94})]}}, 'step': 3}, parent_config={'configurable': {'thread_id': '1', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-306f-6252-8002-47c2374ec1f2'}}, pending_writes=[])</p>
<div class="codehilite"><pre><span></span><code>## Use async connection
</code></pre></div>

<p>async with AsyncRedisSaver.from_conn_info(
    host="localhost", port=6379, db=0
) as checkpointer:
    graph = create_react_agent(model, tools=tools, checkpointer=checkpointer)
    config = {"configurable": {"thread_id": "2"}}
    res = await graph.ainvoke(
        {"messages": [("human", "what's the weather in nyc")]}, config
    )</p>
<div class="codehilite"><pre><span></span><code>latest_checkpoint = await checkpointer.aget(config)
latest_checkpoint_tuple = await checkpointer.aget_tuple(config)
checkpoint_tuples = [c async for c in checkpointer.alist(config)]
</code></pre></div>

<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>latest_checkpoint</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{'v': 1,
 'ts': '2024-08-09T01:56:49.503241+00:00',
 'id': '1ef55f2a-4149-61ea-8003-dc5506862287',
 'channel_values': {'messages': [HumanMessage(content="what's the weather in nyc", id='5a106e79-a617-4707-839f-134d4e4b762a'),
   AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'function': {'arguments': '{"city":"nyc"}', 'name': 'get_weather'}, 'type': 'function'}]}, response_metadata={'token_usage': {'completion_tokens': 15, 'prompt_tokens': 58, 'total_tokens': 73}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-0d6fa3b4-cace-41a8-b025-d01d16f6bbe9-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'nyc'}, 'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'type': 'tool_call'}], usage_metadata={'input_tokens': 58, 'output_tokens': 15, 'total_tokens': 73}),
   ToolMessage(content='It might be cloudy in nyc', name='get_weather', id='922124bd-d3b0-4929-a996-a75d842b8b44', tool_call_id='call_TvPLLyhuQQN99EcZc8SzL8x9'),
   AIMessage(content='The weather in NYC might be cloudy.', response_metadata={'token_usage': {'completion_tokens': 9, 'prompt_tokens': 88, 'total_tokens': 97}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'stop', 'logprobs': None}, id='run-69a10e66-d61f-475e-b7de-a1ecd08a6c3a-0', usage_metadata={'input_tokens': 88, 'output_tokens': 9, 'total_tokens': 97})],
  'agent': 'agent'},
 'channel_versions': {'<strong>start</strong>': '00000000000000000000000000000002.',
  'messages': '00000000000000000000000000000005.2cb29d082da6435a7528b4c917fd0c28',
  'start:agent': '00000000000000000000000000000003.',
  'agent': '00000000000000000000000000000005.065d90dd7f7cd091f0233855210bb2af',
  'branch:agent:should_continue:tools': '00000000000000000000000000000004.',
  'tools': '00000000000000000000000000000005.'},
 'versions_seen': {'<strong>input</strong>': {},
  '<strong>start</strong>': {'<strong>start</strong>': '00000000000000000000000000000001.0e148ae3debe753278387e84f786e863'},
  'agent': {'start:agent': '00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc',
   'tools': '00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8'},
  'tools': {'branch:agent:should_continue:tools': '00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af'}},
 'pending_sends': [],
 'current_tasks': {}}
 ```</p>
<p><code>latest_checkpoint_tuple</code></p>
<p><code>CheckpointTuple(config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-4149-61ea-8003-dc5506862287'}}, checkpoint={'v': 1, 'ts': '2024-08-09T01:56:49.503241+00:00', 'id': '1ef55f2a-4149-61ea-8003-dc5506862287', 'channel_values': {'messages': [HumanMessage(content="what's the weather in nyc", id='5a106e79-a617-4707-839f-134d4e4b762a'), AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'function': {'arguments': '{"city":"nyc"}', 'name': 'get_weather'}, 'type': 'function'}]}, response_metadata={'token_usage': {'completion_tokens': 15, 'prompt_tokens': 58, 'total_tokens': 73}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-0d6fa3b4-cace-41a8-b025-d01d16f6bbe9-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'nyc'}, 'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'type': 'tool_call'}], usage_metadata={'input_tokens': 58, 'output_tokens': 15, 'total_tokens': 73}), ToolMessage(content='It might be cloudy in nyc', name='get_weather', id='922124bd-d3b0-4929-a996-a75d842b8b44', tool_call_id='call_TvPLLyhuQQN99EcZc8SzL8x9'), AIMessage(content='The weather in NYC might be cloudy.', response_metadata={'token_usage': {'completion_tokens': 9, 'prompt_tokens': 88, 'total_tokens': 97}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'stop', 'logprobs': None}, id='run-69a10e66-d61f-475e-b7de-a1ecd08a6c3a-0', usage_metadata={'input_tokens': 88, 'output_tokens': 9, 'total_tokens': 97})], 'agent': 'agent'}, 'channel_versions': {'__start__': '00000000000000000000000000000002.', 'messages': '00000000000000000000000000000005.2cb29d082da6435a7528b4c917fd0c28', 'start:agent': '00000000000000000000000000000003.', 'agent': '00000000000000000000000000000005.065d90dd7f7cd091f0233855210bb2af', 'branch:agent:should_continue:tools': '00000000000000000000000000000004.', 'tools': '00000000000000000000000000000005.'}, 'versions_seen': {'__input__': {}, '__start__': {'__start__': '00000000000000000000000000000001.0e148ae3debe753278387e84f786e863'}, 'agent': {'start:agent': '00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc', 'tools': '00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8'}, 'tools': {'branch:agent:should_continue:tools': '00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af'}}, 'pending_sends': [], 'current_tasks': {}}, metadata={'source': 'loop', 'writes': {'agent': {'messages': [AIMessage(content='The weather in NYC might be cloudy.', response_metadata={'token_usage': {'completion_tokens': 9, 'prompt_tokens': 88, 'total_tokens': 97}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'stop', 'logprobs': None}, id='run-69a10e66-d61f-475e-b7de-a1ecd08a6c3a-0', usage_metadata={'input_tokens': 88, 'output_tokens': 9, 'total_tokens': 97})]}}, 'step': 3}, parent_config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-3d07-647e-8002-b5e4d28c00c9'}}, pending_writes=[])</code></p>
<p><code>checkpoint_tuples</code></p>
<p><code>[CheckpointTuple(config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-4149-61ea-8003-dc5506862287'}}, checkpoint={'v': 1, 'ts': '2024-08-09T01:56:49.503241+00:00', 'id': '1ef55f2a-4149-61ea-8003-dc5506862287', 'channel_values': {'messages': [HumanMessage(content="what's the weather in nyc", id='5a106e79-a617-4707-839f-134d4e4b762a'), AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'function': {'arguments': '{"city":"nyc"}', 'name': 'get_weather'}, 'type': 'function'}]}, response_metadata={'token_usage': {'completion_tokens': 15, 'prompt_tokens': 58, 'total_tokens': 73}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-0d6fa3b4-cace-41a8-b025-d01d16f6bbe9-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'nyc'}, 'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'type': 'tool_call'}], usage_metadata={'input_tokens': 58, 'output_tokens': 15, 'total_tokens': 73}), ToolMessage(content='It might be cloudy in nyc', name='get_weather', id='922124bd-d3b0-4929-a996-a75d842b8b44', tool_call_id='call_TvPLLyhuQQN99EcZc8SzL8x9'), AIMessage(content='The weather in NYC might be cloudy.', response_metadata={'token_usage': {'completion_tokens': 9, 'prompt_tokens': 88, 'total_tokens': 97}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'stop', 'logprobs': None}, id='run-69a10e66-d61f-475e-b7de-a1ecd08a6c3a-0', usage_metadata={'input_tokens': 88, 'output_tokens': 9, 'total_tokens': 97})], 'agent': 'agent'}, 'channel_versions': {'__start__': '00000000000000000000000000000002.', 'messages': '00000000000000000000000000000005.2cb29d082da6435a7528b4c917fd0c28', 'start:agent': '00000000000000000000000000000003.', 'agent': '00000000000000000000000000000005.065d90dd7f7cd091f0233855210bb2af', 'branch:agent:should_continue:tools': '00000000000000000000000000000004.', 'tools': '00000000000000000000000000000005.'}, 'versions_seen': {'__input__': {}, '__start__': {'__start__': '00000000000000000000000000000001.0e148ae3debe753278387e84f786e863'}, 'agent': {'start:agent': '00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc', 'tools': '00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8'}, 'tools': {'branch:agent:should_continue:tools': '00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af'}}, 'pending_sends': [], 'current_tasks': {}}, metadata={'source': 'loop', 'writes': {'agent': {'messages': [AIMessage(content='The weather in NYC might be cloudy.', response_metadata={'token_usage': {'completion_tokens': 9, 'prompt_tokens': 88, 'total_tokens': 97}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'stop', 'logprobs': None}, id='run-69a10e66-d61f-475e-b7de-a1ecd08a6c3a-0', usage_metadata={'input_tokens': 88, 'output_tokens': 9, 'total_tokens': 97})]}}, 'step': 3}, parent_config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-3d07-647e-8002-b5e4d28c00c9'}}, pending_writes=None),
 CheckpointTuple(config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-3d07-647e-8002-b5e4d28c00c9'}}, checkpoint={'v': 1, 'ts': '2024-08-09T01:56:49.056860+00:00', 'id': '1ef55f2a-3d07-647e-8002-b5e4d28c00c9', 'channel_values': {'messages': [HumanMessage(content="what's the weather in nyc", id='5a106e79-a617-4707-839f-134d4e4b762a'), AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'function': {'arguments': '{"city":"nyc"}', 'name': 'get_weather'}, 'type': 'function'}]}, response_metadata={'token_usage': {'completion_tokens': 15, 'prompt_tokens': 58, 'total_tokens': 73}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-0d6fa3b4-cace-41a8-b025-d01d16f6bbe9-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'nyc'}, 'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'type': 'tool_call'}], usage_metadata={'input_tokens': 58, 'output_tokens': 15, 'total_tokens': 73}), ToolMessage(content='It might be cloudy in nyc', name='get_weather', id='922124bd-d3b0-4929-a996-a75d842b8b44', tool_call_id='call_TvPLLyhuQQN99EcZc8SzL8x9')], 'tools': 'tools'}, 'channel_versions': {'__start__': '00000000000000000000000000000002.', 'messages': '00000000000000000000000000000004.07964a3a545f9ff95545db45a9753d11', 'start:agent': '00000000000000000000000000000003.', 'agent': '00000000000000000000000000000004.', 'branch:agent:should_continue:tools': '00000000000000000000000000000004.', 'tools': '00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8'}, 'versions_seen': {'__input__': {}, '__start__': {'__start__': '00000000000000000000000000000001.0e148ae3debe753278387e84f786e863'}, 'agent': {'start:agent': '00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc'}, 'tools': {'branch:agent:should_continue:tools': '00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af'}}, 'pending_sends': [], 'current_tasks': {}}, metadata={'source': 'loop', 'writes': {'tools': {'messages': [ToolMessage(content='It might be cloudy in nyc', name='get_weather', id='922124bd-d3b0-4929-a996-a75d842b8b44', tool_call_id='call_TvPLLyhuQQN99EcZc8SzL8x9')]}}, 'step': 2}, parent_config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-3cf9-6996-8001-88dab066840d'}}, pending_writes=None),
 CheckpointTuple(config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-3cf9-6996-8001-88dab066840d'}}, checkpoint={'v': 1, 'ts': '2024-08-09T01:56:49.051234+00:00', 'id': '1ef55f2a-3cf9-6996-8001-88dab066840d', 'channel_values': {'messages': [HumanMessage(content="what's the weather in nyc", id='5a106e79-a617-4707-839f-134d4e4b762a'), AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'function': {'arguments': '{"city":"nyc"}', 'name': 'get_weather'}, 'type': 'function'}]}, response_metadata={'token_usage': {'completion_tokens': 15, 'prompt_tokens': 58, 'total_tokens': 73}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-0d6fa3b4-cace-41a8-b025-d01d16f6bbe9-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'nyc'}, 'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'type': 'tool_call'}], usage_metadata={'input_tokens': 58, 'output_tokens': 15, 'total_tokens': 73})], 'agent': 'agent', 'branch:agent:should_continue:tools': 'agent'}, 'channel_versions': {'__start__': '00000000000000000000000000000002.', 'messages': '00000000000000000000000000000003.cc96d93b1afbd1b69d53851320670b97', 'start:agent': '00000000000000000000000000000003.', 'agent': '00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af', 'branch:agent:should_continue:tools': '00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af'}, 'versions_seen': {'__input__': {}, '__start__': {'__start__': '00000000000000000000000000000001.0e148ae3debe753278387e84f786e863'}, 'agent': {'start:agent': '00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc'}}, 'pending_sends': [], 'current_tasks': {}}, metadata={'source': 'loop', 'writes': {'agent': {'messages': [AIMessage(content='', additional_kwargs={'tool_calls': [{'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'function': {'arguments': '{"city":"nyc"}', 'name': 'get_weather'}, 'type': 'function'}]}, response_metadata={'token_usage': {'completion_tokens': 15, 'prompt_tokens': 58, 'total_tokens': 73}, 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_48196bc67a', 'finish_reason': 'tool_calls', 'logprobs': None}, id='run-0d6fa3b4-cace-41a8-b025-d01d16f6bbe9-0', tool_calls=[{'name': 'get_weather', 'args': {'city': 'nyc'}, 'id': 'call_TvPLLyhuQQN99EcZc8SzL8x9', 'type': 'tool_call'}], usage_metadata={'input_tokens': 58, 'output_tokens': 15, 'total_tokens': 73})]}}, 'step': 1}, parent_config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-36a6-6788-8000-9efe1769f8c1'}}, pending_writes=None),
 CheckpointTuple(config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-36a6-6788-8000-9efe1769f8c1'}}, checkpoint={'v': 1, 'ts': '2024-08-09T01:56:48.388067+00:00', 'id': '1ef55f2a-36a6-6788-8000-9efe1769f8c1', 'channel_values': {'messages': [HumanMessage(content="what's the weather in nyc", id='5a106e79-a617-4707-839f-134d4e4b762a')], 'start:agent': '__start__'}, 'channel_versions': {'__start__': '00000000000000000000000000000002.', 'messages': '00000000000000000000000000000002.a6994b785a651d88df51020401745af8', 'start:agent': '00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc'}, 'versions_seen': {'__input__': {}, '__start__': {'__start__': '00000000000000000000000000000001.0e148ae3debe753278387e84f786e863'}}, 'pending_sends': [], 'current_tasks': {}}, metadata={'source': 'loop', 'writes': None, 'step': 0}, parent_config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-36a3-6614-bfff-05dafa02b4d7'}}, pending_writes=None),
 CheckpointTuple(config={'configurable': {'thread_id': '2', 'checkpoint_ns': '', 'checkpoint_id': '1ef55f2a-36a3-6614-bfff-05dafa02b4d7'}}, checkpoint={'v': 1, 'ts': '2024-08-09T01:56:48.386807+00:00', 'id': '1ef55f2a-36a3-6614-bfff-05dafa02b4d7', 'channel_values': {'messages': [], '__start__': {'messages': [['human', "what's the weather in nyc"]]}}, 'channel_versions': {'__start__': '00000000000000000000000000000001.0e148ae3debe753278387e84f786e863'}, 'versions_seen': {'__input__': {}}, 'pending_sends': [], 'current_tasks': {}}, metadata={'source': 'input', 'writes': {'messages': [['human', "what's the weather in nyc"]]}, 'step': -1}, parent_config=None, pending_writes=None)]</code></p>
<p># How to add thread-level persistence (functional API)
 Many AI applications need memory to share context across multiple interactions on the same thread (e.g., multiple turns of a conversation). In LangGraph functional API, this kind of memory can be added to any entrypoint() workflow using thread-level persistence.</p>
<p>When creating a LangGraph workflow, you can set it up to persist its results by using a checkpointer:</p>
<ol>
<li>Create an instance of a checkpointer:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemorySaver</span>

<span class="n">checkpointer</span> <span class="o">=</span> <span class="n">MemorySaver</span><span class="p">()</span>
</code></pre></div>

<ol>
<li>Pass checkpointer instance to the entrypoint() decorator:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.func</span><span class="w"> </span><span class="kn">import</span> <span class="n">entrypoint</span>

<span class="nd">@entrypoint</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">workflow</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="o">...</span>
</code></pre></div>

<ol>
<li>Optionally expose previous parameter in the workflow function signature:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nv">@entrypoint</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">)</span>
<span class="n">def</span><span class="w"> </span><span class="n">workflow</span><span class="p">(</span>
<span class="w">    </span><span class="n">inputs</span><span class="p">,</span>
<span class="w">    </span><span class="o">*</span><span class="p">,</span>
<span class="w">    </span><span class="c1"># you can optionally specify `previous` in the workflow function signature</span>
<span class="w">    </span><span class="c1"># to access the return value from the workflow as of the last execution</span>
<span class="w">    </span><span class="n">previous</span>
<span class="p">)</span><span class="o">:</span>
<span class="w">    </span><span class="n">previous</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="err">[]</span>
<span class="w">    </span><span class="n">combined_inputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">previous</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">inputs</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_something</span><span class="p">(</span><span class="n">combined_inputs</span><span class="p">)</span>
<span class="w">    </span><span class="p">...</span>
</code></pre></div>

<ol>
<li>Optionally choose which values will be returned from the workflow and which will be saved by the checkpointer as previous:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nv">@entrypoint</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">)</span>
<span class="n">def</span><span class="w"> </span><span class="n">workflow</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">previous</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="k">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_something</span><span class="p">(...)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">entrypoint</span><span class="p">.</span><span class="n">final</span><span class="p">(</span><span class="k">value</span><span class="o">=</span><span class="k">result</span><span class="p">,</span><span class="w"> </span><span class="k">save</span><span class="o">=</span><span class="n">combine</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="k">result</span><span class="p">))</span>
</code></pre></div>

<h2 id="setup_2">Setup<a class="headerlink" href="#setup_2" title="Permanent link">#</a></h2>
<p>First we need to install the packages required</p>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="nf">%capture</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">quiet</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">langgraph</span><span class="w"> </span><span class="n">langchain_anthropic</span>
</code></pre></div>

<p>Next, we need to set API key for Anthropic (the LLM we will use).</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_env</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>


<span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="example-simple-chatbot-with-short-term-memory">Example: simple chatbot with short-term memory<a class="headerlink" href="#example-simple-chatbot-with-short-term-memory" title="Permanent link">#</a></h2>
<p>We will be using a workflow with a single task that calls a chat model.</p>
<p>Let's first define the model we'll be using:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatAnthropic</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-5-sonnet-latest&quot;</span><span class="p">)</span>
</code></pre></div>

<p>API Reference: ChatAnthropic</p>
<p>Now we can define our task and workflow. To add in persistence, we need to pass in a Checkpointer to the entrypoint() decorator.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseMessage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.func</span><span class="w"> </span><span class="kn">import</span> <span class="n">entrypoint</span><span class="p">,</span> <span class="n">task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemorySaver</span>


<span class="nd">@task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">call_model</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">]):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="n">checkpointer</span> <span class="o">=</span> <span class="n">MemorySaver</span><span class="p">()</span>


<span class="nd">@entrypoint</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">checkpointer</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">workflow</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">previous</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">previous</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">add_messages</span><span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">call_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">entrypoint</span><span class="o">.</span><span class="n">final</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">add_messages</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">response</span><span class="p">))</span>
</code></pre></div>

<p>If we try to use this workflow, the context of the conversation will be persisted across interactions:</p>
<p>We can now interact with the agent and see that it remembers previous messages!</p>
<div class="codehilite"><pre><span></span><code><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;configurable&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;thread_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;1&quot;</span><span class="err">}}</span>
<span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;hi! I&#39;m bob&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">workflow</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>==================================[1m Ai Message [0m==================================

Hi Bob! I&#39;m Claude. Nice to meet you! How are you today?
</code></pre></div>

<p>You can always resume previous threads:</p>
<div class="codehilite"><pre><span></span><code><span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;what&#39;s my name?&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">workflow</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>==================================[1m Ai Message [0m==================================

Your name is Bob.
</code></pre></div>

<p>If we want to start a new conversation, we can pass in a different thread_id. Poof! All the memories are gone!</p>
<div class="codehilite"><pre><span></span><code><span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;what&#39;s my name?&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">workflow</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span>
<span class="w">    </span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="p">,</span>
<span class="w">    </span><span class="err">{</span><span class="ss">&quot;configurable&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;thread_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;2&quot;</span><span class="err">}}</span><span class="p">,</span>
<span class="w">    </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">,</span>
<span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>==================================[1m Ai Message [0m==================================

I don&#39;t know your name unless you tell me. Each conversation I have starts fresh, so I don&#39;t have access to any previous interactions or personal information unless you share it with me.
</code></pre></div>

<h2 id="how-to-add-cross-thread-persistence-functional-api">How to add cross-thread persistence (functional API)<a class="headerlink" href="#how-to-add-cross-thread-persistence-functional-api" title="Permanent link">#</a></h2>
<p>LangGraph allows you to persist data across different threads. For instance, you can store information about users (their names or preferences) in a shared (cross-thread) memory and reuse them in the new threads (e.g., new conversations).</p>
<p>When using the functional API, you can set it up to store and retrieve memories by using the Store interface:</p>
<ol>
<li>Create an instance of a Store</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.store.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryStore</span><span class="p">,</span> <span class="n">BaseStore</span>

<span class="n">store</span> <span class="o">=</span> <span class="n">InMemoryStore</span><span class="p">()</span>
</code></pre></div>

<ol>
<li>Pass the store instance to the entrypoint() decorator and expose store parameter in the function signature:</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.func</span><span class="w"> </span><span class="kn">import</span> <span class="n">entrypoint</span>

<span class="nd">@entrypoint</span><span class="p">(</span><span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">workflow</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span><span class="p">):</span>
    <span class="n">my_task</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="o">...</span>
</code></pre></div>

<h2 id="setup_3">Setup<a class="headerlink" href="#setup_3" title="Permanent link">#</a></h2>
<p>First, let's install the required packages and set our API keys</p>
<div class="codehilite"><pre><span></span><code><span class="o">%</span><span class="nf">%capture</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">stderr</span>
<span class="nf">%pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">langchain_anthropic</span><span class="w"> </span><span class="n">langchain_openai</span><span class="w"> </span><span class="n">langgraph</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_env</span><span class="p">(</span><span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getpass</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">)</span>


<span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;ANTHROPIC_API_KEY&quot;</span><span class="p">)</span>
<span class="n">_set_env</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="example-simple-chatbot-with-long-term-memory">Example: simple chatbot with long-term memory<a class="headerlink" href="#example-simple-chatbot-with-long-term-memory" title="Permanent link">#</a></h2>
<h2 id="define-store_1">Define store<a class="headerlink" href="#define-store_1" title="Permanent link">#</a></h2>
<p>In this example we will create a workflow that will be able to retrieve information about a user's preferences. We will do so by defining an InMemoryStore - an object that can store data in memory and query that data.</p>
<p>When storing objects using the Store interface you define two things:</p>
<ul>
<li>the namespace for the object, a tuple (similar to directories)</li>
<li>the object key (similar to filenames)</li>
</ul>
<p>In our example, we'll be using ("memories", <user_id>) as namespace and random UUID as key for each new memory.</p>
<p>Importantly, to determine the user, we will be passing user_id via the config keyword argument of the node function.</p>
<p>Let's first define our store!</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.store.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_openai</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>

<span class="n">in_memory_store</span> <span class="o">=</span> <span class="n">InMemoryStore</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;embed&quot;</span><span class="p">:</span> <span class="n">OpenAIEmbeddings</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">),</span>
        <span class="s2">&quot;dims&quot;</span><span class="p">:</span> <span class="mi">1536</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="create-workflow">Create workflow<a class="headerlink" href="#create-workflow" title="Permanent link">#</a></h2>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatAnthropic</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.runnables</span><span class="w"> </span><span class="kn">import</span> <span class="n">RunnableConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseMessage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.func</span><span class="w"> </span><span class="kn">import</span> <span class="n">entrypoint</span><span class="p">,</span> <span class="n">task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemorySaver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.store.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseStore</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-5-sonnet-latest&quot;</span><span class="p">)</span>


<span class="nd">@task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">call_model</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span> <span class="n">memory_store</span><span class="p">:</span> <span class="n">BaseStore</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;memories&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="n">last_message</span> <span class="o">=</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">memories</span> <span class="o">=</span> <span class="n">memory_store</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">last_message</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
    <span class="n">info</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">memories</span><span class="p">])</span>
    <span class="n">system_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;You are a helpful assistant talking to the user. User info: </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Store new memories if the user asks the model to remember</span>
    <span class="k">if</span> <span class="s2">&quot;remember&quot;</span> <span class="ow">in</span> <span class="n">last_message</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="s2">&quot;User name is Bob&quot;</span>
        <span class="n">memory_store</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">memory</span><span class="p">})</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">invoke</span><span class="p">([{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">system_msg</span><span class="p">}]</span> <span class="o">+</span> <span class="n">messages</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="c1"># NOTE: we&#39;re passing the store object here when creating a workflow via entrypoint()</span>
<span class="nd">@entrypoint</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">MemorySaver</span><span class="p">(),</span> <span class="n">store</span><span class="o">=</span><span class="n">in_memory_store</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">workflow</span><span class="p">(</span>
    <span class="n">inputs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">previous</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span><span class="p">,</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">BaseStore</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;configurable&quot;</span><span class="p">][</span><span class="s2">&quot;user_id&quot;</span><span class="p">]</span>
    <span class="n">previous</span> <span class="o">=</span> <span class="n">previous</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">add_messages</span><span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">call_model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">entrypoint</span><span class="o">.</span><span class="n">final</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">add_messages</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">response</span><span class="p">))</span>
</code></pre></div>

<h2 id="run-the-workflow">Run the workflow!<a class="headerlink" href="#run-the-workflow" title="Permanent link">#</a></h2>
<p>Now let's specify a user ID in the config and tell the model our name:</p>
<div class="codehilite"><pre><span></span><code><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;configurable&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;thread_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;user_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;1&quot;</span><span class="err">}}</span>
<span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;Hi! Remember: my name is Bob&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">workflow</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>==================================[1m Ai Message [0m==================================

Hello Bob! Nice to meet you. I&#39;ll remember that your name is Bob. How can I help you today?
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;configurable&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;thread_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;2&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;user_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;1&quot;</span><span class="err">}}</span>
<span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;what is my name?&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">workflow</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<p>We can now inspect our in-memory store and verify that we have in fact saved the memories for the user:</p>
<div class="codehilite"><pre><span></span><code>for memory in in_memory_store.search((&quot;memories&quot;, &quot;1&quot;)):
    print(memory.value)
</code></pre></div>

<div class="codehilite"><pre><span></span><code>{&#39;data&#39;: &#39;User name is Bob&#39;}
</code></pre></div>

<p>Let's now run the workflow for another user to verify that the memories about the first user are self contained:</p>
<div class="codehilite"><pre><span></span><code><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;configurable&quot;</span><span class="err">:</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;thread_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;3&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;user_id&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;2&quot;</span><span class="err">}}</span>
<span class="n">input_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="ss">&quot;role&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;content&quot;</span><span class="err">:</span><span class="w"> </span><span class="ss">&quot;what is my name?&quot;</span><span class="err">}</span>
<span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">workflow</span><span class="p">.</span><span class="n">stream</span><span class="p">(</span><span class="o">[</span><span class="n">input_message</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">stream_mode</span><span class="o">=</span><span class="ss">&quot;values&quot;</span><span class="p">)</span><span class="err">:</span>
<span class="w">    </span><span class="n">chunk</span><span class="p">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="o">==================================</span>[<span class="mi">1</span><span class="nv">m</span><span class="w"> </span><span class="nv">Ai</span><span class="w"> </span><span class="nv">Message</span><span class="w"> </span>[<span class="mi">0</span><span class="nv">m</span><span class="o">==================================</span>

<span class="nv">I</span><span class="w"> </span><span class="nv">don</span><span class="s1">&#39;t have any information about your name. I can only see our current conversation without any prior context or personal details about you. If you&#39;</span><span class="nv">d</span><span class="w"> </span><span class="nv">like</span><span class="w"> </span><span class="nv">me</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">know</span><span class="w"> </span><span class="nv">your</span><span class="w"> </span><span class="nv">name</span>,<span class="w"> </span><span class="nv">feel</span><span class="w"> </span><span class="nv">free</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">tell</span><span class="w"> </span><span class="nv">me</span><span class="o">!</span>
</code></pre></div>

<h1 id="how-to-manage-conversation-history">How to manage conversation history<a class="headerlink" href="#how-to-manage-conversation-history" title="Permanent link">#</a></h1>
<p>One of the most common use cases for persistence is to use it to keep track of conversation history. This is great - it makes it easy to continue conversations. As conversations get longer and longer, however, this conversation history can build up and take up more and more of the context window. This can often be undesirable as it leads to more expensive and longer calls to the LLM, and potentially ones that error. In order to prevent this from happening, you need to properly manage the conversation history.</p>
<p>Note: this guide focuses on how to do this in LangGraph, where you can fully customize how this is done. If you want a more off-the-shelf solution, you can look into functionality provided in LangChain:</p>
<ul>
<li>How to filter messages</li>
<li>How to trim messages</li>
</ul>
<h2 id="build-the-agent">Build the agent<a class="headerlink" href="#build-the-agent" title="Permanent link">#</a></h2>
<p>Let's now build a simple ReAct style agent.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatAnthropic</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">tool</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemorySaver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">MessagesState</span><span class="p">,</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span><span class="p">,</span> <span class="n">END</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.prebuilt</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolNode</span>

<span class="n">memory</span> <span class="o">=</span> <span class="n">MemorySaver</span><span class="p">()</span>


<span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Call to surf the web.&quot;&quot;&quot;</span>
    <span class="c1"># This is a placeholder for the actual implementation</span>
    <span class="c1"># Don&#39;t let the LLM know this though 😊</span>
    <span class="k">return</span> <span class="s2">&quot;It&#39;s sunny in San Francisco, but you better look out if you&#39;re a Gemini 😈.&quot;</span>


<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">search</span><span class="p">]</span>
<span class="n">tool_node</span> <span class="o">=</span> <span class="n">ToolNode</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;claude-3-haiku-20240307&quot;</span><span class="p">)</span>
<span class="n">bound_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">should_continue</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">MessagesState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the next node to execute.&quot;&quot;&quot;</span>
    <span class="n">last_message</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># If there is no function call, then we finish</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">END</span>
    <span class="c1"># Otherwise if there is, we continue</span>
    <span class="k">return</span> <span class="s2">&quot;action&quot;</span>


<span class="c1"># Define the function that calls the model</span>
<span class="k">def</span><span class="w"> </span><span class="nf">call_model</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">MessagesState</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">bound_model</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>
    <span class="c1"># We return a list, because this will get added to the existing list</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>


<span class="c1"># Define a new graph</span>
<span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">MessagesState</span><span class="p">)</span>

<span class="c1"># Define the two nodes we will cycle between</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">call_model</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">tool_node</span><span class="p">)</span>

<span class="c1"># Set the entrypoint as `agent`</span>
<span class="c1"># This means that this node is the first one called</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">)</span>

<span class="c1"># We now add a conditional edge</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
    <span class="c1"># First, we define the start node. We use `agent`.</span>
    <span class="c1"># This means these are the edges taken after the `agent` node is called.</span>
    <span class="s2">&quot;agent&quot;</span><span class="p">,</span>
    <span class="c1"># Next, we pass in the function that will determine which node is called next.</span>
    <span class="n">should_continue</span><span class="p">,</span>
    <span class="c1"># Next, we pass in the path map - all the possible nodes this edge could go to</span>
    <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># We now add a normal edge from `tools` to `agent`.</span>
<span class="c1"># This means that after `tools` is called, `agent` node is called next.</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">)</span>

<span class="c1"># Finally, we compile it!</span>
<span class="c1"># This compiles it into a LangChain Runnable,</span>
<span class="c1"># meaning you can use it as you would any other runnable</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">HumanMessage</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">}}</span>
<span class="n">input_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;hi! I&#39;m bob&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">input_message</span><span class="p">]},</span> <span class="n">config</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>
    <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>


<span class="n">input_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;what&#39;s my name?&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">input_message</span><span class="p">]},</span> <span class="n">config</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>
    <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<p>API Reference: HumanMessage</p>
<div class="codehilite"><pre><span></span><code><span class="o">================================</span>[<span class="mi">1</span><span class="nv">m</span><span class="w"> </span><span class="nv">Human</span><span class="w"> </span><span class="nv">Message</span><span class="w"> </span>[<span class="mi">0</span><span class="nv">m</span><span class="o">=================================</span>

<span class="nv">hi</span><span class="o">!</span><span class="w"> </span><span class="nv">I</span><span class="err">&#39;m bob</span>
<span class="err">==================================[1m Ai Message [0m==================================</span>

<span class="nv">Nice</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">meet</span><span class="w"> </span><span class="nv">you</span>,<span class="w"> </span><span class="nv">Bob</span><span class="o">!</span><span class="w"> </span><span class="nv">As</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">AI</span><span class="w"> </span><span class="nv">assistant</span>,<span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="nv">don</span><span class="s1">&#39;t have a physical form, but I&#39;</span><span class="nv">m</span><span class="w"> </span><span class="nv">happy</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">chat</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">you</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">try</span><span class="w"> </span><span class="nv">my</span><span class="w"> </span><span class="nv">best</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">help</span><span class="w"> </span><span class="nv">out</span><span class="w"> </span><span class="nv">however</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="nv">can</span>.<span class="w"> </span><span class="nv">Please</span><span class="w"> </span><span class="nv">feel</span><span class="w"> </span><span class="nv">free</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">ask</span><span class="w"> </span><span class="nv">me</span><span class="w"> </span><span class="nv">anything</span>,<span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">I</span><span class="err">&#39;ll do my best to provide useful information or assistance.</span>
<span class="err">================================[1m Human Message [0m=================================</span>

<span class="nv">what</span><span class="err">&#39;s my name?</span>
<span class="err">==================================[1m Ai Message [0m==================================</span>

<span class="err">You said your name is Bob, so that is the name I have for you.</span>
</code></pre></div>

<h2 id="filtering-messages">Filtering messages<a class="headerlink" href="#filtering-messages" title="Permanent link">#</a></h2>
<p>The most straight-forward thing to do to prevent conversation history from blowing up is to filter the list of messages before they get passed to the LLM. This involves two parts: defining a function to filter messages, and then adding it to the graph. See the example below which defines a really simple filter_messages function and then uses it.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_anthropic</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChatAnthropic</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">tool</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.checkpoint.memory</span><span class="w"> </span><span class="kn">import</span> <span class="n">MemorySaver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">MessagesState</span><span class="p">,</span> <span class="n">StateGraph</span><span class="p">,</span> <span class="n">START</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langgraph.prebuilt</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolNode</span>

<span class="n">memory</span> <span class="o">=</span> <span class="n">MemorySaver</span><span class="p">()</span>


<span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Call to surf the web.&quot;&quot;&quot;</span>
    <span class="c1"># This is a placeholder for the actual implementation</span>
    <span class="c1"># Don&#39;t let the LLM know this though 😊</span>
    <span class="k">return</span> <span class="s2">&quot;It&#39;s sunny in San Francisco, but you better look out if you&#39;re a Gemini 😈.&quot;</span>


<span class="n">tools</span> <span class="o">=</span> <span class="p">[</span><span class="n">search</span><span class="p">]</span>
<span class="n">tool_node</span> <span class="o">=</span> <span class="n">ToolNode</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">ChatAnthropic</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;claude-3-haiku-20240307&quot;</span><span class="p">)</span>
<span class="n">bound_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">bind_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">should_continue</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">MessagesState</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the next node to execute.&quot;&quot;&quot;</span>
    <span class="n">last_message</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># If there is no function call, then we finish</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">last_message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">END</span>
    <span class="c1"># Otherwise if there is, we continue</span>
    <span class="k">return</span> <span class="s2">&quot;action&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">filter_messages</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
    <span class="c1"># This is very simple helper function which only ever uses the last message</span>
    <span class="k">return</span> <span class="n">messages</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>


<span class="c1"># Define the function that calls the model</span>
<span class="k">def</span><span class="w"> </span><span class="nf">call_model</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">MessagesState</span><span class="p">):</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="n">filter_messages</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">])</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">bound_model</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
    <span class="c1"># We return a list, because this will get added to the existing list</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">}</span>


<span class="c1"># Define a new graph</span>
<span class="n">workflow</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">MessagesState</span><span class="p">)</span>

<span class="c1"># Define the two nodes we will cycle between</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;agent&quot;</span><span class="p">,</span> <span class="n">call_model</span><span class="p">)</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">tool_node</span><span class="p">)</span>

<span class="c1"># Set the entrypoint as `agent`</span>
<span class="c1"># This means that this node is the first one called</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">)</span>

<span class="c1"># We now add a conditional edge</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span>
    <span class="c1"># First, we define the start node. We use `agent`.</span>
    <span class="c1"># This means these are the edges taken after the `agent` node is called.</span>
    <span class="s2">&quot;agent&quot;</span><span class="p">,</span>
    <span class="c1"># Next, we pass in the function that will determine which node is called next.</span>
    <span class="n">should_continue</span><span class="p">,</span>
    <span class="c1"># Next, we pass in the pathmap - all the possible nodes this edge could go to</span>
    <span class="p">[</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">],</span>
<span class="p">)</span>

<span class="c1"># We now add a normal edge from `tools` to `agent`.</span>
<span class="c1"># This means that after `tools` is called, `agent` node is called next.</span>
<span class="n">workflow</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">)</span>

<span class="c1"># Finally, we compile it!</span>
<span class="c1"># This compiles it into a LangChain Runnable,</span>
<span class="c1"># meaning you can use it as you would any other runnable</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">HumanMessage</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">}}</span>
<span class="n">input_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;hi! I&#39;m bob&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">input_message</span><span class="p">]},</span> <span class="n">config</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>
    <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>

<span class="c1"># This will now not remember the previous messages</span>
<span class="c1"># (because we set `messages[-1:]` in the filter messages argument)</span>
<span class="n">input_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;what&#39;s my name?&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">input_message</span><span class="p">]},</span> <span class="n">config</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>
    <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<p>API Reference: HumanMessage</p>
<div class="codehilite"><pre><span></span><code>================================[1m Human Message [0m=================================

hi! I&#39;m bob
==================================[1m Ai Message [0m==================================

Nice to meet you, Bob! I&#39;m Claude, an AI assistant created by Anthropic. It&#39;s a pleasure to chat with you. Feel free to ask me anything, I&#39;m here to help!
================================[1m Human Message [0m=================================

what&#39;s my name?
==================================[1m Ai Message [0m==================================

I&#39;m afraid I don&#39;t actually know your name. As an AI assistant, I don&#39;t have information about the specific identities of the people I talk to. I only know what is provided to me during our conversation.
</code></pre></div>

<h1 id="how-to-delete-messages">How to delete messages<a class="headerlink" href="#how-to-delete-messages" title="Permanent link">#</a></h1>
<p>One of the common states for a graph is a list of messages. Usually you only add messages to that state. However, sometimes you may want to remove messages (either by directly modifying the state or as part of the graph). To do that, you can use the RemoveMessage modifier. In this guide, we will cover how to do that.</p>
<p>The key idea is that each state key has a reducer key. This key specifies how to combine updates to the state. The default MessagesState has a messages key, and the reducer for that key accepts these RemoveMessage modifiers. That reducer then uses these RemoveMessage to delete messages from the key.</p>
<p>So note that just because your graph state has a key that is a list of messages, it doesn't mean that that this RemoveMessage modifier will work. You also have to have a reducer defined that knows how to work with this.</p>
<p>NOTE: Many models expect certain rules around lists of messages. For example, some expect them to start with a user message, others expect all messages with tool calls to be followed by a tool message. When deleting messages, you will want to make sure you don't violate these rules.</p>
<h2 id="build-the-agent_1">Build the agent<a class="headerlink" href="#build-the-agent_1" title="Permanent link">#</a></h2>
<p>Let's now build a simple ReAct style agent.</p>
<p>from typing import Literal</p>
<p>from langchain_anthropic import ChatAnthropic
from langchain_core.tools import tool</p>
<p>from langgraph.checkpoint.memory import MemorySaver
from langgraph.graph import MessagesState, StateGraph, START, END
from langgraph.prebuilt import ToolNode</p>
<p>memory = MemorySaver()</p>
<p>@tool
def search(query: str):
    """Call to surf the web."""
    # This is a placeholder for the actual implementation
    # Don't let the LLM know this though 😊
    return "It's sunny in San Francisco, but you better look out if you're a Gemini 😈."</p>
<p>tools = [search]
tool_node = ToolNode(tools)
model = ChatAnthropic(model_name="claude-3-haiku-20240307")
bound_model = model.bind_tools(tools)</p>
<p>def should_continue(state: MessagesState):
    """Return the next node to execute."""
    last_message = state["messages"][-1]
    # If there is no function call, then we finish
    if not last_message.tool_calls:
        return END
    # Otherwise if there is, we continue
    return "action"</p>
<h1 id="define-the-function-that-calls-the-model">Define the function that calls the model<a class="headerlink" href="#define-the-function-that-calls-the-model" title="Permanent link">#</a></h1>
<p>def call_model(state: MessagesState):
    response = model.invoke(state["messages"])
    # We return a list, because this will get added to the existing list
    return {"messages": response}</p>
<h1 id="define-a-new-graph">Define a new graph<a class="headerlink" href="#define-a-new-graph" title="Permanent link">#</a></h1>
<p>workflow = StateGraph(MessagesState)</p>
<h1 id="define-the-two-nodes-we-will-cycle-between">Define the two nodes we will cycle between<a class="headerlink" href="#define-the-two-nodes-we-will-cycle-between" title="Permanent link">#</a></h1>
<p>workflow.add_node("agent", call_model)
workflow.add_node("action", tool_node)</p>
<h1 id="set-the-entrypoint-as-agent">Set the entrypoint as <code>agent</code><a class="headerlink" href="#set-the-entrypoint-as-agent" title="Permanent link">#</a></h1>
<h1 id="this-means-that-this-node-is-the-first-one-called">This means that this node is the first one called<a class="headerlink" href="#this-means-that-this-node-is-the-first-one-called" title="Permanent link">#</a></h1>
<p>workflow.add_edge(START, "agent")</p>
<h1 id="we-now-add-a-conditional-edge">We now add a conditional edge<a class="headerlink" href="#we-now-add-a-conditional-edge" title="Permanent link">#</a></h1>
<p>workflow.add_conditional_edges(
    # First, we define the start node. We use <code>agent</code>.
    # This means these are the edges taken after the <code>agent</code> node is called.
    "agent",
    # Next, we pass in the function that will determine which node is called next.
    should_continue,
    # Next, we pass in the path map - all the possible nodes this edge could go to
    ["action", END],
)</p>
<h1 id="we-now-add-a-normal-edge-from-tools-to-agent">We now add a normal edge from <code>tools</code> to <code>agent</code>.<a class="headerlink" href="#we-now-add-a-normal-edge-from-tools-to-agent" title="Permanent link">#</a></h1>
<h1 id="this-means-that-after-tools-is-called-agent-node-is-called-next">This means that after <code>tools</code> is called, <code>agent</code> node is called next.<a class="headerlink" href="#this-means-that-after-tools-is-called-agent-node-is-called-next" title="Permanent link">#</a></h1>
<p>workflow.add_edge("action", "agent")</p>
<h1 id="finally-we-compile-it">Finally, we compile it!<a class="headerlink" href="#finally-we-compile-it" title="Permanent link">#</a></h1>
<h1 id="this-compiles-it-into-a-langchain-runnable">This compiles it into a LangChain Runnable,<a class="headerlink" href="#this-compiles-it-into-a-langchain-runnable" title="Permanent link">#</a></h1>
<h1 id="meaning-you-can-use-it-as-you-would-any-other-runnable">meaning you can use it as you would any other runnable<a class="headerlink" href="#meaning-you-can-use-it-as-you-would-any-other-runnable" title="Permanent link">#</a></h1>
<p>app = workflow.compile(checkpointer=memory)</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">HumanMessage</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">}}</span>
<span class="n">input_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;hi! I&#39;m bob&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">input_message</span><span class="p">]},</span> <span class="n">config</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>
    <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>


<span class="n">input_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;what&#39;s my name?&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">input_message</span><span class="p">]},</span> <span class="n">config</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>
    <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pretty_print</span><span class="p">()</span>
</code></pre></div>

<p>API Reference: HumanMessage</p>
<div class="codehilite"><pre><span></span><code><span class="o">================================</span>[<span class="mi">1</span><span class="nv">m</span><span class="w"> </span><span class="nv">Human</span><span class="w"> </span><span class="nv">Message</span><span class="w"> </span>[<span class="mi">0</span><span class="nv">m</span><span class="o">=================================</span>

<span class="nv">hi</span><span class="o">!</span><span class="w"> </span><span class="nv">I</span><span class="err">&#39;m bob</span>
<span class="err">==================================[1m Ai Message [0m==================================</span>

<span class="nv">It</span><span class="s1">&#39;s nice to meet you, Bob! I&#39;</span><span class="nv">m</span><span class="w"> </span><span class="nv">an</span><span class="w"> </span><span class="nv">AI</span><span class="w"> </span><span class="nv">assistant</span><span class="w"> </span><span class="nv">created</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">Anthropic</span>.<span class="w"> </span><span class="nv">I</span><span class="s1">&#39;m here to help out with any questions or tasks you might have. Please let me know if there&#39;</span><span class="nv">s</span><span class="w"> </span><span class="nv">anything</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">assist</span><span class="w"> </span><span class="nv">you</span><span class="w"> </span><span class="nv">with</span>.
<span class="o">================================</span>[<span class="mi">1</span><span class="nv">m</span><span class="w"> </span><span class="nv">Human</span><span class="w"> </span><span class="nv">Message</span><span class="w"> </span>[<span class="mi">0</span><span class="nv">m</span><span class="o">=================================</span>

<span class="nv">what</span><span class="err">&#39;s my name?</span>
<span class="err">==================================[1m Ai Message [0m==================================</span>

<span class="err">You said your name is Bob.</span>
</code></pre></div>

<h2 id="manually-deleting-messages">Manually deleting messages<a class="headerlink" href="#manually-deleting-messages" title="Permanent link">#</a></h2>
<p>First, we will cover how to manually delete messages. Let's take a look at the current state of the thread:</p>
<div class="codehilite"><pre><span></span><code>messages = app.get_state(config).values[&quot;messages&quot;]
messages
</code></pre></div>

<div class="codehilite"><pre><span></span><code>[HumanMessage(content=&quot;hi! I&#39;m bob&quot;, additional_kwargs={}, response_metadata={}, id=&#39;db576005-3a60-4b3b-8925-dc602ac1c571&#39;),
 AIMessage(content=&quot;It&#39;s nice to meet you, Bob! I&#39;m an AI assistant created by Anthropic. I&#39;m here to help out with any questions or tasks you might have. Please let me know if there&#39;s anything I can assist you with.&quot;, additional_kwargs={}, response_metadata={&#39;id&#39;: &#39;msg_01BKAnYxmoC6bQ9PpCuHk8ZT&#39;, &#39;model&#39;: &#39;claude-3-haiku-20240307&#39;, &#39;stop_reason&#39;: &#39;end_turn&#39;, &#39;stop_sequence&#39;: None, &#39;usage&#39;: {&#39;input_tokens&#39;: 12, &#39;output_tokens&#39;: 52}}, id=&#39;run-3a60c536-b207-4c56-98f3-03f94d49a9e4-0&#39;, usage_metadata={&#39;input_tokens&#39;: 12, &#39;output_tokens&#39;: 52, &#39;total_tokens&#39;: 64}),
 HumanMessage(content=&quot;what&#39;s my name?&quot;, additional_kwargs={}, response_metadata={}, id=&#39;2088c465-400b-430b-ad80-fad47dc1f2d6&#39;),
 AIMessage(content=&#39;You said your name is Bob.&#39;, additional_kwargs={}, response_metadata={&#39;id&#39;: &#39;msg_013UWTLTzwZi81vke8mMQ2KP&#39;, &#39;model&#39;: &#39;claude-3-haiku-20240307&#39;, &#39;stop_reason&#39;: &#39;end_turn&#39;, &#39;stop_sequence&#39;: None, &#39;usage&#39;: {&#39;input_tokens&#39;: 72, &#39;output_tokens&#39;: 10}}, id=&#39;run-3a6883be-0c52-4938-af98-e9e7476659eb-0&#39;, usage_metadata={&#39;input_tokens&#39;: 72, &#39;output_tokens&#39;: 10, &#39;total_tokens&#39;: 82})]
 ```

 We can call update_state and pass in the id of the first message. This will delete that message.

 ```
 from langchain_core.messages import RemoveMessage

app.update_state(config, {&quot;messages&quot;: RemoveMessage(id=messages[0].id)})
</code></pre></div>

<p>API Reference: RemoveMessage</p>
<div class="codehilite"><pre><span></span><code>{&#39;configurable&#39;: {&#39;thread_id&#39;: &#39;2&#39;,
  &#39;checkpoint_ns&#39;: &#39;&#39;,
  &#39;checkpoint_id&#39;: &#39;1ef75157-f251-6a2a-8005-82a86a6593a0&#39;}}
</code></pre></div>

<p>If we now look at the messages, we can verify that the first one was deleted.</p>
<div class="codehilite"><pre><span></span><code>messages = app.get_state(config).values[&quot;messages&quot;]
messages
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="p">[</span><span class="nv">AIMessage</span><span class="p">(</span><span class="s s-Atom">content=</span><span class="s2">&quot;It&#39;s nice to meet you, Bob! I&#39;m Claude, an AI assistant created by Anthropic. How can I assist you today?&quot;</span><span class="p">,</span> <span class="s s-Atom">response_metadata=</span><span class="p">{</span><span class="s s-Atom">&#39;id&#39;</span><span class="o">:</span> <span class="s s-Atom">&#39;msg_01XPSAenmSqK8rX2WgPZHfz7&#39;</span><span class="p">,</span> <span class="s s-Atom">&#39;model&#39;</span><span class="o">:</span> <span class="s s-Atom">&#39;claude-3-haiku-20240307&#39;</span><span class="p">,</span> <span class="s s-Atom">&#39;stop_reason&#39;</span><span class="o">:</span> <span class="s s-Atom">&#39;end_turn&#39;</span><span class="p">,</span> <span class="s s-Atom">&#39;stop_sequence&#39;</span><span class="o">:</span> <span class="nv">None</span><span class="p">,</span> <span class="s s-Atom">&#39;usage&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s s-Atom">&#39;input_tokens&#39;</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s s-Atom">&#39;output_tokens&#39;</span><span class="o">:</span> <span class="mi">32</span><span class="p">}},</span> <span class="s s-Atom">id=&#39;run-1c69af09-adb1-412d-9010-2456e5a555fb-0&#39;</span><span class="p">,</span> <span class="s s-Atom">usage_metadata=</span><span class="p">{</span><span class="s s-Atom">&#39;input_tokens&#39;</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s s-Atom">&#39;output_tokens&#39;</span><span class="o">:</span> <span class="mi">32</span><span class="p">,</span> <span class="s s-Atom">&#39;total_tokens&#39;</span><span class="o">:</span> <span class="mi">44</span><span class="p">}),</span>
 <span class="nv">HumanMessage</span><span class="p">(</span><span class="s s-Atom">content=</span><span class="s2">&quot;what&#39;s my name?&quot;</span><span class="p">,</span> <span class="s s-Atom">id=&#39;f3c71afe-8ce2-4ed0-991e-65021f03b0a5&#39;</span><span class="p">),</span>
 <span class="nv">AIMessage</span><span class="p">(</span><span class="s s-Atom">content=&#39;Your name is Bob, as you introduced yourself at the beginning of our conversation.&#39;</span><span class="p">,</span> <span class="s s-Atom">response_metadata=</span><span class="p">{</span><span class="s s-Atom">&#39;id&#39;</span><span class="o">:</span> <span class="s s-Atom">&#39;msg_01BPZdwsjuMAbC1YAkqawXaF&#39;</span><span class="p">,</span> <span class="s s-Atom">&#39;model&#39;</span><span class="o">:</span> <span class="s s-Atom">&#39;claude-3-haiku-20240307&#39;</span><span class="p">,</span> <span class="s s-Atom">&#39;stop_reason&#39;</span><span class="o">:</span> <span class="s s-Atom">&#39;end_turn&#39;</span><span class="p">,</span> <span class="s s-Atom">&#39;stop_sequence&#39;</span><span class="o">:</span> <span class="nv">None</span><span class="p">,</span> <span class="s s-Atom">&#39;usage&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s s-Atom">&#39;input_tokens&#39;</span><span class="o">:</span> <span class="mi">52</span><span class="p">,</span> <span class="s s-Atom">&#39;output_tokens&#39;</span><span class="o">:</span> <span class="mi">19</span><span class="p">}},</span> <span class="s s-Atom">id=&#39;run-b2eb9137-2f4e-446f-95f5-3d5f621a2cf8-0&#39;</span><span class="p">,</span> <span class="s s-Atom">usage_metadata=</span><span class="p">{</span><span class="s s-Atom">&#39;input_tokens&#39;</span><span class="o">:</span> <span class="mi">52</span><span class="p">,</span> <span class="s s-Atom">&#39;output_tokens&#39;</span><span class="o">:</span> <span class="mi">19</span><span class="p">,</span> <span class="s s-Atom">&#39;total_tokens&#39;</span><span class="o">:</span> <span class="mi">71</span><span class="p">})]</span>
 <span class="err">```</span>

 <span class="s s-Atom">##</span> <span class="nv">Programmatically</span> <span class="s s-Atom">deleting</span> <span class="s s-Atom">messages</span>

 <span class="nv">We</span> <span class="s s-Atom">can</span> <span class="s s-Atom">also</span> <span class="s s-Atom">delete</span> <span class="s s-Atom">messages</span> <span class="s s-Atom">programmatically</span> <span class="s s-Atom">from</span> <span class="s s-Atom">inside</span> <span class="s s-Atom">the</span> <span class="s s-Atom">graph</span><span class="p">.</span> <span class="nv">Here</span> <span class="s s-Atom">we&#39;ll modify the graph to delete any old messages (longer than 3 messages ago) at the end of a graph run.</span>

<span class="s s-Atom"> ```</span>
<span class="s s-Atom"> from langchain_core.messages import RemoveMessage</span>
<span class="s s-Atom">from langgraph.graph import END</span>


<span class="s s-Atom">def delete_messages(state):</span>
<span class="s s-Atom">    messages = state[&quot;messages&quot;]</span>
<span class="s s-Atom">    if len(messages) &gt; 3:</span>
<span class="s s-Atom">        return {&quot;messages&quot;: [RemoveMessage(id=m.id) for m in messages[:-3]]}</span>


<span class="s s-Atom"># We need to modify the logic to call delete_messages rather than end right away</span>
<span class="s s-Atom">def should_continue(state: MessagesState) -&gt; Literal[&quot;action&quot;, &quot;delete_messages&quot;]:</span>
<span class="s s-Atom">    &quot;&quot;&quot;Return the next node to execute.&quot;&quot;&quot;</span>
<span class="s s-Atom">    last_message = state[&quot;messages&quot;][-1]</span>
<span class="s s-Atom">    # If there is no function call, then we call our delete_messages function</span>
<span class="s s-Atom">    if not last_message.tool_calls:</span>
<span class="s s-Atom">        return &quot;delete_messages&quot;</span>
<span class="s s-Atom">    # Otherwise if there is, we continue</span>
<span class="s s-Atom">    return &quot;action&quot;</span>


<span class="s s-Atom"># Define a new graph</span>
<span class="s s-Atom">workflow = StateGraph(MessagesState)</span>
<span class="s s-Atom">workflow.add_node(&quot;agent&quot;, call_model)</span>
<span class="s s-Atom">workflow.add_node(&quot;action&quot;, tool_node)</span>

<span class="s s-Atom"># This is our new node we&#39;re</span> <span class="s s-Atom">defining</span>
<span class="s s-Atom">workflow</span><span class="p">.</span><span class="nf">add_node</span><span class="p">(</span><span class="s s-Atom">delete_messages</span><span class="p">)</span>


<span class="s s-Atom">workflow</span><span class="p">.</span><span class="nf">add_edge</span><span class="p">(</span><span class="nv">START</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">)</span>
<span class="s s-Atom">workflow</span><span class="p">.</span><span class="nf">add_conditional_edges</span><span class="p">(</span>
    <span class="s2">&quot;agent&quot;</span><span class="p">,</span>
    <span class="s s-Atom">should_continue</span><span class="p">,</span>
<span class="p">)</span>
<span class="s s-Atom">workflow</span><span class="p">.</span><span class="nf">add_edge</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">,</span> <span class="s2">&quot;agent&quot;</span><span class="p">)</span>

<span class="s s-Atom">#</span> <span class="nv">This</span> <span class="o">is</span> <span class="s s-Atom">the</span> <span class="s s-Atom">new</span> <span class="s s-Atom">edge</span> <span class="s s-Atom">we</span><span class="err">&#39;</span><span class="s s-Atom">re</span> <span class="s s-Atom">adding</span><span class="p">:</span> <span class="s s-Atom">after</span> <span class="s s-Atom">we</span> <span class="s s-Atom">delete</span> <span class="s s-Atom">messages</span><span class="p">,</span> <span class="s s-Atom">we</span> <span class="s s-Atom">finish</span>
<span class="s s-Atom">workflow</span><span class="p">.</span><span class="nf">add_edge</span><span class="p">(</span><span class="s2">&quot;delete_messages&quot;</span><span class="p">,</span> <span class="nv">END</span><span class="p">)</span>
<span class="s s-Atom">app</span> <span class="o">=</span> <span class="s s-Atom">workflow</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="s s-Atom">checkpointer</span><span class="o">=</span><span class="s s-Atom">memory</span><span class="p">)</span>
</code></pre></div>

<p>We can now try this out. We can call the graph twice and then check the state</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">HumanMessage</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;configurable&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">}}</span>
<span class="n">input_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;hi! I&#39;m bob&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">input_message</span><span class="p">]},</span> <span class="n">config</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">([(</span><span class="n">message</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]])</span>


<span class="n">input_message</span> <span class="o">=</span> <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;what&#39;s my name?&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">stream</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">input_message</span><span class="p">]},</span> <span class="n">config</span><span class="p">,</span> <span class="n">stream_mode</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">([(</span><span class="n">message</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]])</span>
</code></pre></div>

<p>API Reference: HumanMessage</p>
<div class="codehilite"><pre><span></span><code><span class="k">[(&#39;human&#39;, &quot;hi! I&#39;m bob&quot;)]</span>
<span class="k">[(&#39;human&#39;, &quot;hi! I&#39;m bob&quot;), (&#39;ai&#39;, &quot;Hello Bob! It&#39;s nice to meet you. I&#39;m an AI assistant created by Anthropic. I&#39;m here to help with any questions or tasks you might have. Please let me know how I can assist you.&quot;)]</span>
<span class="k">[(&#39;human&#39;, &quot;hi! I&#39;m bob&quot;), (&#39;ai&#39;, &quot;Hello Bob! It&#39;s nice to meet you. I&#39;m an AI assistant created by Anthropic. I&#39;m here to help with any questions or tasks you might have. Please let me know how I can assist you.&quot;), (&#39;human&#39;, &quot;what&#39;s my name?&quot;)]</span>
<span class="k">[(&#39;human&#39;, &quot;hi! I&#39;m bob&quot;), (&#39;ai&#39;, &quot;Hello Bob! It&#39;s nice to meet you. I&#39;m an AI assistant created by Anthropic. I&#39;m here to help with any questions or tasks you might have. Please let me know how I can assist you.&quot;), (&#39;human&#39;, &quot;what&#39;s my name?&quot;), (&#39;ai&#39;, &#39;You said your name is Bob, so that is the name I have for you.&#39;)]</span>
<span class="k">[(&#39;ai&#39;, &quot;Hello Bob! It&#39;s nice to meet you. I&#39;m an AI assistant created by Anthropic. I&#39;m here to help with any questions or tasks you might have. Please let me know how I can assist you.&quot;), (&#39;human&#39;, &quot;what&#39;s my name?&quot;), (&#39;ai&#39;, &#39;You said your name is Bob, so that is the name I have for you.&#39;)]</span>
</code></pre></div>

<p>If we now check the state, we should see that it is only three messages long. This is because we just deleted the earlier messages - otherwise it would be four!</p>
<div class="codehilite"><pre><span></span><code>messages = app.get_state(config).values[&quot;messages&quot;]
messages
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="o">[</span><span class="n">AIMessage(content=&quot;Hello Bob! It&#39;s nice to meet you. I&#39;m an AI assistant created by Anthropic. I&#39;m here to help with any questions or tasks you might have. Please let me know how I can assist you.&quot;, response_metadata={&#39;id&#39;: &#39;msg_01XPEgPPbcnz5BbGWUDWTmzG&#39;, &#39;model&#39;: &#39;claude-3-haiku-20240307&#39;, &#39;stop_reason&#39;: &#39;end_turn&#39;, &#39;stop_sequence&#39;: None, &#39;usage&#39;: {&#39;input_tokens&#39;: 12, &#39;output_tokens&#39;: 48}}, id=&#39;run-eded3820-b6a9-4d66-9210-03ca41787ce6-0&#39;, usage_metadata={&#39;input_tokens&#39;: 12, &#39;output_tokens&#39;: 48, &#39;total_tokens&#39;: 60}),</span>
<span class="n"> HumanMessage(content=&quot;what&#39;s my name?&quot;, id=&#39;a0ea2097-3280-402b-92e1-67177b807ae8&#39;),</span>
<span class="n"> AIMessage(content=&#39;You said your name is Bob, so that is the name I have for you.&#39;, response_metadata={&#39;id&#39;: &#39;msg_01JGT62pxhrhN4SykZ57CSjW&#39;, &#39;model&#39;: &#39;claude-3-haiku-20240307&#39;, &#39;stop_reason&#39;: &#39;end_turn&#39;, &#39;stop_sequence&#39;: None, &#39;usage&#39;: {&#39;input_tokens&#39;: 68, &#39;output_tokens&#39;: 20}}, id=&#39;run-ace3519c-81f8-45fe-a777-91f42d48b3a3-0&#39;, usage_metadata={&#39;input_tokens&#39;: 68, &#39;output_tokens&#39;: 20, &#39;total_tokens&#39;: 88})</span><span class="o">]</span>
<span class="w"> </span><span class="err">```</span>

<span class="w"> </span><span class="n">Remember</span><span class="p">,</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">deleting</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">want</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">sure</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="n">valid</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">actually</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">AI</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="ow">some</span><span class="w"> </span><span class="n">models</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">allow</span><span class="p">.</span>

<span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">How</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">summary</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">conversation</span><span class="w"> </span><span class="n">history</span>
<span class="w"> </span><span class="n">One</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">most</span><span class="w"> </span><span class="n">common</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">cases</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">persistence</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="n">track</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">conversation</span><span class="w"> </span><span class="n">history</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">great</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">makes</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">easy</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="n">conversations</span><span class="p">.</span><span class="w"> </span><span class="k">As</span><span class="w"> </span><span class="n">conversations</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">longer</span><span class="p">,</span><span class="w"> </span><span class="n">however</span><span class="p">,</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">conversation</span><span class="w"> </span><span class="n">history</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">take</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">context</span><span class="w"> </span><span class="k">window</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">often</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">undesirable</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">leads</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">expensive</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">longer</span><span class="w"> </span><span class="n">calls</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">LLM</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">potentially</span><span class="w"> </span><span class="n">ones</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">error</span><span class="p">.</span><span class="w"> </span><span class="n">One</span><span class="w"> </span><span class="n">way</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">work</span><span class="w"> </span><span class="n">around</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">summary</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">conversation</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nc">date</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">past</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">messages</span><span class="p">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">guide</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="k">go</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">example</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">that</span><span class="p">.</span>

<span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">involve</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">few</span><span class="w"> </span><span class="nl">steps</span><span class="p">:</span>


<span class="o">-</span><span class="w"> </span><span class="k">Check</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">conversation</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="n">long</span><span class="w"> </span><span class="p">(</span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">done</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">messages</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">messages</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="n">yes</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="n">summary</span><span class="w"> </span><span class="p">(</span><span class="n">will</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">prompt</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">this</span><span class="p">)</span>
<span class="o">-</span><span class="w"> </span><span class="k">Then</span><span class="w"> </span><span class="n">remove</span><span class="w"> </span><span class="ow">all</span><span class="w"> </span><span class="ow">except</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">last</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="n">messages</span>

<span class="err">##</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">chatbot</span>
</code></pre></div>

<p>from typing import Literal</p>
<p>from langchain_anthropic import ChatAnthropic
from langchain_core.messages import SystemMessage, RemoveMessage, HumanMessage
from langgraph.checkpoint.memory import MemorySaver
from langgraph.graph import MessagesState, StateGraph, START, END</p>
<p>memory = MemorySaver()</p>
<h1 id="we-will-add-a-summary-attribute-in-addition-to-messages-key">We will add a <code>summary</code> attribute (in addition to <code>messages</code> key,<a class="headerlink" href="#we-will-add-a-summary-attribute-in-addition-to-messages-key" title="Permanent link">#</a></h1>
<h1 id="which-messagesstate-already-has">which MessagesState already has)<a class="headerlink" href="#which-messagesstate-already-has" title="Permanent link">#</a></h1>
<p>class State(MessagesState):
    summary: str</p>
<h1 id="we-will-use-this-model-for-both-the-conversation-and-the-summarization">We will use this model for both the conversation and the summarization<a class="headerlink" href="#we-will-use-this-model-for-both-the-conversation-and-the-summarization" title="Permanent link">#</a></h1>
<p>model = ChatAnthropic(model_name="claude-3-haiku-20240307")</p>
<h1 id="define-the-logic-to-call-the-model">Define the logic to call the model<a class="headerlink" href="#define-the-logic-to-call-the-model" title="Permanent link">#</a></h1>
<p>def call_model(state: State):
    # If a summary exists, we add this in as a system message
    summary = state.get("summary", "")
    if summary:
        system_message = f"Summary of conversation earlier: {summary}"
        messages = [SystemMessage(content=system_message)] + state["messages"]
    else:
        messages = state["messages"]
    response = model.invoke(messages)
    # We return a list, because this will get added to the existing list
    return {"messages": [response]}</p>
<h1 id="we-now-define-the-logic-for-determining-whether-to-end-or-summarize-the-conversation">We now define the logic for determining whether to end or summarize the conversation<a class="headerlink" href="#we-now-define-the-logic-for-determining-whether-to-end-or-summarize-the-conversation" title="Permanent link">#</a></h1>
<p>def should_continue(state: State) -&gt; Literal["summarize_conversation", END]:
    """Return the next node to execute."""
    messages = state["messages"]
    # If there are more than six messages, then we summarize the conversation
    if len(messages) &gt; 6:
        return "summarize_conversation"
    # Otherwise we can just end
    return END</p>
<p>def summarize_conversation(state: State):
    # First, we summarize the conversation
    summary = state.get("summary", "")
    if summary:
        # If a summary already exists, we use a different system prompt
        # to summarize it than if one didn't
        summary_message = (
            f"This is summary of the conversation to date: {summary}\n\n"
            "Extend the summary by taking into account the new messages above:"
        )
    else:
        summary_message = "Create a summary of the conversation above:"</p>
<div class="codehilite"><pre><span></span><code><span class="s s-Atom">messages</span> <span class="o">=</span> <span class="s s-Atom">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nv">HumanMessage</span><span class="p">(</span><span class="s s-Atom">content</span><span class="o">=</span><span class="s s-Atom">summary_message</span><span class="p">)]</span>
<span class="s s-Atom">response</span> <span class="o">=</span> <span class="s s-Atom">model</span><span class="p">.</span><span class="nf">invoke</span><span class="p">(</span><span class="s s-Atom">messages</span><span class="p">)</span>
<span class="s s-Atom">#</span> <span class="nv">We</span> <span class="s s-Atom">now</span> <span class="s s-Atom">need</span> <span class="s s-Atom">to</span> <span class="s s-Atom">delete</span> <span class="s s-Atom">messages</span> <span class="s s-Atom">that</span> <span class="s s-Atom">we</span> <span class="s s-Atom">no</span> <span class="s s-Atom">longer</span> <span class="s s-Atom">want</span> <span class="s s-Atom">to</span> <span class="s s-Atom">show</span> <span class="s s-Atom">up</span>
<span class="s s-Atom">#</span> <span class="nv">I</span> <span class="s s-Atom">will</span> <span class="s s-Atom">delete</span> <span class="s s-Atom">all</span> <span class="s s-Atom">but</span> <span class="s s-Atom">the</span> <span class="s s-Atom">last</span> <span class="s s-Atom">two</span> <span class="s s-Atom">messages</span><span class="p">,</span> <span class="s s-Atom">but</span> <span class="s s-Atom">you</span> <span class="s s-Atom">can</span> <span class="s s-Atom">change</span> <span class="s s-Atom">this</span>
<span class="s s-Atom">delete_messages</span> <span class="o">=</span> <span class="p">[</span><span class="nv">RemoveMessage</span><span class="p">(</span><span class="s s-Atom">id</span><span class="o">=</span><span class="s s-Atom">m</span><span class="p">.</span><span class="s s-Atom">id</span><span class="p">)</span> <span class="s s-Atom">for</span> <span class="s s-Atom">m</span> <span class="s s-Atom">in</span> <span class="s s-Atom">state</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">][</span><span class="o">:-</span><span class="mi">2</span><span class="p">]]</span>
<span class="s s-Atom">return</span> <span class="p">{</span><span class="s2">&quot;summary&quot;</span><span class="o">:</span> <span class="s s-Atom">response</span><span class="p">.</span><span class="s s-Atom">content</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="o">:</span> <span class="s s-Atom">delete_messages</span><span class="p">}</span>
</code></pre></div>

<h1 id="define-a-new-graph_1">Define a new graph<a class="headerlink" href="#define-a-new-graph_1" title="Permanent link">#</a></h1>
<p>workflow = StateGraph(State)</p>
<h1 id="define-the-conversation-node-and-the-summarize-node">Define the conversation node and the summarize node<a class="headerlink" href="#define-the-conversation-node-and-the-summarize-node" title="Permanent link">#</a></h1>
<p>workflow.add_node("conversation", call_model)
workflow.add_node(summarize_conversation)</p>
<h1 id="set-the-entrypoint-as-conversation">Set the entrypoint as conversation<a class="headerlink" href="#set-the-entrypoint-as-conversation" title="Permanent link">#</a></h1>
<p>workflow.add_edge(START, "conversation")</p>
<h1 id="we-now-add-a-conditional-edge_1">We now add a conditional edge<a class="headerlink" href="#we-now-add-a-conditional-edge_1" title="Permanent link">#</a></h1>
<p>workflow.add_conditional_edges(
    # First, we define the start node. We use <code>conversation</code>.
    # This means these are the edges taken after the <code>conversation</code> node is called.
    "conversation",
    # Next, we pass in the function that will determine which node is called next.
    should_continue,
)</p>
<h1 id="we-now-add-a-normal-edge-from-summarize_conversation-to-end">We now add a normal edge from <code>summarize_conversation</code> to END.<a class="headerlink" href="#we-now-add-a-normal-edge-from-summarize_conversation-to-end" title="Permanent link">#</a></h1>
<h1 id="this-means-that-after-summarize_conversation-is-called-we-end">This means that after <code>summarize_conversation</code> is called, we end.<a class="headerlink" href="#this-means-that-after-summarize_conversation-is-called-we-end" title="Permanent link">#</a></h1>
<p>workflow.add_edge("summarize_conversation", END)</p>
<h1 id="finally-we-compile-it_1">Finally, we compile it!<a class="headerlink" href="#finally-we-compile-it_1" title="Permanent link">#</a></h1>
<p>app = workflow.compile(checkpointer=memory)</p>
<div class="codehilite"><pre><span></span><code>## Using the graph
</code></pre></div>

<p>def print_update(update):
    for k, v in update.items():
        for m in v["messages"]:
            m.pretty_print()
        if "summary" in v:
            print(v["summary"])</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>from langchain_core.messages import HumanMessage</p>
<p>config = {"configurable": {"thread_id": "4"}}
input_message = HumanMessage(content="hi! I'm bob")
input_message.pretty_print()
for event in app.stream({"messages": [input_message]}, config, stream_mode="updates"):
    print_update(event)</p>
<p>input_message = HumanMessage(content="what's my name?")
input_message.pretty_print()
for event in app.stream({"messages": [input_message]}, config, stream_mode="updates"):
    print_update(event)</p>
<p>input_message = HumanMessage(content="i like the celtics!")
input_message.pretty_print()
for event in app.stream({"messages": [input_message]}, config, stream_mode="updates"):
    print_update(event)</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>================================[1m Human Message [0m=================================</p>
<p>hi! I'm bob
==================================[1m Ai Message [0m==================================</p>
<p>It's nice to meet you, Bob! I'm an AI assistant created by Anthropic. How can I help you today?
================================[1m Human Message [0m=================================</p>
<p>what's my name?
==================================[1m Ai Message [0m==================================</p>
<p>Your name is Bob, as you told me at the beginning of our conversation.
================================[1m Human Message [0m=================================</p>
<p>i like the celtics!
==================================[1m Ai Message [0m==================================</p>
<p>That's great, the Celtics are a fun team to follow! Basketball is an exciting sport. Do you have a favorite Celtics player or a favorite moment from a Celtics game you've watched? I'd be happy to discuss the team and the sport with you.</p>
<div class="codehilite"><pre><span></span><code>We can see that so far no summarization has happened - this is because there are only six messages in the list.
</code></pre></div>

<p>values = app.get_state(config).values
values</p>
<div class="codehilite"><pre><span></span><code><span class="nv">Now</span><span class="w"> </span><span class="nv">let</span><span class="err">&#39;s send another message in</span>
</code></pre></div>

<p>input_message = HumanMessage(content="i like how much they win")
input_message.pretty_print()
for event in app.stream({"messages": [input_message]}, config, stream_mode="updates"):
    print_update(event)</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>================================[1m Human Message [0m=================================</p>
<p>i like how much they win
==================================[1m Ai Message [0m==================================</p>
<p>That's understandable, the Celtics have been one of the more successful NBA franchises over the years. Their history of winning championships is very impressive. It's always fun to follow a team that regularly competes for titles. What do you think has been the key to the Celtics' sustained success? Is there a particular era or team that stands out as your favorite?
================================[1m Remove Message [0m================================</p>
<p>================================[1m Remove Message [0m================================</p>
<p>================================[1m Remove Message [0m================================</p>
<p>================================[1m Remove Message [0m================================</p>
<p>================================[1m Remove Message [0m================================</p>
<p>================================[1m Remove Message [0m================================</p>
<p>Here is a summary of our conversation so far:</p>
<ul>
<li>You introduced yourself as Bob and said you like the Boston Celtics basketball team.</li>
<li>I acknowledged that it's nice to meet you, Bob, and noted that you had shared your name earlier in the conversation.</li>
<li>You expressed that you like how much the Celtics win, and I agreed that their history of sustained success and championship pedigree is impressive.</li>
<li>I asked if you have a favorite Celtics player or moment that stands out to you, and invited further discussion about the team and the sport of basketball.</li>
<li>The overall tone has been friendly and conversational, with me trying to engage with your interest in the Celtics by asking follow-up questions.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">If</span><span class="w"> </span><span class="nv">we</span><span class="w"> </span><span class="nv">check</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">state</span><span class="w"> </span><span class="nv">now</span>,<span class="w"> </span><span class="nv">we</span><span class="w"> </span><span class="nv">can</span><span class="w"> </span><span class="nv">see</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">we</span><span class="w"> </span><span class="nv">have</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">summary</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">conversation</span>,<span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">well</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">last</span><span class="w"> </span><span class="nv">two</span><span class="w"> </span><span class="nv">messages</span>
</code></pre></div>

<p>values = app.get_state(config).values
values</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{'messages': [HumanMessage(content='i like how much they win', id='bb916ce7-534c-4d48-9f92-e269f9dc4859'),
  AIMessage(content="That's understandable, the Celtics have been one of the more successful NBA franchises over the years. Their history of winning championships is very impressive. It's always fun to follow a team that regularly competes for titles. What do you think has been the key to the Celtics' sustained success? Is there a particular era or team that stands out as your favorite?", response_metadata={'id': 'msg_01B7TMagaM8xBnYXLSMwUDAG', 'model': 'claude-3-haiku-20240307', 'stop_reason': 'end_turn', 'stop_sequence': None, 'usage': {'input_tokens': 148, 'output_tokens': 82}}, id='run-c5aa9a8f-7983-4a7f-9c1e-0c0055334ac1-0')],
 'summary': "Here is a summary of our conversation so far:\n\n- You introduced yourself as Bob and said you like the Boston Celtics basketball team.\n- I acknowledged that it's nice to meet you, Bob, and noted that you had shared your name earlier in the conversation.\n- You expressed that you like how much the Celtics win, and I agreed that their history of sustained success and championship pedigree is impressive.\n- I asked if you have a favorite Celtics player or moment that stands out to you, and invited further discussion about the team and the sport of basketball.\n- The overall tone has been friendly and conversational, with me trying to engage with your interest in the Celtics by asking follow-up questions."}
 ```</p>
<p>We can now resume having a conversation! Note that even though we only have the last two messages, we can still ask it questions about things mentioned earlier in the conversation (because we summarized those)</p>
<p>```
 input_message = HumanMessage(content="what's my name?")
input_message.pretty_print()
for event in app.stream({"messages": [input_message]}, config, stream_mode="updates"):
    print_update(event)</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>================================[1m Human Message [0m=================================</p>
<p>what's my name?
==================================[1m Ai Message [0m==================================</p>
<p>In our conversation so far, you introduced yourself as Bob. I acknowledged that earlier when you had shared your name.</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>input_message = HumanMessage(content="what NFL team do you think I like?")
input_message.pretty_print()
for event in app.stream({"messages": [input_message]}, config, stream_mode="updates"):
    print_update(event)</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>================================[1m Human Message [0m=================================</p>
<p>what NFL team do you think I like?
==================================[1m Ai Message [0m==================================</p>
<p>I don't actually have any information about what NFL team you might like. In our conversation so far, you've only mentioned that you're a fan of the Boston Celtics basketball team. I don't have any prior knowledge about your preferences for NFL teams. Unless you provide me with that information, I don't have a basis to guess which NFL team you might be a fan of.</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>input_message = HumanMessage(content="i like the patriots!")
input_message.pretty_print()
for event in app.stream({"messages": [input_message]}, config, stream_mode="updates"):
    print_update(event)</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>================================[1m Human Message [0m=================================</p>
<p>i like the patriots!
==================================[1m Ai Message [0m==================================</p>
<p>Okay, got it! Thanks for sharing that you're also a fan of the New England Patriots in the NFL. That makes sense, given your interest in other Boston sports teams like the Celtics. The Patriots have also had a very successful run over the past couple of decades, winning multiple Super Bowls. It's fun to follow winning franchises like the Celtics and Patriots. Do you have a favorite Patriots player or moment that stands out to you?
================================[1m Remove Message [0m================================</p>
<p>================================[1m Remove Message [0m================================</p>
<p>================================[1m Remove Message [0m================================</p>
<p>================================[1m Remove Message [0m================================</p>
<p>================================[1m Remove Message [0m================================</p>
<p>================================[1m Remove Message [0m================================</p>
<p>Okay, extending the summary with the new information:</p>
<ul>
<li>You initially introduced yourself as Bob and said you like the Boston Celtics basketball team. </li>
<li>I acknowledged that and we discussed your appreciation for the Celtics' history of winning.</li>
<li>You then asked what your name was, and I reminded you that you had introduced yourself as Bob earlier in the conversation.</li>
<li>You followed up by asking what NFL team I thought you might like, and I explained that I didn't have any prior information about your NFL team preferences.</li>
<li>You then revealed that you are also a fan of the New England Patriots, which made sense given your Celtics fandom.</li>
<li>I responded positively to this new information, noting the Patriots' own impressive success and dynasty over the past couple of decades.</li>
<li>I then asked if you have a particular favorite Patriots player or moment that stands out to you, continuing the friendly, conversational tone.</li>
</ul>
<p>Overall, the discussion has focused on your sports team preferences, with you sharing that you are a fan of both the Celtics and the Patriots. I've tried to engage with your interests and ask follow-up questions to keep the dialogue flowing.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Tool calling</span>
<span class="c1">## How to call tools using ToolNode</span>
<span class="n">ToolNode</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">LangChain</span><span class="w"> </span><span class="n">Runnable</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">messages</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">outputs</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="k">tool</span><span class="w"> </span><span class="n">calls</span><span class="o">.</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">designed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">work</span><span class="w"> </span><span class="n">well</span><span class="w"> </span><span class="n">out</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">box</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">LangGraph</span><span class="s1">&#39;s prebuilt ReAct agent, but can also work with any StateGraph as long as its state has a messages key with an appropriate reducer (see MessagesState).</span>


<span class="c1">## Define tools</span>
</code></pre></div>

<p>from langchain_core.messages import AIMessage
from langchain_core.tools import tool</p>
<p>from langgraph.prebuilt import ToolNode</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>@tool
def get_weather(location: str):
    """Call to get the current weather."""
    if location.lower() in ["sf", "san francisco"]:
        return "It's 60 degrees and foggy."
    else:
        return "It's 90 degrees and sunny."</p>
<p>@tool
def get_coolest_cities():
    """Get a list of coolest cities"""
    return "nyc, sf"</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>tools = [get_weather, get_coolest_cities]
tool_node = ToolNode(tools)</p>
<div class="codehilite"><pre><span></span><code><span class="c1">## Manually call ToolNode</span>
<span class="n">ToolNode</span><span class="w"> </span><span class="n">operates</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">messages</span><span class="o">.</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">expects</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">last</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="n">AIMessage</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">tool_calls</span><span class="w"> </span><span class="n">parameter</span><span class="o">.</span>

<span class="n">Let</span><span class="s1">&#39;s first see how to invoke the tool node manually:</span>
</code></pre></div>

<p>message_with_single_tool_call = AIMessage(
    content="",
    tool_calls=[
        {
            "name": "get_weather",
            "args": {"location": "sf"},
            "id": "tool_call_id",
            "type": "tool_call",
        }
    ],
)</p>
<p>tool_node.invoke({"messages": [message_with_single_tool_call]})</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{'messages': [ToolMessage(content="It's 60 degrees and foggy.", name='get_weather', tool_call_id='tool_call_id')]}</p>
<div class="codehilite"><pre><span></span><code><span class="n">Note</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">typically</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">don</span><span class="s1">&#39;t need to create AIMessage manually, and it will be automatically generated by any LangChain chat model that supports tool calling.</span>

<span class="n">You</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">also</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">parallel</span><span class="w"> </span><span class="k">tool</span><span class="w"> </span><span class="n">calling</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">ToolNode</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="k">pass</span><span class="w"> </span><span class="n">multiple</span><span class="w"> </span><span class="k">tool</span><span class="w"> </span><span class="n">calls</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">AIMessage</span><span class="s1">&#39;s tool_calls parameter:</span>
</code></pre></div>

<p>message_with_multiple_tool_calls = AIMessage(
    content="",
    tool_calls=[
        {
            "name": "get_coolest_cities",
            "args": {},
            "id": "tool_call_id_1",
            "type": "tool_call",
        },
        {
            "name": "get_weather",
            "args": {"location": "sf"},
            "id": "tool_call_id_2",
            "type": "tool_call",
        },
    ],
)</p>
<p>tool_node.invoke({"messages": [message_with_multiple_tool_calls]})</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{'messages': [ToolMessage(content='nyc, sf', name='get_coolest_cities', tool_call_id='tool_call_id_1'),
  ToolMessage(content="It's 60 degrees and foggy.", name='get_weather', tool_call_id='tool_call_id_2')]}</p>
<div class="codehilite"><pre><span></span><code><span class="c1">## Using with chat models</span>

<span class="n">We</span><span class="s1">&#39;ll be using a small chat model from Anthropic in our example. To use chat models with tool calling, we need to first ensure that the model is aware of the available tools. We do this by calling .bind_tools method on ChatAnthropic model</span>
</code></pre></div>

<p>from typing import Literal</p>
<p>from langchain_anthropic import ChatAnthropic
from langgraph.graph import StateGraph, MessagesState
from langgraph.prebuilt import ToolNode</p>
<p>model_with_tools = ChatAnthropic(
    model="claude-3-haiku-20240307", temperature=0
).bind_tools(tools)</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>model_with_tools.invoke("what's the weather in sf?").tool_calls</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>[{'name': 'get_weather',
  'args': {'location': 'San Francisco'},
  'id': 'toolu_01Fwm7dg1mcJU43Fkx2pqgm8',
  'type': 'tool_call'}]</p>
<div class="codehilite"><pre><span></span><code><span class="n">As</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">see</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">AI</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">generated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">chat</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">already</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">tool_calls</span><span class="w"> </span><span class="n">populated</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="k">pass</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">directly</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ToolNode</span>
</code></pre></div>

<p>tool_node.invoke({"messages": [model_with_tools.invoke("what's the weather in sf?")]})</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{'messages': [ToolMessage(content="It's 60 degrees and foggy.", name='get_weather', tool_call_id='toolu_01LFvAVT3xJMeZS6kbWwBGZK')]}</p>
<div class="codehilite"><pre><span></span><code><span class="c1">## ReAct Agent</span>
<span class="n">Next</span><span class="p">,</span><span class="w"> </span><span class="n">let</span><span class="s1">&#39;s see how to use ToolNode inside a LangGraph graph. Let&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="n">implementation</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ReAct</span><span class="w"> </span><span class="n">agent</span><span class="o">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">agent</span><span class="w"> </span><span class="n">takes</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">repeatedly</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">tools</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">enough</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">resolve</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">query</span><span class="o">.</span><span class="w"> </span><span class="n">We</span><span class="s1">&#39;ll be using ToolNode and the Anthropic model with tools we just defined</span>
</code></pre></div>

<p>from typing import Literal</p>
<p>from langgraph.graph import StateGraph, MessagesState, START, END</p>
<p>def should_continue(state: MessagesState):
    messages = state["messages"]
    last_message = messages[-1]
    if last_message.tool_calls:
        return "tools"
    return END</p>
<p>def call_model(state: MessagesState):
    messages = state["messages"]
    response = model_with_tools.invoke(messages)
    return {"messages": [response]}</p>
<p>workflow = StateGraph(MessagesState)</p>
<h1 id="define-the-two-nodes-we-will-cycle-between_1">Define the two nodes we will cycle between<a class="headerlink" href="#define-the-two-nodes-we-will-cycle-between_1" title="Permanent link">#</a></h1>
<p>workflow.add_node("agent", call_model)
workflow.add_node("tools", tool_node)</p>
<p>workflow.add_edge(START, "agent")
workflow.add_conditional_edges("agent", should_continue, ["tools", END])
workflow.add_edge("tools", "agent")</p>
<p>app = workflow.compile()</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>from IPython.display import Image, display</p>
<p>try:
    display(Image(app.get_graph().draw_mermaid_png()))
except Exception:
    # This requires some extra dependencies and is optional
    pass</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<h1 id="example-with-a-single-tool-call">example with a single tool call<a class="headerlink" href="#example-with-a-single-tool-call" title="Permanent link">#</a></h1>
<p>for chunk in app.stream(
    {"messages": [("human", "what's the weather in sf?")]}, stream_mode="values"
):
    chunk["messages"][-1].pretty_print()</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>================================[1m Human Message [0m=================================</p>
<p>what's the weather in sf?
==================================[1m Ai Message [0m==================================</p>
<p>[{'text': "Okay, let's check the weather in San Francisco:", 'type': 'text'}, {'id': 'toolu_01LdmBXYeccWKdPrhZSwFCDX', 'input': {'location': 'San Francisco'}, 'name': 'get_weather', 'type': 'tool_use'}]
Tool Calls:
  get_weather (toolu_01LdmBXYeccWKdPrhZSwFCDX)
 Call ID: toolu_01LdmBXYeccWKdPrhZSwFCDX
  Args:
    location: San Francisco
=================================[1m Tool Message [0m=================================
Name: get_weather</p>
<p>It's 60 degrees and foggy.
==================================[1m Ai Message [0m==================================</p>
<p>The weather in San Francisco is currently 60 degrees with foggy conditions.</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<h1 id="example-with-a-multiple-tool-calls-in-succession">example with a multiple tool calls in succession<a class="headerlink" href="#example-with-a-multiple-tool-calls-in-succession" title="Permanent link">#</a></h1>
<p>for chunk in app.stream(
    {"messages": [("human", "what's the weather in the coolest cities?")]},
    stream_mode="values",
):
    chunk["messages"][-1].pretty_print()</p>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>================================[1m Human Message [0m=================================</p>
<p>what's the weather in the coolest cities?
==================================[1m Ai Message [0m==================================</p>
<p>[{'text': "Okay, let's find out the weather in the coolest cities:", 'type': 'text'}, {'id': 'toolu_01LFZUWTccyveBdaSAisMi95', 'input': {}, 'name': 'get_coolest_cities', 'type': 'tool_use'}]
Tool Calls:
  get_coolest_cities (toolu_01LFZUWTccyveBdaSAisMi95)
 Call ID: toolu_01LFZUWTccyveBdaSAisMi95
  Args:
=================================[1m Tool Message [0m=================================
Name: get_coolest_cities</p>
<p>nyc, sf
==================================[1m Ai Message [0m==================================</p>
<p>[{'text': "Now let's get the weather for those cities:", 'type': 'text'}, {'id': 'toolu_01RHPQBhT1u6eDnPqqkGUpsV', 'input': {'location': 'nyc'}, 'name': 'get_weather', 'type': 'tool_use'}]
Tool Calls:
  get_weather (toolu_01RHPQBhT1u6eDnPqqkGUpsV)
 Call ID: toolu_01RHPQBhT1u6eDnPqqkGUpsV
  Args:
    location: nyc
=================================[1m Tool Message [0m=================================
Name: get_weather</p>
<p>It's 90 degrees and sunny.
==================================[1m Ai Message [0m==================================</p>
<p>[{'id': 'toolu_01W5sFGF8PfgYzdY4CqT5c6e', 'input': {'location': 'sf'}, 'name': 'get_weather', 'type': 'tool_use'}]
Tool Calls:
  get_weather (toolu_01W5sFGF8PfgYzdY4CqT5c6e)
 Call ID: toolu_01W5sFGF8PfgYzdY4CqT5c6e
  Args:
    location: sf
=================================[1m Tool Message [0m=================================
Name: get_weather</p>
<p>It's 60 degrees and foggy.
==================================[1m Ai Message [0m==================================</p>
<p>Based on the results, it looks like the weather in the coolest cities is:
- New York City: 90 degrees and sunny
- San Francisco: 60 degrees and foggy</p>
<p>So the weather in the coolest cities is a mix of warm and cool temperatures, with some sunny and some foggy conditions.
```</p>
<p>ToolNode can also handle errors during tool execution. You can enable / disable this by setting handle_tool_errors=True (enabled by default). See our guide on handling errors in ToolNode here</p>
<h1 id="how-to-integrate-langgraph-into-your-react-application">How to integrate LangGraph into your React application<a class="headerlink" href="#how-to-integrate-langgraph-into-your-react-application" title="Permanent link">#</a></h1>
<p><a href="https://langchain-ai.github.io/langgraph/cloud/how-tos/use_stream_react/">React application</a></p>
<h1 id="launch-local-langgraph-server">Launch Local LangGraph Server<a class="headerlink" href="#launch-local-langgraph-server" title="Permanent link">#</a></h1>
<p><a href="https://langchain-ai.github.io/langgraph/tutorials/langgraph-platform/local-server/">LangGraph Server</a></p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
